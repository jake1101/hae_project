<dom-module id="ep-apply-service-apply">
	<style>
		:host {
            @apply(--vbox-layout);
        }
	</style>
	<template>
		<sc-request-group init>
			<sc-code-group>
                <sc-code code="CRN001" value="{{codes.term}}"></sc-code>
            </sc-code-group>
		</sc-request-group>
		<sc-ajax
	       	id="serviceAplAprProcess"
	       	url="serviceAplAprProcess.do"
	       	body="{{setParam}}"
        ></sc-ajax>

		<cc-sub-title-bar title-text="서비스 신청 상세 내용 조회"></cc-sub-title-bar>
		<table class="tb-form">
			<tr>
				<th>계열사</th>
				<td>[[selectedService.group_nm]]</td>
				<th>담당자</th>
				<td>[[selectedService.usr_nm]]</td>
			</tr>
			<tr>
				<th>사업장</th>
				<td>[[selectedService.wpc_nm]]</td>
				<th>이메일</th>
				<td>[[selectedService.email]]</td>
			</tr>
			<tr>
				<th>주소</th>
				<td>[[selectedService.address]]</td>
				<th>연락처</th>
				<td>[[selectedService.mobile_no]]</td>
			</tr>
		</table>
		
		<!-- <sc-splitter split-type="horizontal"></sc-splitter> -->
		<div style="border-bottom: 1px solid #dedede; margin: 10px 10px;"></div>
		
		<table class="tb-form">
			<tr>
				<th>신청 서비스</th>
				<td colspan=2>[[selectedService.svc_ctl_nm]]</td>
			</tr>
			<tr>
				<th>신청 일시</th>
				<td colspan=2>[[selectedService.req_dt]]</td>
			</tr>
			<tr>
				<th>서비스 개시 요청일</th>
				<td colspan=2>[[selectedService.dsr_str_dt]]</td>
			</tr>
			<tr>
				<th id="dvcTh">
					디바이스 수량
				</th>
			</tr>
			<template id="dvcTemplate" is="dom-repeat" items="[[selectedService.dvc_list]]">
				<tr>
       				<th>
						<sc-label
							text="[[item.product_name]]"
						></sc-label>
					</th>
					<td>
						[[item.qtt]] 대
					</td>
       			</tr>
	        </template>
	        <tr>
	        	<th>구독기간(약정기간)</th>
	        	<td colspan=2>[[selectedService.sst_trm]]개월</td>
	        </tr>
	        <tr>
	        	<th>서비스 만료 예정일</th>
	        	<td colspan=2>[[selectedService.exp_end_dt]]</td>
	        </tr>
	        <tr>
	        	<th>예상 월 구독료</th>
	        	<td colspan=2>[[selectedService.exp_mon_fee]] 원 (VAT 별도)</td>
	        </tr>
	        <tr>
	        	<th>최종 월 구독료</th>
	        	<td colspan=2>
	        		<div style="display: flex; gap: 10px; align-items: center; width: 200px;">
						<sc-text-field
							id="mon_fee"
							type="number"
							value="{{setParam.mon_fee}}"
						></sc-text-field>
						<div style="width: 200px;">원 (VAT 별도)</div>
					</div>
	        	</td>
	        </tr>
		</table>
		<div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 20px;">
			<sc-button id="apply" text="승인" style="width: 100px; padding: 10px; display: none;" on-click="onBtnClick"></sc-button>
			<sc-button id="test" text="서비스 테스트" style="width: 100px; padding: 10px; display: none;" on-click="onBtnClick"></sc-button>
			<sc-button id="start" text="서비스 개시" style="width: 100px; padding: 10px; display: none;" on-click="onBtnClick"></sc-button>
		</div>
	</template>
	<script>
		Polymer({
			is: "ep-apply-service-apply",
			properties: {
				codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                            term: []
                        };
                    }
                },
				selectedService: {
					type: Object,
					value: function(){
						return {};
					}
				},
				setParam: {
					type: Object,
					value: function(){
						return {};
					}
				}
			},
			load: function(param){
				const me = this;
				const {stt_cd} = param;
				const commaNum = n => n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
				
				if(stt_cd == "1"){
					me.$.apply.style.display = "block";
					me.$.test.style.display = "none";
					me.$.start.style.display = "none";
					
					me.$.mon_fee.readonly = "false";
				}else if(stt_cd == "2"){
					me.$.apply.style.display = "none";
					me.$.test.style.display = "block";
					me.$.start.style.display = "none";
					
					me.$.mon_fee.type = "text";
					me.$.mon_fee.value = commaNum(param.mon_fee);
					me.$.mon_fee.readonly = "true";
				}else if(stt_cd == "3"){
					me.$.apply.style.display = "none";
					me.$.test.style.display = "none";
					me.$.start.style.display = "block";
					
					me.$.mon_fee.type = "text";
					me.$.mon_fee.value = commaNum(param.mon_fee);
					me.$.mon_fee.readonly = "true";
				}else{
					me.$.mon_fee.type = "text";
					me.$.mon_fee.value = commaNum(param.mon_fee);
					me.$.mon_fee.readonly = "true";
				}
				
				me.set("selectedService", param);
				me.$.dvcTh.setAttribute('rowspan', param.dvc_list.length + 1);
			},
			onBtnClick: function() {
				const me = this;
				const btnId = event.target.id;
				const {
					svc_id,
					service_gb_cd,
					stt_cd
				} = me.get("selectedService");

				if(!me.$.mon_fee.value){
					SCAlert.show('error', `최종 월 구독료를 입력해 주십시오.`);
					return;
				}
				
				Object.assign(me.get("setParam"), {svc_id, service_gb_cd, stt_cd});
				
				if(btnId == "apply"){
					Object.assign(me.get("setParam"), {"mon_fee": Number(me.get("setParam").mon_fee)});
					SCAlert.confirm("승인", "승인하시겠습니까?", function(btn){
						if(btn == "yes"){
							UT.request(me.$.serviceAplAprProcess, function(e, {response}){
								me.fire("refresh");
							});
						}else{
							SCAlert.show('error', `승인 실패하였습니다.`);
						}
					})
				}else if(btnId == "test"){
					SCAlert.confirm("서비스 테스트", "서비스 테스트를 진행하시겠습니까?", function(btn){
						if(btn == "yes"){
							UT.request(me.$.serviceAplAprProcess, function(e, {response}){
								me.fire("refresh");
							});
						}else{
							SCAlert.show('error', `테스트 실패하였습니다.`);
						}
					})
				}else if(btnId == "start"){
					const date = new Date();
					const {sst_trm} = me.get("selectedService");
					
					date.setMonth(date.getMonth() + Number(sst_trm));
					
					Object.assign(me.get("setParam"), {"sst_str_dt": new Date() ,"sst_end_dt": date});
					SCAlert.confirm("서비스 개시", "서비스를 개시하시겠습니까?", function(btn){
						if(btn == "yes"){
							UT.request(me.$.serviceAplAprProcess, function(e, {response}){
								me.fire("refresh");
							});
						}else{
							SCAlert.show('error', `개시 실패하였습니다.`);
						}
					})
				}
			}
		})
	</script>
</dom-module>