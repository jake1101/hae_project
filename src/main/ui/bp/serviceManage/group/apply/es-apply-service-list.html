<sc-link rel="import" href="ep-apply-service-apply.html"></sc-link>
<sc-link rel="import" href="ep-apply-service-update.html"></sc-link>

<dom-module id="es-apply-service-list">
	<style>
		:host{
			@apply(--vbox-layout);
		}
	</style>
	<template>
		<sc-request-group init>
			<sc-code-group>
                <sc-code code="CRN006" value="{{codes.division}}" ></sc-code>
                <sc-code code="CRN007" value="{{codes.stt}}" ></sc-code>
            </sc-code-group>
            <sc-ajax
            	id="getCompanyList"
            	url="getCompanyList.do"
            	body="{}"
            	last-response="{{companyList}}"
            ></sc-ajax>
            <sc-ajax
            	id="getWPCList"
            	url="getWPCList.do"
            	body="{}"
            	last-response="{{wpcResult}}"
            ></sc-ajax>
            <sc-ajax 
				id="getWpcServiceList" 
				url="getWpcServiceList.do"
				body="{}"
				last-response="{{wpcSerivceResult}}"
			></sc-ajax>
			<sc-ajax
            	id="getServiceAprList"
            	url="getServiceAprList.do"
            	body="{{searchParam}}"
            	last-response="{{serviceResult}}"
            	on-response="complateServiceResult"
            ></sc-ajax>
		</sc-request-group>
        <sc-ajax
           	id="getServiceAprListDetail"
           	url="getServiceAprListDetail.do"
           	body="{}"
        ></sc-ajax>
		<cc-sub-title-bar title-text="서비스 목록"></cc-sub-title-bar>
		<cc-search-container on-search="onFindService">
			<table>
				<colgroup>
					<col style="width: 50px;">
					<col>
					<col style="width: 60px;">
					<col>
					<col style="width: 60px;">
					<col>
					<col style="width: 90px;">
					<col>
					<col style="width: 50px;">
					<col>
					<col style="width: 90px;">
					<col>
				</colgroup>
				<tr style="height: 50px;">
					<th>
						<sc-label text="구분"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
                			items="{{codes.division}}"
						 	value="{{searchParam.service_gb_cd}}"
						 	display-field="label" 
						 	value-field="data" 
                			placeholder="구분"
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="계열사"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
                			placeholder="계열사"
                			items="{{companyList}}"
						 	value="{{searchParam.group_id}}"
						 	display-field="name" 
						 	value-field="id" 
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="사업장"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
						 	items="{{wpcResult.result_data}}"
						 	value="{{searchParam.wpc_cd}}"
						 	display-field="wpc_nm" 
						 	value-field="wpc_cd" 
							placeholder="사업장"
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="신청 서비스"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field
						 	items="{{wpcSerivceResult.result_data}}"
						 	value="{{searchParam.svc_ctl_id}}"
						 	display-field="svc_ctl_nm" 
						 	value-field="svc_ctl_id" 
                			placeholder="신청 서비스"
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="상태"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
                			items="{{codes.stt}}"
						 	value="{{searchParam.stt_cd}}"
						 	display-field="label" 
						 	value-field="data" 
                			placeholder="상태"
                		></sc-combobox-field>
                	</td>
					<th colspan=2 style="text-align: right;">
						<sc-label text="키워드 검색"></sc-label>
					</th>
					<td>
						<sc-text-field value="{{searchParam.search}}"></sc-text-field>
					</td>
				</tr>
				<tr></tr>
			</table>
		</cc-search-container>
		<sc-grid
			id="gridPanel"
			data-provider="{{serviceResult.result_data}}"
			use-selection="false"
			use-state="false"
			editable="true"
			on-item-click="onItemClick"
		>
			<cc-grid-toolbar></cc-grid-toolbar>
			<sc-grid-columns >
				<sc-data-column data-field="service_gb__nm" header-text="구분" width="100" text-align="center"></sc-data-column>
				<sc-data-column data-field="group_nm" header-text="계열사" width="200" text-align="center"></sc-data-column>
				<sc-data-column data-field="wpc_nm" header-text="사업장" width="150" text-align="center"></sc-data-column>
				<sc-data-column data-field="svc_ctl_nm" header-text="신청 서비스" width="400" text-align="center" style-name="link"></sc-data-column>
				<sc-data-column data-field="status_nm" header-text="상태" width="200" text-align="center"></sc-data-column>
				<sc-data-column data-field="req_dt" header-text="신청 일시" width="200" text-align="center"></sc-data-column>
				<sc-data-column data-field="sst_str_dt" header-text="서비스 개시일" width="200" text-align="center"></sc-data-column>
			</sc-grid-columns>
		</sc-grid>
	</template>
    <script>
    	Polymer({
    		is: "es-apply-service-list",
    		properties: {
    			codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                        	division: [],
                        	stt: []
                        };
                    }
                },
                companyList: {
    				type: Array,
    				value: function() {
    					return [];
    				}
    			},
				wpcResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			wpcList: {
    				type: Array,
    				value: function() {
    					return [];
    				}
    			},
    			wpcSerivceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
				serviceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			searchParam: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    		},
    		initialized: function() {
                const me = this;
                
                const result_data = me.get("wpcResult").result_data.map(wpc => wpc = {"wpc_cd": wpc.id, "wpc_nm": wpc.name, "company_id": wpc.company_id});
                me.set("wpcResult", {result_data});
            },
			complateServiceResult: function(e, {response: {result_data: serviceList}}) {
				const me = this;
				
				const setDate = dt => {
					if(dt != 253402182000000){
						const date = new Date(dt);
						const a = b => b > 10 ? b : '0'+b;
						
						const y = date.getFullYear() || "",
							  m = date.getMonth()+1 || "",
							  d = date.getDate() || "";
						
	                	return `${y}.${a(m)}.${a(d)}`;
					}else{
						return "";
					}
                }
                
                const setService = s =>{
                	if(s.status_nm != "이용중"){
                		return Object.assign(s, {
                        	"req_dt": setDate(s.req_dt),
                        	"sst_end_dt": setDate(s.sst_end_dt),
                        	"sst_str_dt": setDate(s.sst_str_dt),
                        });
                	}
                }
                
                if(serviceList){
                	result_data = serviceList.filter(setService);
                    me.set("serviceResult", {result_data});
                }
			},
            onFindService: function() {
            	const me = this;
            	UT.request(me.$.getServiceAprList);
            },
			onItemClick: function() {
				const me = this;
				const {data, item} = event.detail;
				data.svc_id = Number(data.svc_id);
				
				const {svc_id, stt_cd} = data;
				me.$.getServiceAprListDetail.body = {svc_id, stt_cd}
				
				UT.request(me.$.getServiceAprListDetail, 
				function(e, {response: {result_data}}){
					const {
							  getServiceAprListDetail,
							  getServiceAprListDvcDetail
					  	  } = result_data[0];
			  	 	const setDate = (dt) => {
			  	  		const date = new Date(dt);
				
					  	const y = date.getFullYear() || "",
			    			  m = date.getMonth()+1 || "",
						      d = date.getDate() || "";
				
				  		return `${y}-${m}-${d}`;
			 	 	};	
				  	const commaNum = n => n&& n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
			  	
				  	getServiceAprListDetail[0].dsr_str_dt = setDate(getServiceAprListDetail[0].dsr_str_dt);
				  	getServiceAprListDetail[0].exp_end_dt = setDate(getServiceAprListDetail[0].exp_end_dt);
				  	getServiceAprListDetail[0].req_dt = setDate(getServiceAprListDetail[0].req_dt);
				  	getServiceAprListDetail[0].exp_mon_fee = commaNum(getServiceAprListDetail[0].exp_mon_fee);
				  	
				  	Object.assign(data, getServiceAprListDetail[0]);
				  	Object.assign(data, {"dvc_list": getServiceAprListDvcDetail});
				  	
				  	if(data.service_gb_cd == "1"){
						const applyPop = UT.popup(
	       					"ep-apply-service-apply", 
	       					me,
	       					1000,
	       					800,
	       					{
	       						"refresh": function(popup, e) {
	       							UT.request(me.$.getServiceAprList, function() {
	       								popup.close();
	       							});
	                           	}
	       					},
	       					{ 
	       						maximizable: true, 
	       						titleText: `서비스 이용 상세 내역`
	       					}
	        			);
		                applyPop.show();
		                applyPop.getWindowContent().load(data);
					}else if(data.service_gb_cd == "2"){
						const updatePop = UT.popup(
	       					"ep-apply-service-update", 
	       					me,
	       					1000,
	       					800,
	       					{},
	       					{ 
	       						maximizable: true, 
	       						titleText: `서비스 변경 상세 내용 조회`
	       					}
	        			);
		                updatePop.show();
		                updatePop.getWindowContent().load(data);
					}
				})
			}
    	})
    </script>
</dom-module>