<dom-module id="es-company-status-service-list">
	<style>
        :host {
            @apply(--vbox-layout);
        }
    </style>
	<template>
		<sc-request-group init>
			<sc-code-group>
                <sc-code code="CRN001" value="{{codes.term}}" ></sc-code> <!-- 사용여부 -->
            </sc-code-group>
            <sc-ajax
            	id="getWPCList"
            	url="getWPCList.do"
            	body="{}"
            	last-response="{{wpcResult}}"
            ></sc-ajax>
            <sc-ajax 
				id="getWpcServiceList" 
				url="getWpcServiceList.do"
				body="{}"
				last-response="{{wpcSerivceResult}}"
			></sc-ajax>
			<sc-ajax 
				id="getServiceUseList" 
				url="getServiceUseList.do"
				body="{{searchParam}}"
				last-response="{{serviceResult}}"
				on-response = "complateServiceResult"
			></sc-ajax>
		</sc-request-group>
		<cc-sub-title-bar title-text="서비스 이용 목록"></cc-sub-title-bar>
		<cc-search-container on-search="onFindService">
			<table>
				<colgroup>
					<col style="width: 60px;">
					<col style="width: 150px;">
					<col style="width: 90px;">
					<col style="width: 300px;">
					<col style="width: 95px;">
					<col style="width: 60px;">
					<col style="width: 95px;">
					<col>
					<col style="width: 90px;">
					<col>
				</colgroup>
				<tr style="height: 50px;">
                	<th>
						<sc-label text="사업장"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
						 	items="{{wpcResult.result_data}}"
						 	value="{{searchParam.wpc_cd}}"
						 	display-field="wpc_nm" 
						 	value-field="wpc_cd" 
							placeholder="사업장"
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="신청 서비스"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field
						 	items="{{wpcSerivceResult.result_data}}"
						 	value="{{searchParam.svc_ctl_id}}"
						 	display-field="svc_ctl_nm" 
						 	value-field="svc_ctl_id" 
                			placeholder="신청 서비스"
                		></sc-combobox-field>
                	</td>
                	<th>
                		<sc-label text="이용중인 서비스만 조회"></sc-label>
                	</th>
              	    <td>
                		<sc-checkbox-field
                			input-value="{{searchParam.stt_cd}}"
                			checked-value="1" 
                			un-checked-value="0"
                		></sc-checkbox-field>
                	</td>
                	<th>
                		<sc-label text="장바구니 저장 서비스만 조회"></sc-label>
                	</th>
              	    <td>
                		<sc-checkbox-field
                			input-value="{{searchParam.bsk_itm_yn}}"
                			checked-value="1" 
                			un-checked-value="0"
                		></sc-checkbox-field>
                	</td>
                	<th rowspan=2>
						<sc-label text="키워드 검색"></sc-label>
					</th>
					<td rowspan=2>
						<sc-text-field value="{{searchParam.search}}"></sc-text-field>
					</td>
   	            </tr>
               	<tr>
				</tr>
			</table>
		</cc-search-container>
		<sc-grid
			id="gridPanel"
			data-provider="{{serviceResult.result_data}}"
			use-selection="false"
			use-state="false"
			editable="true"
		>
			<cc-grid-toolbar></cc-grid-toolbar>
			<sc-grid-columns >
				<sc-data-column data-field="wpc_nm" header-text="사업장" width="150" text-align="center"></sc-data-column>
				<sc-data-column data-field="svc_ctl_nm" header-text="신청 서비스" width="400" text-align="center"></sc-data-column>
				<sc-data-column data-field="req_dt" header-text="서비스 게시일" width="200" text-align="center"></sc-data-column>
				<sc-data-column data-field="req_dt" header-text="서비스 만료일" width="200" text-align="center"></sc-data-column>
				<sc-data-column data-field="sst_trm" header-text="구독 기간" width="150" text-align="center"></sc-data-column>
				<sc-data-column data-field="exp_mon_fee" header-text="월 구독료" width="150" text-align="center"></sc-data-column>
				<sc-data-column data-field="status_nm" header-text="상태" width="100" text-align="center"></sc-data-column>
				<sc-group-column
					hide-child-headers="true" 
					header-text=""  
					width="150"
				>
					<sc-button-column 
						data-field="stt_cd" 
						text="{{stt_cd}}" 
						width="100" 
						text-align="center"
					></sc-data-column>
				</sc-group-column>
			</sc-grid-columns>
		</sc-grid>
	</template>

	<script>
		Polymer({
			is: "es-company-status-service-list",
			properties: {
				codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                            term: []
                        };
                    }
                },
				searchParam: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
				wpcResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			wpcList: {
    				type: Array,
    				value: function() {
    					return [];
    				}
    			},
    			wpcSerivceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
				serviceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			}
			},
			observers: [

			],
			complateServiceResult(e, {response: {result_data: serviceList}}){
				const me = this;

				const setReqDt = dt => {
					const date = new Date(dt);
					const a = b => b > 10 ? b : '0'+b;
					
					const y = date.getFullYear() || "",
						  m = date.getMonth()+1 || "",
						  d = date.getDate() || "";
					
                	return `${y}.${a(m)}.${a(d)}`;
                }
				
				const setTerm = t => {
					const term = me.get("codes").term;
					return term.find(trm => t == Number(trm.data)).label
				}
                
				const commaNum = n => {
					return n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
				}
                
                const setService = s => Object.assign(s, {
                	"req_dt": setReqDt(s.req_dt),
                	"sst_trm": setTerm(s.sst_trm),
                	"exp_mon_fee": commaNum(s.exp_mon_fee)
                });
                
                if(serviceList){
                	result_data = serviceList.map(setService);
                    me.set("serviceResult", {result_data});
    				return serviceList;
                }
                
			},
			initialized: function() {
                const me = this;
             	
                const result_data = me.get("wpcResult").result_data.map(wpc => wpc = {"wpc_cd": wpc.id, "wpc_nm": wpc.name});
                result_data.unshift({"wpc_cd": "99", "wpc_nm": "전체"});
                me.set("wpcResult", {result_data});
                
                me.get("wpcSerivceResult").result_data.unshift({"svc_ctl_id": "99", "svc_ctl_nm": "전체"});
            },
            onFindService: function() {
            	const me = this;
            	UT.request(me.$.getServiceUseList);
            }
		})
	</script>
</dom-module>