<sc-link rel="import" href="ep-company-status-service-detail.html"></sc-link>
<sc-link rel="import" href="ep-company-status-service-apply.html"></sc-link>
<sc-link rel="import" href="ep-company-status-service-update.html"></sc-link>
<sc-link rel="import" href="ep-company-status-service-alarm.html"></sc-link>

<dom-module id="es-company-status-service-list">
	<style>
        :host {
            @apply(--vbox-layout);
        }
        
        #notification {
        	position: absolute;
        	top: 10px;
        	right: 0;
        	padding-right: 10px;
        }
        
        #notification < div {
        	position: relative;
        	width: 100%;
        }
        
        #notiCnt {
        	position: absolute;
        	bottom: -5px;
        	right: 0;
        	width: 20px;
        	height: 20px;
        	border-radius: 50%;
        	background-color: red;
        	color: #fff;
        	font-weight: 600;
        	text-align: center;
        	user-select: none;
        }
    </style>
	<template>
		<sc-request-group init>
			<sc-code-group>
                <sc-code code="CRN001" value="{{codes.term}}"></sc-code>
            </sc-code-group>
            <sc-ajax
            	id="getWPCList"
            	url="getWPCList.do"
            	body="{}"
            	last-response="{{wpcResult}}"
            ></sc-ajax>
            <sc-ajax 
				id="getWpcServiceList" 
				url="getWpcServiceList.do"
				body="{}"
				last-response="{{wpcSerivceResult}}"
			></sc-ajax>
			<sc-ajax 
				id="getServiceUseList" 
				url="getServiceUseList.do"
				body="{{searchParam}}"
				last-response="{{serviceResult}}"
				on-response = "complateServiceResult"
			></sc-ajax>
		</sc-request-group>
		<sc-ajax
			id="serviceUseChange"
			url="serviceUseChange.do"
		></sc-ajax>
		<sc-ajax 
			id="deleteApplyService" 
			url="deleteApplyService.do"
		></sc-ajax>
		<div id="notification" class="dm_notification_wrap" on-click="onClickAlarm">
			<div>
				<img src="/ui/assets/img/serviceManage/icon_notification.png" width="32">
				<div id="notiCnt">[[_computedAlarmListLength(alarmList)]]</div>
			</div>
		</div>
		
		<cc-sub-title-bar title-text="서비스 이용 목록"></cc-sub-title-bar>
		
		<cc-search-container on-search="onFindService">
			<table>
				<colgroup>
					<col style="width: 60px;">
					<col style="width: 150px;">
					<col style="width: 90px;">
					<col style="width: 300px;">
					<col style="width: 95px;">
					<col style="width: 60px;">
					<col style="width: 95px;">
					<col>
					<col style="width: 90px;">
					<col>
				</colgroup>
				<tr style="height: 50px;">
                	<th>
						<sc-label text="사업장"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
						 	items="{{wpcResult.result_data}}"
						 	value="{{searchParam.wpc_cd}}"
						 	display-field="wpc_nm" 
						 	value-field="wpc_cd" 
							placeholder="사업장"
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="신청 서비스"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field
						 	items="{{wpcSerivceResult.result_data}}"
						 	value="{{searchParam.svc_ctl_id}}"
						 	display-field="svc_ctl_nm" 
						 	value-field="svc_ctl_id" 
                			placeholder="신청 서비스"
                		></sc-combobox-field>
                	</td>
                	<th>
                		<sc-label text="이용중인 서비스만 조회"></sc-label>
                	</th>
              	    <td>
                		<sc-checkbox-field
                			input-value="{{searchParam.stt_cd}}"
                			checked-value="1" 
                			un-checked-value="0"
                		></sc-checkbox-field>
                	</td>
                	<th>
                		<sc-label text="장바구니 저장 서비스만 조회"></sc-label>
                	</th>
              	    <td>
                		<sc-checkbox-field
                			input-value="{{searchParam.bsk_itm_yn}}"
                			checked-value="1" 
                			un-checked-value="0"
                		></sc-checkbox-field>
                	</td>
                	<th rowspan=2>
						<sc-label text="키워드 검색"></sc-label>
					</th>
					<td rowspan=2>
						<sc-text-field value="{{searchParam.search}}"></sc-text-field>
					</td>
   	            </tr>
               	<tr>
				</tr>
			</table>
		</cc-search-container>
		<sc-grid
			id="gridPanel"
			data-provider="{{serviceResult.result_data}}"
			use-selection="false"
			use-state="false"
			editable="true"
			on-item-click="onItemClick"
		>
			<cc-grid-toolbar></cc-grid-toolbar>
			<sc-grid-columns>
				<sc-data-column data-field="wpc_nm" header-text="사업장" width="150" text-align="center"></sc-data-column>
				<sc-data-column data-field="svc_ctl_nm" header-text="신청 서비스" width="400" text-align="center" style-name="link"></sc-data-column>
				<sc-data-column data-field="sst_str_dt" header-text="서비스 게시일" width="200" text-align="center"></sc-data-column>
				<sc-data-column data-field="sst_end_dt" header-text="서비스 만료일" width="200" text-align="center"></sc-data-column>
				<sc-data-column data-field="sst_trm" header-text="구독 기간" width="150" text-align="center"></sc-data-column>
				<sc-data-column data-field="exp_mon_fee" header-text="월 구독료" width="150" text-align="center"></sc-data-column>
				<sc-data-column data-field="status_nm" header-text="상태" width="100" text-align="center"></sc-data-column>
				<sc-group-column header-text="서비스 신청/변경" hide-child-headers="true" data-field="status_code">
					<sc-data-column data-field="btn_l" text-align="center" style-name="link"></sc-data-column>
					<sc-data-column data-field="btn_r" text-align="center" style-name="link"></sc-data-column>
				</sc-group-column>
				
			</sc-grid-columns>
		</sc-grid>
	</template>

	<script>
		Polymer({
			is: "es-company-status-service-list",
			properties: {
				codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                            term: []
                        };
                    }
                },
				searchParam: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
				wpcResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			wpcList: {
    				type: Array,
    				value: function() {
    					return [];
    				}
    			},
    			wpcSerivceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
				serviceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			alarmList: {
    				type: Array,
    				value: function() {
    					return [];
    				}
    			},
			},
			initialized: function() {
                const me = this;
                
                const result_data = me.get("wpcResult").result_data.map(wpc => wpc = {"wpc_cd": wpc.id, "wpc_nm": wpc.name});
                me.set("wpcResult", {result_data});
            },
            complateServiceResult: function(e, {response: {result_data: serviceList}}){
				const me = this;
				
				me.set(
					"alarmList", 
					JSON.parse(JSON.stringify(serviceList))
					.filter(d => {
						if(d.sst_str_dt != 253402182000000 && d.sst_end_dt != 253402182000000){
							diff = d.sst_end_dt - d.sst_str_dt;
							d.diff = diff/24/60/60/1000;
							if(0 < diff && diff < 90){
								return d;
							}
						}
					})
				);

				const setDate = dt => {
					if(dt != 253402182000000){
						const date = new Date(dt);
						const a = b => b > 10 ? b : '0'+b;
						
						const y = date.getFullYear() || "",
							  m = date.getMonth()+1 || "",
							  d = date.getDate() || "";
						
	                	return `${y}.${a(m)}.${a(d)}`;
					}else{
						return "";
					}
                }
				
				const setTerm = t => {
					const term = me.get("codes").term;
					return term.find(trm => t == Number(trm.data)).label
				}
                
				const commaNum = n => {
					return n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
				}
				
				const setBtn = ({status_code: s}) => {
					let l = ""
					let r = ""
					if(s == "8") {
						l = "취소";
						r = "";
					}else if(s == "9") {
						l = "";
						r = "삭제";
					}else if(s == "5") {
						l = "변경";
						r = "";
					}else if(s == "2") {
						l = "신청";
						r = "";
					}else if(s == "0") {
						l = "신청";
						r = "삭제";
					}
					return {l, r};
				}
                
                const setService = s => {
                	if(s.status_nm != "삭제"){
                		return Object.assign(s, {
    	                   	"req_dt": setDate(s.req_dt),
    	                   	"sst_end_dt": setDate(s.sst_end_dt),
    	                   	"sst_str_dt": setDate(s.sst_str_dt),
    	                   	"sst_trm": setTerm(s.sst_trm),
    	                   	"exp_mon_fee": commaNum(s.exp_mon_fee),
    	                   	"btn_l": setBtn(s).l,
    	                   	"btn_r": setBtn(s).r
                        });
                	}
                }
                
                if(serviceList){
                	result_data = serviceList.filter(setService);
                    me.set("serviceResult", {result_data});
                }
			},
			_computedAlarmListLength: function(al) {
				return al.length;
			},
			onItemClick: function() {
				const me = this,
					  {data: d} = event.detail,
       		  		  {columnName: cn} = event.detail.item;
       		  		  
       		  	
       		  		  
       		  	d.svc_id = Number(d.svc_id);

       		  	if(cn == "svc_ctl_nm"){
       		  		const detailPop = UT.popup(
       					"ep-company-status-service-detail", 
       					me,
       					800,
       					800,
       					{},
       					{ 
       						maximizable: true, 
       						titleText: `서비스 신청 상세 내용 조회`
       					}
        			);
	       		 	detailPop.show();
	       			detailPop.getWindowContent().load(d)
       		  	}else if(cn == "btn_l" && d.btn_l == "신청"){
       		  		const applyPop = UT.popup(
       					"ep-company-status-service-apply", 
       					me,
       					800,
       					800,
       					{
       						"refresh": function(popup, e) {
       							UT.request(me.$.getServiceUseList, function() {
       								popup.close();
       							});
                           	}
       					},
       					{ 
    						maximizable: true, 
    						titleText: `${d.svc_ctl_nm} 서비스 이용 상세 내역`
    					}
        			);
	       		  	applyPop.show();
	       		 	applyPop.getWindowContent().load(d)
       		  	}else if(cn == "btn_l" && d.btn_l == "변경"){
	       		  	const updatePop = UT.popup(
	   					"ep-company-status-service-update", 
	   					me,
	   					1000,
	   					800,
	   					{
	   						"refresh": function(popup, e) {
	   							UT.request(me.$.getServiceUseList, function() {
	   								popup.close();
	   							});
	                       	}
	   					},
	   					{ 
	   						maximizable: true, 
	   						titleText: `${d.svc_ctl_nm} 변경 신청`
	   					}
	       			);
	       		 	updatePop.show();
	       			updatePop.getWindowContent().load(d)
       		  	}else if(cn=="btn_l" && d.btn_l == "취소"){
	       		  	SCAlert.confirm(`서비스 신청 취소`, `정말 취소하시겠습니까?`, function(btn){
						if(btn === 'yes'){
							me.$.serviceUseChange.body = {"svc_id": d.svc_id, "status": "8"}
		       		  		UT.request(me.$.serviceUseChange);
		       		  		UT.request(me.$.getServiceUseList);
						}
	    			});
       		  	}else if(cn == "btn_r" && d.btn_r == "삭제"){
	       		  	SCAlert.confirm(`서비스 삭제`, `정말 삭제하시겠습니까?`, function(btn){
						if(btn === 'yes'){
							me.$.deleteApplyService.body = {"svc_id": d.svc_id}
		       		  		UT.request(me.$.deleteApplyService);
		       		  		UT.request(me.$.getServiceUseList);
						}
	    			});
       		  	}
			},
			onClickAlarm: function() {
				const me = this;
            	const alarmPop = UT.popup(
   					"ep-company-status-service-alarm", 
   					me,
   					450,
   					400,
   					{
   						"click-button": function(popup, e) {
   							popup.close();
   							const serviceList = me.get("serviceResult").result_data,
   							 	  bId = e.detail.btn_id,
   								  sId = e.detail.svc_id,
   								  svc = serviceList.find(s => s.svc_id == sId);
   							
 							e.detail = {"data": svc}
   							if(bId.includes("detail")) {
   								e.detail.item={"columnName": "svc_ctl_nm"}
   							}else if(bId.includes("update") && svc.status_code == "4") {
   								Object.assign(e.detail, {"btn_l": "변경"})
   								e.detail.item={"columnName": "btn_l"}
   							}else{
   								return;
   							}
 							
 							me.onItemClick();
                       	}
   					},
   					{ 
   						maximizable: true, 
   						titleText: "구독 만료 임박 알림"
   					}
    			);
            	
            	alarmPop.show();
            	alarmPop.getWindowContent().load(me.get("alarmList"));
			},
            onFindService: function() {
            	const me = this;
            	UT.request(me.$.getServiceUseList);
            }
		})
	</script>
</dom-module>