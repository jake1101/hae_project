<dom-module id="ep-company-status-service-update">
	<style>
		:host {
			@apply(--vbox-layout);
		}
	</style>
	<template>
		<sc-request-group init>
			<sc-code-group>
                <sc-code code="CRN001" value="{{codes.term}}"></sc-code> <!-- 사용여부 -->
            </sc-code-group>
		</sc-request-group>
        <sc-ajax
           	id="getServiceUseListDetail"
           	url="getServiceUseListDetail.do"
           	body="{}"
           	on-response="complateServiceResult"
        ></sc-ajax>
		<cc-sub-title-bar
			id="subTitle"
			title-text="자세히"
		></cc-sub-title-bar>
		<div class="vspace-10"></div>
		<div style="color: red;">(*표시는 필수 입력 항목)</div>
		<table class="tb-form">
			<tr>
				<th rowspan=3>
					<sc-label text="변경 사유*"></sc-label>
				</th>
				<td colspan=3>
					<sc-combobox-field
						id="sst_trm_reason"
						name="구독기간(약정기간)"
					 	items="{{sstTrmReasonList.label}}"
						value="[1,2,3,0]"
					 	display-field="label" 
					 	value-field="data" 
					 	on-change=""
						placeholder="구독 기간 변경"
						required="true"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<td colspan=3>
					<sc-combobox-field
						id="sst_trm_reason"
						name="구독기간(약정기간)"
					 	items="{{codes.term}}"
						value="{{setParam.sst_trm}}"
					 	display-field="label" 
					 	value-field="data" 
					 	on-change="onChangeTerm"
						placeholder="디바이스 수량 변경"
						required="true"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<td colspan=3>
					<sc-text-field
						placeholder="(변경 사유 내용 상세 입력)"
						style="height: 100px;"
					></sc-text-field>
				</td>
			</tr>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th></th>
				<th>
					<sc-label text="번경 전"></sc-label>
				</th>
				<th>
					<sc-label text="변경 후"></sc-label>
				</th>
			</tr>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th>
					<sc-label text="구독기간(약정기간)*"></sc-label>
				</th>
				<td id="sst_trm__bf">
				</td>
				<td>
					<sc-combobox-field
						id="sst_trm__dm_required"
						name="구독기간(약정기간)"
					 	items="{{codes.term}}"
						value="{{setParam.sst_trm}}"
					 	display-field="label" 
					 	value-field="data" 
					 	on-change="onChangeTerm"
						placeholder="기간"
						required="true"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<th id="dvcTh">
					<sc-label text="디바이스 수량"></sc-label>
				</th>
			</tr>
			<template id="dvcTemplate" is="dom-repeat" items="{{deviceList}}">
				<tr>
       				<th>
						<sc-label
							text="{{item.dvc_th}}"
						></sc-label>
					</th>
					<td>
						{{item.qtt}} 대
					</td>
					<td>
						<div style="display: flex; gap: 10px; align-items: center;">
							<sc-text-field
								id="{{item.dvc_id}}{{item.dvc_required_id}}"
								type="number"
								on-input="onInputField"
								value="{{setParam.qtt}}"
								required="{{item.dvc_required}}"
							></sc-text-field>
							대
						</div>
					</td>
       			</tr>
	        </template>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th>
					<sc-label text="서비스 만료 예정일"></sc-label>
				</th>
				<td id="exp_end_dt__bf">
				</td>
				<td>
					<div style="display: flex; gap: 10px;">
						<sc-button text="조회"></sc-button>
						<div></div>
					</div>
				</td>
			</tr>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th>
					<sc-label text="예상 월 구독료"></sc-label>
				</th>
				<td id="exp_mon_fee__bf">
				</td>
				<td>
					<div style="display: flex; gap: 10px;">
						<sc-button text="조회"></sc-button>
						<div></div>
					</div>
				</td>
			</tr>
		</table>
		<div style="margin-top: 30px; margin-right: 50px; display: flex; justify-content: flex-end; gap: 20px;">
			<sc-button text="변경 신청" style="width: 100px; padding: 10px;"></sc-button>
		</div>
	</template>
	<script>
		Polymer({
			is: "ep-company-status-service-update",
			properties: {
				codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                            term: []
                        };
                    }
                },
                sstTrmReasonList: {
                	type: Array,
                	value: function() {
                		return [
                			{"label": "기간 변경"},
                			{"label": "연장"},
                			{"label": "중단"},
                			{"label": "해당없음"}
                			
                		];
                	}
                },
				deviceList: {
					type: Array,
					value: function(){
						return [];
					}
				},
				serviceData: {
					type: Object,
					value: function(){
						return {};
					}
				},
				setParam: {
					type: Object,
					value: function(){
						return {};
					}
				}
			},
			complateServiceResult(e, {response: {result_data}}){
				const me = this,
				  {
					  serviceUseDeviceListDetail,
					  serviceUseListDetail
				  } = result_data[0],
				  setDevice = l => {
						if(Number(l.mdt_yn)) {
							Object.assign(l, {
								dvc_th: l.product_name+"*", 
								dvc_required: "true",
								dvc_required_id: "__dm_required",
							}) 
						}else{
							Object.assign(l, {
								dvc_th: l.product_name, 
								dvc_required: "false",
								dvc_required_id: "",
							})
						}
						return l;
				  },
				  setEndDt = (dt, trm) => {
				  	const date = new Date(dt);
					
					const y = date.getFullYear() || "",
						  m = date.getMonth()+1 || "",
						  d = date.getDate() || "";
					
					return `${y}. ${m}. ${d}`;
				},
				commaNum = n => n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
					  
			    me.$.dvcTh.setAttribute('rowspan', serviceUseDeviceListDetail.length + 1);
			    me.$.sst_trm__bf.textContent = serviceUseListDetail[0].sst_trm + " 개월";
			    me.$.exp_end_dt__bf.textContent = setEndDt(serviceUseListDetail[0].exp_end_dt, serviceUseListDetail[0].sst_trm);
			    me.$.exp_mon_fee__bf.textContent = commaNum(serviceUseListDetail[0].exp_mon_fee);
			    
				me.set("deviceList", serviceUseDeviceListDetail.map(setDevice));
				me.set("serviceData", serviceUseListDetail[0]);
			},
			load: function(param) {
				const me = this;
				console.log(param);
				me.$.subTitle.titleText = `이동형 비전센서 > 이동형 비전센서 활용 작업자 안전 관리`;
				
				me.$.getServiceUseListDetail.body = {"svc_id": Number(param.svc_id)}
				UT.request(me.$.getServiceUseListDetail)
			}
		})
	</script>
</dom-module>