<dom-module id="ep-company-status-service-update">
	<style>
		:host {
			@apply(--vbox-layout);
		}
	</style>
	<template>
		<sc-request-group init>
			<sc-code-group>
                <sc-code code="CRN001" value="{{codes.term}}"></sc-code>
                <sc-code code="CRN004" value="{{codes.trmReason}}"></sc-code>
                <sc-code code="CRN005" value="{{codes.dvcReason}}"></sc-code>
            </sc-code-group>
		</sc-request-group>
        <sc-ajax
           	id="getServiceUseListDetail"
           	url="getServiceUseListDetail.do"
           	body="{}"
           	on-response="complateServiceResult"
        ></sc-ajax>
        <sc-ajax
			id="estimateMonthlyFee"
			url="estimateMonthlyFee.do"
		></sc-ajax>
		<sc-ajax
			id="serviceUseChange"
			url="serviceUseChange.do"
			body="{{applyParam}}"
		></sc-ajax>
		<cc-sub-title-bar title-text="서비스 변경 신청"></cc-sub-title-bar>
		<div id="svcPath" style="font-weight: 600; color: #2eadd9;">[{{selectedService.wpc_nm}} > {{selectedService.svc_ctl_nm}}]</div>
		<div class="vspace-10"></div>
		<div style="color: red;">(*표시는 필수 입력 항목)</div>
		<table class="tb-form" validation-group="apply">
			<tr>
				<th rowspan=3>
					<sc-label text="변경 사유*"></sc-label>
				</th>
				<td colspan=3>
					<sc-combobox-field
						id="trm_r__dm_required"
						name="구독 기간 변경"
					 	items="{{codes.trmReason}}"
						value="{{applyParam.trm_chg_cd}}"
					 	display-field="label" 
					 	value-field="data" 
						placeholder="구독 기간 변경"
						required="true"
						on-change="onChangeReason"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<td colspan=3>
					<sc-combobox-field
						id="dvc_r__dm_required"
						name="디바이스 수량 변경"
					 	items="{{codes.dvcReason}}"
						value="{{applyParam.dvc_chg_yn}}"
					 	display-field="label" 
					 	value-field="data" 
						placeholder="디바이스 수량 변경"
						required="true"
						on-change="onChangeReason"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<td colspan=3>
					<sc-textarea-field
						id="upd_r__dm_required"
						name="변경 사유 내용"
						placeholder="(변경 사유 내용 상세 입력)"
						on-input="onTextareaInput"
						required="true"
						style="height: 100px;"
					></sc-textarea-field>
				</td>
			</tr>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th></th>
				<th>
					<sc-label text="변경 전"></sc-label>
				</th>
				<th>
					<sc-label text="변경 후"></sc-label>
				</th>
			</tr>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th>
					<sc-label text="구독기간(약정기간)*"></sc-label>
				</th>
				<td id="sst_trm__bf">
					{{selectedService.sst_trm}}
				</td>
				<td>
					<sc-combobox-field
						id="sst_trm__af"
						name="구독기간(약정기간)"
					 	items="{{codes.term}}"
						value="{{serviceData.sst_trm__af}}"
					 	display-field="label" 
					 	value-field="data" 
					 	on-change="onChangeTerm"
						placeholder="기간"
						readonly="true"
						required="true"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<th id="dvcTh">
					<sc-label text="디바이스 수량"></sc-label>
				</th>
			</tr>
			<template id="dvcTemplate" is="dom-repeat" items="{{deviceList}}">
				<tr>
       				<th>
						<sc-label
							text="{{item.dvc_th}}"
						></sc-label>
					</th>
					<td>
						{{item.qtt__bf}} 대
					</td>
					<td>
						<div style="display: flex; gap: 10px; align-items: center;">
							<sc-text-field
								id="dvc_{{item.dvc_id}}{{item.dvc_required_id}}"
								name="{{item.product_name}}"
								type="number"
								on-input="onInputField"
								value="{{item.qtt__af}}"
								readonly="true"
								required="{{item.dvc_required}}"
							></sc-text-field>
							대
						</div>
					</td>
       			</tr>
	        </template>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th>
					<sc-label text="서비스 만료 예정일"></sc-label>
				</th>
				<td id="exp_end_dt__bf">
					{{selectedService.sst_end_dt}}
				</td>
				<td>
					<div style="display: flex; gap: 10px;">
						<sc-button 
							text="조회"
							on-click="onEndDateClick"
						></sc-button>
						<div id="expEndDt" style="display: none;">
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<th style="background: #ccc !important;"></th>
				<th>
					<sc-label text="예상 월 구독료"></sc-label>
				</th>
				<td id="exp_mon_fee__bf">
					{{selectedService.exp_mon_fee}}
				</td>
				<td>
					<div style="display: flex; gap: 10px;">
						<sc-button 
							text="조회"
							on-click="onEstimatedFeeClick"
						></sc-button>
						<div id="estimatedFee" style="display: none;">
						</div>
					</div>
				</td>
			</tr>
		</table>
		<div style="margin-top: 30px; margin-right: 50px; display: flex; justify-content: flex-end; gap: 20px;">
			<sc-button text="변경 신청" style="width: 100px; padding: 10px;" on-click="onApplyClick"></sc-button>
		</div>
	</template>
	<script>
		Polymer({
			is: "ep-company-status-service-update",
			properties: {
				codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                            term: [],
                            trmReason: [],
                            dvcReason: []
                        };
                    }
                },
                selectedService: {
					type: Object,
					value: function(){
						return {};
					}
				},
				applyParam: {
					type: Object,
					value: function(){
						return {};
					}
				}
			},
			load: function(param) {
				const me = this,
				{svc_id, stt_cd} = param;
				
				me.set("selectedService", param);
				
				me.$.getServiceUseListDetail.body = {svc_id, stt_cd}
				UT.request(me.$.getServiceUseListDetail)
			},
			complateServiceResult: function(e, {response: {result_data}}) {
				const me = this;
				
				const {
					serviceUseDeviceListDetail: deviceList,
					serviceUseListDetail: {[0]: serviceData},
					serviceUseListDetailPayList
				} = result_data[0];
				
				const setDevice = l => {
					Object.assign(l, {qtt__bf: JSON.parse(JSON.stringify(l)).qtt});
					if(Number(l.mdt_yn)) {
						Object.assign(l, {
							dvc_th: l.product_name+"*", 
							dvc_required: "true",
							dvc_required_id: "__dm_required",
						}) 
					}else{
						Object.assign(l, {
							dvc_th: l.product_name, 
							dvc_required: "false",
							dvc_required_id: "",
						})
					}
					return l;
		  		};
				
				me.$.dvcTh.setAttribute('rowspan', deviceList.length + 1);
				
				Object.assign(serviceData, {sst_trm__bf: JSON.parse(JSON.stringify(serviceData)).sst_trm});
				me.set("serviceData", serviceData);
				me.set("deviceList", deviceList.map(setDevice));
			},
			onChangeReason: function() {
				const me = this,
					  {id} = event.target,
					  {value} = event.detail;
				
				if(id.includes("trm")){
					me.$.expEndDt.style.display = "none";
					const {sst_trm__bf} = me.get("serviceData")
					if(value && value.includes("e")) {
						me.$.sst_trm__af.setAttribute("value", "");
						me.$.sst_trm__af.readonly = "false";
					}else if(value && value.includes("d")){
						me.$.sst_trm__af.setAttribute("value", sst_trm__bf);
						me.$.sst_trm__af.readonly = "true";
					}
				}else{
					me.$.estimatedFee.style.display = "none";
					const list = me.get("deviceList");
					list.forEach(d => {
						const id = `#dvc_${d.dvc_id}${d.mdt_yn == "1" ? d.dvc_required_id : ""}`;
						if(value == "1") {
							me.$$(id).readonly = "false";
							me.$$(id).setAttribute("value", "");
						}else{
							me.$$(id).readonly = "true";
							me.$$(id).setAttribute("value", d.qtt__bf);
						}
					});
					me.get("deviceList").map(d => Object.assign(d, {qtt__af: d.qtt__af ? d.qtt__af = Number(d.qtt__af) : d.qtt__af = 0}));
				}
			},
			onTextareaInput: function() {
				const me = this;
				      chg_rsn = event.target.value;
				Object.assign(me.get("applyParam"), {chg_rsn})
			},
			onChangeTerm: function() {
				const me = this,
					  date = new Date(me.get("serviceData").dsr_str_dt);
				
				const trm = Number(event.detail.value);
				
				date.setMonth(date.getMonth() + trm);
				Object.assign(me.get("serviceData"), {exp_end_dt__af: date});
				
				me.$.expEndDt.style.display = "none";
				me.$.estimatedFee.style.display = "none";
			},
			onInputField: function() {
				const me = this;
				me.$.estimatedFee.style.display = "none";
			},
			onEndDateClick: function(){
				const me = this,
				  	  {
						sst_trm__af, 
						exp_end_dt__af: d
					  } = me.get("serviceData");
			
				if(!sst_trm__af){
					SCAlert.show('error', `구독기간(약정기간) 입력란에 데이터를 입력해 주십시오.`);
					return;
				}
				
				const now = new Date()
				
				if(d < now) {
					SCAlert.show('error', `서비스 만료 예정일이 오늘 이전입니다.`);
					return;
				}
				
				me.$.expEndDt.style.display = "block";
				me.$.expEndDt.textContent = `${d.getFullYear()}. ${d.getMonth() + 1}, ${d.getDate()}`;
			},
			onEstimatedFeeClick: function() {
				const me = this,
					  serviceData = JSON.parse(JSON.stringify(me.get("serviceData"))),
					  {
						sst_trm__af, 
						exp_end_dt__af: d
				  	  } = me.get("serviceData");
				  	  
				if(!sst_trm__af){
					SCAlert.show('error', `구독기간(약정기간) 입력란에 데이터를 입력해 주십시오.`);
					return;
				}
				
				Object.assign(serviceData, {sst_trm: Number(sst_trm__af)});
				
				const deviceList = JSON.parse(JSON.stringify(me.get("deviceList")));
				deviceList.map(d => Object.assign(d, {qtt: d.qtt__af ? d.qtt__af = Number(d.qtt__af) : d.qtt__af = 0}));
				
				const requiredList = deviceList.filter(d => d.mdt_yn == "1");
				const checkList = requiredList.filter(d => !d.qtt__af);
				
				if(checkList.length) {
					SCAlert.show('error', `${checkList[0].product_name} 수량을 입력해 주십시오.`);
					return;
				}
				
				const param = {};
				Object.assign(param, serviceData)
				Object.assign(param, {"dvc_list": deviceList})

				me.$.estimateMonthlyFee.body = param;
				UT.request(me.$.estimateMonthlyFee, function(e, {response: {result_data: {estimatedMonthlyFee: fee}}}){
					me.get("serviceData").exp_mon_fee__af = fee;
					
					const commaNum = n => n && n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
					me.$.estimatedFee.style.display = "block";
					me.$.estimatedFee.textContent = commaNum(fee) + " (VAT 별도)";
				});
			},
			onApplyClick: function() {
				const me = this;
				const requiredList = Object.values(me.$).filter(o => o.id.includes("__dm_required"));
				me.get("deviceList").forEach(d => {
					if(d.mdt_yn == "1"){
						requiredList.push(me.$$(`#dvc_${d.dvc_id}${d.dvc_required_id}`))
					}
				})
				
				if(!me.validate("apply")){
					const i = requiredList.findIndex(m => !m.value)
					SCAlert.show('error', `${requiredList[i].name} 입력란에 데이터를 입력해 주십시오.`);
					return;
				}
				
				if(me.$.expEndDt.style.display == "none"){
					SCAlert.show('error', `"서비스 만료 예정일 조회 버튼"을 클릭해 주십시오.`);
					return;
				}
				
				if(me.$.estimatedFee.style.display == "none"){
					SCAlert.show('error', `"예상 월 구독료 조회 버튼"을 클릭해 주십시오.`);
					return;
				}
				
				const serviceData = JSON.parse(JSON.stringify(me.get("serviceData")));
				const deviceList = JSON.parse(JSON.stringify(me.get("deviceList")));
				
				Object.keys(serviceData).filter(k => {
					if(k.includes("__af")){
						return serviceData[k.split("__af")[0]] = isNaN(serviceData[k]) ? serviceData[k] : Number(serviceData[k]);
					}
				});
				
				serviceData.dsr_str_dt = new Date(serviceData.dsr_str_dt);
				
				deviceList.forEach(d => {
					Object.keys(d).filter(k => {
						if(k.includes("__af")){
							return d[k.split("__af")[0]] = isNaN(d[k]) ? d[k] : Number(d[k]);
						}
					})
				});
				
				const {svc_ctl_id, svc_id, stt_cd} = me.get("selectedService");
				
				Object.assign(me.get("applyParam"), {svc_ctl_id, svc_id, stt_cd, "status": "5"});
				Object.assign(me.get("applyParam"), serviceData);
				Object.assign(me.get("applyParam"), {dvc_list: deviceList});

				UT.request(me.$.serviceUseChange, function(e, {response}){
					if(response.result_status == "E"){
						console.log(response.result_message)
					}else{
						SCAlert.show(`${e.target.textContent}`, `${response.result_message}`);
					}
					
					me.fire("refresh");
				});
			}
		})
	</script>
</dom-module>