<dom-module id="ep-company-status-service-detail">
	<style>
		:host {
			@apply(--vbox-layout);
		}
	</style>
	<template>
		<sc-ajax
           	id="getServiceUseListDetail"
           	url="getServiceUseListDetail.do"
           	last-response="{{serviceResult}}"
           	on-response="complateServiceResult"
        ></sc-ajax>
        
        <div style="display: flex; align-items: center; gap: 10px;">
        	<cc-sub-title-bar id="subTitle" title-text="서비스 이용 상세 내역"></cc-sub-title-bar>
        	<div id="svcPath" style="font-size: 15px; font-weight: 600; color: #2eadd9;">[{{selectedService.svc_ctl_nm}}]</div>
        </div>

		<div class="vspace-10"></div>
		<table class="tb-form">
			<tr>
				<th>사업장</th>
				<td>
					<div id="wpc_nm">
					</div>
				</td>
				<th>서비스 신청일</th>
				<td>
					<div id="req_dt"></div>
				</td>
			</tr>
			<tr>
				<th>서비스 개시 요청일</th>
				<td>
					<div id="dsr_str_dt"></div>
				</td>
				<th>서비스 만료 예정일</th>
				<td>
					<div id="exp_end_dt"></div>
				</td>
			</tr>
			<tr>
				<th>구독기간(약정기간)</th>
				<td colspan=3>
					<div id="sst_trm"></div>
				</td>
			</tr>
			<tr>
				<th id="dvcTh">
					<sc-label text="디바이스 수량"></sc-label>
				</th>
			</tr>
			<template id="dvcTemplate" is="dom-repeat" items="[[deviceList]]">
				<tr>
       				<th>
						<sc-label
							text="[[item.dvc_th]]"
						></sc-label>
					</th>
					<td colspan=2>
						[[item.qtt]] 대
					</td>
       			</tr>
	        </template>
			<tr>
				<th>월 구독료</th>
				<td colspan=3>
					<div style="display: flex;">
						<div id="exp_mon_fee"></div>
						원 (VAT별도)
					</div>
				</td>
			</tr>
		</table>
		
		<sc-grid
			id="gridPanel"
			data-provider="{{payList}}"
			use-selection="false"
			use-state="false"
			editable="true"
		>
			<cc-grid-toolbar title-text="구독료 납부 현황"></cc-grid-toolbar>
			<sc-grid-columns>
				<sc-data-column data-field="b" header-text="납부 예정일" width="180" text-align="center"></sc-data-column>
				<sc-data-column data-field="c" header-text="납부 상태" width="180" text-align="center"></sc-data-column>
				<sc-data-column data-field="d" header-text="납부 완료일" width="180" text-align="center"></sc-data-column>
				<sc-data-column data-field="e" header-text="확인자" width="180" text-align="center"></sc-data-column>
			</sc-grid-columns>
		</sc-grid>
	</template>

<script>
	Polymer({
		is: "ep-company-status-service-detail",
		properties: {
			selectedService: {
				type: Object,
				value: function() {
					return {};
				}
			},
			serviceResult: {
				type: Object,
				value: function() {
					return {};
				}
			},
			deviceList: {
				type: Array,
				value: function() {
					return [];
				}
			},
			serviceData: {
				type: Object,
				value: function() {
					return {};
				}
			},
			payList: {
				type: Array,
				value: function() {
					return [];
				}
			}
		},
		load: function(param) {
			const {
				svc_id,
				svc_ctl_id,
				svc_ctl_nm,
				stt_cd
			} = param,
			me = this;
			
			me.set("selectedService", param);
			me.$.getServiceUseListDetail.body = {svc_id, stt_cd}
			UT.request(me.$.getServiceUseListDetail);
		},
		complateServiceResult(e, {response: {result_data}}){
			const me = this,
			  {
				  serviceUseDeviceListDetail,
				  serviceUseListDetail,
				  serviceUseListDetailPayList
			  } = result_data[0],
			  setDevice = l => {
					if(Number(l.mdt_yn)) {
						Object.assign(l, {
							dvc_th: l.product_name+"*", 
							dvc_required: "true",
							dvc_required_id: "__dm_required",
						}) 
					}else{
						Object.assign(l, {
							dvc_th: l.product_name, 
							dvc_required: "false",
							dvc_required_id: "",
						})
					}
					return l;
			  },
			  setDate = (dt) => {
			  	const date = new Date(dt);
				
				const y = date.getFullYear() || "",
					  m = date.getMonth()+1 || "",
					  d = date.getDate() || "";
				
				return `${y}-${m}-${d}`;
			},
			commaNum = n => n && n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
				  
		    me.$.dvcTh.setAttribute('rowspan', serviceUseDeviceListDetail.length + 1);
		  	me.$.wpc_nm.textContent = me.get("selectedService").wpc_nm;
			me.$.req_dt.textContent = setDate(serviceUseListDetail[0].req_dt);
			me.$.dsr_str_dt.textContent = setDate(serviceUseListDetail[0].dsr_str_dt);
			me.$.exp_end_dt.textContent = setDate(serviceUseListDetail[0].exp_end_dt);
	     	me.$.sst_trm.textContent = serviceUseListDetail[0].sst_trm + " 개월";
		    me.$.exp_mon_fee.textContent = commaNum(serviceUseListDetail[0].exp_mon_fee);
		    
			me.set("deviceList", serviceUseDeviceListDetail.map(setDevice));
			me.set("serviceData", serviceUseListDetail[0]);
			me.set("payList", serviceUseListDetailPayList);
		}
	})
</script>
</dom-module>