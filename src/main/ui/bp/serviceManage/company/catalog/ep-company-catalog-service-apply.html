<dom-module id="ep-company-catalog-service-apply">
	<style>
		:host {
			@apply(--vbox-layout);
		}
	</style>
	<template>
		<sc-request-group init>
			<sc-code-group>
                <sc-code code="CRN001" value="{{codes.term}}" ></sc-code> <!-- 사용여부 -->
            </sc-code-group>
            <sc-ajax
            	id="getWPCList"
            	url="getWPCList.do"
            	body="{}"
            	last-response="{{wpcResult}}"
            ></sc-ajax>
		</sc-request-group>
		
		<sc-ajax
			id="getDevicesByCatalogId"
			url="getDevicesByCatalogId.do"
			body="{{selectedService}}"
			last-response="{{deviceResult}}"
			on-response="complateDeviceResult"
		></sc-ajax>
		<sc-ajax
			id="estimateMonthlyFee"
			url="estimateMonthlyFee.do"
			body="{{setParam}}"
			on-response="complateMonthlyFee"
		></sc-ajax>
		<sc-ajax
			id="applyService"
			url="applyService.do"
			body="{{applyParam}}"
		></sc-ajax>
		
		<cc-sub-title-bar
			id="subTitle"
			title-text="자세히"
		></cc-sub-title-bar>
		<div class="vspace-10"></div>
		<div style="color: red;">(*표시는 필수 입력 항목)</div>
		<table class="tb-form">
			<tr>
				<th>
					<sc-label class="wpc_list dm_required" text="사업장*"></sc-label>
				</th>
				<td colspan=2>
					<sc-combobox-field
						id="wpc_list"
						class="dm_required"
					 	items="{{wpcResult.result_data}}"
					 	value="{{setParam.wpc_cd}}"
					 	display-field="name" 
					 	value-field="id" 
						placeholder="사업장"
					    required="true"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<th>
					<sc-label class="dsr_str_dt dm_required" text="서비스 개시 요청일*"></sc-label>
				</th>
				<td colspan=2>
					<div style="display: flex; gap: 10px; align-items: center;">
						<sc-date-field 
							id="dsr_str_dt"
							class="dm_required"
							value={{setParam.dsr_str_dt}} 
							style="width: 150px;"
							placeholder="요청일"
							required="true"
						></sc-date-field>
   						~
					</div>
				</td>
			</tr>
			<tr id="dvcTr">
				<th>
					<sc-label text="디바이스 수량"></sc-label>
				</th>
			</tr>
			<tr>
				<th>
					<sc-label class="sst_trm dm_required" text="구독기간(약정기간)*"></sc-label>
				</th>
				<td colspan=2>
					<sc-combobox-field
						id="sst_trm"
						class="dm_required"
					 	items="{{codes.term}}"
						value="{{setParam.sst_trm}}"
					 	display-field="label" 
					 	value-field="data" 
					 	on-change="onChangeTerm"
						placeholder="기간"
						required="true"
					></sc-combobox-field>
				</td>
			</tr>
			<tr>
				<th>
					<sc-label text="서비스 만료 예정일"></sc-label>
				</th>
				<td colspan=2>
					<div style="display: flex; align-items: center; gap: 10px;">
						<sc-button 
							text="조회"
							on-click="onEndDateClick"
						></sc-button>
						<div id="term">
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<th>
					<sc-label text="예상 월 구독료"></sc-label>
				</th>
				<td colspan=2>
					<div style="display: flex; align-items: center; gap: 10px;">
						<sc-button 
							text="조회"
							on-click="onEstimatedFeeClick"
						></sc-button>
						<div id="estimatedFee">
							{{estimatedFee.result_data}}
						</div>
					</div>
				</td>
			</tr>
		</table>
		<div style="margin-top: 30px; display: flex; justify-content: center; gap: 20px;">
			<sc-button id="dm_cart" text="장바구니 저장" style="width: 100px; padding: 10px;" on-click="onApplyClick"></sc-button>
			<sc-button id="dm_apply" text="신청" style="width: 100px; padding: 10px;" on-click="onApplyClick"></sc-button>
		</div>
	</template>
	<script>
		Polymer({
			is: "ep-company-catalog-service-apply",
			properties: {
				codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                            term: []
                        };
                    }
                },
                selectedService: {
					type: Object,
    				value: function() {
    					return {};
    				}
				},
                wpcResult: {
					type: Object,
					value: function() {
						return {};
					}
				},
				deviceResult: {
					type: Object,
					value: function() {
						return {};
					}
				},
				setParam: {
					type: Object,
					value: function() {
						return {};
					}
				},
				applyParam: {
					type: Object,
    				value: function() {
    					return {};
    				}
				},
				clickFlag: {
					type: Object,
					value: function() {
						return {
							term: 0,
							fee: 0,
						};
					}
				}
			},
			initialized: function() {
                const me = this;
                const term = me.get("codes.term") || [];
            },
			load: function(param) {
				const {
					svc_ctl_id,
					svc_ctl_nm
				} = param,
				me = this;
				
				me.$.subTitle.titleText = `서비스 신청하기 (${svc_ctl_nm})`;
				me.set("selectedService", param);
				
				UT.request(this.$.getDevicesByCatalogId);
			},
			complateDeviceResult: function(e, {response: {result_data: list}}){
				const me = this;
				list.forEach(l => {
					const {dvc_id, dvc_nm, mdt_yn} = l;
					const tr = document.createElement('tr');
					tr.innerHTML = `
						<th>
							<sc-label class="dvc_label ${Number(mdt_yn) ? 'dm_required' : ''}" text="${dvc_nm}${Number(mdt_yn) ? '*' : ''}"></sc-label>
						</th>
						<td>
							<div style="display: flex; gap: 10px; align-items: center;">
								<sc-text-field 
									type="number"
									id="dvc_field${dvc_id}" 
									class="dvc_field ${Number(mdt_yn) ? 'dm_required' : ''}" 
									required="${Number(mdt_yn) ? 'true' : 'false'}"
								></sc-text-field>
								대
							</div>
						</td>
					`;
					me.$.dvcTr.after(tr);
				})
				me.$.dvcTr.children[0].setAttribute('rowspan', list.length + 1);
				for(f of document.querySelectorAll(".dvc_field")) f.oninput = me.onInputField;
			},
			complateMonthlyFee: function(e, {response: {result_data: {estimatedMonthlyFee: r}}}){
				const me = this,
				  	  commaNum = n => n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","),
				  	  fee = commaNum(r);
				  	  
				Object.assign(me.get("setParam"), {"exp_mon_fee": r});
				if(me.get("clickFlag").fee){
					me.$.estimatedFee.textContent = `${fee} (VAT별도)`;
				}
			},
			onInputField: function(e){
				const me = document.querySelector("ep-company-catalog-service-apply"),
					  param = me.get("setParam"),
					  term = param.sst_trm,
					  field = e.path.find(t => t.id.includes("dvc_field"));
				
				me.get("deviceResult").result_data.find(d => d.dvc_id == field.id.replace("dvc_field", "")).qtt = Number(e.target.value);
				
				const dvcList = me.get("deviceResult").result_data.filter(d => d.qtt && d.qtt != 0 && d)
				dvcList.length && Object.assign(me.get("setParam"), {"dvc_list": dvcList});
				
				me.$.estimatedFee.textContent = "";	
			},
			onChangeTerm: function() {
				const me = this,
					  param = me.get("setParam"),
					  date = new Date(param.dsr_str_dt);
				
				param.sst_trm = Number(param.sst_trm);
				date.setMonth(date.getMonth() + param.sst_trm);
				
				const y = date.getFullYear() || "",
					  m = date.getMonth()+1 || "",
					  d = date.getDate() || "";
				
				Object.assign(me.get("setParam"), {"exp_end_dt": date})
				
				if(me.get("clickFlag").term){
					me.$.term.textContent = `${y}. ${m}. ${d}`;
				}
				
				me.$.estimatedFee.textContent = "";
			},
			requiredCheck: function(requiredElements, callback = null) {
				const labelElements = Array.prototype.slice.call(requiredElements.labels),
					  fieldElements = Array.prototype.slice.call(requiredElements.fields),
					  labelTextList = labelElements.map(label => label.textContent.trim().replace("*", ""));
					  fieldResult = fieldElements.map(element => element.value && element.value != 0 ? 1 : 0);
				
				if(!fieldResult.includes(0)){
					callback();
					return 1;
				}else{
					const i = fieldResult.indexOf(0);
			  	  	SCAlert.show('error', `${labelTextList[i]} 입력란에 데이터를 입력해 주십시오.`);
			  	  	return 0;
				}
			},
			onEndDateClick: function() {
				const me = this;
				return me.requiredCheck({
					labels: document.querySelectorAll(".dsr_str_dt.dm_required, .sst_trm.dm_required"),
					fields: document.querySelectorAll("#dsr_str_dt, #sst_trm")
		  	  	}, () => {
		  	  		me.get("clickFlag").term = 1;
		  	  		me.onChangeTerm()
		  	  	});
			},
			onEstimatedFeeClick: function() {
				const me = this,
					  param = me.get("setParam"),
					  commaNum = n => n.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","),
					  term = Number(param.sst_trm),
					  getQtt = id => Number(document.getElementById(id).value),
					  setList = l => getQtt(`dvc_field${l.dvc_id}`) && Object.assign(l, {"qtt": getQtt(`dvc_field${l.dvc_id}`)}),
					  dvcList = me.get("deviceResult").result_data.filter(setList);
					  
				return me.requiredCheck({
					labels: document.querySelectorAll(".dvc_label.dm_required, .sst_trm.dm_required"),
					fields: document.querySelectorAll(".dvc_field.dm_required, #sst_trm")
				}, () => {
					me.get("clickFlag").fee = 1;
					UT.request(me.$.estimateMonthlyFee)
				});
			},
			onApplyClick: function(e){
				const me = this,
					  svc_ctl_id = "SVC"+me.get("selectedService")["svc_ctl_id"].substr(-5);
				
				const checkWpc = me.requiredCheck({
					labels: document.querySelectorAll(".wpc_list.dm_required"),
				  	fields: document.querySelectorAll("#wpc_list")
				}, () => {});
				
				if(!checkWpc) return;
				if(!me.onEndDateClick()) return;
				if(!me.onEstimatedFeeClick()) return;

				Object.assign(me.get("applyParam"), {svc_ctl_id});
				Object.assign(me.get("applyParam"), me.get("setParam"));

				if(e.target.id == "dm_cart"){
					Object.assign(me.get("applyParam"), {"bsk_itm_yn": "1"});
				}else{
					Object.assign(me.get("applyParam"), {"bsk_itm_yn": "0"});
				}
				
				UT.request(me.$.applyService, function(event, {response}){
					if(response.result_status == "E"){
						SCAlert.show(`${e.target.textContent}`, response.result_message);
					}else{
						SCAlert.show(`${e.target.textContent}`, `${e.target.textContent} 완료되었습니다.`);
					}
					me.$.dm_cart.disabled = "true";
					me.$.dm_apply.disabled = "true";
				});
			}
		})
	</script>
</dom-module>