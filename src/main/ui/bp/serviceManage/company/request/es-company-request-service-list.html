<sc-link rel="import" href="ep-company-request-service-new.html"></sc-link>
<sc-link rel="import" href="ep-company-request-service-request.html"></sc-link>

<dom-module id="es-company-request-service-list">
	<template>
		<sc-request-group init>
			<sc-code-group>
				<sc-code code="CRN002" value="{{codes.status_code}}" ></sc-code>
				<sc-code code="CRN003" value="{{codes.req_tp_cd}}" ></sc-code>
			</sc-code-group>
			<sc-ajax
            	id="getWPCList"
            	url="getWPCList.do"
            	body="{}"
            	last-response="{{wpcResult}}"
            ></sc-ajax>
            <sc-ajax 
				id="getWpcServiceList" 
				url="getWpcServiceList.do"
				body="{}"
				last-response="{{wpcSerivceResult}}"
			></sc-ajax>
			<sc-ajax 
				id="searchQNA" 
				url="searchQNA.do"
				body="{{searchParam}}"
				last-response="{{requestServiceResult}}"
			></sc-ajax>
		</sc-request-group>
		
		<sc-button 
			text="신규 요청" 
			style=" width: 200px; 
					height: 35px; 
					display: flex; 
					justify-content: center; 
					align-items: center;"
			on-click="onClickNewRequest"
			></sc-button>
		<div class="vspace-10"></div>
		<div class="vspace-10"></div>
		<cc-search-container on-search="onSearchRequest">
			<table>
				<colgroup>
					<col style="width: 40px;">
					<col>
					
					<col style="width: 60px;">
					<col>
					
					<col style="width: 90px;">
					<col>
					
					<col style="width: 120px;">
					<col>
					
					<col style="width: 90px;">
					<col>
				</colgroup>
				<tr style="height: 50px;">
					<th>
						<sc-label text="상태"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
                			items="{{codes.status_code}}"
						 	value="{{searchParam.status_code}}"
						 	display-field="label" 
						 	value-field="data" 
                			placeholder="상태"
                		></sc-combobox-field>
                	</td>
					<th>
						<sc-label text="사업장"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
                			items="{{wpcResult.result_data}}"
						 	value="{{searchParam.wpc_cd}}"
						 	display-field="wpc_nm" 
						 	value-field="wpc_cd" 
							placeholder="사업장"
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="이용 서비스"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
                			items="{{wpcSerivceResult.result_data}}"
						 	value="{{searchParam.svc_ctl_id}}"
						 	display-field="svc_ctl_nm" 
						 	value-field="svc_ctl_id" 
                			placeholder="이용 서비스"
                		></sc-combobox-field>
                	</td>
                	<th>
						<sc-label text="서비스 요청 유형"></sc-label>
					</th>
                	<td>
                		<sc-combobox-field 
                			items="{{codes.req_tp_cd}}"
						 	value="{{searchParam.req_tp_cd}}"
						 	display-field="label" 
						 	value-field="data" 
                			placeholder="서비스 요청 유형"
                		></sc-combobox-field>
                	</td>
                	
                	<th rowspan=2>
						<sc-label text="키워드 검색"></sc-label>
					</th>
					<td rowspan=2>
						<sc-text-field value="{{searchParam.search}}"></sc-text-field>
					</td>
				</tr>
				<tr></tr>
			</table>
		</cc-search-container>
		<!-- <sc-grid 
			id="gridPanel" 
			data-provider="{{requestServiceResult.result_data}}" 
			on-item-click="onItemClick"
			use-selection="false"
			use-state="false"
		> -->
		<sc-grid 
			id="gridPanel" 
			data-provider="[[_computedRequestService(requestServiceResult.result_data)]]" 
			on-item-click="onItemClick"
			use-selection="false"
			use-state="false"
		>
			<cc-grid-toolbar></cc-grid-toolbar>
			<sc-grid-columns>
				<sc-data-column 
					data-field="status_nm" 
					header-text="상태" 
					width="200" 
					text-align="center"
				></sc-data-column>
				<sc-data-column 
					data-field="wpc_nm" 
					header-text="사업장" 
					width="200" 
					text-align="center"
				></sc-data-column>
				<sc-data-column 
					data-field="svc_ctl_nm" 
					header-text="이용 서비스" 
					width="500" 
					text-align="center"
				></sc-data-column>
				<sc-data-column 
					data-field="req_tp_cd" 
					header-text="서비스 요청 유형" 
					width="200" 
					text-align="center"
				></sc-data-column>
				<sc-data-column 
					data-field="req_dt" 
					header-text="요청 일시" 
					width="300" 
					text-align="center"
				></sc-data-column>
			</sc-grid-columns>
		</sc-grid>
    </template>
    <script>
    	Polymer({
    		is: "es-company-request-service-list",
    		properties: {
    			codes: {
                    type: Object,
                    reset: false,
                    value: function() {
                        return {
                            status_code: [],
                            req_tp_cd: []
                        };
                    }
                },
    			searchParam: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			wpcResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			wpcList: {
    				type: Array,
    				value: function() {
    					return [];
    				}
    			},
    			wpcSerivceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			},
    			requestServiceResult: {
    				type: Object,
    				value: function() {
    					return {};
    				}
    			}
    		},
    		_computedRequestService: function(serviceList) {
    			const me = this;
    			const setReqDt = dt => {
					const date = new Date(dt);
					const a = b => b > 10 ? b : '0'+b;
					
					const y = date.getFullYear() || "",
						  m = date.getMonth()+1 || "",
						  d = date.getDate() || "";
					
                	return `${y}.${a(m)}.${a(d)}`;
                }
    			if(serviceList){
    				return serviceList.map(s => {
    					s.req_tp_cd = me.get("codes").req_tp_cd.find(c => c.data == s.req_tp_cd).label;
    					s.req_dt = setReqDt(s.req_dt);
    					return s;
    				});
    			}
    		},
    		initialized: function() {
				const me = this;
				
                const result_data = me.get("wpcResult").result_data.map(wpc => wpc = {"wpc_cd": wpc.id, "wpc_nm": wpc.name});
                me.set("wpcResult", {result_data});
            },
            onSearchRequest: function() {
            	const me = this;
            	UT.request(me.$.searchQNA)
            },
            onClickNewRequest: function() {
            	const me = this;
            	const newRequestPop = UT.popup(
    					"ep-company-request-service-new", 
    					me,
    					800,
    					345,
    					{
    						"refresh": function(popup, e) {
    		                   	UT.request(me.$.searchQNA);
    		                   	popup.close();
                        	}
    					},
    					{ 
    						maximizable: true, 
    						titleText: "1:1 서비스 요청"
    					}
    			);
    			newRequestPop.show();
    			newRequestPop.getWindowContent().load()
            },
    		onItemClick: function() {
    			const me = this,
	                  {data: d} = event.detail,
             		  {columnName: cn} = event.detail.item;
             		  
   				const requestPop = UT.popup(
   					"ep-company-request-service-request", 
   					me,
   					800,
   					435,
   					{
   						"refresh": function(popup, e) {
  		                   	UT.request(me.$.searchQNA);
  		                   	popup.close();
                      	}
   					},
   					{ 
   						maximizable: true, 
   						titleText: "1:1 서비스 요청"
   					}
   				);
   				requestPop.show();
   				requestPop.getWindowContent().load(d)
    		}
    	})
    </script>
</dom-module>