var __certlistui=function(a){var v=function(d){function s(a){if(!a)return alert("UI load error."),!1;var c=document.createElement("div");document.body.insertBefore(c,document.body.firstChild);c.innerHTML=a;return!0}function e(){h&&h.restoreOnMouseEvent();d.onCancel()}function f(b,c){if(!b||!c)return!1;if(!a.certsList||0>h.selectedIndex())return a.uiUtil().msgBox(c.IDS_MSGBOX_COMMON_ERROR_NO_SELECTED_CERT),!1;var d=a.loadUI("certview")({type:null,args:{type:"Base64",idx:parseInt(h.selectedIndex()),cert:a.certsList.list[parseInt(h.selectedIndex())-1].cert},onConfirm:function(){d.dispose();b.focus()},onCancel:function(){d.dispose();b.focus()}});d.show();a.uiUtil().loadingBox(!1,"us-div-cert-list-load");return!0}function m(b,c){if(!b||!c)return!1;w=a.loadUI("gridlist");h=w({type:"certslist",tblid:"us-tbl-cert-list",tbltitleid:"us-tbl-cert-list-th",titlelistid:"us-grid2-head-div",titlerowid:"us-cert-list-title-row",titleelementid:"us-cert-list-title-element",titledividerid:"us-cert-list-title-divider",titlelistcn:"us-layout-grid-head-div",titlerowcn:"us-layout-grid-head-row",titleelementcn:"us-layout-grid-row-title-element",titledividercn:"us-layout-grid-row-title-divider",tblbodyid:"us-tbl-cert-list-td",datalistid:"us-grid2-body-div",datarowid:"us-cert-list-body-row",dataelementid:"us-cert-list-data-element",datalistcn:"us-layout-grid-body-div",datarowcn:"us-layout-grid-body-row",dataelementcn:"us-layout-grid-row-data-element",dataselectcn:"us-layout-grid-row-data-selected-element"});var g=!0;"opera"==a.browserName&&(g=!1);h.drawList(b,b.length,null,0,x,g);r(y,z,c,"",function(b){if(0!=b)a.uiUtil().errMsgBox(c.IDS_MSGBOX_COMMON_ERROR_GET_CERT,b);else{if(a.certsList){b=null;b=a.certsList;var n=b.list.length,g=[],f=d.args.dn,k=null;null!=a.ESVS.Policy&&(-1!=a.ESVS.Policy.indexOf("|")?k=a.ESVS.Policy.split("|"):(k=[],k[0]=a.ESVS.Policy));var p=null;null!=a.ESVS.Organization&&(-1!=a.ESVS.Organization.indexOf("|")?p=a.ESVS.Organization.split("|"):(p=[],p[0]=a.ESVS.Organization));for(var e=0;e<n;e++){a.usWebToolkit.x509Certificate.parser(b.list[e].cert,"Base64");var m=a.usWebToolkit.x509Certificate.getCertificatePoliciesOid(),q=a.usWebToolkit.x509Certificate.getSubjectName(),D=a.usWebToolkit.x509Certificate.getNotAfter(),A=a.usWebToolkit.x509Certificate.getNotAfter(),E=b.list[e].index,u=a.certUtil().getIssuerName(m);"undefined"==u&&(u=a.certUtil().getO(q));if(null==f||"DIGITAL_SIGNATURE_P1"!=d.type&&"DIGITAL_SIGNATURE_P7"!=d.type&&"DIGITAL_SIGNATURE_P7_EXT"!=d.type||q.toLowerCase()==f.toLowerCase()){if(null!=a.ESVS.Policy){for(var l=0;l<k.length&&k[l]!=m;l++);if(k.length<=l)continue}if(null!=a.ESVS.Organization&&("CERT_RENEWAL"==d.type||"CERT_REVOCATION"==d.type||"CERT_SOE"==d.type||"CERT_RENEWAL_SIGN"==d.type)){for(l=0;l<p.length&&p[l].toLowerCase()!=a.certUtil().getO(q).toLowerCase();l++);if(p.length<=l)continue}if(a.ESVS.ShowExpiredCerts||"DIGITAL_SIGNATURE_P1"!=d.type&&"DIGITAL_SIGNATURE_P7"!=d.type&&"DIGITAL_SIGNATURE_P7_EXT"!=d.type||2!==a.certUtil().getExpirationStateValue(A))l=[""],l[1]=a.certUtil().getCertType(m),l[2]=a.certUtil().getCN(q),l[3]=u,l[4]=a.certUtil().getLocalDate(D),l[5]=E,l[6]=a.certUtil().getExpirationStateValue(A),g.push(l)}}b={list:g}}else b=null;b?h.redrawList(b.list,b.list.length):h.redrawList(null,0)}});return!0}function r(b,c,g,e,n){if(a.CONST.__USFB_M_DISK.device>b||0>c||!g)return-1;var f=0,h=0;z=c;a.certsList&&(a.certsList=null);if(a.CONST.__PF_M_LS.device===b&&2&a.ESVS.Mode){a.PFSH||n(-1);try{a.PFSH.SelectStorage(1)}catch(m){k.log("***** Plugin Free SelectStorage error *****"),k.log("e.code : ",m.code,"e.message : ",m.message,"e.detail : ",m.detail)}try{a.PFSH.LoadAllCerts(document.domain)}catch(p){301E5===p.code?(a.PFSH.InstallCACerts(document.domain),a.PFSH.LoadAllCerts(document.domain)):(k.log("***** Plugin Free LoadAllCerts error *****"),k.log("e.code : ",p.code,"e.message : ",p.message,"e.detail : ",p.detail))}c=null;try{c=a.PFSH.GetUserCerts(document.domain),a.PFUC=c}catch(r){k.log("***** Plugin Free GetUserCerts error *****"),k.log("e.code : ",r.code,"e.message : ",r.message,"e.detail : ",r.detail)}c&&(f=c.length-1);k.log("***** Plugin Free *****");k.log("user certificate counts : ",f);if(0<f){g=[];for(e=0;e<f;e++){var t=e+1,q={};q.index=t;q.cert=c[t].signcert;g[e]=q}a.certsList={list:g}}else a.certsList=null,h=0;n(h)}else b==a.CONST.__PF_M_SS.device&&a.CCPFSH()?a.CCPFSH().GetCCStorageHandler(a.ESVS.EncAlgo,a.ESVS.HashAlgo,a.ESVS.PKI,function(b,c){0==b&&a.CCPFSH().GetCertificateList(function(b,c){if(0==b){var d=0;(a.PFUC=c)&&(d=c.length-1);k.log("***** Plugin Free *****");k.log("user certificate counts : ",d);if(0<d){for(var e=[],f=0;f<d;f++){var h=f+1,g={};g.index=h;g.cert=c[h].signcert;e[f]=g}a.certsList={list:e}}}n(b)})}):!a.uiUtil().isItPFDevice(b)&&4&a.ESVS.Mode?a.nimservice()?b==a.CONST.__USFB_M_SECUREDISK.device&&d.type&&"BACKUPED_CERT"==d.type?a.nimservice().GetBackupedCertList(c,function(b,c,d){var f=c=0;d&&(c=d.length);if(0==b&&0<c){for(var e=[],g=0;g<c;g++){var f=g+1,h={};h.index=f;h.cert=d[g];e[g]=h}a.certsList={list:e}}else a.certsList=null,a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");n(b)}):a.nimservice().GetAllUserCertListNum(b,c,e,function(c,d,e){f=e;if(0==c)0<f?a.nimservice().GetAllUserCert(e,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");n(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),n(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=v.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,n(c),!1;-1!==f&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());n(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}}):(a.uiUtil().msgBox(g.IDS_MSGBOX_NIM_ERROR_UNLOAD),n(-1)):n(h)}var t=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/layout/certlistui.html?version="+a.ver,!1);b.send(null);return b.responseText},B=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/"+a.ESVS.Language+"/certlist_ui_"+a.ESVS.Language+".js?version="+a.ver,!1);b.send(null);return b.responseText},v=eval(eval(B)()),w=null,h=null,C=a.ESVS.TabIndex,x=0,y=d.args&&d.args.device?d.args.device:2==a.ESVS.Mode?a.CONST.__PF_M_LS.device:a.CONST.__USFB_M_HDD.device,z=y==a.CONST.__USFB_M_SECUREDISK.device?1:0,k=window.console||{log:function(){}};return function(){var b=eval(t),c=eval(eval(B)());s(b());document.getElementById("us-div-cert-list-lbl-notice").appendChild(document.createTextNode(c.IDS_CERT_STATE_NOTICE_3));var g=document.getElementById("us-list-lbl-title");g.appendChild(document.createTextNode(c.IDS_DIALOG_TITLE));g.setAttribute("tabindex",C,0);b=document.getElementById("us-cert-view-btn");b.setAttribute("value",c.IDS_CERT_VIEW,0);b.setAttribute("title",c.IDS_CERT_VIEW,0);b.onclick=function(){f(this,c)};b=document.getElementById("us-cert-list-confirm-btn");b.setAttribute("value",c.IDS_DIALOG_BTN_CONFIRM,0);b.setAttribute("title",c.IDS_DIALOG_BTN_CONFIRM,0);b.onclick=function(){h&&h.restoreOnMouseEvent();var a=parseInt(h.selectedIndex());d.onConfirm(a)};b=document.getElementById("us-cls-btn");b.setAttribute("title",c.IDS_DIALOG_BTN_CANCEL,0);b.setAttribute("value",c.IDS_DIALOG_BTN_CANCEL,0);b.onclick=function(){e()};b.onfocus=function(){g.focus()};b=document.getElementById("us-cert-list-cls-img-btn");b.onclick=function(){e()};b.onfocus=function(){g.focus()};b=document.getElementById("us-cert-list-cls-btn-img");b.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/x-btn.png",0);b.onclick=function(){e()};var k=[{title:c.IDS_CERT_STATUS},{title:c.IDS_CERT_CLASSIFY},{title:c.IDS_CERT_USER},{title:c.IDS_CERT_ISSUER},{title:c.IDS_CERT_EXPIRATION_DAY}];x=C++;setTimeout(function(){m(k,c)},100);return document.getElementById("us-div-cert-list")}()};return function(d){var s=a.uiLayerLevel,e=a.uiUtil().getOverlay(s),f=v({type:d.type,args:d.args,onConfirm:d.onConfirm,onCancel:d.onCancel});f.style.zIndex=s+1;a.ESVS.TargetObj.insertBefore(e,a.ESVS.TargetObj.firstChild);var m=window.onresize;return{show:function(){draggable(f,document.getElementById("us-div-list-title"));e.style.display="block";a.uiUtil().offsetResize(f);window.onresize=function(){a.uiUtil().offsetResize(f);m&&m()};a.uiLayerLevel+=10;a.ESVS.TabIndex+=30;setTimeout(function(){var a=f.getElementsByTagName("p");if(0<a.length)for(var d=0;d<a.length;d++)"us-view-lbl-title"==a[d].id&&a[d].focus()},10)},hide:function(){e.style.display="none";f.style.display="none"},dispose:function(){window.onresize=function(){m&&m()};f.parentNode.parentNode.removeChild(f.parentNode);e.parentNode.removeChild(e);a.uiLayerLevel-=10;a.ESVS.TabIndex-=30}}}};