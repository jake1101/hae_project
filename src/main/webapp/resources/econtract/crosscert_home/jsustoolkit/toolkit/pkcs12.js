(function(){function x(h){function s(a,e,d,h){for(var g=[],b=0;b<a.length;b++)for(var k=0;k<a[b].safeBags.length;k++){var c=a[b].safeBags[k];if(void 0===h||c.type===h)null===e?g.push(c):void 0!==c.attributes[e]&&0<=c.attributes[e].indexOf(d)&&g.push(c)}return g}function q(f,e,d,n){e=a.fromDer(e);if(e.tagClass!==a.Class.UNIVERSAL||e.type!==a.Type.SEQUENCE||!0!==e.constructed)throw{code:"115011",message:m["115011"]+"(PKCS#12 AuthenticatedSafe expected to be a SEQUENCE OF ContentInfo)"};for(var g=0;g<e.value.length;g++){var b={},k=[];if(!a.validate(e.value[g],D,b,k))throw{code:"115012",message:m["115012"]+"Cannot read ContentInfo.",errors:k};var k={encrypted:!1},c=null,c=b.content.value[0];switch(a.derToOid(b.contentType)){case l.oids.data:if(c.tagClass!==a.Class.UNIVERSAL||c.type!==a.Type.OCTETSTRING)throw{code:"115013",message:m["115013"]};c=c.value;break;case l.oids.encryptedData:if(void 0===d)throw{code:"115014",message:m["115014"]};var r=d,b={},p=[];if(!a.validate(c,h.pkcs7.asn1.encryptedDataValidator,b,p))throw{code:"115016",message:m["115016"]+"Cannot read EncryptedContentInfo.",errors:p};c=a.derToOid(b.contentType);if(c!==l.oids.data)throw{code:"115017",message:m["115017"]+"(PKCS#12 EncryptedContentInfo ContentType is not Data. oid : "+c+")"};c=a.derToOid(b.encAlgorithm);c=h.pkcs5.pbe.getCipher(c,b.encParameter,r);b=h.util.createBuffer(b.encContent);c.update(b);if(!c.finish())throw{code:"115018",message:m["115018"]+"Failed to decrypt PKCS#12 SafeContents."};c=c.output.getBytes();k.encrypted=!0;break;default:throw{code:"115015",message:m["115015"]+"(contentType:"+a.derToOid(b.contentType)+")"};}k.safeBags=C(c,n);f.safeContents.push(k)}}function z(f,e,d){var n=l.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"];e=h.pkcs5.pbe.setCipher(n,d,e);e.update(a.toDer(f));if(!e.finish())throw{code:"115019",message:m["115019"]};f=h.util.createBuffer();f.putInt16(d.count);d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.data).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d.salt),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,f.getBytes())])]),a.create(a.Class.CONTEXT_SPECIFIC,0,!1,e.output.getBytes())]);return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.encryptedData).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(0)),d])])])}function C(f,e){f=a.fromDer(f);if(f.tagClass!==a.Class.UNIVERSAL||f.type!==a.Type.SEQUENCE||!0!==f.constructed)throw{code:"115020",message:m["115020"]+"PKCS#12 SafeContents expected to be a SEQUENCE OF SafeBag."};for(var d=[],h=0;h<f.value.length;h++){var g={},b=[];if(!a.validate(f.value[h],F,g,b))throw{code:"115021",message:m["115021"]+"Cannot read SafeBag.",errors:b};var k={type:a.derToOid(g.bagId),attributes:t(g.bagAttributes)};d.push(k);var c,r,p=g.bagValue.value[0];switch(k.type){case l.oids.pkcs8ShroudedKeyBag:if(void 0===e){k.key=p;continue}p=v.decryptPrivateKeyInfo(p,e);if(null===p)throw{code:"115022",message:m["115022"]+"Unable to decrypt PKCS#8 ShroudedKeyBag, wrong password?"};case l.oids.keyBag:k.key=l.privateKeyFromAsn1(p);k.rand=v.getPrivateKeyAttributesRandom(p);continue;case l.oids.certBag:c=G;r=function(){if(a.derToOid(g.certId)!==l.oids.x509Certificate)throw{code:"115023",message:m["115023"]+"(Unsupported certificate type, only X.509 supported. oid:"+a.derToOid(g.certId)+")"};k.cert=l.certificateFromAsn1(a.fromDer(g.cert),!0)};break;default:throw{code:"115024",message:m["115024"]+"(oid:"+k.type+")"};}if(void 0!==c&&!a.validate(p,c,g,b))throw{code:"115025",message:m["115025"]+c.name,errors:b};r()}return d}function t(f){var e={};if(void 0!==f)for(var d=0;d<f.length;d++){var h={},g=[];if(!a.validate(f[d],H,h,g))throw{code:"115026",message:m["115026"]+"Cannot read PKCS#12 BagAttribute. validator="+validator.name,errors:g};g=a.derToOid(h.oid);if(void 0!==l.oids[g]){e[l.oids[g]]=[];for(var b=0;b<h.values.length;b++)e[l.oids[g]].push(h.values[b].value)}}return e}function A(){var f=h.random.getBytes(20);if(null!==f){var f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.localKeyId).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SET,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,f)])]),e=a.create(a.Class.UNIVERSAL,a.Type.SET,!0,[]);e.value.push(f);return e}throw{code:"115027",message:m["115027"],errors:errors};}function x(f,e,d,m){return null===e?a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.keyBag).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[f]),d]):a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.pkcs8ShroudedKeyBag).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[h.pkcs8.encryptPrivateKeyInfo(f,e,m)]),d])}function y(f,e){return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.pkcs8ShroudedKeyBag).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[f]),e])}function B(f,e){"string"===typeof f&&(f=l.certificateFromPem(f));var d=l.certificateToAsn1(f);return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.certBag).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.x509Certificate).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,a.toDer(d).getBytes())])])]),e])}var m=h.jsustoolkitErrCode=h.jsustoolkitErrCode||{},a=h.asn1,l=h.pki=h.pki||{},v=h.pkcs8=h.pkcs8||{},u=h.pkcs12=h.pkcs12||{},D={name:"ContentInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"ContentInfo.contentType",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"contentType"},{name:"ContentInfo.content",tagClass:a.Class.CONTEXT_SPECIFIC,constructed:!0,captureAsn1:"content"}]},E={name:"PFX",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PFX.version",tagClass:a.Class.UNIVERSAL,type:a.Type.INTEGER,constructed:!1,capture:"version"},D,{name:"PFX.macData",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"mac",value:[{name:"PFX.macData.mac",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PFX.macData.mac.digestAlgorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PFX.macData.mac.digestAlgorithm.algorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"macAlgorithm"},{name:"PFX.macData.mac.digestAlgorithm.parameters",tagClass:a.Class.UNIVERSAL,captureAsn1:"macAlgorithmParameters"}]},{name:"PFX.macData.mac.digest",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"macDigest"}]},{name:"PFX.macData.macSalt",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"macSalt"},{name:"PFX.macData.iterations",tagClass:a.Class.UNIVERSAL,type:a.Type.INTEGER,constructed:!1,optional:!0,capture:"macIterations"}]}]},F={name:"SafeBag",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"SafeBag.bagId",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"bagId"},{name:"SafeBag.bagValue",tagClass:a.Class.CONTEXT_SPECIFIC,constructed:!0,captureAsn1:"bagValue"},{name:"SafeBag.bagAttributes",tagClass:a.Class.UNIVERSAL,type:a.Type.SET,constructed:!0,optional:!0,capture:"bagAttributes"}]},H={name:"Attribute",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"Attribute.attrId",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"oid"},{name:"Attribute.attrValues",tagClass:a.Class.UNIVERSAL,type:a.Type.SET,constructed:!0,capture:"values"}]},G={name:"CertBag",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"CertBag.certId",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"certId"},{name:"CertBag.certValue",tagClass:a.Class.CONTEXT_SPECIFIC,constructed:!0,value:[{name:"CertBag.certValue[0]",tagClass:a.Class.UNIVERSAL,type:a.Class.OCTETSTRING,constructed:!1,capture:"cert"}]}]};u.getCertNKeyFromPKCS12=function(f,e){if(null==f||"undefined"==typeof f)throw{code:"115001",message:m["115001"]};if(null==e||"undefined"==typeof e)throw{code:"115002",message:m["115002"]};var d={},n=[];if(!a.validate(f,E,d,n))throw{code:"115003",message:m["115003"],errors:n};var g={version:d.version.charCodeAt(0),safeContents:[],getCertAndKeyFromPKCS12:function(a){for(var b={sign:{}},c=0;c<g.safeContents[0].safeBags.length;c++){var d=g.safeContents[0].safeBags[c].attributes.localKeyId[0],e=s(g.safeContents,"localKeyId",d,l.oids.pkcs8ShroudedKeyBag);0==e.length&&(e=s(g.safeContents,"localKeyId",d,l.oids.keyBag));if(2==e.length){var f=s(g.safeContents,"localKeyId",d,l.oids.certBag);b.sign.cert=g.safeContents[1].safeBags[0].cert;d=v.rsaPrivateKeyInfo(l.privateKeyToAsn1(e[0].key),e[0].rand);b.sign.prikey=v.encryptPrivateKeyInfo(d,a,{algorithm:"seed"});f={};f.cert=g.safeContents[1].safeBags[1].cert;d=v.rsaPrivateKeyInfo(l.privateKeyToAsn1(e[1].key),e[1].rand);f.prikey=v.encryptPrivateKeyInfo(d,a,{algorithm:"seed"});b.km=f;break}else if(1==e.length)f=s(g.safeContents,"localKeyId",d,l.oids.certBag),d=v.rsaPrivateKeyInfo(l.privateKeyToAsn1(e[0].key),e[0].rand),d=v.encryptPrivateKeyInfo(d,a,{algorithm:"seed"}),e=f[0].cert,e.getExtension("keyUsage").keyEncipherment?(f={},f.cert=e,f.prikey=d,b.km=f):(b.sign.cert=e,b.sign.prikey=d);else throw{code:"115004",message:m["115004"]};}return b}};if(3!==d.version.charCodeAt(0))throw{code:"115005",message:m["115005"]+"(version: "+d.version.charCodeAt(0)+")"};if(a.derToOid(d.contentType)!==l.oids.data)throw{code:"115006",message:m["115006"]+"(oid :"+a.derToOid(d.contentType)+")"};n=d.content.value[0];if(n.tagClass!==a.Class.UNIVERSAL||n.type!==a.Type.OCTETSTRING)throw{code:"115007",message:m["115007"]+"(PKCS#12 authSafe content data is not an OCTET STRING.)"};if(d.mac){var b=null,k=0,c=a.derToOid(d.macAlgorithm);switch(c){case l.oids.sha1:b=h.md.sha1.create();k=20;break;case l.oids.sha256:b=h.md.sha256.create();k=32;break;case l.oids.md5:b=h.md.md5.create();k=16;break;default:throw{code:"115008",message:m["115008"]+"(PKCS#12 uses unsupported MAC algorithm: "+c+")"};}if(null===b)throw{code:"115009",message:m["115009"]+c};var c=new h.util.ByteBuffer(d.macSalt),r="macIterations"in d?parseInt(h.util.bytesToHex(d.macIterations),16):1,k=u.generateKey(e||"",c,3,r,k,b),c=h.hmac.create();c.start(b,k);c.update(n.value);if(c.getMac().toHex()!==h.util.bytesToHex(d.macDigest))throw{code:"115010",message:m["115010"]};}q(g,n.value,e,e);return g};u.makePKCS12=function(f,e,d,n,g,b){if(null==f||"undefined"==typeof f)throw{code:"115028",message:m["115028"]};if(null==e||"undefined"==typeof e)throw{code:"115029",message:m["115029"]};if(null==g||"undefined"==typeof g)throw{code:"115030",message:m["115030"]};b=b||{};b.saltSize=b.saltSize||20;b.count=b.count||2E3;b.encAlgorithm=b.encAlgorithm||"3des";b.algorithm=b.algorithm||"3des";b.generateLocalKeyId=b.generateLocalKeyId||!0;b.useMac=b.useMac||!0;"useMac"in b||(b.useMac=!0);"generateLocalKeyId"in b||(b.generateLocalKeyId=!0);var k=[],c=A();k.push(c);null!==d&&"undefined"!=typeof d&&(c=A(),k.push(c));c=[];if(null!==e){e=h.pkcs8.decryptPrivateKeyInfo(e,g);var r=null,p=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),r=x(e,g,k[0],b);p.value.push(r);null!==n&&"undefined"!=typeof n&&(n=h.pkcs8.decryptPrivateKeyInfo(n,g),r=x(n,g,k[1],b),p.value.push(r));e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.data).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,a.toDer(p).getBytes())])]);c.push(e)}null!==f&&(e=null,n=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),e=B(f,k[0]),n.value.push(e),null!==d&&"undefined"!=typeof d&&(e=B(d,k[1]),n.value.push(e)),f=z(n,g,b),c.push(f));f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,c);d=void 0;b.useMac&&(k=h.md.sha1.create(),d=new h.util.ByteBuffer(h.random.getBytes(b.saltSize)),b=b.count,g=u.generateKey(g||"",d,3,b,20),c=h.hmac.create(),c.start(k,g),c.update(a.toDer(f).getBytes()),g=c.getMac(),d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.sha1).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,"")]),a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,g.getBytes())]),a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d.getBytes()),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,h.util.hexToBytes(b.toString(16)))]));return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(3)),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.data).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,a.toDer(f).getBytes())])]),d])};u.makePKCS12FromCertNEncPKCS8=function(f,e,d,n,g,b){if(null==f||"undefined"==typeof f)throw{code:"115031",message:m["115031"]};if(null==e||"undefined"==typeof e)throw{code:"115032",message:m["115032"]};if(null==g||"undefined"==typeof g)throw{code:"115033",message:m["115033"]};b=b||{};b.saltSize=b.saltSize||20;b.count=b.count||2E3;b.encAlgorithm=b.encAlgorithm||"3des";b.algorithm=b.algorithm||"3des";b.generateLocalKeyId=b.generateLocalKeyId||!0;b.useMac=b.useMac||!0;b.salt=b.salt||h.random.getBytes(b.saltSize);"useMac"in b||(b.useMac=!0);"generateLocalKeyId"in b||(b.generateLocalKeyId=!0);var k=[],c=A();k.push(c);null!==d&&"undefined"!=typeof d&&(c=A(),k.push(c));c=[];if(null!==e){var r=null,p=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),r=y(e,k[0]);p.value.push(r);null!==n&&"undefined"!=typeof n&&(r=y(n,k[1]),p.value.push(r));e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.data).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,a.toDer(p).getBytes())])]);c.push(e)}null!==f&&(e=null,n=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),e=B(f,k[0]),n.value.push(e),null!==d&&"undefined"!=typeof d&&(e=B(d,k[1]),n.value.push(e)),f=z(n,g,b),c.push(f));f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,c);d=void 0;b.useMac&&(k=h.md.sha1.create(),d=new h.util.ByteBuffer(h.random.getBytes(b.saltSize)),b=b.count,g=u.generateKey(g||"",d,3,b,20),c=h.hmac.create(),c.start(k,g),c.update(a.toDer(f).getBytes()),g=c.getMac(),d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.sha1).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,"")]),a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,g.getBytes())]),a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d.getBytes()),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,h.util.hexToBytes(b.toString(16)))]));return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(3)),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.oids.data).getBytes()),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,a.toDer(f).getBytes())])]),d])};u.getCertNKeyFromPKCS12WithEncPKCS8=function(f,e){if(null==f||"undefined"==typeof f)throw{code:"115034",message:m["115034"]};if(null==e||"undefined"==typeof e)throw{code:"115035",message:m["115035"]};var d={},n=[];if(!a.validate(f,E,d,n))throw{code:"115036",message:m["115036"],errors:n};var g={version:d.version.charCodeAt(0),safeContents:[],getCertAndKeyFromPKCS12:function(){for(var a={sign:{}},b=0;b<g.safeContents[0].safeBags.length;b++){var c=g.safeContents[0].safeBags[b].attributes.localKeyId[0],d=s(g.safeContents,"localKeyId",c,l.oids.pkcs8ShroudedKeyBag);0==d.length&&(d=s(g.safeContents,"localKeyId",c,l.oids.keyBag));if(2==d.length){c=s(g.safeContents,"localKeyId",c,l.oids.certBag);a.sign.cert=g.safeContents[1].safeBags[0].cert;a.sign.prikey=d[0].key;c={};c.cert=g.safeContents[1].safeBags[1].cert;c.prikey=d[1].key;a.km=c;break}else if(1==d.length){var c=s(g.safeContents,"localKeyId",c,l.oids.certBag),d=d[0].key,e=c[0].cert;e.getExtension("keyUsage").keyEncipherment?(c={},c.cert=e,c.prikey=d,a.km=c):(a.sign.cert=e,a.sign.prikey=d)}else throw{code:"115037",message:m["115037"]};}return a}};if(3!==d.version.charCodeAt(0))throw{code:"115038",message:m["115038"]+"(version : "+d.version.charCodeAt(0)+")"};if(a.derToOid(d.contentType)!==l.oids.data)throw{code:"115039",message:m["115039"]+"(oid : "+a.derToOid(d.contentType)+")"};n=d.content.value[0];if(n.tagClass!==a.Class.UNIVERSAL||n.type!==a.Type.OCTETSTRING)throw{code:"115040",message:m["115040"]};if(d.mac){var b=null,k=0,c=a.derToOid(d.macAlgorithm);switch(c){case l.oids.sha1:b=h.md.sha1.create();k=20;break;case l.oids.sha256:b=h.md.sha256.create();k=32;break;case l.oids.md5:b=h.md.md5.create();k=16;break;default:throw{code:"115041",message:m["115041"]+"("+c+")"};}if(null===b)throw{code:"115042",message:m["115042"]+"("+c+")"};var c=new h.util.ByteBuffer(d.macSalt),r="macIterations"in d?parseInt(h.util.bytesToHex(d.macIterations),16):1,k=u.generateKey(e||"",c,3,r,k,b),c=h.hmac.create();c.start(b,k);c.update(n.value);if(c.getMac().toHex()!==h.util.bytesToHex(d.macDigest))throw{code:"115043",message:m["115043"]};}q(g,n.value,e);return g};u.generateKey=function(a,e,d,l,g,b){if(null==a||"undefined"==typeof a)throw{code:"115044",message:m["115044"]};if(null==e||"undefined"==typeof e)throw{code:"115045",message:m["115045"]};if(null==d||"undefined"==typeof d)throw{code:"115046",message:m["115046"]};if(null==l||"undefined"==typeof l)throw{code:"115047",message:m["115047"]};if(null==g||"undefined"==typeof g)throw{code:"115001",message:m["115001"]};var k,c;if("undefined"===typeof b||null===b)b=h.md.sha1.create();var r=b.digestLength,p=b.blockLength,s=new h.util.ByteBuffer,q=new h.util.ByteBuffer;for(c=0;c<a.length;c++)q.putInt16(a.charCodeAt(c));q.putInt16(0);a=q.length();var u=e.length(),v=new h.util.ByteBuffer;v.fillWithByte(d,p);var w=p*Math.ceil(u/p);d=new h.util.ByteBuffer;for(c=0;c<w;c++)d.putByte(e.at(c%u));w=p*Math.ceil(a/p);e=new h.util.ByteBuffer;for(c=0;c<w;c++)e.putByte(q.at(c%a));q=d;q.putBuffer(e);e=Math.ceil(g/r);for(d=1;d<=e;d++){w=new h.util.ByteBuffer;w.putBytes(v.bytes());w.putBytes(q.bytes());for(c=0;c<l;c++)b.start(),b.update(w.getBytes()),w=b.digest();var x=new h.util.ByteBuffer;for(c=0;c<p;c++)x.putByte(w.at(c%r));var C=Math.ceil(u/p)+Math.ceil(a/p),z=new h.util.ByteBuffer;for(k=0;k<C;k++){var y=new h.util.ByteBuffer(q.getBytes(p)),t=511;for(c=x.length()-1;0<=c;c--)t>>=8,t+=x.at(c)+y.at(c),y.setAt(c,t&255);z.putBuffer(y)}q=z;s.putBuffer(w)}s.truncate(s.length()-g);return s}}var y="./asn1 ./sha1 ./pkcs7asn1 ./pki ./util ./random ./hmac ./jsustoolkitErrCode".split(" "),t=null;"function"!==typeof define&&("object"===typeof module&&module.exports?t=function(h,s){s(require,module)}:(crosscert=window.crosscert=window.crosscert||{},x(crosscert)));(t||"function"===typeof define)&&(t||define)(["require","module"].concat(y),function(h,s){s.exports=function(q){var s=y.map(function(q){return h(q)}).concat(x);q=q||{};q.defined=q.defined||{};if(q.defined.pkcs12)return q.pkcs12;q.defined.pkcs12=!0;for(var t=0;t<s.length;++t)s[t](q);return q.pkcs12}})})();