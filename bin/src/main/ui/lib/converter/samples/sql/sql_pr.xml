<?xml version="1.0" encoding="utf-8"?>
    <sql-descriptor id="procurement/pr" data-source="srmDS">
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                          조 달 공 통 START        ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <Sql id="get.pcnmt" comment="조달 화면 공통 Condition Matrix조회">
        <![CDATA[
            SELECT MD_CLS   ,
                   FIELD_CD ,
                   VISIBLE  ,
                   COND_CLS
              FROM ESPCNMT
             WHERE SYS_ID   = #sys_id#
               AND COMP_CD  = 'N'
               AND GRP_CD   = UPPER(#grp_cd#)
               AND TYPE_CLS = NVL(#type_cls#, 'ALL')
               AND USE_YN   = 'Y'
              
         UNION ALL
        
            SELECT MD_CLS   ,
                   FIELD_CD ,
                   VISIBLE  ,
                   COND_CLS
              FROM ESPCNMT
             WHERE SYS_ID   = #sys_id#
               AND COMP_CD  = #s_comp_cd#
               AND GRP_CD   = UPPER(#grp_cd#)
               AND TYPE_CLS = NVL(#type_cls#, 'ALL')
               AND USE_YN   = 'Y'

        ]]>
    </Sql>
    
    <Sql id="get.pcnmt.cost_typ.info" comment="회계지정범주에 따른 Cost type 데이터 조회">
    	<![CDATA[
			SELECT A.TYPE_CLS
			      ,A.FIELD_CD
			      ,A.FIELD_NM
			  FROM ESPCNMT A
			 WHERE A.SYS_ID   = #sys_id#
			   AND A.COMP_CD  = #s_comp_cd#
			   AND A.GRP_CD   = 'COST_TYP'
			   AND A.MD_CLS   = 'G'
			   AND A.VISIBLE  = 'true'
			   AND A.COND_CLS = 'M'
			   AND NOT EXISTS (
			                   SELECT 'X'
			                     FROM ESPCNMT B
			                    WHERE A.SYS_ID   = B.SYS_ID
			                      AND A.COMP_CD  = B.COMP_CD
			                      AND A.GRP_CD   = B.GRP_CD
			                      AND A.MD_CLS   = B.MD_CLS
			                      AND A.TYPE_CLS = B.TYPE_CLS
			                      AND A.FIELD_CD = B.FIELD_CD
			                      AND A.VISIBLE  = B.VISIBLE
			                      AND A.COND_CLS = B.COND_CLS
			                      AND (B.FIELD_CD LIKE 'img_%' OR B.FIELD_CD LIKE '%_nm')
			                  )
    	]]>
    </Sql>
    
    <sql id="select.sap_pr_no">
        <![CDATA[
            SELECT SAP_PR_NO
              FROM ESPPRHD
             WHERE SYS_ID  = #sys_id#
               AND COMP_CD = #s_comp_cd#
               AND PR_NO   = #pr_no#
        ]]>
    </sql>
    
    <Sql id="insertGlobalTemporaryTable" comment="Global Temporary Table에 Insert">
        <![CDATA[
            INSERT INTO ESPTEMP
                      (
                        SYS_ID      ,
                        COMP_CD     ,
                        PR_NO       ,
                        PR_LNO      ,
                        ITEM_CD  
                      )
                 VALUES
                      (
                        #sys_id#                               ,
                        #s_comp_cd#                            , 
                        #pr_no#                                ,
                        TO_CHAR(NVL(#pr_lno#, 10),'FM00000')   ,
                        #item_cd#  
                      )
        ]]>
    </Sql>
    
    <sql id="insert.temp.for.pr" comment="발주생성을 위한 Global Temp테이블 Insert">
        <![CDATA[
            INSERT INTO ESPTEMP 
                        ( SYS_ID  , COMP_CD    , PR_NO  , PR_LNO                     , ITEM_QTY   , ITEM_PRICE   ) 
                 VALUES ( #sys_id#, #s_comp_cd#, #pr_no#, NVL(#pr_lno#, #grid_index#), #item_qty# , #pr_price#   )
        ]]>
    </sql>
    
    <sql id="get.pay.calc" comment="">
        <![CDATA[
           SELECT PR_LNO,
                  ITEM_QTY * ITEM_PRICE  AS PR_AMT
              FROM ESPTEMP
              WHERE SYS_ID = #sys_id#
        ]]>
    </sql>
    
    <sql id="get.pay.calc.sum" comment="">
        <![CDATA[
           SELECT SUM( ITEM_QTY * ITEM_PRICE ) AS PR_TOT_AMT
              FROM ESPTEMP
              WHERE SYS_ID = #sys_id#
        ]]>
    </sql>
    
    <sql id="get.session.info" comment="">
        <![CDATA[
           SELECT    AUSR.USR_ID    AS REQ_ID
			       , AUSR.USR_NM    AS REQ_USR_NM
			       , AUSR.DEPT_CD   AS PR_REQ_DEPT
			       , AUSR.DEPT_CD   AS REQ_DEPT_CD
			       , (SELECT FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#, 'DEPT', AUSR.COMP_CD, AUSR.PLT_CD, AUSR.DEPT_CD,'','','') FROM DUAL) AS PR_REQ_DEPT_NM
			       , (SELECT FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#, 'DEPT', AUSR.COMP_CD, AUSR.PLT_CD, AUSR.DEPT_CD,'','','') FROM DUAL) AS REQ_DEPT_NM
			       , (SELECT WM_CONCAT(DECODE(jbps.purc_grp_cd,'',' ',jbps.purc_grp_cd))
			            FROM ESMJBPS jbps
			           WHERE jbps.SYS_ID       = AUSR.SYS_ID
			             AND jbps.PURC_GRP_TYP  = 'PU'
			             AND jbps.COMP_CD 	   =AUSR.COMP_CD
			             AND jbps.USR_ID       = AUSR.USR_ID
			             AND JBPS.USE_YN       = 'Y'		 ) AS PURC_GRP_CD_LIST
			FROM  ESAUSER AUSR
			WHERE AUSR.SYS_ID  = #sys_id# 
			  AND AUSR.COMP_CD = #comp_cd# 
			  AND AUSR.USR_ID  = #usr_id# 
        ]]>
    </sql>
    
    <sql id="get.session.info.backup" comment="기준 단일 직무코드를 가져온 쿼리 (2015.07.14) Backup처리">
        <![CDATA[
           SELECT    AUSR.USR_ID    AS REQ_ID
			       , AUSR.USR_NM    AS REQ_USR_NM
			       , AUSR.DEPT_CD   AS PR_REQ_DEPT
			       , AUSR.DEPT_CD   AS REQ_DEPT_CD
			       , (SELECT FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#, 'DEPT', AUSR.COMP_CD, AUSR.PLT_CD, AUSR.DEPT_CD,'','','') FROM DUAL) AS PR_REQ_DEPT_NM
			       , (SELECT FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#, 'DEPT', AUSR.COMP_CD, AUSR.PLT_CD, AUSR.DEPT_CD,'','','') FROM DUAL) AS REQ_DEPT_NM
			       , (SELECT JBPS.PURC_GRP_CD
			            FROM ESMJBPS JBPS
			           WHERE JBPS.SYS_ID       = AUSR.SYS_ID
			             AND JBPS.PURC_GRP_TYP = 'PU'
			             AND JBPS.COMP_CD      = AUSR.COMP_CD
			             AND JBPS.USR_ID       = AUSR.USR_ID
			             AND JBPS.USE_YN       = 'Y'
			             AND ROWNUM            = 1           ) AS PURC_GRP_CD
			        , (SELECT FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#, 'PURC_GRP', 'PU'
                            , (SELECT JBPS.PURC_GRP_CD
                                 FROM ESMJBPS JBPS
                                WHERE JBPS.SYS_ID       = AUSR.SYS_ID
                                  AND JBPS.COMP_CD      = AUSR.COMP_CD
                                  AND JBPS.PURC_GRP_TYP = 'PU'
                                  AND JBPS.USR_ID       = AUSR.USR_ID
                                  AND JBPS.USE_YN       = 'Y'
                                  AND ROWNUM            = 1)
                            ,''
                            ,''
                            ,''
                            ,'') FROM DUAL
                      )  AS  PURC_GRP_NM
			FROM  ESAUSER AUSR
			WHERE AUSR.SYS_ID  = #sys_id# 
			  AND AUSR.COMP_CD = #comp_cd# 
			  AND AUSR.USR_ID  = #usr_id# 
        ]]>
    </sql>
    
    <sql id="chk.status.prhd">
        <![CDATA[
            SELECT CASE WHEN APRV_STS = 'N'
                             THEN '''' || PR_NO || ''' 해당 구매요청건은 전자결재 전송상태로 ' || DECODE(#mode#, 'U', '수정', 'D', '삭제') || ' 하실 수 없습니다.'
                        WHEN APRV_STS = 'S'
                             THEN '''' || PR_NO || ''' 해당 구매요청건은 전자결재 임시저장상태로 ' || DECODE(#mode#, 'U', '수정', 'D', '삭제') || ' 하실 수 없습니다.'
                        WHEN APRV_STS = 'P'
                             THEN '''' || PR_NO || ''' 해당 구매요청건은 전자결재 기안상태로 ' || DECODE(#mode#, 'U', '수정', 'D', '삭제') || ' 하실 수 없습니다.'
                        WHEN APRV_STS = 'C'
                             THEN '''' || PR_NO || ''' 해당 구매요청건은 전자결재 승인상태로 ' || DECODE(#mode#, 'U', '수정', 'D', '삭제') || ' 하실 수 없습니다.'
                        WHEN STS = 'D'
                             THEN '''' || PR_NO || ''' 해당 구매요청건은 삭제 되어 ' || DECODE(#mode#, 'U', '수정', 'D', '삭제') || ' 하실 수 없습니다.'
                        ELSE ''
                   END ERR_MSG
              FROM (
                    SELECT PRHD.PR_NO       ,
                           PRHD.APRV_STS    ,
                           PRHD.STS                  
                      FROM ESPPRHD PRHD
                     WHERE PRHD.SYS_ID  = #sys_id#
                       AND PRHD.COMP_CD = #s_comp_cd#
                       AND PRHD.PR_NO   = #pr_no#
                   ) 
        ]]>
    </sql>
    
    <sql id="chk.status.prdt">
        <![CDATA[
            SELECT CASE WHEN #mode# = 'U'
                             THEN CASE WHEN DT_STS = 'D'
                                            THEN '''' || PR_LNO || ''' 품목은 삭제 되어 수정을 하실 수 없습니다.'
                                       WHEN PR_PROG_STS <> 'RN'
                                            THEN '''' || PR_LNO || ''' 품목은 수정할 수 없는 ' || '''' || PR_PROG_STS_NM || ''' 상태입니다.'
                                       WHEN PO_END_YN = 'C'
                                            THEN '''' || PR_LNO || ''' 품목은 발주가 종결되어 수정을 하실 수 없습니다.'
                                       ELSE ''
                                   END
                    END ERR_MSG
              FROM (
		            SELECT PRHD.APRV_STS                 AS APRV_STS        ,
		                   PRHD.STS                      AS HD_STS          ,
		                   PRDT.STS                      AS DT_STS          ,
		                   PRDT.PR_NO                    AS PR_NO           ,
                           PRDT.PR_LNO                   AS PR_LNO          ,
                           PRDT.PR_PROG_STS              AS PR_PROG_STS     ,
                           ( SELECT FC_GET_NAME( PRDT.SYS_ID, #locale#, PRDT.COMP_CD, 'CODE', 'P044', PRDT.PR_PROG_STS, '', '', '', '') 
                               FROM DUAL )               AS PR_PROG_STS_NM  ,
		                   NVL( PRDT.PO_END_YN, 'N' )    AS PO_END_YN       ,
		                   NVL( PRDT.ITEM_QTY , 0   )    AS ITEM_QTY        ,
		                   NVL( PRDT.PO_QTY   , 0   )    AS PO_QTY
		              FROM ESPPRDT PRDT, ESPPRHD PRHD, ESPPODT PODT 
		             WHERE PRDT.SYS_ID  = #sys_id#
		               AND PRDT.COMP_CD = #s_comp_cd#
		               AND PRDT.PR_NO   = #pr_no#
		             [ AND PRDT.PR_LNO  = #pr_lno#      ]
		               AND PRDT.SYS_ID  = PRHD.SYS_ID
		               AND PRDT.COMP_CD = PRHD.COMP_CD
		               AND PRDT.PR_NO   = PRHD.PR_NO
		               AND PRDT.PR_NO   = PODT.PR_NO
		               AND PRDT.PR_LNO  = PODT.PR_LNO		               
		           ) 
        ]]>
    </sql>
    
    <sql id="chk.dup.rfq">
        <![CDATA[
            SELECT COUNT(*) AS CNT ,
                   RQHD.RFQ_NO
              FROM ESPRQDT RQDT, ESPRQHD RQHD
             WHERE RQDT.SYS_ID       = #sys_id#
               AND RQDT.COMP_CD      = #s_comp_cd#
               AND RQDT.PR_NO        = #pr_no#
            [  AND RQDT.PR_LNO       = #pr_lno# ]
               AND RQHD.RFQ_PROG_STS <> 'C'
               AND RQHD.RFQ_END_STS  <> 'C'
               AND RQDT.SYS_ID       = RQHD.SYS_ID
               AND RQDT.COMP_CD      = RQHD.COMP_CD
               AND RQDT.RFQ_NO       = RQHD.RFQ_NO
          GROUP BY RQHD.RFQ_NO
        ]]>
    </sql>
    
    <sql id="chk.dup.po">
        <![CDATA[
            SELECT COUNT(*) AS CNT ,
                   POHD.PO_NO
              FROM ESPPODT PODT, ESPPOHD POHD
             WHERE PODT.SYS_ID    = #sys_id#
               AND PODT.COMP_CD   = #s_comp_cd#
               AND PODT.PR_NO     = #pr_no#
            [  AND PODT.PR_LNO    = #pr_lno# ]
               AND PODT.STS       <> 'D'
               AND POHD.STS       <> 'D'
               AND NVL( PODT.PO_COMP_YN    , 'N' ) <> 'Y'
               AND NVL( PODT.PO_CRC_END_YN , 'N' ) <> 'Y'
               AND PODT.SYS_ID    = POHD.SYS_ID
               AND PODT.COMP_CD   = POHD.COMP_CD
               AND PODT.PO_NO     = POHD.PO_NO
               AND NOT EXISTS (
					SELECT PR_NO 
					  FROM ESPPRDT
					WHERE PR_NO 			= #pr_no#
					[  AND PR_LNO    = #pr_lno# ]
					   AND AUTO_PO_YN = 'Y'               
               )
          GROUP BY POHD.PO_NO
        ]]>
    </sql>
    
    <sql id="complete.approval.pr" comment="결재 완료후 처리 로직">
        <![CDATA[
           BEGIN
            UPDATE ESPPRHD
               SET APRV_STS      = #aprv_sts#
               		,APRV_URL    = #aprv_url#
               		,APRV_DATE   = TO_CHAR(SYSDATE,'YYYYMMDD')
               		,APRV_ID		= #reg_id#
               		,STS         = 'U'
               		,MOD_DT      = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
             WHERE SYS_ID    = #sys_id# 
               AND PR_NO   = #pr_no#;
             
             UPDATE ESPPRDT
               SET PR_PROG_STS       = #pr_prog_sts#
                   ,STS              = 'U'
               	   ,MOD_DT           = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
             WHERE SYS_ID    = #sys_id# 
               AND PR_NO   = #pr_no#
               AND STS <> 'D';
            END;            
        ]]>
    </sql>
 
     <sql id="complete.approval.prdt.info" comment="결재 완료후 보정로직">
        <![CDATA[
             UPDATE ESPPRDT
               SET PR_PROG_STS       = 'CW'
                   ,STS              = 'U'
               	   ,MOD_DT           = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
             WHERE SYS_ID    = #sys_id# 
               AND PR_NO   = #pr_no#
               AND PR_LNO  = #pr_lno# 
        ]]>
    </sql>
 
 
     <sql id="return.approval.pr" comment="결재 반려후 처리 로직">
        <![CDATA[
           BEGIN
            UPDATE ESPPRHD
               SET APRV_STS      = #aprv_sts#
               ,STS              = 'U'
               ,MOD_DT           = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
             WHERE SYS_ID    = #sys_id# 
               AND PR_NO   = #pr_no#;
            END;            
        ]]>
    </sql>

    <sql id="set.approval.pr" comment="결재 처리시 결재번호 세팅">
        <![CDATA[
            UPDATE ESPPRHD
               SET APRV_NO    = #aprv_docno#
               	  ,STS        = 'U'
                 ,MOD_DT      = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
             WHERE SYS_ID    = #sys_id# 
               AND PR_NO   = #pr_no#          
        ]]>
    </sql>

	<sql id="cancel.approval.pr" comment="결재 처리시 결재취소">
        <![CDATA[
           BEGIN
            UPDATE ESPPRHD
               SET APRV_STS      = #aprv_sts#
               ,STS              = 'U'
               ,MOD_DT           = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
             WHERE SYS_ID    = #sys_id# 
               AND PR_NO   = #pr_no#;
            END;         
        ]]>
    </sql>

    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                          조 달 공 통 END          ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                 구 매 요 청 조 회 쿼 리  START      ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    <!--
    ***************************************************************************************************************************
    ** @Description    : 구매요청 Default값 Setting
    ** @Author         : 김병철
    ** @Create Date    : 2012.05.24
    ** @History        : 1) 2012.05.24-최초 생성
    ***************************************************************************************************************************
    -->
    <sql id="select.prinfo.default" commnet="구매요청 Default값 Setting">
        <![CDATA[
            SELECT TOT.*
              FROM (
		            SELECT #s_comp_cd#                                   AS COMP_CD                   , --회사코드
		                   ( SELECT DTL_CD
		                       FROM (
		                             SELECT DTL_CD
		                               FROM ESACDDT
		                              WHERE SYS_ID  = #sys_id#
		                                AND COMP_CD = #s_comp_cd#
		                                AND GRP_CD  = 'P045'
		                               ORDER BY TO_NUMBER(SORT_ORD)
		                             )
		                      WHERE ROWNUM = 1 )                           AS PURC_TYP                   , --구매유형
		                   TO_CHAR(SYSDATE, 'YYYYMMDD')                    AS PR_REQ_DATE                , --구매요청일
		                   #s_reg_id#                                        AS PR_REQ_ID                  , --구매요청담당자ID
		                   USR_NM                                          AS PR_REQ_NM                  , --구매요청담당자명
		                   NVL( AUSR.PHONE_NO, AUSR.MOBILE_NO )            AS PR_REQ_PHONE_NO            , --구매요청자 전화번호
		                   DEPT_CD                                         AS PR_REQ_DEPT                , --구매요청자 부서
		                   (SELECT FC_GET_NAME(#sys_id#, #locale#, #s_comp_cd#, 'DEPT', AUSR.COMP_CD, AUSR.PLT_CD, AUSR.DEPT_CD, '', '', '') FROM DUAL) AS PR_REQ_DEPT_NM             , --구매요청부서 명
		                   0                                               AS PR_TOT_AMT                 , --구매요청 금액
		                   (SELECT FC_COMP_CUR(AUSR.SYS_ID, AUSR.COMP_CD) FROM DUAL)          AS CUR                        , --통화
		                   (SELECT FC_GET_NAME(#sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C003', FC_COMP_CUR(AUSR.SYS_ID, AUSR.COMP_CD), '', '', '', '') FROM DUAL) AS CUR_NM, --통화명
		                   'N'                                             AS ORGN_RPT_YN                , --시행품의여부
		                   'T'                                             AS APRV_STS                   , --결재상태
		                   '1'                                             AS PR_MOD_CNT                 , --구매요청 변경 회수
		                   'T'                                             AS PR_MOD_PROG_STS            , --구매요청 변경 상태
		                   #purc_req_typ#                                  AS PURC_REQ_TYP               , --구매요청유형
		                   'N'                                             AS PRE_BID                    , --선입찰
		                   DECODE( CODE.CNT, 1, CODE.DTL_CD   , '')        AS PURC_ORG                   , --구매조직(무조건 하나만 사용하기로 결정됨)
		                   DECODE( CODE.CNT, 1, CODE.DTL_CD_NM, '' )       AS PURC_ORG_NM                , --구매조직명(무조건 하나만 사용하기로 결정됨)
		                   SAP_GRP.DTL_CD                                  AS SAP_GRP_CD                 , --구매조직(무조건 하나만 사용하기로 결정됨)
                           SAP_GRP.DTL_CD_NM                               AS SAP_GRP_NM                 , --구매조직명(무조건 하나만 사용하기로 결정됨)
                           PURC_GRP.PURC_GRP_CD                            AS PURC_GRP_CD                , --구매조직(무조건 하나만 사용하기로 결정됨)
                           PURC_GRP.PURC_GRP_NM                            AS PURC_GRP_NM                , --구매조직명(무조건 하나만 사용하기로 결정됨)
		                   DECODE( PLNT.CNT, 1, PLNT.PLT_CD, '')           AS PLT_CD                     , --Plant
		                   DECODE( PLNT.CNT, 1, PLNT.PLT_NM, '')           AS PLT_NM                     , --Plant명
		                   ''                                           AS COST_TYP                        --회계계정지정범주
		              FROM ESAUSER AUSR,
		                   (  SELECT CDDL.SYS_ID     ,
		                             CDDL.COMP_CD    ,
		                             MAX( CDDT.DTL_CD    ) AS DTL_CD    ,
		                             MAX( CDDL.DTL_CD_NM ) AS DTL_CD_NM ,
		                             COUNT(*)          AS CNT
		                        FROM ESACDDT CDDT, ESACDDL CDDL
		                       WHERE CDDT.SYS_ID   =  #sys_id#
		                         AND CDDL.COMP_CD  =  DECODE( ( SELECT COMP_CLS_YN 
		                                                          FROM ESACDGP 
		                                                         WHERE SYS_ID = #sys_id# AND GRP_CD = 'C028' ), 'Y', #s_comp_cd#, 'N' )
		                         AND CDDT.GRP_CD   =  'C028'
		                         AND CDDT.USE_YN   =  'Y'
		                         AND CDDT.STS      <> 'D'
		                         AND CDDT.SYS_ID   =  CDDL.SYS_ID
		                         AND CDDT.COMP_CD  =  CDDL.COMP_CD
		                         AND CDDT.GRP_CD   =  CDDL.GRP_CD
		                         AND CDDT.DTL_CD   =  CDDL.DTL_CD
		                         AND CDDL.LANG_CD  =  #locale#
		                    GROUP BY CDDL.SYS_ID, CDDL.COMP_CD ) CODE ,
		                    ( SELECT TOT.SYS_ID, TOT.COMP_CD,
							         CASE 
							              WHEN TOT.CNT = 1
							                   THEN TOT.DTL_CD
   							              ELSE ''
							          END AS DTL_CD,
							         CASE 
							              WHEN TOT.CNT = 1
							                   THEN TOT.DTL_CD_NM
							              ELSE ''
							          END AS DTL_CD_NM
							    FROM 
				                    ( SELECT CDDL.SYS_ID,
										     CDDL.COMP_CD,
										     CDDT.DTL_CD,
										     CDDL.DTL_CD_NM,
										     RANK() OVER( ORDER BY TO_NUMBER(SORT_ORD)) AS RANK,
										     COUNT(*) OVER( PARTITION BY CDDT.GRP_CD ) AS CNT
		                                FROM ESACDDT CDDT, ESACDDL CDDL
		                               WHERE CDDT.SYS_ID   =  #sys_id#
		                                 AND CDDL.COMP_CD  =  DECODE( ( SELECT COMP_CLS_YN 
		                                                                  FROM ESACDGP 
		                                                                 WHERE SYS_ID = #sys_id# AND GRP_CD = 'C009' ), 'Y', #s_comp_cd#, 'N' )
		                                 AND CDDT.GRP_CD   =  'C009'
		                                 AND CDDT.USE_YN   =  'Y'
		                                 AND CDDT.STS      <> 'D'
		                                 AND CDDT.SYS_ID   =  CDDL.SYS_ID
		                                 AND CDDT.COMP_CD  =  CDDL.COMP_CD
		                                 AND CDDT.GRP_CD   =  CDDL.GRP_CD
		                                 AND CDDT.DTL_CD   =  CDDL.DTL_CD
		                                 AND CDDL.LANG_CD  =  #locale# ) TOT
		                         WHERE ROWNUM = 1
                                  ) SAP_GRP ,
                           ( SELECT TOT.SYS_ID, TOT.COMP_CD,
                                     CASE 
                                          WHEN TOT.CNT = 1
                                               THEN TOT.PURC_GRP_CD
                                          ELSE ''
                                      END AS PURC_GRP_CD,
                                     CASE 
                                          WHEN TOT.CNT = 1
                                               THEN TOT.PURC_GRP_NM
                                          ELSE ''
                                      END AS PURC_GRP_NM
                                FROM 
                                    ( SELECT SYS_ID,
                                             COMP_CD,
                                             PURC_GRP_CD,
                                             PURC_GRP_NM,
                                             RANK() OVER( ORDER BY ROWNUM) AS RANK,
                                             COUNT(*) OVER( PARTITION BY COMP_CD ) AS CNT
                                        FROM ESMJBMA
                                       WHERE SYS_ID  = #sys_id#
                                         AND COMP_CD = #s_comp_cd# ) TOT
                               WHERE ROWNUM = 1
                                ) PURC_GRP,
		                   ( SELECT SYS_ID,
		                            COMP_CD,
		                            MAX( PLT_CD ) AS PLT_CD,
		                            MAX( PLT_NM ) AS PLT_NM,
		                            COUNT(*)    AS CNT
		                       FROM 
				                   ( SELECT SYS_ID, 
				                            COMP_CD, 
				                            ORG_CD                        AS PLT_CD ,
				                            CASE WHEN #locale# = 'ko_KR' 
				                                      THEN ORG_NM_LOC
				                                 ELSE ORG_NM_ENG
				                             END                          AS PLT_NM 
				                       FROM ESAOGMG
				                      WHERE SYS_ID     = #sys_id#
				                        AND COMP_CD    = #s_comp_cd#
				                        AND ORG_TYP_CD <> 'ROOT'
				                        AND ORG_TYP_CD = 'PLANT'
				                        AND USE_YN = 'Y'
				                        AND STS <> 'D' )
		                   GROUP BY SYS_ID, COMP_CD ) PLNT
		             WHERE AUSR.SYS_ID  = #sys_id#
		               AND AUSR.COMP_CD = #s_comp_cd#
		               AND AUSR.USR_ID  = #s_reg_id#
		               AND AUSR.SYS_ID  = CODE.SYS_ID(+)
		               AND AUSR.COMP_CD = CODE.COMP_CD(+)
		               AND AUSR.SYS_ID  = PLNT.SYS_ID(+)
		               AND AUSR.COMP_CD = PLNT.COMP_CD(+)
		               AND AUSR.SYS_ID  = SAP_GRP.SYS_ID(+)
		               AND AUSR.COMP_CD = SAP_GRP.COMP_CD(+)
		               AND AUSR.SYS_ID  = PURC_GRP.SYS_ID(+)
		               AND AUSR.COMP_CD = PURC_GRP.COMP_CD(+)
		           ) TOT
        ]]>
    </sql>
    
    <sql id="select.espprhd.default.by.cntr" commnet="구매요청 Default값 Setting">
        <![CDATA[
            SELECT INHD.COMP_CD                                  AS COMP_CD                    , --회사코드
            	   INHD.OPER_ORG_SN								 AS OPER_ORG_SN                , --운영조직	
                   INHD.PURC_TYP                                 AS PURC_TYP                   , --구매유형
                   TO_CHAR(SYSDATE, 'YYYYMMDD')                  AS PR_REQ_DATE                , --구매요청일
                   #s_reg_id#                                    AS PR_REQ_ID                  , --구매요청담당자ID
                   USR_NM                                        AS PR_REQ_NM                  , --구매요청담당자명
                   NVL( AUSR.PHONE_NO, AUSR.MOBILE_NO )          AS PR_REQ_PHONE_NO            , --구매요청자 전화번호
                   DEPT_CD                                       AS PR_REQ_DEPT                , --구매요청자 부서
                   (SELECT FC_GET_NAME(#sys_id#, #locale#, #s_comp_cd#, 'DEPT', AUSR.COMP_CD, AUSR.PLT_CD, AUSR.DEPT_CD, '', '', '') FROM DUAL) AS PR_REQ_DEPT_NM             , --구매요청부서 명
                   0                                             AS PR_TOT_AMT                 , --구매요청 금액
                   (SELECT FC_COMP_CUR(AUSR.SYS_ID, AUSR.COMP_CD) FROM DUAL)        AS CUR     , --통화
                   (SELECT FC_GET_NAME(#sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C003', FC_COMP_CUR(AUSR.SYS_ID, AUSR.COMP_CD), '', '', '', '') FROM DUAL) AS CUR_NM,   
                   'N'                                           AS ORGN_RPT_YN                , --시행품의여부
                   'T'                                           AS APRV_STS                   , --결재상태
                   '1'                                           AS PR_MOD_CNT                 , --구매요청 변경 회수
                   'T'                                           AS PR_MOD_PROG_STS            , --구매요청 변경 상태
                   #purc_req_typ#                                AS PURC_REQ_TYP               , --구매요청유형
                   'N'                                           AS PRE_BID                    , --선입찰
                   DECODE( CODE.CNT, 1, CODE.DTL_CD, '')         AS PURC_ORG                   , --구매조직
                   DECODE( CODE.CNT, 1, CODE.DTL_CD_NM, '')      AS PURC_ORG_NM                , --구매조직명
                   DECODE( PLNT.CNT, 1, PLNT.PLT_CD, '')         AS PLT_CD                     , --Plant
                   DECODE( PLNT.CNT, 1, PLNT.PLT_NM, '')         AS PLT_NM                     , --Plant명
                   ( SELECT DTL_CD
                       FROM (
                             SELECT DTL_CD
                               FROM ESACDDT
                              WHERE SYS_ID  = #sys_id#
                                AND COMP_CD = #s_comp_cd#
                                AND GRP_CD  = 'P052'
                               ORDER BY TO_NUMBER(SORT_ORD)
                             )
                      WHERE ROWNUM = 1 )                         AS COST_TYP2                   --회계계정지정범주
              FROM ESPINHD INHD, ESAUSER AUSR,
                   (  SELECT CDDL.SYS_ID     ,
                             CDDL.COMP_CD    ,
                             MAX( CDDT.DTL_CD    ) AS DTL_CD    ,
                             MAX( CDDL.DTL_CD_NM ) AS DTL_CD_NM ,
                             COUNT(*)          AS CNT
                        FROM ESACDDT CDDT, ESACDDL CDDL
                       WHERE CDDT.SYS_ID   =  #sys_id#
                         AND CDDL.COMP_CD  =  DECODE( ( SELECT COMP_CLS_YN 
                                                          FROM ESACDGP 
                                                         WHERE SYS_ID = #sys_id# AND GRP_CD = 'C028' ), 'Y', #s_comp_cd#, 'N' )
                         AND CDDT.GRP_CD   =  'C028'
                         AND CDDT.USE_YN   =  'Y'
                         AND CDDT.STS      <> 'D'
                         AND CDDT.SYS_ID   =  CDDL.SYS_ID
                         AND CDDT.COMP_CD  =  CDDL.COMP_CD
                         AND CDDT.GRP_CD   =  CDDL.GRP_CD
                         AND CDDT.DTL_CD   =  CDDL.DTL_CD
                         AND CDDL.LANG_CD  =  #locale#
                    GROUP BY CDDL.SYS_ID, CDDL.COMP_CD ) CODE ,
                   ( SELECT SYS_ID,
                            COMP_CD,
                            MAX( PLT_CD ) AS PLT_CD,
                            MAX( PLT_NM ) AS PLT_NM,
                            COUNT(*)    AS CNT
                       FROM 
                           ( SELECT SYS_ID, 
                                    COMP_CD, 
                                    ORG_CD                        AS PLT_CD ,
                                    CASE WHEN #locale# = 'ko_KR' 
                                              THEN ORG_NM_LOC
                                         ELSE ORG_NM_ENG
                                     END                          AS PLT_NM 
                               FROM ESAOGMG
                              WHERE SYS_ID     = #sys_id#
                                AND COMP_CD    = #s_comp_cd#
                                AND ORG_TYP_CD <> 'ROOT'
                                AND ORG_TYP_CD = 'PLANT'
                                AND USE_YN = 'Y'
                                AND STS <> 'D' )
                   GROUP BY SYS_ID, COMP_CD ) PLNT
             WHERE INHD.SYS_ID        = #sys_id#
               AND INHD.COMP_CD       = #s_comp_cd#
               AND INHD.PRICE_CNTR_NO = #price_cntr_no#
               AND INHD.SYS_ID        = AUSR.SYS_ID
               AND INHD.COMP_CD       = AUSR.COMP_CD
               AND AUSR.USR_ID        = #s_reg_id#
               AND AUSR.SYS_ID        = CODE.SYS_ID(+)
               AND AUSR.COMP_CD       = CODE.COMP_CD(+) 
               AND AUSR.SYS_ID        = PLNT.SYS_ID(+)
               AND AUSR.COMP_CD       = PLNT.COMP_CD(+)
        ]]>
    </sql>
    
    <sql id="select.espprdt.default.by.cntr" comment="PR 디테일(espprdt) 조회">
        <![CDATA[
            SELECT TOT.*,
                   (SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'OGMG', 'PLANT', TOT.PLT_CD, '', '', '', '') 
                        FROM DUAL)                                                                                                 AS PLT_NM        , --Plant 명
                   (SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'VENDOR', TOT.REF_VD, '', '', '', '', '') 
                        FROM DUAL )                                                                                                AS REF_VD_NM     , --참조업체 명
                   (SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'WHNM', 'PLANT', TOT.PLT_CD, TOT.WH_CD, '', '', '') 
                        FROM DUAL)                                                                                                 AS WH_NM         , --창고 명
                   (SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C009', TOT.SAP_GRP_CD, '', '', '', '') 
                        FROM DUAL)                                                                                                 AS SAP_GRP_NM    , --구매그룹 명
                   (SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'PURC_GRP', 'PU', TOT.PURC_GRP_CD, '', '', '', '') 
                        FROM DUAL)                                                                                                 AS PURC_GRP_NM   , --구매그룹 명
                   ( SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C029', TOT.CATE_CD, '', '', '', '')                          
                        FROM DUAL )                                                                                                AS CATE_NM       , --자재그룹명
                   ( SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C022', TOT.AUTO_PO_YN, '', '', '', '') 
                          FROM DUAL )                                                                                              AS AUTO_PO_YN_NM   --자동발주여부
                   
              FROM (     
                    SELECT INDT.SYS_ID                                                               AS SYS_ID                          , --시스템 아이디
                           INDT.COMP_CD                                                              AS COMP_CD                         , --회사 코드
                           INDT.PRICE_CNTR_LNO                                                       AS PRICE_CNTR_LNO                  ,
                           INDT.PURC_TYP                                                             AS PURC_TYP                        , --구매 유형 P045 (MT:물품, CT:공사/용역, MC:물품/공사/용역)
                           INDT.PURC_GRP_CD                                                          AS PURC_GRP_CD                     ,
                           INDT.COST_TYP                                                             AS COST_TYP                        , --회계계정지정범주 P052
                           INDT.PLT_CD                                                               AS PLT_CD                          , --공장 코드
                           INDT.ITEM_CD                                                              AS ITEM_CD                         , --품목 코드
                           INDT.ITEM_NM                                                              AS ITEM_NM                         , --품목 명
                           INDT.ITEM_EN_NM                                                           AS ITEM_EN_NM                      , --품목 영문명
                           INDT.SPEC                                                                 AS SPEC                            , --규격
                           INDT.UNIT_CD                                                              AS UNIT_CD                         , --단위 코드
                           INDT.PRICE_UNIT                                                           AS PRICE_UNIT                      , --가격단위
                           INDT.ITEM_QTY                                                             AS ITEM_QTY                        , --품목 수량
                           INDT.CUR                                                                  AS CUR                             , --통화 C003
                           INDT.ITEM_PRICE                                                           AS PR_PRICE                        , --구매요청 단가
                           INDT.ITEM_QTY * INDT.ITEM_PRICE                                           AS PR_AMT                          , --구매요청 금액
                           INHD.VD_CD                                                                AS REF_VD                          , --참조 업체
                           INDT.CATE_CD                                                              AS CATE_CD                         , --분류 코드
                           INDT.WH_CD                                                                AS WH_CD                           , --창고 코드
                           INDT.RD_LOCAT                                                             AS RD_LOCAT                        , --납품요청 장소
                           INHD.PRICE_CNTR_NO                                                        AS PRICE_CNTR_NO                   , --계약번호
                           INDT.ITEM_CATE                                                            AS ITEM_CATE                       , --품목범주
                           INDT.PURC_ORG                                                             AS PURC_ORG                        , --구매조직
                           INDT.SG_SN                                                                AS SG_SN                           , --SG일련번호
                           INDT.SG_CD                                                                AS SG_CD                           , --SG코드
                           INDT.OPER_ORG_SN                                                          AS OPER_ORG_SN                     , --운영 조직 일련번호
                           INDT.PRD_SD                                                               AS PRD_SD                          , --프로젝트 시작일
                           INDT.PRD_ED                                                               AS PRD_ED                          , --프로젝트 종료일
                           INDT.RD_DATE                                                              AS RD_DATE                         , --납품요청일
                           INDT.SAP_ITEM_YN                                                          AS SAP_ITEM_YN                     , --ERP 아이템 관리여부
                           INDT.SAP_ITEM_CD                                                          AS SAP_ITEM_CD                     , --ERP 아이템 코드
                           INDT.SAP_GRP_CD                                                           AS SAP_GRP_CD                      , --ERP 구매그룹 코드
                           INDT.SAP_CATE_CD                                                          AS SAP_CATE_CD                     , --ERP 자재그룹 코드
                           1                                                                         AS PR_MOD_CNT                      , --구매요청 변경 회수
                           FC_GET_SG_SN_NAME(INDT.SYS_ID, INDT.SG_SN)                                   AS SG_NM                           , -- SG 명
                           INDT.AUTO_PO_YN                                                           AS AUTO_PO_YN                      ,
                           INHD.CNTR_NO                                                              AS CNTR_NO
                       FROM ESPINDT INDT, ESPINHD INHD
                      WHERE INDT.SYS_ID        = #sys_id#
                        AND INDT.COMP_CD       = #s_comp_cd#
                        AND INDT.PRICE_CNTR_NO = #price_cntr_no#
                        AND INDT.SYS_ID        = INHD.SYS_ID
                        AND INDT.COMP_CD       = INHD.COMP_CD
                        AND INDT.PRICE_CNTR_NO = INHD.PRICE_CNTR_NO
                        AND INDT.STS           <> 'D'
                    ) TOT
           ORDER BY TO_NUMBER(TOT.PRICE_CNTR_LNO)
        ]]>
    </sql>   
    
    <!--
    ***************************************************************************************************************************
    ** @Description    : PR 헤더(espprhd) 조회
    ** @Author         : phatchul
    ** @Create Date    : 2012.04.17
    ** @History        : 1) 2012.04.17-최초 생성
    **                   2) 2012.06.14 - copy_flag = 'Y'인 경우에는 기존 정보에서 PR번호 등을 Clear 시킨다.
    ***************************************************************************************************************************
    -->
    <sql id="select.espprhd" comment="PR 헤더(espprhd) 조회">
        <![CDATA[
            SELECT TOT.*,
                   (SELECT FC_GET_NAME( TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'DEPT', TOT.COMP_CD, TOT.PLT_CD, TOT.DEPT_CD, '', '', '') 
                      FROM DUAL)                                                                                                     AS PR_REQ_DEPT_NM  , --구매요청부서명
                   (SELECT FC_GET_NAME( TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'USER', TOT.APRV_ID,  '', '', '', '', '')   
                      FROM DUAL)                                                                                                     AS APRV_USR_NM     , --승인자 명
                   (SELECT FC_GET_NAME( TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'P011', TOT.TMP_APRV_STS, '', '', '', '') 
                      FROM DUAL)                                                                                                     AS APRV_STS_NM     , --결재진행상태
                   (SELECT FC_GET_NAME( TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'C003', TOT.CUR, '', '', '', '') 
                      FROM DUAL)                                                                                                     AS CUR_NM,
                   OPER_ORG_SN
              FROM (
		            SELECT PRHD.SYS_ID                                                                                 AS SYS_ID          , --시스템아이디
		                   PRHD.COMP_CD                                                                                AS COMP_CD         , --회사 코드 
		                   #locale#                                                                                    AS LOCALE          , -- 언어
                           DECODE( #copy_flag#, 'Y', '', PRHD.PR_NO )                                                  AS PR_NO           , --구매요청 번호 
		                   PRHD.PR_TIT                                                                                 AS PR_TIT          , --구매요청 제목 
		                   PRHD.PURC_TYP                                                                               AS PURC_TYP        , --구매유형(MT:물품, CT:공사/용역, MC:물품/공사/용역)
		                   PRHD.PR_TYP                                                                                 AS PR_TYP          , --구매요청Type [P053] [ERP 전송 코드]
		                   PRHD.PURC_REQ_TYP                                                                           AS PURC_REQ_TYP    , --구매요청방식(NC;일반계약, UC:단가계약) 
		                   DECODE( #copy_flag#, 'Y', TO_CHAR(SYSDATE, 'YYYYMMDD'), PRHD.PR_REQ_DATE              )     AS PR_REQ_DATE     , --구매요청일 
		                   DECODE( #copy_flag#, 'Y', #s_reg_id#, PRHD.PR_REQ_ID                                  )     AS PR_REQ_ID       , --구매요청자 아이디 
		                   DECODE( #copy_flag#, 'Y', LOUR.USR_NM, AUSR.USR_NM                                    )     AS PR_REQ_NM       , --요청자 명
		                   DECODE( #copy_flag#, 'Y', NVL( LOUR.PHONE_NO, LOUR.MOBILE_NO ), PRHD.PR_REQ_PHONE_NO  )     AS PR_REQ_PHONE_NO , --구매요청자 전화번호
		                   DECODE( #copy_flag#, 'Y', LOUR.DEPT_CD, PRHD.PR_REQ_DEPT                              )     AS PR_REQ_DEPT     , --구매요청부서
		                   PRHD.PR_TOT_AMT                                                                             AS PR_TOT_AMT      , --구매요청 전체금액 
		                   PRHD.CUR                                                                                    AS CUR             , --통화 
		                   PRHD.ORDER_NUM                                                                              AS ORDER_NUM       ,
		                   PRHD.PRE_BID                                                                                AS PRE_BID         , --선입찰 
		                   DECODE( #copy_flag#, 'Y', 'N', PRHD.ORGN_RPT_YN      )                                      AS ORGN_RPT_YN     , --시행품의사용여부                                                      
		                   DECODE( #copy_flag#, 'Y', '',  PRHD.ORGN_RPT_NO      )                                      AS ORGN_RPT_NO     , --시행품의번호                                                          
		                   DECODE( #copy_flag#, 'Y', '',  PRHD.ORGN_RPT_ATT_NO  )                                      AS ORGN_RPT_ATT_NO , --시행품의 첨부파일번호                                                 
		                   PRHD.BIZ_PLACE                                                                              AS BIZ_PLACE       , --사업장                                                
		                   PRHD.BIZ_PLACE_NM                                                                           AS BIZ_PLACE_NM    , --사업장명                                              
		                   PRHD.CONST_AREA_P                                                                           AS CONST_AREA_P    , --공사면적 평                                           
		                   PRHD.CONST_AREA_M                                                                           AS CONST_AREA_M    , --공사면적 m2                                           
		                   PRHD.STORE_FRM                                                                              AS STORE_FRM       , --매장형태                                              
		                   PRHD.CONST_PRD_SD                                                                           AS CONST_PRD_SD    , --공사기간 FROM                                         
		                   PRHD.CONST_PRD_ED                                                                           AS CONST_PRD_ED    , --공사시간 TO                                           
		                   PRHD.CONST_COST_SUPT                                                                        AS CONST_COST_SUPT , --공사비지원                                            
		                   PRHD.PR_REM                                                                                 AS PR_REM          , --특이사항                                                              
		                   PRHD.REF_VD_CAUSE                                                                           AS REF_VD_CAUSE    , --추천업체사유                                                          
		                   PRHD.PR_PRC_RATE                                                                            AS PR_PRC_RATE     , -- 		                                                            
		                   DECODE( #copy_flag#, 'Y', '', PRHD.APRV_NO          )                                       AS APRV_NO         , --결재번호                                                              
		                   DECODE( #copy_flag#, 'Y', '', PRHD.APRV_URL         )                                       AS APRV_URL        , --결재번호
		                   DECODE( #copy_flag#, 'Y', '', PRHD.ELEC_APRV_YN     )                                       AS ELEC_APRV_YN    , --전자결재여부(Y:전자결재, Default:Y)                                   
		                   CASE WHEN #copy_flag# = 'Y' OR #mod_flag# = 'Y'
                                     THEN ''
                                ELSE PRHD.APRV_STS
                            END                                                                                        AS APRV_STS        , --결재상태 [P011] (T:작성중, P:결재중, C:결재승인, B:반려, N:결재취소)
                           CASE WHEN #copy_flag# = 'Y' OR #mod_flag# = 'Y'
                                     THEN ''
                                ELSE CASE WHEN PRHD.ELEC_APRV_YN = 'N' AND PRHD.APRV_STS = 'C'
                                               THEN 'K'
                                          ELSE PRHD.APRV_STS
                                      END
                            END                                                                                        AS TMP_APRV_STS      ,
                             
		                   CASE WHEN #copy_flag# = 'Y' OR #mod_flag# = 'Y'
                                     THEN ''
                                ELSE PRHD.APRV_ID
                            END                                                                                        AS APRV_ID         , --승인자 아이디                                                         
		                   CASE WHEN #copy_flag# = 'Y' OR #mod_flag# = 'Y'
                                     THEN ''
                                ELSE PRHD.APRV_DATE
                            END                                                                                        AS APRV_DATE       , --승인일                                                                
		                   DECODE( #copy_flag#, 'Y', '', PRHD.ATT_NO           )                                       AS ATT_NO          , --첨부파일번호                                                          
		                   CASE WHEN #copy_flag# = 'Y'
		                             THEN 1
		                        ELSE CASE WHEN #mod_flag# = 'Y'
		                                       THEN NVL( PRHD.PR_MOD_CNT, 1 ) + 1
		                                  ELSE PRHD.PR_MOD_CNT
		                              END
		                         END                                                                                   AS PR_MOD_CNT      , --구매요청 변경 회수 
		                   CASE WHEN #copy_flag# = 'Y' OR #mod_flag# = 'Y'
		                             THEN 'T'
		                        ELSE PRHD.PR_MOD_PROG_STS
		                    END                                                                                        AS PR_MOD_PROG_STS , --변경요청 진행 상태 [P040] (T:대상, A:변경승인, B:변경거부, R:변경요청)
		                   PRHD.PR_TARG_SRC                                                                            AS PR_TARG_SRC     , --Legacy PR 타켓                                                        
		                   PRHD.PR_TARG_SRC_NM                                                                         AS PR_TARG_SRC_NM  , --Legacy PR 타켓명                                                      
		                   DECODE( #copy_flag#, 'Y', '', PRHD.IF_REJECT_YN    )                                        AS IF_REJECT_YN    , --I/F 반송여부(Y:반송가능, Default:N)                                   
		                   DECODE( #copy_flag#, 'Y', '', PRHD.IF_FLAG         )                                        AS IF_FLAG         , --I/F 성공여부(S:성공,E:실패)                                           
		                   DECODE( #copy_flag#, 'Y', '', PRHD.IF_DATE         )                                        AS IF_DATE         , --I/F 날짜                                                              
		                   DECODE( #copy_flag#, 'Y', '', PRHD.IF_MSG          )                                        AS IF_MSG          , --I/F Message                                                           
		                   PRHD.MIG_YN                                                                                 AS MIG_YN          , --Migration여부(Y:Migration, Default:N)
		                   PRHD.IF_TYP                                                                                 AS IF_TYP          , --I/F 타입(S:Send, R:Receive)
		                   DECODE( #copy_flag#, 'Y', '', PRHD.SAP_PR_NO              )                                 AS SAP_PR_NO       , --ERP PR NO
                           DECODE( #copy_flag#, 'Y', LOUR.PLT_CD, AUSR.PLT_CD        )                                 AS PLT_CD          , --사용자 Plant코드
                           DECODE( #copy_flag#, 'Y', LOUR.DEPT_CD, AUSR.DEPT_CD      )                                 AS DEPT_CD         , --사용자 부서코드
                           NVL( #mod_flag#, 'N' )                                                                      AS TMP_MOD_FLAG    ,
                           PRHD.OPER_ORG_SN                                                                                               ,
                           PRHD.RELEASE_REQ_CAUSE                                                                                         ,
                           PRHD.RELEASE_REJECT_CAUSE
		              FROM ESPPRHD PRHD, ESAUSER AUSR,
		                   ( SELECT *
                               FROM ESAUSER
                              WHERE SYS_ID  = #sys_id#
                                AND COMP_CD = #s_comp_cd#
                                AND USR_ID  = #s_reg_id# ) LOUR 
		             WHERE PRHD.SYS_ID    = #sys_id#
		               AND PRHD.COMP_CD   = #s_comp_cd#
		               AND PRHD.PR_NO     = #pr_no#
		               AND PRHD.STS       <> 'D'
		               AND PRHD.SYS_ID    = AUSR.SYS_ID(+)
		               AND PRHD.COMP_CD   = AUSR.COMP_CD(+)
		               AND PRHD.PR_REQ_ID = AUSR.USR_ID(+) 
		               AND PRHD.SYS_ID    = LOUR.SYS_ID(+)
		               AND PRHD.COMP_CD   = LOUR.COMP_CD(+)
		           ) TOT
        ]]>
    </sql>

    <sql id="select.espprdt" comment="PR 디테일(espprdt) 조회">
        <![CDATA[
            SELECT TOT.*,
                   CASE WHEN TOT.COPY_FLAG = 'Y' 
                             THEN CASE WHEN TOT.PRC_VALID_YN = 0
                                            THEN ''
                                       ELSE TMP_PRICE_CNTR_NO
                                   END
                        ELSE TMP_PRICE_CNTR_NO 
                    END                                                                                                            AS PRICE_CNTR_NO                   ,
                   CASE WHEN TOT.COPY_FLAG = 'Y' 
                             THEN CASE WHEN TOT.PRC_VALID_YN = 0
                                            THEN ''
                                       ELSE TMP_CNTR_NO
                                   END
                        ELSE TMP_CNTR_NO 
                    END                                                                                                            AS CNTR_NO                         ,
                   CASE WHEN TOT.COPY_FLAG = 'Y' 
                             THEN CASE WHEN TOT.PRC_VALID_YN = 0
                                            THEN ''
                                       ELSE TMP_CNTR_LNO
                                   END
                        ELSE TMP_CNTR_LNO 
                    END                                                                                                            AS CNTR_LNO                        ,
                   CASE WHEN TOT.COPY_FLAG = 'Y' 
                             THEN CASE WHEN TOT.PRC_VALID_YN = 0
                                            THEN 'N'
                                       ELSE TMP_AUTO_PO_YN
                                   END
                        ELSE TMP_AUTO_PO_YN 
                    END                                                                                                            AS AUTO_PO_YN                      ,
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'C022', CASE WHEN TOT.COPY_FLAG = 'Y' 
                                                                                                    THEN CASE WHEN TOT.PRC_VALID_YN = 0
                                                                                                                   THEN 'N'
                                                                                                              ELSE TMP_AUTO_PO_YN
                                                                                                          END
                                                                                               ELSE TMP_AUTO_PO_YN 
                                                                                           END, '', '', '', '') 
                          FROM DUAL )                                                                                              AS AUTO_PO_YN_NM                   , --자동발주여부
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'OGMG', 'PLANT', TOT.PLT_CD, '', '', '', '') 
                       FROM DUAL )                                                                                                 AS PLT_NM                          , --Plant 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'VENDOR', TOT.REF_VD, '', '', '', '', '')
                       FROM DUAL )                                                                                                 AS REF_VD_NM                       , --참조업체 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'C029', TOT.CATE_CD, '', '', '', '')
                       FROM DUAL )                                                                                                 AS CATE_NM                         , --분류 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'WHNM', 'PLANT', TOT.PLT_CD, TOT.WH_CD, '', '', '') 
                       FROM DUAL )                                                                                                 AS WH_NM                           , --창고 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'C009', TOT.SAP_GRP_CD, '', '', '', '')     
                      FROM DUAL )                                                                                                  AS SAP_GRP_NM                      , --구매그룹 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'PURC_GRP', 'PU', TOT.PURC_GRP_CD, '', '', '', '') 
                      FROM DUAL )                                                                                                  AS PURC_GRP_NM                     , --구매그룹 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'P040', TOT.MOD_REQ_PROG_STS, '', '', '', '')  
                      FROM DUAL )                                                                                                  AS MOD_REQ_PROG_STS_NM             , --변경요청 진행상태 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'DEPT', TOT.COMP_CD, TOT.PLT_CD, TOT.TBE_DEPT_CD, '', '', '')
                       FROM DUAL )                                                                                                 AS TBE_DEPT_NM                     , --부서명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'C028', TOT.PURC_ORG, '', '', '', '')            
                       FROM DUAL )                                                                                                 AS PURC_ORG_NM                     , --구매조직명
                   NVL( TRIM(TOT.PR_SUG_TEXT), 
                      ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'USER', TOT.PR_SUG_ID,  '', '', '', '', '')     
                          FROM DUAL ) )                                                                                            AS PR_SUG_NM                       , --구매의뢰자
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'USER', TOT.GR_CHR_ID,  '', '', '', '', '')              
                          FROM DUAL )                                                                                              AS GR_CHR_NM                       , --검수담당자
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'C029', TOT.CATE_CD, '', '', '', '')                          
                        FROM DUAL )                                                                                                AS CATE_NM                         , --자재그룹명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'P045', TOT.PURC_TYP, '', '', '', '')                          
                        FROM DUAL )                                                                                                AS PURC_TYP_NM                     ,  
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'P052', TOT.COST_TYP, '', '', '', '')                          
                        FROM DUAL )                                                                                                AS COST_TYP_NM                     ,
                   CASE
                   		WHEN TOT.STS = 'D'          
                        			THEN ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'C026', TOT.STS, '', '', '', '') FROM DUAL ) 
                        ELSE ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'P044', TOT.PR_PROG_STS, '', '', '', '') FROM DUAL )       
                   END                                                                                                             AS STS_NM                          ,
                   CASE WHEN TOT.PR_PROG_STS IN ('RQ','RA','RB','RW','RV') /* 구매요청 진행상태가 변경요청,변경승인,변경반려,접수대기 인 경우에만 변경요청이 가능하다. 구매접수(RV)도 추가(2013.02.07) */
                             THEN 'Y'
                        ELSE 'N'
                   END                                                                                                             AS MOD_REQ_ABLE                    ,
                   CASE 
                   	  WHEN TOT.PR_PROG_STS = 'RD' THEN 'A'
                      WHEN TOT.STS = 'D' THEN 'A'
                      ELSE 'B'        
                   END                                                                                                             AS STS_CD                                    
              FROM (     
		            SELECT PRDT.SYS_ID                                                               AS SYS_ID                          , --시스템 아이디
		                   PRDT.COMP_CD                                                              AS COMP_CD                         , --회사 코드
		                   DECODE( #copy_flag#, 'Y', '', PRDT.PR_NO  )                               AS PR_NO                           , --구매요청 번호
		                   DECODE( #copy_flag#, 'Y', '', PRDT.PR_LNO )                               AS PR_LNO                          , --구매요청 항번
		                   PRDT.PR_LNO                                                               AS TMP_PR_LNO                      , --
		                   NVL( #copy_flag#, 'N' )                                                   AS COPY_FLAG                       ,
		                   PRDT.REP_CD_YN															   AS REP_CD_YN						  , --대표품목 여부
		                   DECODE( #copy_flag#, 'Y', 'I', '' )                                       AS EDITSTATUS                      ,
                           DECODE( #copy_flag#, 'Y', '', 
                             TO_NUMBER(NVL(PRDT.SAP_PR_LNO, PRDT.PR_LNO) ) )                         AS LINE_NO                         , --LINE NO                                                        
		                   PRDT.PURC_TYP                                                             AS PURC_TYP                        , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)
		                   PRDT.COST_TYP                                                             AS COST_TYP                        , --회계계정지정범주 [P052]                  
		                   PRDT.PLT_CD                                                               AS PLT_CD                          , --공장 코드
		                   ( SELECT CATE4_CD 
                               FROM ESMMTGL 
                              WHERE SYS_ID  = PRDT.SYS_ID 
                                AND ITEM_CD = PRDT.ITEM_CD 
                                AND USE_COMP_CD  LIKE  '%' || UPPER(#s_comp_cd#) ||',%'
                                AND STS    <> 'D' 
                           )                                                                         AS CATE4_CD                        ,                                                             
		                   PRDT.ITEM_CD                                                              AS ITEM_CD                         , --품목 코드                                                            
		                   PRDT.ITEM_NM                                                              AS ITEM_NM                         , --품목 명                                                              
		                   PRDT.ITEM_EN_NM                                                           AS ITEM_EN_NM                      , --품목 영문명                                                          
		                   PRDT.SPEC                                                                 AS SPEC                            , --규격                                                                 
		                   PRDT.UNIT_CD                                                              AS UNIT_CD                         , --단위 코드                                                            
		                   PRDT.PRICE_UNIT                                                           AS PRICE_UNIT                      , --가격단위                                                             
		                   PRDT.ITEM_QTY                                                             AS ITEM_QTY                        , --품목 수량                                                            
		                   PRDT.CUR                                                                  AS CUR                             , --통화 [C003]                                                          
		                   PRDT.PR_PRICE                                                             AS PR_PRICE                        , --구매요청 단가                                                        
		                   PRDT.PR_AMT                                                               AS PR_AMT                          , --구매요청 금액                                                        
		                   PRDT.REF_VD                                                               AS REF_VD                          , --참조 업체                                                            
		                   PRDT.SAP_VD_CD                                                            AS SAP_VD_CD                       , --참조 업체
		                   PRDT.CATE_CD                                                              AS CATE_CD                         , --분류 코드                                                            
		                   PRDT.WH_CD                                                                AS WH_CD                           , --창고 코드                                                            
		                   PRDT.RD_LOCAT                                                             AS RD_LOCAT                        , --납품요청 장소
		                   PRDT.TBE_EVAL_YN                                                          AS TBE_EVAL_YN                     , --기술검토여부                                                        
		                   PRDT.TBE_DEPT_CD                                                          AS TBE_DEPT_CD                     , --기술검토 부서 코드                                                   
		                   PRDT.PURC_GRP_CD                                                          AS PURC_GRP_CD                     , --구매 그룹 코드
		                   PRDT.PR_SUG_ID                                                            AS PR_SUG_ID                       , --구매의뢰자
		                   PRDT.PR_SUG_TEXT                                                          AS PR_SUG_TEXT                     , --구매의뢰자텍스트
		                   PRDT.GR_CHR_ID                                                            AS GR_CHR_ID                       , --검수담당자
		                   PRDT.PRICE_CNTR_NO                                                        AS TMP_PRICE_CNTR_NO               , --계약번호
		                   PRDT.CNTR_NO                                                              AS TMP_CNTR_NO                     , --계약번호
		                   ( SELECT MAX(PRC_CHG_YN)
		                       FROM ESPINFO
		                      WHERE SYS_ID  = PRDT.SYS_ID
		                        AND COMP_CD = PRDT.COMP_CD
		                        AND CNTR_NO = PRDT.CNTR_NO
		                        AND APPLY_SD  <= TO_CHAR(SYSDATE,'YYYYMMDD')
                                AND APPLY_ED  >= TO_CHAR(SYSDATE,'YYYYMMDD') )                       AS PRC_CHG_YN                      ,
		                   PRDT.CNTR_LNO                                                             AS TMP_CNTR_LNO                    , --계약번호항번
		                   PRDT.ITEM_CATE                                                            AS ITEM_CATE                       , --품목범주
		                   PRDT.PURC_ORG                                                             AS PURC_ORG                        , --구매조직
		                   PRDT.SG_SN                                                                AS SG_SN                           , --SG일련번호                                                           
		                   PRDT.SG_CD                                                                AS SG_CD                           , --SG코드                                                               
		                   PRDT.OPER_ORG_SN                                                          AS OPER_ORG_SN                     , --운영 조직 일련번호                                                   
		                   PRDT.PRD_SD                                                               AS PRD_SD                          , --프로젝트 시작일                                                      
		                   PRDT.PRD_ED                                                               AS PRD_ED                          , --프로젝트 종료일                                                      
		                   PRDT.RD_DATE                                                              AS RD_DATE                         , --납품요청일
		                   PRDT.PLAT_CD                                                              AS PLAT_CD                         , --플랫폼 
		                   PRDT.PLAT_SVC_CD                                                          AS PLAT_SVC_CD                     , --서비스 
		                   PRDT.CUST_INFO_TREAT_YN                                                   AS CUST_INFO_TREAT_YN              , --고객정보취급여부 
		                   PRDT.ATT_NO                                                               AS ATT_NO                          , --첨부 번호
		                   DECODE( #copy_flag#, 'Y', 'C', PRDT.STS        )                          AS STS                             ,                                                             
		                   DECODE( #copy_flag#, 'Y', '', PRDT.REJECT_CAUSE)                          AS REJECT_CAUSE                    , --반려 사유                                                            
		                   DECODE( #copy_flag#, 'Y', 0, PRDT.RFQ_QTY      )                          AS RFQ_QTY                         , --견적요청 수량                                                        
		                   DECODE( #copy_flag#, 'Y', 0, PRDT.PO_QTY       )                          AS PO_QTY                          , --발주 수량                                                            
		                   DECODE( #copy_flag#, 'Y', 0, PRDT.AR_QTY       )                          AS AR_QTY                          , --검수요청 수량                                                            
		                   DECODE( #copy_flag#, 'Y', 0, PRDT.GR_QTY       )                          AS GR_QTY                          , --입고 수량                                                            
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.PO_END_YN  )                          AS PO_END_YN                       , --발주 종료 여부                                                       
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.GR_END_YN  )                          AS GR_END_YN                       , --입고 종료 여부                                                       
		                   PRDT.EMG_YN                                                               AS EMG_YN                          , --긴급 여부                                                            
		                   PRDT.AUTO_PO_YN                                                           AS TMP_AUTO_PO_YN                  , --자동발주여부                                                         
		                   CASE WHEN #copy_flag# = 'Y' OR #mod_flag# = 'Y'
		                             THEN ''
		                        ELSE PRDT.PR_PROG_STS
		                    END                                                                      AS PR_PROG_STS                     , --구매요청 진행 상태 [P044]                                            
		                   DECODE( #copy_flag#, 'Y', '', PRDT.SAP_PR_NO   )                          AS SAP_PR_NO                       , --ERP PR NO                                                            
		                   DECODE( #copy_flag#, 'Y', '', PRDT.SAP_PR_LNO  )                          AS SAP_PR_LNO                      , --ERP PR LNO
		                   PRDT.SAP_ITEM_YN                                                          AS SAP_ITEM_YN                     , --ERP 아이템 관리여부
		                   PRDT.SAP_ITEM_CD                                                          AS SAP_ITEM_CD                     , --ERP 아이템 코드
		                   PRDT.SAP_GRP_CD                                                           AS SAP_GRP_CD                      , --ERP 구매그룹 코드
		                   PRDT.SAP_CATE_CD                                                          AS SAP_CATE_CD                     , --ERP 자재그룹 코드
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.SAP_DEL_YN )                          AS SAP_DEL_YN                      , --ERP 삭제여부
		                   PRDT.IF_TYP                                                               AS IF_TYP                          , --I/F성공여부(S:성공,E:실패)
		                   PRDT.IF_REJECT_YN                                                         AS IF_REJECT_YN                    , --I/F 반송여부(Y:반송가능, Default:N)                                                                     
		                   DECODE( #copy_flag#, 'Y', '', PRDT.IF_FLAG              )                 AS IF_FLAG                         , --I/F성공여부(S:성공,E:실패)                                           
		                   DECODE( #copy_flag#, 'Y', '', PRDT.IF_DATE              )                 AS IF_DATE                         , --I/F날짜                                                              
		                   DECODE( #copy_flag#, 'Y', '', PRDT.IF_MSG               )                 AS IF_MSG                          , --I/F Message                                                          
		                   DECODE( #copy_flag#, 'Y', '', PRDT.MOD_REQ_PROG_STS     )                 AS MOD_REQ_PROG_STS                , --변경 요청 진행 상태 [P040] (P : 요청중, A : 대상, R : 거부, C : 승인)
		                   DECODE( #copy_flag#, 'Y', '', PRDT.MOD_STS              )                 AS MOD_STS                         , --변경 상태                                                            
		                   CASE WHEN #copy_flag# = 'Y'
                                     THEN 1
                                ELSE CASE WHEN #mod_flag# = 'Y'
                                               THEN NVL( PRDT.PR_MOD_CNT, 1 ) + 1
                                          ELSE PRDT.PR_MOD_CNT
                                      END
                                 END                                                                 AS PR_MOD_CNT      , --구매요청 변경 회수 
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.ACC_MOD_YN          )                 AS ACC_MOD_YN                      , --계정 변경 여부                                                       
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.ATT_MOD_YN          )                 AS ATT_MOD_YN                      , --첨부 변경 여부                                                       
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.ITEM_MOD_YN         )                 AS ITEM_MOD_YN                     , --품목 변경 여부                                                       
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.PR_MOD_YN           )                 AS PR_MOD_YN                       , --구매요청 변경 여부                                                   
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.QTY_MOD_YN          )                 AS QTY_MOD_YN                      , --수량 변경 여부                                                       
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.RD_MOD_YN           )                 AS RD_MOD_YN                       , --납품요청 변경 여부                                                   
		                   DECODE( #copy_flag#, 'Y', 'N', PRDT.SVC_MOD_YN          )                 AS SVC_MOD_YN                      , --서비스 변경 여부                                                     
		                   DECODE( #copy_flag#, 'Y', '', PRDT.RELEASE_FLAG         )                 AS RELEASE_FLAG                    , --릴리즈 플래그                                                        
		                   DECODE( #copy_flag#, 'Y', '', PRDT.RELEASE_REQ_ID       )                 AS RELEASE_REQ_ID                  , --릴리즈 요청자 아이디                                                 
		                   DECODE( #copy_flag#, 'Y', '', PRDT.RELEASE_REQ_DT       )                 AS RELEASE_REQ_DT                  , --릴리즈 요청 일시                                                     
		                   DECODE( #copy_flag#, 'Y', '', PRDT.RELEASE_APRV_ID      )                 AS RELEASE_APRV_ID                 , --릴리즈 승인자 아이디                                                 
		                   DECODE( #copy_flag#, 'Y', '', PRDT.RELEASE_APRV_DT      )                 AS RELEASE_APRV_DT                 , --릴리즈 승인 일시                                                     
		                   DECODE( #copy_flag#, 'Y', '', PRDT.RELEASE_REQ_CAUSE    )                 AS RELEASE_REQ_CAUSE               , --릴리즈 요청 사유                                                     
		                                                                         ''                 AS RELEASE_REJECT_CAUSE            , --릴리즈 반려 사유
		                   FC_GET_SG_SN_NAME(PRDT.SYS_ID, PRDT.SG_SN)                                   AS SG_NM                           , -- SG 명
		                   ( SELECT COUNT(1)                                                                                       
		                       FROM ESAATTH                                                                               
		                      WHERE SYS_ID = PRDT.SYS_ID                                                                           
		                        AND GRP_CD = PRDT.ATT_NO                                                                           
		                        AND STS    <> 'D' )                                                  AS ATT_CNT                          ,  --첨부파일 수
		                     PRSV.PR_SVC_LNO                                                         AS PR_SVC_LNO                       ,
		                     PRSV.SVC_CD                                                             AS SVC_CD                           ,
		                     PRSV.SVC_NM                                                             AS SVC_NM                           ,
		                    ( SELECT MAT_TYP
                                FROM ESMLMTGL
                               WHERE SYS_ID  = PRDT.SYS_ID
                                 AND COMP_CD = PRDT.COMP_CD
                                 AND ITEM_CD = PRDT.ITEM_CD )                                        AS MAT_TYP                          ,
		                    
		                    ( SELECT COUNT(*)
                                FROM ESPINFO
                               WHERE SYS_ID  = PRDT.SYS_ID
                                 AND COMP_CD = PRDT.COMP_CD
                                 AND ITEM_CD = PRDT.ITEM_CD
                                 AND (
                                       PLT_CD IS NULL
                                       OR
                                       (
                                           PLT_CD IS NOT NULL
                                           AND
                                           PLT_CD  = PRDT.PLT_CD
                                       )
                                     )
                                 AND APPLY_SD  <= TO_CHAR(SYSDATE,'YYYYMMDD')
                                 AND APPLY_ED  >= TO_CHAR(SYSDATE,'YYYYMMDD')
                                 AND STS       <> 'D'   )                                            AS PRC_VALID_YN
		               FROM ESPPRDT PRDT, ESPPRSV PRSV
		              WHERE PRDT.SYS_ID      = #sys_id#
		                AND PRDT.COMP_CD     = #s_comp_cd#
		                AND PRDT.PR_NO       = #pr_no#
		              [ AND (
		                        #release# = 'Y'
				                   AND PRDT.PR_PROG_STS      = 'RQ'
		                           AND PRDT.MOD_REQ_PROG_STS = 'R'
                            )]                      
		                AND(
		                        #mode# = 'view'
		                        AND
		                           (
		                                #copy_flag# IS NULL  
		                                AND PRDT.STS <> 'D'	
		                            OR
		                               (
                                            #copy_flag# = 'Y'
                                            AND PRDT.STS <> 'D'		                               
		                               )
		                           )
                             OR
                               (
                                    #mode# != 'view' 
                                AND
                                   (
                                        #copy_flag# = 'Y'
                                        AND PRDT.STS <> 'D'
	                                 OR
	                                   (
	                                        #copy_flag# IS NULL 
                                            AND PRDT.STS <> 'D'     
                                            AND PRDT.PR_PROG_STS <> 'RD'                                                                               
	                                    )
                                    )
                                )   
		                    )
		                AND PRDT.SYS_ID      = PRSV.SYS_ID(+)
		                AND PRDT.PR_NO       = PRSV.PR_NO(+)
		                AND PRDT.PR_LNO      = PRSV.PR_LNO(+)
		                AND PRDT.COMP_CD     = PRSV.COMP_CD(+)
		            ) TOT
           ORDER BY TOT.COMP_CD, TOT.PR_NO, TO_NUMBER(TOT.PR_LNO)
        ]]>
    </sql>
    
    <!--
    ***************************************************************************************************************************
    ** @Description    : PR 계정(espprac) 조회
    ** @Author         : 김병철(phatchul)
    ** @Create Date    : 2012.4.17
    ** @History        : 1) 2012.4.17-최초 생성
    ***************************************************************************************************************************
    -->
    <sql id="select.espprac" comment="PR 계정(espprac) 조회">
        <![CDATA[
          SELECT DECODE( #copy_flag#, 'Y', '', PRAC.PR_NO      )            AS PR_NO            , --구매요청 번호    
                 DECODE( #copy_flag#, 'Y', '', PRAC.PR_LNO     )            AS PR_LNO           , --구매요청 항번
                 NVL( #copy_flag#, 'N' )                                    AS COPY_FLAG        ,
                 PRAC.PR_LNO                                                AS TMP_PR_LNO       ,
                 DECODE( #copy_flag#, 'Y', '', PRDT.SAP_PR_NO  )            AS SAP_PR_NO        ,
                 DECODE( #copy_flag#, 'Y', '', PRDT.SAP_PR_LNO )            AS SAP_PR_LNO       ,
                 PRDT.SAP_ITEM_CD                                           AS SAP_ITEM_CD      ,
                 DECODE( #copy_flag#, 'Y', '', TO_NUMBER(PRAC.PR_LNO)     ) AS PR_LINE_NO       , --구매요청 LINE번호
                 DECODE( #copy_flag#, 'Y', '', TO_NUMBER(PRAC.PR_ACC_LNO) ) AS LINE_NO          , --계정 LINE번호
                 PRAC.PR_SVC_LNO                                            AS PR_SVC_LNO       , --구매요청 서비스 항번  
                 PRAC.PR_ACC_LNO                                            AS PR_ACC_LNO       , --구매요청 계정 항번  
                 PRAC.ACC_TYP                                               AS ACC_TYP          , --계정 유형  
                 PRAC.QTY_OR_RATE                                           AS QTY_OR_RATE      , --수량 OR 율  
                 PRAC.BUDGET_AMT                                            AS ORDER_NO_AMT     , --투자예산잔액
                 PRAC.GL_ACC_CD                                             AS GL_ACC_CD        , --G/L ACCOUNT코드  
                 PRAC.GL_ACC_NM                                             AS GL_ACC_NM        , --G/L ACCOUNT코드명
                 PRAC.GL_DATE                                               AS GL_DATE          , --G/L 일자
                 PRAC.COST_ACC_CD                                           AS COST_ACC_CD      , --Cost Ctr 코드  
                 PRAC.COST_ACC_NM                                           AS COST_ACC_NM      , --Cost Ctr 코드명
                 PRAC.WBS_CD                                                AS WBS_CD           , --WBS 코드  
                 PRAC.WBS_NM                                                AS WBS_NM           , --WBS 코드명
                 PRAC.FUND_CENTER_CD                                        AS FUND_CENTER_CD   , --FUND Ctr 코드 
                 PRAC.FUND_CENTER_NM                                        AS FUND_CENTER_NM   , --FUND Ctr 코드명
                 PRAC.ASSET_NO                                              AS ASSET_NO         , --자산번호
                 PRAC.ASSET_NO_NM                                           AS ASSET_NO_NM      , --자산번호명
                 PRAC.ASSET_SUB_NO                                          AS ASSET_SUB_NO     , --자산하위번호
                 PRAC.TMP_ASSET_NO                                          AS TMP_ASSET_NO     , --임시자산번호
                 PRAC.ORDER_NO                                              AS ORDER_NO         , --오더번호
                 PRAC.ORDER_NO_NM                                           AS ORDER_NO_NM      , --오더번호명
                 PRAC.SVC_MASTER                                            AS SVC_MASTER       , --서비스마스터
                 PRAC.SVC_MASTER_NM                                         AS SVC_MASTER_NM    , --서비스마스터명
                 PRAC.STS                                                   AS STS              , --상태  
                 PRAC.REG_ID                                                AS REG_ID           , --등록자 아이디  
                 PRAC.REG_DT                                                AS REG_DT           , --등록 일시  
                 PRAC.MOD_ID                                                AS MOD_ID           , --수정자 아이디  
                 PRAC.MOD_DT                                                AS MOD_DT             --수정 일시
            FROM ESPPRAC PRAC,
                 ESPPRDT PRDT
           WHERE PRAC.SYS_ID     = #sys_id#
             AND PRAC.COMP_CD    = #s_comp_cd#
             AND PRAC.PR_NO      = #pr_no#
             AND PRAC.STS        <> 'D'
             AND PRAC.SYS_ID     = PRDT.SYS_ID
             AND PRAC.COMP_CD    = PRDT.COMP_CD
             AND PRAC.PR_NO      = PRDT.PR_NO
             AND PRAC.PR_LNO     = PRDT.PR_LNO
        ORDER BY PRAC.PR_NO, TO_NUMBER(PRAC.PR_LNO), TO_NUMBER(PRAC.PR_SVC_LNO), TO_NUMBER(PRAC.PR_ACC_LNO)
        ]]>
    </sql>
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                 구 매 요 청 조 회 쿼 리  END        ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                 구 매 요 청 생 성 쿼 리  START      ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <sql id="prdt.max.count" comment="espprdt pr_no 별 Data Count 조회">
        <![CDATA[
            SELECT COUNT(*) AS CNT
              FROM ESPPRDT 
             WHERE SYS_ID    = #sys_id# 
               AND COMP_CD   = #s_comp_cd#
               AND PR_NO     = #pr_no# 
        ]]>
    </sql>
    
    <sql id="delete.espprdt" comment="">
        <![CDATA[
            UPDATE ESPPRDT
               SET STS       = 'D' 
             WHERE SYS_ID    = #sys_id# 
               AND COMP_CD   = #s_comp_cd#
               AND PR_NO     = #pr_no#
               AND PR_LNO    = #pr_lno# 
        ]]>
    </sql>
    
    <sql id="insert.espprac.temp" comment="">
        <![CDATA[
            INSERT INTO ESPTEMP
                      (
                        SYS_ID       ,
                        COMP_CD      ,
                        ORDER_NO     ,
                        ORDER_AMT    ,
                        PR_AMT
                      )
                 VALUES
                      (
                        #sys_id#        ,
                        #s_comp_cd#     , 
                        #order_no#      , 
                        #order_no_amt#  ,
                        #pr_amt#
                      ) 
        ]]>
    </sql>
    
    <sql id="select.prac.validation" comment="">
        <![CDATA[
            SELECT ORDER_NO
	             , CASE WHEN ORDER_AMT < TOT_PR_AMT
	                    THEN 'Y'
	                    ELSE 'N'
	               END RSLT_VAL               
	          FROM(       
	                SELECT SYS_ID
	                     , COMP_CD
	                     , ORDER_NO
	                     , MAX(ORDER_AMT) AS ORDER_AMT
	                     , SUM(PR_AMT)    AS TOT_PR_AMT
	                  FROM ESPTEMP 
	                  WHERE SYS_ID = #sys_id#
	                GROUP BY SYS_ID, COMP_CD, ORDER_NO     
	               )  
        ]]>
    </sql>
    
    <!--
    ***************************************************************************************************************************
    ** @Description    : PR 헤더(espprhd) 저장
    ** @Author         : 김병철(phatchul)
    ** @Create Date    : 2012.4.17
    ** @History        : 1) 2012.4.17-최초 생성
    ***************************************************************************************************************************
    -->
    <sql id="merge.espprhd" comment="">
        <![CDATA[
            MERGE INTO ESPPRHD A
                 USING ( SELECT #sys_id#                                                                     AS SYS_ID           , --시스템 아이디                                                                      
                                #s_comp_cd#                                                                  AS COMP_CD          , --회사코드                                                                           
                                #pr_no#                                                                      AS PR_NO            , --구매요청 번호
                                TRIM(#pr_tit#)                                                               AS PR_TIT           , --구매요청 제목                                                                      
                                #purc_typ#                                                                   AS PURC_TYP         , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                                #pr_typ#                                                                     AS PR_TYP           , --구매요청Type [P053] [ERP 전송 코드]                                                
                                #purc_req_typ#                                                               AS PURC_REQ_TYP     , --구매요청유형 [P049] [NC:일반계약, UC:단가계약]                                     
                                #pr_req_date#                                                                AS PR_REQ_DATE      , --구매요청일                                                                         
                                #pr_req_id#                                                                  AS PR_REQ_ID        , --구매요청자 아이디                                                                  
                                #pr_req_phone_no#                                                            AS PR_REQ_PHONE_NO  , --구매요청자 전화번호                                                                
                                #pr_req_dept#                                                                AS PR_REQ_DEPT      , --구매요청자 부서                                                                    
                                ( SELECT SUM(PR_AMT)
                                    FROM ESPPRDT
                                   WHERE SYS_ID  = #sys_id#
                                     AND COMP_CD = #s_comp_cd#
                                     AND PR_NO   = #pr_no#
                                     AND PR_PROG_STS <> 'RD'
                                     AND STS         <> 'D' )                                                AS PR_TOT_AMT       , --구매요청 금액                                                                      
                                #cur#                                                                        AS CUR              , --통화 [C003]                                                                        
                                NVL( #pre_bid#, 'N' )                                                        AS PRE_BID          , --선입찰                                                             
                                #orgn_rpt_yn#                                                                AS ORGN_RPT_YN      , --시행품의사용여부                                                                   
                                #orgn_rpt_no#                                                                AS ORGN_RPT_NO      , --시행품의번호                                                                       
                                #orgn_rpt_att_no#                                                            AS ORGN_RPT_ATT_NO  , --시행품의 첨부파일번호                                                              
                                #biz_place#                                                                  AS BIZ_PLACE        , --사업장                                                             
                                TRIM(#biz_place_nm#)                                                         AS BIZ_PLACE_NM     , --사업장명                                                           
                                #const_area_p#                                                               AS CONST_AREA_P     , --공사면적 평                                                        
                                #const_area_m#                                                               AS CONST_AREA_M     , --공사면적 m2                                                        
                                #store_frm#                                                                  AS STORE_FRM        , --매장형태                                                           
                                #const_prd_sd#                                                               AS CONST_PRD_SD     , --공사기간 FROM                                                      
                                #const_prd_ed#                                                               AS CONST_PRD_ED     , --공사시간 TO                                                        
                                TRIM(#const_cost_supt#)                                                      AS CONST_COST_SUPT  , --공사비지원                                                         
                                TRIM(#pr_rem#)                                                               AS PR_REM           , --특이사항                                                                           
                                TRIM(#ref_vd_cause#)                                                         AS REF_VD_CAUSE     , --추천업체사유                                                                       
                                TRIM(#pr_prc_rate#)                                                          AS PR_PRC_RATE      , --                                                                                                                         
                                #elec_aprv_yn#                                                               AS ELEC_APRV_YN     , --전자결재여부(Y:전자결재, Default:Y)                                                
                                NVL(#aprv_sts#, 'T')                                                         AS APRV_STS         , --결재상태 [P011]               
                                #aprv_id#                                                                    AS APRV_ID          , --승인자 아이디                                                                      
                                #aprv_date#                                                                  AS APRV_DATE        , --승인일                                                                             
                                #att_no#                                                                     AS ATT_NO           , --첨부파일번호                                                                       
                                NVL( #pr_mod_cnt#, 1 )                                                       AS PR_MOD_CNT       , --구매요청 변경 회수                                                                 
                                NVL( #pr_mod_prog_sts# , 'T' )                                               AS PR_MOD_PROG_STS  , --변경요청 진행 상태 [P040] (T:대상, A:변경승인, B:변경거부, R:변경요청)             
                                TRIM(#pr_targ_src#)                                                          AS PR_TARG_SRC      , --Legacy PR 타켓                                                                     
                                TRIM(#pr_targ_src_nm#)                                                       AS PR_TARG_SRC_NM   , --Legacy PR 타켓명                                                                   
                                #sap_pr_no#                                                                  AS SAP_PR_NO        , --ERP PR NO                                                                          
                                #if_typ#                                                                     AS IF_TYP           , --I/F 타입(S:Send, R:Receive)                                                        
                                #if_reject_yn#                                                               AS IF_REJECT_YN     , --I/F 반송여부(Y:반송가능, Default:N)                                                
                                #if_flag#                                                                    AS IF_FLAG          , --I/F 성공여부(S:성공,E:실패)                                                        
                                #if_date#                                                                    AS IF_DATE          , --I/F 날짜                                                                           
                                TRIM(#if_msg#)                                                               AS IF_MSG           , --I/F Message                                                                        
                                NVL( #mig_yn#, 'N')                                                          AS MIG_YN           , --Migration여부(Y:Migration, Default:N)                                              
                                #mode#                                                                       AS STS              , --상태
                                #order_num#                                                                  AS ORDER_NUM        ,                                                                               
                                #s_reg_id#                                                                     AS REG_ID           , --등록자 아이디                                                                      
                                TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                                          AS REG_DT           , --등록 일시                                                                          
                                #s_reg_id#                                                                     AS MOD_ID           , --수정자 아이디                                                                      
                                TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                                          AS MOD_DT             --수정 일시
                                ,#oper_org_sn#																AS OPER_ORG_SN 		-- 운영 조직 일련번호
                           FROM DUAL ) B
                             ON ( A.SYS_ID  = B.SYS_ID
                              AND A.COMP_CD = B.COMP_CD
                              AND A.PR_NO   = B.PR_NO )
            WHEN NOT MATCHED THEN
                       INSERT
                            (
                                SYS_ID              , --시스템 아이디                                                                      
                                COMP_CD             , --회사코드                                                                           
                                PR_NO               , --구매요청 번호
                                PR_TIT              , --구매요청 제목                                                                      
                                PURC_TYP            , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                                PR_TYP              , --구매요청Type [P053] [ERP 전송 코드]                                                
                                PURC_REQ_TYP        , --구매요청유형 [P049] [NC:일반계약, UC:단가계약]                                     
                                PR_REQ_DATE         , --구매요청일                                                                         
                                PR_REQ_ID           , --구매요청자 아이디                                                                  
                                PR_REQ_PHONE_NO     , --구매요청자 전화번호                                                                
                                PR_REQ_DEPT         , --구매요청자 부서                                                                    
                                PR_TOT_AMT          , --구매요청 금액                                                                      
                                CUR                 , --통화 [C003]                                                                        
                                PRE_BID             , --선입찰                                                             
                                ORGN_RPT_YN         , --시행품의사용여부                                                                   
                                ORGN_RPT_NO         , --시행품의번호                                                                       
                                ORGN_RPT_ATT_NO     , --시행품의 첨부파일번호                                                              
                                BIZ_PLACE           , --사업장                                                             
                                BIZ_PLACE_NM        , --사업장명                                                           
                                CONST_AREA_P        , --공사면적 평                                                        
                                CONST_AREA_M        , --공사면적 m2                                                        
                                STORE_FRM           , --매장형태                                                           
                                CONST_PRD_SD        , --공사기간 FROM                                                      
                                CONST_PRD_ED        , --공사시간 TO                                                        
                                CONST_COST_SUPT     , --공사비지원                                                         
                                PR_REM              , --특이사항                                                                           
                                REF_VD_CAUSE        , --추천업체사유                                                                       
                                PR_PRC_RATE         , --                                                                                                                                 
                                ELEC_APRV_YN        , --전자결재여부(Y:전자결재, Default:Y)                                                
                                APRV_STS            , --결재상태 [P011] (T:작성중, P:결재중, C:결재승인, B:반려, N:결재취소)               
                                APRV_ID             , --승인자 아이디                                                                      
                                APRV_DATE           , --승인일                                                                             
                                ATT_NO              , --첨부파일번호                                                                       
                                PR_MOD_CNT          , --구매요청 변경 회수                                                                 
                                PR_MOD_PROG_STS     , --변경요청 진행 상태 [P040] (T:대상, A:변경승인, B:변경거부, R:변경요청)             
                                PR_TARG_SRC         , --Legacy PR 타켓                                                                     
                                PR_TARG_SRC_NM      , --Legacy PR 타켓명                                                                   
                                SAP_PR_NO           , --ERP PR NO                                                                          
                                IF_TYP              , --I/F 타입(S:Send, R:Receive)                                                        
                                IF_REJECT_YN        , --I/F 반송여부(Y:반송가능, Default:N)                                                
                                IF_FLAG             , --I/F 성공여부(S:성공,E:실패)                                                        
                                IF_DATE             , --I/F 날짜                                                                           
                                IF_MSG              , --I/F Message                                                                        
                                MIG_YN              , --Migration여부(Y:Migration, Default:N)                                              
                                STS                 , --상태 
                                ORDER_NUM           ,                                                                              
                                REG_ID              , --등록자 아이디                                                                      
                                REG_DT              , --등록 일시                                                                          
                                MOD_ID              , --수정자 아이디                                                                      
                                MOD_DT                --수정 일시                       
                                ,OPER_ORG_SN                                                   
                            )
                      VALUES
                            (
                                B.SYS_ID              , --시스템 아이디                                                                      
                                B.COMP_CD             , --회사코드                                                                           
                                B.PR_NO               , --구매요청 번호
                                B.PR_TIT              , --구매요청 제목                                                                      
                                B.PURC_TYP            , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                                B.PR_TYP              , --구매요청Type [P053] [ERP 전송 코드]                                                
                                B.PURC_REQ_TYP        , --구매요청유형 [P049] [NC:일반계약, UC:단가계약]                                     
                                B.PR_REQ_DATE         , --구매요청일                                                                         
                                B.PR_REQ_ID           , --구매요청자 아이디                                                                  
                                B.PR_REQ_PHONE_NO     , --구매요청자 전화번호                                                                
                                B.PR_REQ_DEPT         , --구매요청자 부서                                                                    
                                B.PR_TOT_AMT          , --구매요청 금액                                                                      
                                B.CUR                 , --통화 [C003]                                                                        
                                B.PRE_BID             , --선입찰                                                             
                                B.ORGN_RPT_YN         , --시행품의사용여부                                                                   
                                B.ORGN_RPT_NO         , --시행품의번호                                                                       
                                B.ORGN_RPT_ATT_NO     , --시행품의 첨부파일번호                                                              
                                B.BIZ_PLACE           , --사업장                                                             
                                B.BIZ_PLACE_NM        , --사업장명                                                           
                                B.CONST_AREA_P        , --공사면적 평                                                        
                                B.CONST_AREA_M        , --공사면적 m2                                                        
                                B.STORE_FRM           , --매장형태                                                           
                                B.CONST_PRD_SD        , --공사기간 FROM                                                      
                                B.CONST_PRD_ED        , --공사시간 TO                                                        
                                B.CONST_COST_SUPT     , --공사비지원                                                         
                                B.PR_REM              , --특이사항                                                                           
                                B.REF_VD_CAUSE        , --추천업체사유                                                                       
                                B.PR_PRC_RATE         , --                                                                                                                            
                                B.ELEC_APRV_YN        , --전자결재여부(Y:전자결재, Default:Y)                                                
                                B.APRV_STS            , --결재상태 [P011] (T:작성중, P:결재중, C:결재승인, B:반려, N:결재취소)               
                                B.APRV_ID             , --승인자 아이디                                                                      
                                B.APRV_DATE           , --승인일                                                                             
                                B.ATT_NO              , --첨부파일번호                                                                       
                                B.PR_MOD_CNT          , --구매요청 변경 회수                                                                 
                                B.PR_MOD_PROG_STS     , --변경요청 진행 상태 [P040] (T:대상, A:변경승인, B:변경거부, R:변경요청)             
                                B.PR_TARG_SRC         , --Legacy PR 타켓                                                                     
                                B.PR_TARG_SRC_NM      , --Legacy PR 타켓명                                                                   
                                B.SAP_PR_NO           , --ERP PR NO                                                                          
                                B.IF_TYP              , --I/F 타입(S:Send, R:Receive)                                                        
                                B.IF_REJECT_YN        , --I/F 반송여부(Y:반송가능, Default:N)                                                
                                B.IF_FLAG             , --I/F 성공여부(S:성공,E:실패)                                                        
                                B.IF_DATE             , --I/F 날짜                                                                           
                                B.IF_MSG              , --I/F Message                                                                        
                                B.MIG_YN              , --Migration여부(Y:Migration, Default:N)                                              
                                B.STS                 , --상태     
                                B.ORDER_NUM           ,                                                                          
                                B.REG_ID              , --등록자 아이디                                                                      
                                B.REG_DT              , --등록 일시                                                                          
                                B.MOD_ID              , --수정자 아이디                                                                      
                                B.MOD_DT                --수정 일시                  
                                ,B.OPER_ORG_SN                                                        
                            )
                WHEN MATCHED THEN
                  UPDATE 
                     SET PR_TIT          = B.PR_TIT              , --구매요청 제목                                                                      
                         PURC_TYP        = B.PURC_TYP            , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                         PR_TYP          = B.PR_TYP              , --구매요청Type [P053] [ERP 전송 코드]                                                
                         PR_REQ_PHONE_NO = B.PR_REQ_PHONE_NO     , --구매요청자 전화번호                                                                
                         PR_REQ_DEPT     = B.PR_REQ_DEPT         , --구매요청자 부서                                                                    
                         PR_TOT_AMT      = B.PR_TOT_AMT          , --구매요청 금액                                                                      
                         CUR             = B.CUR                 , --통화 [C003]                                                                        
                         PRE_BID         = B.PRE_BID             , --선입찰                                                             
                         ORGN_RPT_YN     = B.ORGN_RPT_YN         , --시행품의사용여부                                                                   
                         ORGN_RPT_NO     = B.ORGN_RPT_NO         , --시행품의번호                                                                       
                         ORGN_RPT_ATT_NO = B.ORGN_RPT_ATT_NO     , --시행품의 첨부파일번호                                                              
                         BIZ_PLACE       = B.BIZ_PLACE           , --사업장                                                             
                         BIZ_PLACE_NM    = B.BIZ_PLACE_NM        , --사업장명                                                           
                         CONST_AREA_P    = B.CONST_AREA_P        , --공사면적 평                                                        
                         CONST_AREA_M    = B.CONST_AREA_M        , --공사면적 m2                                                        
                         STORE_FRM       = B.STORE_FRM           , --매장형태                                                           
                         CONST_PRD_SD    = B.CONST_PRD_SD        , --공사기간 FROM                                                      
                         CONST_PRD_ED    = B.CONST_PRD_ED        , --공사시간 TO                                                        
                         CONST_COST_SUPT = B.CONST_COST_SUPT     , --공사비지원                                                         
                         PR_REM          = B.PR_REM              , --특이사항                                                                           
                         REF_VD_CAUSE    = B.REF_VD_CAUSE        , --추천업체사유                                                                       
                         PR_PRC_RATE     = B.PR_PRC_RATE         , --                                                                                                                                 
                         ELEC_APRV_YN    = B.ELEC_APRV_YN        , --전자결재여부(Y:전자결재, Default:Y)                                                
                         APRV_STS        = B.APRV_STS            , --결재상태 [P011] (T:작성중, P:결재중, C:결재승인, B:반려, N:결재취소)               
                         APRV_ID         = B.APRV_ID             , --승인자 아이디                                                                      
                         APRV_DATE       = B.APRV_DATE           , --승인일                                                                             
                         ATT_NO          = B.ATT_NO              , --첨부파일번호                                                                       
                         PR_MOD_CNT      = B.PR_MOD_CNT          , --구매요청 변경 회수                                                                 
                         PR_MOD_PROG_STS = B.PR_MOD_PROG_STS     , --변경요청 진행 상태 [P040] (T:대상, A:변경승인, B:변경거부, R:변경요청)             
                         PR_TARG_SRC     = B.PR_TARG_SRC         , --Legacy PR 타켓                                                                     
                         PR_TARG_SRC_NM  = B.PR_TARG_SRC_NM      , --Legacy PR 타켓명                                                                   
                         SAP_PR_NO       = B.SAP_PR_NO           , --ERP PR NO                                                                          
                         IF_TYP          = B.IF_TYP              , --I/F 타입(S:Send, R:Receive)                                                        
                         IF_REJECT_YN    = B.IF_REJECT_YN        , --I/F 반송여부(Y:반송가능, Default:N)                                                
                         IF_FLAG         = B.IF_FLAG             , --I/F 성공여부(S:성공,E:실패)                                                        
                         IF_DATE         = B.IF_DATE             , --I/F 날짜                                                                           
                         IF_MSG          = B.IF_MSG              , --I/F Message                                                                        
                         MIG_YN          = B.MIG_YN              , --Migration여부(Y:Migration, Default:N)                                              
                         STS             = B.STS                 , --상태
                         ORDER_NUM       = B.ORDER_NUM           ,                                                                               
                         MOD_ID          = B.MOD_ID              , --수정자 아이디                                                                      
                         MOD_DT          = B.MOD_DT              ,  --수정 일시
                         OPER_ORG_SN 	 = B.OPER_ORG_SN			-- 운영조직
                   WHERE SYS_ID  = B.SYS_ID
                     AND COMP_CD = B.COMP_CD
                     AND PR_NO   = B.PR_NO          
        ]]>
    </sql>
    
    <sql id="merge.espprdt" comment="">
        <![CDATA[
            MERGE INTO ESPPRDT A
                 USING ( SELECT #sys_id#                                     AS SYS_ID                 , --시스템 아이디                                                                          
                                #s_comp_cd#                                  AS COMP_CD                , --회사 코드                                                                          
                                #pr_no#                                      AS PR_NO                  , --구매요청 번호
                                TO_CHAR(NVL(#pr_lno#, 10),'FM00000')         AS PR_LNO                 , --구매요청 항번                                                                      
                                #purc_typ#                                   AS PURC_TYP               , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                                #cost_typ#                                   AS COST_TYP               , --회계계정지정범주 [P052]                                                            
                                #plt_cd#                                     AS PLT_CD                 , --공장 코드                                                                          
                                #item_cd#                                    AS ITEM_CD                , --품목 코드                                                                          
                                TRIM(#item_nm#)                              AS ITEM_NM                , --품목 명                                                                            
                                TRIM(#item_en_nm#)                           AS ITEM_EN_NM             , --품목 영문명                                                                        
                                TRIM(#spec#)                                 AS SPEC                   , --규격                                                                               
                                #unit_cd#                                    AS UNIT_CD                , --단위 코드                                                                          
                                NVL(#price_unit#, 1)                         AS PRICE_UNIT             , --가격단위                                                                           
                                #item_qty#                                   AS ITEM_QTY               , --품목 수량                                                                          
                                #cur#                                        AS CUR                    , --통화 [C003]                                                                        
                                #pr_price#                                   AS PR_PRICE               , --구매요청 단가                                                                      
                                NVL(#item_qty#, 0 ) * NVL(#pr_price#, 0 )
                                 / NVL(#price_unit#, 1)                      AS PR_AMT                 , --구매요청 금액                                                                      
                                #ref_vd#                                     AS REF_VD                 , --참조 업체
                                NVL( #sap_vd_cd# ,
                                  ( SELECT ERP_VD_CD
                                      FROM ESMVDOG
                                     WHERE SYS_ID = #sys_id#
                                       AND VD_SN IN (
                                             SELECT VD_SN
                                               FROM ESMVDGL
                                              WHERE SYS_ID = #sys_id# 
                                                AND VD_CD = #ref_vd#
                                                AND ROWNUM = 1
                                                    )
                                       AND OPER_ORG_SN = #eo_oper_org_sn#             
                                  ) )                                        AS SAP_VD_CD              , --ERP업체코드                                                                          
                                #cate_cd#                                    AS CATE_CD                , --자재그룹코드                                                                       
                                #wh_cd#                                      AS WH_CD                  , --창고 코드                                                                          
                                TRIM(#rd_locat#)                             AS RD_LOCAT               , --납품요청 장소                                                                      
                                #tbe_eval_yn#                                AS TBE_EVAL_YN            , --기술평가여부                                                                       
                                #tbe_dept_cd#                                AS TBE_DEPT_CD            , --기술검토 부서 코드                                                                 
                                #purc_grp_cd#                                AS PURC_GRP_CD            , --구매 그룹 코드
                                #pr_sug_id#                                  AS PR_SUG_ID              , --구매의뢰자
                                TRIM(#pr_sug_text#)                          AS PR_SUG_TEXT            , --구매의뢰자텍스트                                                                     
                                #gr_chr_id#                                  AS GR_CHR_ID              , --검수담당자                                                                         
                                #price_cntr_no#                              AS PRICE_CNTR_NO          , --단가계약번호
                                #cntr_no#                                    AS CNTR_NO                , --계약번호                                                                             
                                #cntr_lno#                                   AS CNTR_LNO               , --계약번호항번                                                                       
                                DECODE( #purc_typ#, 'CT', 'D', '')           AS ITEM_CATE              , --품목범주(구매유형이 공사/용역인 경우에만 'D')                                                                           
                                NVL(#purc_org#, FC_GET_PURC_ORG(#sys_id#, #s_comp_cd# ) )  AS PURC_ORG               , --구매조직                                                                           
                                #sg_sn#                                      AS SG_SN                  , --SG일련번호                                                                         
                                #sg_cd#                                      AS SG_CD                  , --SG코드                                                                             
                                #oper_org_sn#                                AS OPER_ORG_SN            , --운영 조직 일련번호                                                                 
                                #prd_sd#                                     AS PRD_SD                 , --프로젝트 시작일                                                                    
                                #prd_ed#                                     AS PRD_ED                 , --프로젝트 종료일                                                                    
                                #rd_date#                                    AS RD_DATE                , --납품요청일                                                                         
                                #plat_cd#                                    AS PLAT_CD                , --플랫폼                                                         
                                #plat_svc_cd#                                AS PLAT_SVC_CD            , --서비스                                                         
                                TRIM(#cust_info_treat_yn#)                   AS CUST_INFO_TREAT_YN     , --고객정보취급여부                                                 
                                #att_no#                                     AS ATT_NO                 , --첨부 번호                                                                          
                                #reject_cause#                               AS REJECT_CAUSE           , --반려 사유                                                                          
                                NVL( #rfq_qty#     , 0    )                  AS RFQ_QTY                , --견적요청 수량                                                                      
                                NVL( #po_qty#      , 0    )                  AS PO_QTY                 , --발주 수량                                                                          
                                NVL( #ar_qty#      , 0    )                  AS AR_QTY                 , --검수요청 수량                                                                          
                                NVL( #gr_qty#      , 0    )                  AS GR_QTY                 , --입고 수량                                                                          
                                NVL( #po_end_yn#   , 'N'  )                  AS PO_END_YN              , --발주 종료 여부                                                                     
                                NVL( #gr_end_yn#   , 'N'  )                  AS GR_END_YN              , --입고 종료 여부                                                                     
                                NVL( #emg_yn#      , 'N'  )                  AS EMG_YN                 , --긴급 여부                                                                          
                                NVL( #auto_po_yn#  , 'N'  )                  AS AUTO_PO_YN             , --자동발주여부                                                                       
                                NVL( #pr_prog_sts# , 'RN' )                  AS PR_PROG_STS            , --구매요청 진행 상태 [P044]                                                          
                                #sap_pr_no#                                  AS SAP_PR_NO              , --ERP PR NO                                                                          
                                #sap_pr_lno#                                 AS SAP_PR_LNO             , --ERP PR LNO                                                                         
                                #sap_item_yn#                                AS SAP_ITEM_YN            , --ERP 아이템 관리여부                                                                
                                #sap_item_cd#                                AS SAP_ITEM_CD            , --ERP 아이템 코드                                                                    
                                #sap_grp_cd#                                 AS SAP_GRP_CD             , --ERP 구매그룹 코드                                                                  
                                NVL( #sap_cate_cd#, #cate_cd# )              AS SAP_CATE_CD            , --ERP 자재그룹 코드                                                                  
                                NVL(#sap_del_yn#, 'N')                       AS SAP_DEL_YN             , --ERP 삭제여부                                                                       
                                #if_typ#                                     AS IF_TYP                 , --I/F 타입(S:Send, R:Receive)                                                        
                                #if_reject_yn#                               AS IF_REJECT_YN           , --I/F 반송여부(Y:반송가능, Default:N)                                                
                                #if_flag#                                    AS IF_FLAG                , --I/F성공여부(S:성공,E:실패)                                                         
                                #if_date#                                    AS IF_DATE                , --I/F날짜                                                                            
                                TRIM(#if_msg#)                               AS IF_MSG                 , --I/F Message                                                                        
                                #mod_req_prog_sts#                           AS MOD_REQ_PROG_STS       , --변경 요청 진행 상태 [P040] (P : 요청중, A : 대상, R : 거부, C : 승인)              
                                #mod_sts#                                    AS MOD_STS                , --변경 상태                                                                          
                                #pr_mod_cnt#                                 AS PR_MOD_CNT             , --구매요청 변경 회수                                                                 
                                #acc_mod_yn#                                 AS ACC_MOD_YN             , --계정 변경 여부                                                                     
                                #att_mod_yn#                                 AS ATT_MOD_YN             , --첨부 변경 여부                                                                     
                                #item_mod_yn#                                AS ITEM_MOD_YN            , --품목 변경 여부                                                                     
                                #pr_mod_yn#                                  AS PR_MOD_YN              , --구매요청 변경 여부                                                                 
                                #qty_mod_yn#                                 AS QTY_MOD_YN             , --수량 변경 여부                                                                     
                                #rd_mod_yn#                                  AS RD_MOD_YN              , --납품요청 변경 여부                                                                 
                                #svc_mod_yn#                                 AS SVC_MOD_YN             , --서비스 변경 여부                                                                   
                                #release_flag#                               AS RELEASE_FLAG           , --릴리즈 플래그                                                                      
                                #release_req_id#                             AS RELEASE_REQ_ID         , --릴리즈 요청자 아이디                                                               
                                #release_req_dt#                             AS RELEASE_REQ_DT         , --릴리즈 요청 일시                                                                   
                                #release_aprv_id#                            AS RELEASE_APRV_ID        , --릴리즈 승인자 아이디                                                               
                                #release_aprv_dt#                            AS RELEASE_APRV_DT        , --릴리즈 승인 일시                                                                   
                                TRIM(#release_req_cause#)                    AS RELEASE_REQ_CAUSE      , --릴리즈 요청 사유                                                                   
                                TRIM(#release_reject_cause#)                 AS RELEASE_REJECT_CAUSE   , --릴리즈 반려 사유                                                                   
                                NVL( #mig_yn#    , 'N' )                     AS MIG_YN                 , --Migration여부(Y:Migration, Default:N)
                                #rep_cd_yn#                                  AS REP_CD_YN              , --대표품목여부(Default:N) 2012.10.10                                               
                                NVL( #editstatus#, 'U' )                     AS STS                    , --상태                                                                               
                                #s_reg_id#                                     AS REG_ID                 , --등록자 아이디                                                                      
                                TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')          AS REG_DT                 , --등록 일시                                                                          
                                #s_reg_id#                                     AS MOD_ID                 , --수정자 아이디                                                                      
                                TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')          AS MOD_DT                   --수정 일시   
                           FROM DUAL ) B
                             ON ( A.SYS_ID  = B.SYS_ID
                              AND A.COMP_CD = B.COMP_CD
                              AND A.PR_NO   = B.PR_NO
                              AND A.PR_LNO  = B.PR_LNO )
            WHEN NOT MATCHED THEN
                       INSERT
                            (
                                SYS_ID               , --시스템 아이디                                                                      
                                COMP_CD              , --회사 코드                                                                          
                                PR_NO                , --구매요청 번호
                                PR_LNO               , --구매요청 항번                                                                      
                                PURC_TYP             , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                                COST_TYP             , --회계계정지정범주 [P052]                                                            
                                PLT_CD               , --공장 코드                                                                          
                                ITEM_CD              , --품목 코드                                                                          
                                ITEM_NM              , --품목 명                                                                            
                                ITEM_EN_NM           , --품목 영문명                                                                        
                                SPEC                 , --규격                                                                               
                                UNIT_CD              , --단위 코드                                                                          
                                PRICE_UNIT           , --가격단위                                                                           
                                ITEM_QTY             , --품목 수량                                                                          
                                CUR                  , --통화 [C003]                                                                        
                                PR_PRICE             , --구매요청 단가                                                                      
                                PR_AMT               , --구매요청 금액                                                                      
                                REF_VD               , --참조 업체
                                SAP_VD_CD            , --ERP업체코드                                                                          
                                CATE_CD              , --자재그룹코드                                                                       
                                WH_CD                , --창고 코드                                                                          
                                RD_LOCAT             , --납품요청 장소                                                                      
                                TBE_EVAL_YN          , --기술평가여부                                                                       
                                TBE_DEPT_CD          , --기술검토 부서 코드                                                                 
                                PURC_GRP_CD          , --구매 그룹 코드
                                PR_SUG_ID            , --구매의뢰자
                                PR_SUG_TEXT          , --구매의뢰자텍스트                                                                     
                                GR_CHR_ID            , --검수담당자                                                                         
                                PRICE_CNTR_NO        , --단가계약번호    
                                CNTR_NO              , --계약번호                                                                       
                                CNTR_LNO             , --계약번호항번                                                                       
                                ITEM_CATE            , --품목범주                                                                           
                                PURC_ORG             , --구매조직                                                                           
                                SG_SN                , --SG일련번호                                                                         
                                SG_CD                , --SG코드                                                                             
                                OPER_ORG_SN          , --운영 조직 일련번호                                                                 
                                PRD_SD               , --프로젝트 시작일                                                                    
                                PRD_ED               , --프로젝트 종료일                                                                    
                                RD_DATE              , --납품요청일                                                                         
                                PLAT_CD              , --플랫폼                                                         
                                PLAT_SVC_CD          , --서비스                                                         
                                CUST_INFO_TREAT_YN   , --고객정보취급여부                                                 
                                ATT_NO               , --첨부 번호                                                                          
                                REJECT_CAUSE         , --반려 사유                                                                          
                                RFQ_QTY              , --견적요청 수량                                                                      
                                PO_QTY               , --발주 수량                                                                          
                                AR_QTY               , --검수요청 수량                                                                          
                                GR_QTY               , --입고 수량                                                                          
                                PO_END_YN            , --발주 종료 여부                                                                     
                                GR_END_YN            , --입고 종료 여부                                                                     
                                EMG_YN               , --긴급 여부                                                                          
                                AUTO_PO_YN           , --자동발주여부                                                                       
                                PR_PROG_STS          , --구매요청 진행 상태 [P044]                                                          
                                SAP_PR_NO            , --ERP PR NO                                                                          
                                SAP_PR_LNO           , --ERP PR LNO                                                                         
                                SAP_ITEM_YN          , --ERP 아이템 관리여부                                                                
                                SAP_ITEM_CD          , --ERP 아이템 코드                                                                    
                                SAP_GRP_CD           , --ERP 구매그룹 코드                                                                  
                                SAP_CATE_CD          , --ERP 자재그룹 코드                                                                  
                                SAP_DEL_YN           , --ERP 삭제여부                                                                       
                                IF_TYP               , --I/F 타입(S:Send, R:Receive)                                                        
                                IF_REJECT_YN         , --I/F 반송여부(Y:반송가능, Default:N)                                                
                                IF_FLAG              , --I/F성공여부(S:성공,E:실패)                                                         
                                IF_DATE              , --I/F날짜                                                                            
                                IF_MSG               , --I/F Message                                                                        
                                MOD_REQ_PROG_STS     , --변경 요청 진행 상태 [P040] (P : 요청중, A : 대상, R : 거부, C : 승인)              
                                MOD_STS              , --변경 상태                                                                          
                                PR_MOD_CNT           , --구매요청 변경 회수                                                                 
                                ACC_MOD_YN           , --계정 변경 여부                                                                     
                                ATT_MOD_YN           , --첨부 변경 여부                                                                     
                                ITEM_MOD_YN          , --품목 변경 여부                                                                     
                                PR_MOD_YN            , --구매요청 변경 여부                                                                 
                                QTY_MOD_YN           , --수량 변경 여부                                                                     
                                RD_MOD_YN            , --납품요청 변경 여부                                                                 
                                SVC_MOD_YN           , --서비스 변경 여부                                                                   
                                RELEASE_FLAG         , --릴리즈 플래그                                                                      
                                RELEASE_REQ_ID       , --릴리즈 요청자 아이디                                                               
                                RELEASE_REQ_DT       , --릴리즈 요청 일시                                                                   
                                RELEASE_APRV_ID      , --릴리즈 승인자 아이디                                                               
                                RELEASE_APRV_DT      , --릴리즈 승인 일시                                                                   
                                RELEASE_REQ_CAUSE    , --릴리즈 요청 사유                                                                   
                                RELEASE_REJECT_CAUSE , --릴리즈 반려 사유                                                                   
                                MIG_YN               , --Migration여부(Y:Migration, Default:N)                                              
                                REP_CD_YN            , --대표품목여부
                                STS                  , --상태                                                                               
                                REG_ID               , --등록자 아이디                                                                      
                                REG_DT               , --등록 일시                                                                          
                                MOD_ID               , --수정자 아이디                                                                      
                                MOD_DT                 --수정 일시                                                                          
                            )
                      VALUES
                            (
                                B.SYS_ID               , --시스템 아이디                                                                      
                                B.COMP_CD              , --회사 코드                                                                          
                                B.PR_NO                , --구매요청 번호
                                B.PR_LNO               , --구매요청 항번                                                                      
                                B.PURC_TYP             , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                                B.COST_TYP             , --회계계정지정범주 [P052]                                                            
                                B.PLT_CD               , --공장 코드                                                                          
                                B.ITEM_CD              , --품목 코드                                                                          
                                B.ITEM_NM              , --품목 명                                                                            
                                B.ITEM_EN_NM           , --품목 영문명                                                                        
                                B.SPEC                 , --규격                                                                               
                                B.UNIT_CD              , --단위 코드                                                                          
                                B.PRICE_UNIT           , --가격단위                                                                           
                                B.ITEM_QTY             , --품목 수량                                                                          
                                B.CUR                  , --통화 [C003]                                                                        
                                B.PR_PRICE             , --구매요청 단가                                                                      
                                B.PR_AMT               , --구매요청 금액                                                                      
                                B.REF_VD               , --참조 업체
                                B.SAP_VD_CD            , --ERP업체코드                                                                          
                                B.CATE_CD              , --자재그룹코드                                                                       
                                B.WH_CD                , --창고 코드                                                                          
                                B.RD_LOCAT             , --납품요청 장소                                                                      
                                B.TBE_EVAL_YN          , --기술평가여부                                                                       
                                B.TBE_DEPT_CD          , --기술검토 부서 코드                                                                 
                                B.PURC_GRP_CD          , --구매 그룹 코드
                                B.PR_SUG_ID            , --구매의뢰자
                                B.PR_SUG_TEXT          , --구매의뢰자텍스트                                                                     
                                B.GR_CHR_ID            , --검수담당자                                                                         
                                B.PRICE_CNTR_NO        , --단가계약번호
                                B.CNTR_NO              , --계약번호                                                                           
                                B.CNTR_LNO             , --계약번호항번                                                                       
                                B.ITEM_CATE            , --품목범주                                                                           
                                B.PURC_ORG             , --구매조직                                                                           
                                B.SG_SN                , --SG일련번호                                                                         
                                B.SG_CD                , --SG코드                                                                             
                                B.OPER_ORG_SN          , --운영 조직 일련번호                                                                 
                                B.PRD_SD               , --프로젝트 시작일                                                                    
                                B.PRD_ED               , --프로젝트 종료일                                                                    
                                B.RD_DATE              , --납품요청일                                                                         
                                B.PLAT_CD              , --플랫폼                                                         
                                B.PLAT_SVC_CD          , --서비스                                                         
                                B.CUST_INFO_TREAT_YN   , --고객정보취급여부                                                 
                                B.ATT_NO               , --첨부 번호                                                                          
                                B.REJECT_CAUSE         , --반려 사유                                                                          
                                B.RFQ_QTY              , --견적요청 수량                                                                      
                                B.PO_QTY               , --발주 수량                                                                          
                                B.AR_QTY               , --검수요청 수량                                                                          
                                B.GR_QTY               , --입고 수량                                                                          
                                B.PO_END_YN            , --발주 종료 여부                                                                     
                                B.GR_END_YN            , --입고 종료 여부                                                                     
                                B.EMG_YN               , --긴급 여부                                                                          
                                B.AUTO_PO_YN           , --자동발주여부                                                                       
                                B.PR_PROG_STS          , --구매요청 진행 상태 [P044]                                                          
                                B.SAP_PR_NO            , --ERP PR NO                                                                          
                                B.SAP_PR_LNO           , --ERP PR LNO                                                                         
                                B.SAP_ITEM_YN          , --ERP 아이템 관리여부                                                                
                                B.SAP_ITEM_CD          , --ERP 아이템 코드                                                                    
                                B.SAP_GRP_CD           , --ERP 구매그룹 코드                                                                  
                                B.SAP_CATE_CD          , --ERP 자재그룹 코드                                                                  
                                B.SAP_DEL_YN           , --ERP 삭제여부                                                                       
                                B.IF_TYP               , --I/F 타입(S:Send, R:Receive)                                                        
                                B.IF_REJECT_YN         , --I/F 반송여부(Y:반송가능, Default:N)                                                
                                B.IF_FLAG              , --I/F성공여부(S:성공,E:실패)                                                         
                                B.IF_DATE              , --I/F날짜                                                                            
                                B.IF_MSG               , --I/F Message                                                                        
                                B.MOD_REQ_PROG_STS     , --변경 요청 진행 상태 [P040] (P : 요청중, A : 대상, R : 거부, C : 승인)              
                                B.MOD_STS              , --변경 상태                                                                          
                                B.PR_MOD_CNT           , --구매요청 변경 회수                                                                 
                                B.ACC_MOD_YN           , --계정 변경 여부                                                                     
                                B.ATT_MOD_YN           , --첨부 변경 여부                                                                     
                                B.ITEM_MOD_YN          , --품목 변경 여부                                                                     
                                B.PR_MOD_YN            , --구매요청 변경 여부                                                                 
                                B.QTY_MOD_YN           , --수량 변경 여부                                                                     
                                B.RD_MOD_YN            , --납품요청 변경 여부                                                                 
                                B.SVC_MOD_YN           , --서비스 변경 여부                                                                   
                                B.RELEASE_FLAG         , --릴리즈 플래그                                                                      
                                B.RELEASE_REQ_ID       , --릴리즈 요청자 아이디                                                               
                                B.RELEASE_REQ_DT       , --릴리즈 요청 일시                                                                   
                                B.RELEASE_APRV_ID      , --릴리즈 승인자 아이디                                                               
                                B.RELEASE_APRV_DT      , --릴리즈 승인 일시                                                                   
                                B.RELEASE_REQ_CAUSE    , --릴리즈 요청 사유                                                                   
                                B.RELEASE_REJECT_CAUSE , --릴리즈 반려 사유                                                                   
                                B.MIG_YN               , --Migration여부(Y:Migration, Default:N)                                              
                                B.REP_CD_YN            , --대표품목여부
                                B.STS                  , --상태                                                                               
                                B.REG_ID               , --등록자 아이디                                                                      
                                B.REG_DT               , --등록 일시                                                                          
                                B.MOD_ID               , --수정자 아이디                                                                      
                                B.MOD_DT                 --수정 일시                                                                          
                            )
                WHEN MATCHED THEN
                  UPDATE 
                     SET PURC_TYP               = B.PURC_TYP             , --구매 유형 [P045] (MT:물품, CT:공사/용역, MC:물품/공사/용역)                        
                         COST_TYP               = B.COST_TYP             , --회계계정지정범주 [P052]                                                            
                         PLT_CD                 = B.PLT_CD               , --공장 코드                                                                          
                         ITEM_CD                = B.ITEM_CD              , --품목 코드                                                                          
                         ITEM_NM                = B.ITEM_NM              , --품목 명                                                                            
                         ITEM_EN_NM             = B.ITEM_EN_NM           , --품목 영문명                                                                        
                         SPEC                   = B.SPEC                 , --규격                                                                               
                         UNIT_CD                = B.UNIT_CD              , --단위 코드                                                                          
                         PRICE_UNIT             = B.PRICE_UNIT           , --가격단위                                                                           
                         ITEM_QTY               = B.ITEM_QTY             , --품목 수량                                                                          
                         CUR                    = B.CUR                  , --통화 [C003]                                                                        
                         PR_PRICE               = B.PR_PRICE             , --구매요청 단가                                                                      
                         PR_AMT                 = B.PR_AMT               , --구매요청 금액                                                                      
                         REF_VD                 = B.REF_VD               , --참조 업체
                         SAP_VD_CD              = B.SAP_VD_CD            , --ERP업체코드                                                                          
                         CATE_CD                = B.CATE_CD              , --자재그룹코드                                                                       
                         WH_CD                  = B.WH_CD                , --창고 코드                                                                          
                         RD_LOCAT               = B.RD_LOCAT             , --납품요청 장소                                                                      
                         TBE_EVAL_YN            = B.TBE_EVAL_YN          , --기술평가여부                                                                       
                         TBE_DEPT_CD            = B.TBE_DEPT_CD          , --기술검토 부서 코드                                                                 
                         PURC_GRP_CD            = B.PURC_GRP_CD          , --구매 그룹 코드
                         PR_SUG_ID              = B.PR_SUG_ID            , --구매의뢰자
                         PR_SUG_TEXT            = B.PR_SUG_TEXT          , --구매의뢰자텍스트                                                                     
                         GR_CHR_ID              = B.GR_CHR_ID            , --검수담당자                                                                         
                         PRICE_CNTR_NO          = B.PRICE_CNTR_NO        , --단가계약번호              
                         CNTR_NO                = B.CNTR_NO              , --계약번호                                                             
                         CNTR_LNO               = B.CNTR_LNO             , --계약번호항번                                                                       
                         ITEM_CATE              = B.ITEM_CATE            , --품목범주                                                                           
                         PURC_ORG               = B.PURC_ORG             , --구매조직                                                                           
                         SG_SN                  = B.SG_SN                , --SG일련번호                                                                         
                         SG_CD                  = B.SG_CD                , --SG코드                                                                             
                         OPER_ORG_SN            = B.OPER_ORG_SN          , --운영 조직 일련번호                                                                 
                         PRD_SD                 = B.PRD_SD               , --프로젝트 시작일                                                                    
                         PRD_ED                 = B.PRD_ED               , --프로젝트 종료일                                                                    
                         RD_DATE                = B.RD_DATE              , --납품요청일                                                                         
                         PLAT_CD                = B.PLAT_CD              , --플랫폼                                                         
                         PLAT_SVC_CD            = B.PLAT_SVC_CD          , --서비스                                                         
                         CUST_INFO_TREAT_YN     = B.CUST_INFO_TREAT_YN   , --고객정보취급여부                                                 
                         ATT_NO                 = B.ATT_NO               , --첨부 번호                                                                          
                         REJECT_CAUSE           = B.REJECT_CAUSE         , --반려 사유                                                                          
                         RFQ_QTY                = B.RFQ_QTY              , --견적요청 수량                                                                      
                         PO_QTY                 = B.PO_QTY               , --발주 수량                                                                          
                         AR_QTY                 = B.AR_QTY               , --검수요청 수량                                                                          
                         GR_QTY                 = B.GR_QTY               , --입고 수량                                                                          
                         PO_END_YN              = B.PO_END_YN            , --발주 종료 여부                                                                     
                         GR_END_YN              = B.GR_END_YN            , --입고 종료 여부                                                                     
                         EMG_YN                 = B.EMG_YN               , --긴급 여부                                                                          
                         AUTO_PO_YN             = B.AUTO_PO_YN           , --자동발주여부                                                                       
                         PR_PROG_STS            = B.PR_PROG_STS          , --구매요청 진행 상태 [P044]                                                          
                         SAP_PR_NO              = B.SAP_PR_NO            , --ERP PR NO                                                                          
                         SAP_PR_LNO             = B.SAP_PR_LNO           , --ERP PR LNO                                                                         
                         SAP_ITEM_YN            = B.SAP_ITEM_YN          , --ERP 아이템 관리여부                                                                
                         SAP_ITEM_CD            = B.SAP_ITEM_CD          , --ERP 아이템 코드                                                                    
                         SAP_GRP_CD             = B.SAP_GRP_CD           , --ERP 구매그룹 코드                                                                  
                         SAP_CATE_CD            = B.SAP_CATE_CD          , --ERP 자재그룹 코드                                                                  
                         SAP_DEL_YN             = B.SAP_DEL_YN           , --ERP 삭제여부                                                                       
                         IF_TYP                 = B.IF_TYP               , --I/F 타입(S:Send, R:Receive)                                                        
                         IF_REJECT_YN           = B.IF_REJECT_YN         , --I/F 반송여부(Y:반송가능, Default:N)                                                
                         IF_FLAG                = B.IF_FLAG              , --I/F성공여부(S:성공,E:실패)                                                         
                         IF_DATE                = B.IF_DATE              , --I/F날짜                                                                            
                         IF_MSG                 = B.IF_MSG               , --I/F Message                                                                        
                         MOD_REQ_PROG_STS       = B.MOD_REQ_PROG_STS     , --변경 요청 진행 상태 [P040] (P : 요청중, A : 대상, R : 거부, C : 승인)              
                         MOD_STS                = B.MOD_STS              , --변경 상태                                                                          
                         PR_MOD_CNT             = B.PR_MOD_CNT           , --구매요청 변경 회수                                                                 
                         ACC_MOD_YN             = B.ACC_MOD_YN           , --계정 변경 여부                                                                     
                         ATT_MOD_YN             = B.ATT_MOD_YN           , --첨부 변경 여부                                                                     
                         ITEM_MOD_YN            = B.ITEM_MOD_YN          , --품목 변경 여부                                                                     
                         PR_MOD_YN              = B.PR_MOD_YN            , --구매요청 변경 여부                                                                 
                         QTY_MOD_YN             = B.QTY_MOD_YN           , --수량 변경 여부                                                                     
                         RD_MOD_YN              = B.RD_MOD_YN            , --납품요청 변경 여부                                                                 
                         SVC_MOD_YN             = B.SVC_MOD_YN           , --서비스 변경 여부                                                                   
                         RELEASE_FLAG           = B.RELEASE_FLAG         , --릴리즈 플래그                                                                      
                         RELEASE_REQ_ID         = B.RELEASE_REQ_ID       , --릴리즈 요청자 아이디                                                               
                         RELEASE_REQ_DT         = B.RELEASE_REQ_DT       , --릴리즈 요청 일시                                                                   
                         RELEASE_APRV_ID        = B.RELEASE_APRV_ID      , --릴리즈 승인자 아이디                                                               
                         RELEASE_APRV_DT        = B.RELEASE_APRV_DT      , --릴리즈 승인 일시                                                                   
                         RELEASE_REQ_CAUSE      = B.RELEASE_REQ_CAUSE    , --릴리즈 요청 사유                                                                   
                         RELEASE_REJECT_CAUSE   = B.RELEASE_REJECT_CAUSE , --릴리즈 반려 사유                                                                   
                         MIG_YN                 = B.MIG_YN               , --Migration여부(Y:Migration, Default:N)                                              
                         REP_CD_YN              = B.REP_CD_YN            , --대표품목여부
                         STS                    = B.STS                  , --상태                                                                               
                         MOD_ID                 = B.MOD_ID               , --수정자 아이디                                                                      
                         MOD_DT                 = B.MOD_DT                 --수정 일시                                                                          
                   WHERE SYS_ID  = B.SYS_ID
                     AND COMP_CD = B.COMP_CD
                     AND PR_NO   = B.PR_NO
                     AND PR_LNO  = B.PR_LNO          
        ]]>
    </sql>
    
    <sql id="merge.espprsv" comment="">
        <![CDATA[
            MERGE INTO ESPPRSV A
                  USING (  
                         SELECT #sys_id#                                   AS SYS_ID        , --시스템 아이디                                                                      
	                            #s_comp_cd#                                AS COMP_CD       , --회사코드                                                                           
		                        #pr_no#                                    AS PR_NO         , --구매요청 번호
		                        TO_CHAR(NVL(#pr_lno#, 10),'FM00000')       AS PR_LNO        , --구매요청 항번                                                                      
		                        TO_CHAR(NVL(#pr_svc_lno#, 10),'FM00000')   AS PR_SVC_LNO    , --구매요청 서비스 항번                                                               
		                        #svc_cd#                                   AS SVC_CD        , --서비스코드                                                                         
		                        TRIM(#item_nm#)                            AS SVC_NM        , --서비스명                                                                           
		                        #unit_cd#                                  AS UNIT_CD       , --단위코드                                                                           
		                        #item_qty#                                 AS SVC_QTY       , --서비스수량                                                                         
		                        #pr_price#                                 AS SVC_PRICE     , --서비스단가                                                                         
		                        #pr_amt#                                   AS SVC_AMT       , --서비스금액
		                        NVL(#editstatus#, 'U')                     AS STS           , --상태                                                                               
		                        #s_reg_id#                                   AS REG_ID        , --등록자 아이디                                                                      
		                        TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')        AS REG_DT        , --등록 일시                                                                          
		                        #s_reg_id#                                   AS MOD_ID        , --수정자 아이디                                                                      
		                        TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')        AS MOD_DT          --수정 일시
		                   FROM DUAL ) B
	                        ON ( A.SYS_ID     = B.SYS_ID
	                         AND A.COMP_CD    = B.COMP_CD
	                         AND A.PR_NO      = B.PR_NO
	                         AND A.PR_LNO     = B.PR_LNO
	                         AND A.PR_SVC_LNO = B.PR_SVC_LNO )     
             WHEN NOT MATCHED THEN
                       INSERT
		                      (
		                        SYS_ID     , --시스템 아이디                                                                      
		                        COMP_CD    , --회사코드                                                                           
		                        PR_NO      , --구매요청 번호
		                        PR_LNO     , --구매요청 항번                                                                      
		                        PR_SVC_LNO , --구매요청 서비스 항번                                                               
		                        SVC_CD     , --서비스코드                                                                         
		                        SVC_NM     , --서비스명                                                                           
		                        UNIT_CD    , --단위코드                                                                           
		                        SVC_QTY    , --서비스수량                                                                         
		                        SVC_PRICE  , --서비스단가                                                                         
		                        SVC_AMT    , --서비스금액
		                        STS        , --상태                                                                               
		                        REG_ID     , --등록자 아이디                                                                      
		                        REG_DT     , --등록 일시                                                                          
		                        MOD_ID     , --수정자 아이디                                                                      
		                        MOD_DT       --수정 일시                                                                          
		                      )
			                VALUES
		                      (
		                         B.SYS_ID     , --시스템 아이디                                                                                                           
		                         B.COMP_CD    , --회사코드                                                                                                              
		                         B.PR_NO      , --구매요청 번호                                           
		                         B.PR_LNO     , --구매요청 항번                                                                                                          
		                         B.PR_SVC_LNO , --구매요청 서비스 항번                                                                                                      
		                         B.SVC_CD     , --서비스코드                                                                                                            
		                         B.SVC_NM     , --서비스명                                                                                                             
		                         B.UNIT_CD    , --단위코드                                                                                                             
		                         B.SVC_QTY    , --서비스수량                                                                                                            
		                         B.SVC_PRICE  , --서비스단가                                                                                                            
		                         B.SVC_AMT    , --서비스금액                                                                                                            
		                         B.STS        , --상태                                                                                                                
		                         B.REG_ID     , --등록자 아이디                                                                                                           
		                         B.REG_DT     , --등록 일시                                                                                                             
		                         B.MOD_ID     , --수정자 아이디                                                                                                           
		                         B.MOD_DT       --수정 일시                                                                                                             
		                      )
		       WHEN MATCHED THEN
                  UPDATE 
                     SET  SVC_CD         = B.SVC_CD     , --서비스코드                                                                                                                              
                          SVC_NM         = B.SVC_NM     , --서비스명                                                                                                                               
                          UNIT_CD        = B.UNIT_CD    , --단위코드                                                                                                                               
                          SVC_QTY        = B.SVC_QTY    , --서비스수량                                                                                                                              
                          SVC_PRICE      = B.SVC_PRICE  , --서비스단가                                                                                                                              
                          SVC_AMT        = B.SVC_AMT    , --서비스금액                                                                                                                              
                          STS            = B.STS        , --상태                                                                                                                                 
                          MOD_ID         = B.MOD_ID     , --수정자 아이디                                                                                                                            
                          MOD_DT         = B.MOD_DT       --수정 일시                                                                                                                              
                     
                     
        ]]>
    </sql>
    
    <sql id="merge.espprac" comment="">
        <![CDATA[
            MERGE INTO ESPPRAC A
             USING ( SELECT #sys_id#                                                                   AS SYS_ID          , --시스템 아이디                                                                      
                            #s_comp_cd#                                                                AS COMP_CD         , --회사코드                                                                           
                            #pr_no#                                                                    AS PR_NO           , --구매요청 번호
                            TO_CHAR(#pr_lno#,'FM00000')                                                AS PR_LNO          , --구매요청 항번                                                                      
                            TO_CHAR(NVL(#pr_svc_lno#, 10),'FM00000')                                   AS PR_SVC_LNO      , --구매요청 서비스 항번                                                               
                            TO_CHAR(NVL(#pr_svc_lno#, 10),'FM00000')                                   AS PR_ACC_LNO      , --구매요청 계정 항번                                                                 
                            #acc_typ#                                                                  AS ACC_TYP         , --계정유형                                                                           
                            #qty_or_rate#                                                              AS QTY_OR_RATE     , --수량 OR 율                                                                         
                            #order_no_amt#                                                             AS BUDGET_AMT      , --예산금액                                                                           
                            #gl_acc_cd#                                                                AS GL_ACC_CD       , --GL ACCOUNT 코드                                                                    
                            TRIM(#gl_acc_nm#)                                                          AS GL_ACC_NM       , --GL ACCOUNT명                                                                       
                            #gl_date#                                                                  AS GL_DATE         , --G/L일자(SAP에서 마감일짜)                                                          
                            #cost_acc_cd#                                                              AS COST_ACC_CD     , --COST CENTER 코드                                                                   
                            TRIM(#cost_acc_nm#)                                                        AS COST_ACC_NM     , --COST CENTER명                                                                      
                            #wbs_cd#                                                                   AS WBS_CD          , --WBS 코드                                                                           
                            TRIM(#wbs_nm#)                                                             AS WBS_NM          , --WBS명                                                                              
                            #fund_center_cd#                                                           AS FUND_CENTER_CD  , --FUND CENTER 코드                                                                   
                            TRIM(#fund_center_nm#)                                                     AS FUND_CENTER_NM  , --FUND CENTER명                                                                      
                            #tmp_asset_no#                                                             AS TMP_ASSET_NO    , --임시자산번호                                                                       
                            #asset_no#                                                                 AS ASSET_NO        , --자산번호                                                                           
                            TRIM(#asset_no_nm#)                                                        AS ASSET_NO_NM     , --자산번호명                                                                         
                            #asset_sub_no#                                                             AS ASSET_SUB_NO    , --자산하위번호                                                                       
                            #order_no#                                                                 AS ORDER_NO        , --오더번호                                                                           
                            TRIM(#order_no_nm#)                                                        AS ORDER_NO_NM     , --오더번호명                                                                         
                            #svc_master#                                                               AS SVC_MASTER      , --서비스마스터                                                                           
                            TRIM(#svc_master_nm#)                                                      AS SVC_MASTER_NM   , --서비스마스터명
                            NVL(#mode#, 'C')                                                           AS STS             , --상태                                                                               
                            #s_reg_id#                                                                   AS REG_ID          , --등록자 아이디                                                                      
                            TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                                        AS REG_DT          , --등록 일시                                                                          
                            #s_reg_id#                                                                   AS MOD_ID          , --수정자 아이디                                                                      
                            TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                                        AS MOD_DT            --수정 일시
                       FROM DUAL ) B
                         ON ( A.SYS_ID     = B.SYS_ID
                          AND A.COMP_CD    = B.COMP_CD
                          AND A.PR_NO      = B.PR_NO
                          AND A.PR_LNO     = B.PR_LNO
                          AND A.PR_SVC_LNO = B.PR_SVC_LNO
                          AND A.PR_ACC_LNO = B.PR_ACC_LNO )
        WHEN NOT MATCHED THEN
                   INSERT
                        (
                        SYS_ID         , --시스템 아이디                                                                      
                        COMP_CD        , --회사코드                                                                           
                        PR_NO          , --구매요청 번호
                        PR_LNO         , --구매요청 항번                                                                      
                        PR_SVC_LNO     , --구매요청 서비스 항번                                                               
                        PR_ACC_LNO     , --구매요청 계정 항번                                                                 
                        ACC_TYP        , --계정유형                                                                           
                        QTY_OR_RATE    , --수량 OR 율                                                                         
                        BUDGET_AMT     , --예산금액                                                                           
                        GL_ACC_CD      , --GL ACCOUNT 코드                                                                    
                        GL_ACC_NM      , --GL ACCOUNT명                                                                       
                        GL_DATE        , --G/L일자(SAP에서 마감일짜)                                                          
                        COST_ACC_CD    , --COST CENTER 코드                                                                   
                        COST_ACC_NM    , --COST CENTER명                                                                      
                        WBS_CD         , --WBS 코드                                                                           
                        WBS_NM         , --WBS명                                                                              
                        FUND_CENTER_CD , --FUND CENTER 코드                                                                   
                        FUND_CENTER_NM , --FUND CENTER명                                                                      
                        TMP_ASSET_NO   , --임시자산번호                                                                       
                        ASSET_NO       , --자산번호                                                                           
                        ASSET_NO_NM    , --자산번호명                                                                         
                        ASSET_SUB_NO   , --자산하위번호                                                                       
                        ORDER_NO       , --오더번호                                                                           
                        ORDER_NO_NM    , --오더번호명   
                        SVC_MASTER     , --서비스마스터                                                                           
                        SVC_MASTER_NM  , --서비스마스터명                                                                      
                        STS            , --상태                                                                               
                        REG_ID         , --등록자 아이디                                                                      
                        REG_DT         , --등록 일시                                                                          
                        MOD_ID         , --수정자 아이디                                                                      
                        MOD_DT           --수정 일시                                                                          
                      )
                VALUES
                      (
                        B.SYS_ID         , --시스템 아이디                                                                       
                        B.COMP_CD        , --회사코드                                                                            
                        B.PR_NO          , --구매요청 번호 
                        B.PR_LNO         , --구매요청 항번                                                                       
                        B.PR_SVC_LNO     , --구매요청 서비스 항번                                                                
                        B.PR_ACC_LNO     , --구매요청 계정 항번                                                                  
                        B.ACC_TYP        , --계정유형                                                                            
                        B.QTY_OR_RATE    , --수량 OR 율                                                                          
                        B.BUDGET_AMT     , --예산금액                                                                            
                        B.GL_ACC_CD      , --GL ACCOUNT 코드                                                                     
                        B.GL_ACC_NM      , --GL ACCOUNT명                                                                        
                        B.GL_DATE        , --G/L일자(SAP에서 마감일짜)                                                           
                        B.COST_ACC_CD    , --COST CENTER 코드                                                                    
                        B.COST_ACC_NM    , --COST CENTER명                                                                       
                        B.WBS_CD         , --WBS 코드                                                                            
                        B.WBS_NM         , --WBS명                                                                               
                        B.FUND_CENTER_CD , --FUND CENTER 코드                                                                    
                        B.FUND_CENTER_NM , --FUND CENTER명                                                                       
                        B.TMP_ASSET_NO   , --임시자산번호                                                                        
                        B.ASSET_NO       , --자산번호                                                                            
                        B.ASSET_NO_NM    , --자산번호명                                                                          
                        B.ASSET_SUB_NO   , --자산하위번호                                                                        
                        B.ORDER_NO       , --오더번호                                                                            
                        B.ORDER_NO_NM    , --오더번호명 
                        B.SVC_MASTER     , --서비스마스터                                                                           
                        B.SVC_MASTER_NM  , --서비스마스터명                                                                         
                        B.STS            , --상태                                                                                
                        B.REG_ID         , --등록자 아이디                                                                       
                        B.REG_DT         , --등록 일시                                                                           
                        B.MOD_ID         , --수정자 아이디                                                                       
                        B.MOD_DT           --수정 일시                                                                       
                      )
           WHEN MATCHED THEN
                 UPDATE 
                    SET A.BUDGET_AMT     = B.BUDGET_AMT     , --예산금액                                                                           
						A.GL_ACC_CD      = B.GL_ACC_CD      , --GL ACCOUNT 코드                                                                    
						A.GL_ACC_NM      = B.GL_ACC_NM      , --GL ACCOUNT명                                                                       
						A.GL_DATE        = B.GL_DATE        , --G/L일자(SAP에서 마감일짜)                                                          
						A.COST_ACC_CD    = B.COST_ACC_CD    , --COST CENTER 코드                                                                   
						A.COST_ACC_NM    = B.COST_ACC_NM    , --COST CENTER명                                                                      
						A.WBS_CD         = B.WBS_CD         , --WBS 코드                                                                           
						A.WBS_NM         = B.WBS_NM         , --WBS명                                                                              
						A.FUND_CENTER_CD = B.FUND_CENTER_CD , --FUND CENTER 코드                                                                   
						A.FUND_CENTER_NM = B.FUND_CENTER_NM , --FUND CENTER명                                                                      
						A.TMP_ASSET_NO   = B.TMP_ASSET_NO   , --임시자산번호                                                                       
						A.ASSET_NO       = B.ASSET_NO       , --자산번호                                                                           
						A.ASSET_NO_NM    = B.ASSET_NO_NM    , --자산번호명                                                                         
						A.ASSET_SUB_NO   = B.ASSET_SUB_NO   , --자산하위번호                                                                       
						A.ORDER_NO       = B.ORDER_NO       , --오더번호                                                                           
						A.ORDER_NO_NM    = B.ORDER_NO_NM    , --오더번호명                                                                         
						A.SVC_MASTER     = B.SVC_MASTER     , --서비스마스터                                                                       
						A.SVC_MASTER_NM  = B.SVC_MASTER_NM  , --서비스마스터명                                                                     
						A.STS            = B.STS            , --상태                                                                               
						A.MOD_ID         = B.MOD_ID         , --수정자 아이디                                                                      
						A.MOD_DT         = B.MOD_DT           --수정 일시                                                                          
        ]]>
    </sql>
    
    <sql id="update.pr.status" comment="PR Item IF 전송 성공 후처리">
        <![CDATA[
        BEGIN
            UPDATE ESPPRHD PRHD
               SET APRV_STS     = CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                            THEN 'C'
                                       ELSE NVL(#aprv_sts#, 'T')
                                   END                                            , --결재상태 [P011] (T:작성중, P:결재중, C:결재승인, B:반려, N:결재취소)               
                   APRV_ID      = CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                            THEN #s_reg_id#
                                       ELSE ''
                                   END                                            , --승인자 아이디               
                   APRV_DATE    = CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                            THEN TO_CHAR(SYSDATE,'YYYYMMDD')
                                        ELSE ''
                                   END                                            , --승인일
                   STS          = CASE WHEN ( SELECT COUNT(*)
                                                FROM ESPPRDT
                                               WHERE SYS_ID = PRHD.SYS_ID
                                                AND COMP_CD = PRHD.COMP_CD
                                                AND PR_NO   = PRHD.PR_NO )  =  ( SELECT COUNT(*)
                                                                                   FROM ESPPRDT
                                                                                  WHERE SYS_ID  = PRHD.SYS_ID
                                                                                    AND COMP_CD = PRHD.COMP_CD
                                                                                    AND PR_NO   = PRHD.PR_NO
                                                                                    AND STS     = 'D') 
                                             THEN 'D'
                                        ELSE STS
                                   END                                            ,
                   MOD_ID       = #s_reg_id#                                        ,
                   MOD_DT       = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')             
             WHERE SYS_ID       = #sys_id#
               AND COMP_CD      = #s_comp_cd#
               AND PR_NO        = #pr_no#;
                 
            UPDATE ESPPRDT 
               SET PR_PROG_STS           = CASE WHEN PR_PROG_STS <> 'RD' AND STS <> 'D'
                                                     THEN CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                                                    THEN 'RW'
                                                               ELSE 'RN'
                                                           END
                                                ELSE PR_PROG_STS
                                            END                                   ,
                   MOD_ID                = #s_reg_id#                               ,
                   MOD_DT                = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
             WHERE SYS_ID                = #sys_id#
               AND COMP_CD               = #s_comp_cd#
               AND PR_NO                 = #pr_no#
             [ AND PR_LNO                = #pr_lno# ]
               AND NVL(SAP_DEL_YN, 'N')  = 'N';
         END;
         ]]>
    </sql>
    
    <sql id="update.pr.status.by.gu" comment="PR Item IF 전송 성공 후처리">
        <![CDATA[
        BEGIN
            UPDATE ESPPRHD PRHD
               SET STS          = CASE WHEN ( SELECT COUNT(*)
                                                FROM ESPPRDT
                                               WHERE SYS_ID = PRHD.SYS_ID
                                                AND COMP_CD = PRHD.COMP_CD
                                                AND PR_NO   = PRHD.PR_NO )  =  ( SELECT COUNT(*)
                                                                                   FROM ESPPRDT
                                                                                  WHERE SYS_ID  = PRHD.SYS_ID
                                                                                    AND COMP_CD = PRHD.COMP_CD
                                                                                    AND PR_NO   = PRHD.PR_NO
                                                                                    AND STS     = 'D') 
                                             THEN 'D'
                                        ELSE STS
                                   END                                            ,
                   MOD_ID       = #s_reg_id#                                        ,
                   MOD_DT       = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')             
             WHERE SYS_ID       = #sys_id#
               AND COMP_CD      = #s_comp_cd#
               AND PR_NO        = #pr_no#;
                 
            UPDATE ESPPRDT 
               SET MOD_ID                = #s_reg_id#                               ,
                   MOD_DT                = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
             WHERE SYS_ID                = #sys_id#
               AND COMP_CD               = #s_comp_cd#
               AND PR_NO                 = #pr_no#
             [ AND PR_LNO                = #pr_lno# ]
               AND NVL(SAP_DEL_YN, 'N')  = 'N';
         END;
         ]]>
    </sql>
    
    <sql id="update.pr.ifflag" comment="PR Item IF 전송 성공 후처리">
        <![CDATA[
        BEGIN
            UPDATE ESPPRHD PRHD
               SET SAP_PR_NO    = CASE WHEN #sap_pr_no# IS NOT NULL
                                            THEN #sap_pr_no#
                                       ELSE SAP_PR_NO
                                   END                                            ,
                   IF_REJECT_YN = 'N'                                             ,
                   IF_FLAG      = #rtn_flag#                                      ,
                   IF_DATE      = TO_CHAR(SYSDATE,'YYYYMMDD')                     ,
                   IF_MSG       = SUBSTRB(#rtn_msg#, 1, 1000 )                    ,
                   IF_TYP       = 'S'                                             ,
                   APRV_STS     = CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                            THEN 'C'
                                       ELSE CASE WHEN #trans_flag# = 'send' AND #rtrn_code# = 'E'
                                                      THEN 'T'
                                                 ELSE NVL(#aprv_sts#, 'T')
                                             END
                                   END                                            , --결재상태 [P011] (T:작성중, P:결재중, C:결재승인, B:반려, N:결재취소)               
                   APRV_ID      = CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                            THEN #s_reg_id#
                                       ELSE ''
                                   END                                            , --승인자 아이디               
                   APRV_DATE    = CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                            THEN TO_CHAR(SYSDATE,'YYYYMMDD')
                                        ELSE APRV_DATE
                                   END                                            , --승인일
                   STS          = CASE WHEN ( SELECT COUNT(*)
                                                FROM ESPPRDT
                                               WHERE SYS_ID = PRHD.SYS_ID
                                                AND COMP_CD = PRHD.COMP_CD
                                                AND PR_NO   = PRHD.PR_NO )  =  ( SELECT COUNT(*)
                                                                                   FROM ESPPRDT
                                                                                  WHERE SYS_ID  = PRHD.SYS_ID
                                                                                    AND COMP_CD = PRHD.COMP_CD
                                                                                    AND PR_NO   = PRHD.PR_NO
                                                                                    AND STS     = 'D') 
                                             THEN 'D'
                                        ELSE STS
                                   END                                            ,
                   MOD_ID       = #s_reg_id#                                        ,
                   MOD_DT       = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')             
             WHERE SYS_ID       = #sys_id#
               AND COMP_CD      = #s_comp_cd#
               AND PR_NO        = #pr_no#;
                 
            UPDATE ESPPRDT PRDT
               SET SAP_PR_NO             = CASE WHEN #sap_pr_no# IS NOT NULL AND SAP_PR_LNO IS NOT NULL
                                                     THEN #sap_pr_no#
                                                ELSE SAP_PR_NO
                                            END                                            ,
                   SAP_DEL_YN            = CASE WHEN #sap_pr_no# IS NOT NULL AND STS = 'D' OR PR_PROG_STS = 'RD' 
                                                     THEN 'Y' 
                                                ELSE 'N' 
                                            END                ,
                   PR_PROG_STS           = CASE WHEN PR_PROG_STS <> 'RD' AND STS <> 'D' AND MOD_REQ_PROG_STS = 'A' 
                   													THEN 'RW'
                                                            WHEN PR_PROG_STS <> 'RD' AND STS <> 'D'
                                                            		THEN CASE WHEN #rtrn_code# = 'S' AND #elec_aprv_yn# = 'N'
                                                                    THEN 'RW'
                                                            ELSE 'RN' END
                                                    ELSE PR_PROG_STS
                                            END                                            ,
                   IF_FLAG               = #rtn_flag#                                      ,
                   IF_DATE               = TO_CHAR(SYSDATE,'YYYYMMDD')                     ,
                   IF_MSG                = SUBSTRB(#rtn_msg#, 1, 1000 )                    ,
                   IF_TYP                = 'S'                                             ,
                   MOD_ID                = #s_reg_id#                                        ,
                   MOD_DT                = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
             WHERE SYS_ID                = #sys_id#
               AND COMP_CD               = #s_comp_cd#
               AND PR_NO                 = #pr_no#
             [ AND PR_LNO                = #pr_lno# ]
               AND NVL(SAP_DEL_YN, 'N')  = 'N'
               AND EXISTS ( SELECT 'X'
                             FROM ESPTEMP
                             WHERE SYS_ID  = PRDT.SYS_ID
                               AND COMP_CD = PRDT.COMP_CD
                               AND PR_NO   = PRDT.PR_NO
                               AND PR_LNO  = PRDT.PR_LNO );
                               
                               
          UPDATE ESPPRDT PRDT
               SET PR_PROG_STS           = 'RW'
             WHERE SYS_ID                = #sys_id#
               AND COMP_CD               = #s_comp_cd#
               AND PR_NO                 = #pr_no#
               AND PR_PROG_STS           IN ('RN', 'RA')
               AND EXISTS ( SELECT 'X'
                              FROM ESPPRHD
                             WHERE SYS_ID   = PRDT.SYS_ID
                               AND COMP_CD  = PRDT.COMP_CD
                               AND PR_NO    = PRDT.PR_NO
                               AND APRV_STS = 'C' );
         END;
         ]]>
    </sql>
    
    <sql id="update.pr.ifflag.by.gu" comment="PR Item IF 전송 성공 후처리">
        <![CDATA[
        BEGIN
            UPDATE ESPPRHD PRHD
               SET SAP_PR_NO    = CASE WHEN #sap_pr_no# IS NOT NULL
                                            THEN #sap_pr_no#
                                       ELSE SAP_PR_NO
                                   END                                            ,
                   IF_REJECT_YN = 'N'                                             ,
                   IF_FLAG      = #rtn_flag#                                      ,
                   IF_DATE      = TO_CHAR(SYSDATE,'YYYYMMDD')                     ,
                   IF_MSG       = SUBSTRB(#rtn_msg#, 1, 1000 )                    ,
                   IF_TYP       = 'S'                                             ,
                   STS          = CASE WHEN ( SELECT COUNT(*)
                                                FROM ESPPRDT
                                               WHERE SYS_ID = PRHD.SYS_ID
                                                AND COMP_CD = PRHD.COMP_CD
                                                AND PR_NO   = PRHD.PR_NO )  =  ( SELECT COUNT(*)
                                                                                   FROM ESPPRDT
                                                                                  WHERE SYS_ID  = PRHD.SYS_ID
                                                                                    AND COMP_CD = PRHD.COMP_CD
                                                                                    AND PR_NO   = PRHD.PR_NO
                                                                                    AND STS     = 'D') 
                                             THEN 'D'
                                        ELSE STS
                                   END                                            ,
                   MOD_ID       = #s_reg_id#                                        ,
                   MOD_DT       = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')             
             WHERE SYS_ID       = #sys_id#
               AND COMP_CD      = #s_comp_cd#
               AND PR_NO        = #pr_no#;
                 
            UPDATE ESPPRDT 
               SET SAP_PR_NO             = CASE WHEN #sap_pr_no# IS NOT NULL AND SAP_PR_LNO IS NOT NULL
                                                     THEN #sap_pr_no#
                                                ELSE SAP_PR_NO
                                            END                                            ,
                   SAP_DEL_YN            = CASE WHEN #sap_pr_no# IS NOT NULL AND STS = 'D' OR PR_PROG_STS = 'RD' 
                                                     THEN 'Y' 
                                                ELSE 'N' 
                                            END                                            ,
                   PR_PROG_STS           = 'RW'                                            ,
                   IF_FLAG               = #rtn_flag#                                      ,
                   IF_DATE               = TO_CHAR(SYSDATE,'YYYYMMDD')                     ,
                   IF_MSG                = SUBSTRB(#rtn_msg#, 1, 1000 )                    ,
                   IF_TYP                = 'S'                                             ,
                   MOD_ID                = #s_reg_id#                                        ,
                   MOD_DT                = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
             WHERE SYS_ID                = #sys_id#
               AND COMP_CD               = #s_comp_cd#
               AND PR_NO                 = #pr_no#
             [ AND PR_LNO                = #pr_lno# ]
               AND NVL(SAP_DEL_YN, 'N')  = 'N';
         END;
         ]]>
    </sql>
    
    <sql id="insert.temp.excel.item" comment="">
        <![CDATA[
            INSERT INTO ESPTEMP
                      ( SYS_ID
                      , COMP_CD
                      , SAP_ITEM_CD
                      , ITEM_CD
                      , ITEM_QTY
                      , ITEM_PRICE
                      , PRICE_UNIT
                      , PLT_CD
                      , RD_LOCAT
                      , VD_CD
                      , SAP_VD_CD
                      , SEQ 
                      )
                 VALUES
                      ( #sys_id#
                      , #s_comp_cd#
                      , UPPER( TRIM( REPLACE( #sap_item_cd#, 'null', '' ) ) )
                      , UPPER( TRIM( REPLACE( #item_cd#, 'null', '' ) ) )
                      , TRIM( REPLACE( #item_qty#, 'null', '' ) )
                      , TRIM( REPLACE( #item_price#, 'null', '' ) )
                      , TRIM( REPLACE( #price_unit#, 'null', '1' ) )
                      , UPPER( TRIM( REPLACE( #plt_cd#, 'null', '' ) ) )
                      , TRIM( REPLACE( #rd_locat#, 'null', '' ) )
                      , UPPER( TRIM( REPLACE( #vd_cd#, 'null', '' ) ) )
                      , UPPER( TRIM( REPLACE( #sap_vd_cd#, 'null', '' ) ) )
                      , #seq# 
                      )
        ]]>
    </sql>
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                 구 매 요 청 생 성 쿼 리  END        ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #######################                 구 매 요 청 목 록, 구 매 요 청 진 행 현 황 쿼 리  START              ############################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    <!--
    ***************************************************************************************************************************
    ** @Description    : PR목록  조회
    ** @Author         : 김병철(phatchul)
    ** @Create Date    : 2010.10.05
    ** @History        : 1) 2010.10.05-최초 생성
    ***************************************************************************************************************************
    -->
    <sql id="select.pr.list" comment="PR목록  조회">
        <![CDATA[
            SELECT AA.*
                 , DECODE(AA.APRV_FLAG, 'Y', 'assets/images/icon_view.png', '')                                                    AS APRV_IMG
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'USER', AA.APRV_ID, '', '','','','') 
                       FROM DUAL )                                                                                                  AS APRV_USER_NM      
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'USER', AA.PR_REQ_ID, '', '','','','')  
                       FROM DUAL )                                                                                                  AS REQ_USER_NM       
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'DEPT', AA.COMP_CD, AA.PLT_CD, AA.DEPT_CD,'','','')  
                       FROM DUAL )                                                                                                  AS PR_REQ_DEPT_NM    
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'CODE', 'P045', AA.PURC_TYP,'','','','') 
                       FROM DUAL )                                                                                                  AS PURC_TYP_NM        
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'CODE', 'P011', AA.TMP_APRV_STS,'','','','')  
                       FROM DUAL )                                                                                                  AS APRV_STS_NM 
                 , ( SELECT FC_GET_NAME(AA.SYS_ID,'ko_KR', AA.COMP_CD, 'CODE', 'P049', AA.PURC_REQ_TYP_SUB, '', '', '', '') 
                       FROM DUAL )                                                                                                  AS PURC_REQ_TYP_NM   --구매요청유형명
                 , ( SELECT FC_GET_ORG_SN_NAME(AA.SYS_ID, '', AA.OPER_ORG_SN) FROM DUAL )                                           AS OPER_ORG_NM          
              FROM(
                    SELECT TOT.SYS_ID                                                                                AS SYS_ID            ,
		                   TOT.COMP_CD                                                                               AS COMP_CD           ,
		                   TOT.LOCALE                                                                                AS LOCALE ,
		                   TOT.APRV_STS                                                                              AS APRV_STS          ,                          
		                   CASE WHEN TOT.ELEC_APRV_YN = 'N' AND TOT.APRV_STS = 'C'
                                     THEN 'K'
                                ELSE TOT.APRV_STS
                            END                                                                                      AS TMP_APRV_STS      ,
                           TOT.APRV_URL                                                                              AS APRV_URL          ,
		                   TOT.APRV_NO                                                                               AS APRV_NO           ,
		                   CASE WHEN TOT.APRV_STS IN ('T', 'P', 'C', 'S','R') AND TOT.APRV_NO IS NOT NULL                                  
		                             THEN 'Y'
		                        ELSE 'N' 
		                    END                                                                                      AS APRV_FLAG         ,                                                                                              
		                   TOT.PURC_REQ_TYP                                                                          AS PURC_REQ_TYP      ,
		                   TOT.PURC_TYP                                                                              AS PURC_TYP          ,
		                   TOT.PR_NO                                                                                 AS PR_NO             ,
		                   TOT.SAP_PR_NO                                                                             AS SAP_PR_NO         ,     
		                   TOT.CUR                                                                                   AS CUR               ,   
		                   TOT.PR_TOT_AMT                                                                            AS PR_TOT_AMT        ,   
		                   TOT.PR_TIT                                                                                AS PR_TIT            ,   
		                   TOT.PR_REQ_DATE                                                                           AS REQ_DATE          ,
		                   TOT.APRV_DATE                                                                             AS APRV_DATE         ,  
		                   TOT.APRV_ID                                                                               AS APRV_ID           ,                          
		                   TOT.PR_REQ_ID                                                                             AS PR_REQ_ID         ,  
		                -- TOT.PR_REQ_DEPT                                                                           AS DEPT_CD           , -- 구매생성시 ESPPRHD에 저장된 구매부서 가져오기
		                   TOT.DEPT_CD																				 AS DEPT_CD			  , -- 사용자 테이블 ESAUSER에 해당 구매요청담당자의 구매부서 가져오기 (1:1 관계확인)
		                   TOT.MIG_YN                                                                                AS MIG_YN            ,       
		                   TOT.ATT_NO                                                                                AS ATT_NO            ,
		                   NVL(TOT.IF_TYP, 'S')                                                                      AS IF_TYP            ,  
		                   TOT.IF_MSG                                                                                AS IF_MSG            ,
		                   TOT.PURC_REQ_TYP_SUB                                                                      AS PURC_REQ_TYP_SUB  ,
		                   ( SELECT COUNT(1) 
		                       FROM ESAATTH 
		                      WHERE SYS_ID = TOT.SYS_ID 
		                        AND GRP_CD = TOT.ATT_NO 
		                        AND STS <> 'D' )                                                                     AS ATT_CNT           , 
		                   TOT.REG_ID                                                                                AS REG_ID            ,                           
		                   TOT.ITEM_CNT                                                                                                   ,   
		                   TOT.ITEM_CRE_CNT                                                                                               ,   
		                   TOT.ITEM_DEL_CNT                                                                                               ,  
		                   TOT.ITEM_REJ_CNT                                                                                               , 
		                   TOT.PLT_CD                                                                                                     ,
		                   TOT.ELEC_APRV_YN																								  ,
		                   TOT.OPER_ORG_SN
		            FROM (
		                  SELECT #locale# AS LOCALE, 
		                         PRHD.*,
		                         CASE WHEN PRHD.PURC_REQ_TYP = 'NC' AND PRDT.PRICE_CNTR_NO IS NOT NULL
                                           THEN 'CC'
                                      ELSE PRHD.PURC_REQ_TYP
                                  END                                                                               AS PURC_REQ_TYP_SUB       , --구매요청요형
		                         NVL(PRDT.ITEM_CNT, 0) AS ITEM_CNT,
		                         NVL(PRDT.ITEM_CRE_CNT, 0) AS ITEM_CRE_CNT,
		                         NVL(PRDT.ITEM_DEL_CNT, 0) AS ITEM_DEL_CNT,
		                         NVL(PRDT.ITEM_REJ_CNT, 0) AS ITEM_REJ_CNT,
		                         AUSR.DEPT_CD			   AS DEPT_CD,
		                         AUSR.PLT_CD
		                    FROM ( SELECT /*+ INDEX ( PRHD IDX_ESPPRHD_01 ) */
		                                  *
		                             FROM ESPPRHD
		                            WHERE SYS_ID  = #sys_id#
		                              AND (
		                                      (
		                                          #comp_flag#   = 'Y' 
		                                          AND
		                                          (
		                                              #comp_cd#    IS NULL
		                                              OR
		                                              COMP_CD  = NVL(#comp_cd#, #s_comp_cd#)
		                                          )
		                                       )
		                                       OR
		                                       (
		                                           #comp_flag#   IS NULL
		                                           AND
		                                           COMP_CD  = #s_comp_cd#
		                                       )
		                                 )
		                             AND PR_REQ_DATE BETWEEN #from_date# AND #to_date#
		                           [ AND PURC_TYP        =    #purc_typ#          ]
		                           [ AND SAP_PR_NO       LIKE '%'||UPPER(#sap_pr_no#) || '%' ]
		                           [ AND PR_NO           LIKE '%'||UPPER(#pr_no#) || '%' ]
		                           [ AND (
		                                     ( #aprv_sts# = 'K' AND ELEC_APRV_YN = 'N' AND APRV_STS = 'C' )
		                                  OR ( #aprv_sts# = 'C' AND ELEC_APRV_YN = 'Y' AND APRV_STS = 'C' )
		                                  OR ( #aprv_sts# NOT IN ('K', 'C') AND APRV_STS = #aprv_sts# ) 
		                                 ) ]
		                           [ AND PR_REQ_ID       =    #pr_req_id#         ]
		                           [ AND PR_REQ_DEPT     =    #pr_req_dept#       ]
        {
				  	//운영조직 일련번호 (복수 선택)
				  	var sql = "";
				  	var list = $data.oper_org_sn;
				  	if(list.length > 0)
				  	{
				  		sql = "AND OPER_ORG_SN IN ("
				  		sql += list.join();
				  		sql += ")";
				  	}
			  		sql;
		  }
		                             AND PR_MOD_PROG_STS = 'T'             
		                             AND STS             <>   'D'
		                        ORDER BY PR_NO DESC) PRHD,
		                        ( SELECT SYS_ID, 
		                                 COMP_CD, 
		                                 OPER_ORG_SN,
		                                 PR_NO, 
		                                 MAX(PRICE_CNTR_NO)               AS PRICE_CNTR_NO,
		                                 COUNT(*) AS ITEM_CNT,
		                                 COUNT(DECODE(STS, 'D', NULL, 1)) AS ITEM_CRE_CNT,
		                                 COUNT(DECODE(STS, 'D', 1))       AS ITEM_DEL_CNT,
		                                 COUNT(DECODE(STS, 'D', NULL, DECODE(PR_PROG_STS, 'RD', 1))) AS ITEM_REJ_CNT
		                            FROM ESPPRDT
		                           WHERE SYS_ID = #sys_id#
		                        GROUP BY SYS_ID, COMP_CD, OPER_ORG_SN, PR_NO
		                        ) PRDT,
		                        ESAUSER AUSR               
		                  WHERE PRHD.SYS_ID      = PRDT.SYS_ID
		                    AND PRHD.COMP_CD     = PRDT.COMP_CD
		                    AND PRHD.OPER_ORG_SN = PRDT.OPER_ORG_SN
		                    AND PRHD.PR_NO       = PRDT.PR_NO
		                    AND PRHD.SYS_ID      = AUSR.SYS_ID(+)
		                    AND PRHD.COMP_CD     = AUSR.COMP_CD(+)
		                    AND PRHD.PR_REQ_ID   = AUSR.USR_ID(+)
		                ) TOT
		                WHERE 1=1
		                [ AND PURC_REQ_TYP_SUB = #purc_req_typ# ] 
                   ) AA
             ORDER BY AA.COMP_CD, AA.PR_NO DESC
        ]]>
    </sql>
   
       <sql id="select.pr.list.copySearch" comment="구매요청복사시 조회 ">
        <![CDATA[
            SELECT AA.*
                 , DECODE(AA.APRV_FLAG, 'Y', 'assets/images/icon_view.png', '')                                                    AS APRV_IMG
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'USER', AA.APRV_ID, '', '','','','') 
                       FROM DUAL )                                                                                                  AS APRV_USER_NM      
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'USER', AA.PR_REQ_ID, '', '','','','')  
                       FROM DUAL )                                                                                                  AS REQ_USER_NM       
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'DEPT', AA.COMP_CD, AA.PLT_CD, AA.DEPT_CD,'','','')  
                       FROM DUAL )                                                                                                  AS PR_REQ_DEPT_NM    
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'CODE', 'P045', AA.PURC_TYP,'','','','') 
                       FROM DUAL )                                                                                                  AS PURC_TYP_NM        
                 , ( SELECT FC_GET_NAME(AA.SYS_ID, AA.LOCALE, AA.COMP_CD, 'CODE', 'P011', AA.TMP_APRV_STS,'','','','')  
                       FROM DUAL )                                                                                                  AS APRV_STS_NM 
                 , ( SELECT FC_GET_NAME(AA.SYS_ID,'ko_KR', AA.COMP_CD, 'CODE', 'P049', AA.PURC_REQ_TYP_SUB, '', '', '', '') 
                       FROM DUAL )                                                                                                  AS PURC_REQ_TYP_NM   --구매요청유형명          
                         
              FROM(
                    SELECT TOT.SYS_ID                                                                                AS SYS_ID            ,
		                   TOT.COMP_CD                                                                               AS COMP_CD           ,
		                   TOT.LOCALE                                                                                AS LOCALE ,
		                   TOT.APRV_STS                                                                              AS APRV_STS          ,                          
		                   CASE WHEN TOT.ELEC_APRV_YN = 'N' AND TOT.APRV_STS = 'C'
                                     THEN 'K'
                                ELSE TOT.APRV_STS
                            END                                                                                      AS TMP_APRV_STS      ,
                           TOT.APRV_URL                                                                              AS APRV_URL          ,
		                   TOT.APRV_NO                                                                               AS APRV_NO           ,
		                   CASE WHEN TOT.APRV_STS IN ('T', 'P', 'C', 'S','R') AND TOT.APRV_NO IS NOT NULL                                  
		                             THEN 'Y'
		                        ELSE 'N' 
		                    END                                                                                      AS APRV_FLAG         ,                                                                                              
		                   TOT.PURC_REQ_TYP                                                                          AS PURC_REQ_TYP      ,
		                   TOT.PURC_TYP                                                                              AS PURC_TYP          ,
		                   TOT.PR_NO                                                                                 AS PR_NO             ,
		                   TOT.SAP_PR_NO                                                                             AS SAP_PR_NO         ,     
		                   TOT.CUR                                                                                   AS CUR               ,   
		                   TOT.PR_TOT_AMT                                                                            AS PR_TOT_AMT        ,   
		                   TOT.PR_TIT                                                                                AS PR_TIT            ,   
		                   TOT.PR_REQ_DATE                                                                           AS REQ_DATE          ,
		                   TOT.APRV_DATE                                                                             AS APRV_DATE         ,  
		                   TOT.APRV_ID                                                                               AS APRV_ID           ,                          
		                   TOT.PR_REQ_ID                                                                             AS PR_REQ_ID         ,  
		                   TOT.PR_REQ_DEPT                                                                           AS DEPT_CD           ,
		                   TOT.MIG_YN                                                                                AS MIG_YN            ,       
		                   TOT.ATT_NO                                                                                AS ATT_NO            ,
		                   NVL(TOT.IF_TYP, 'S')                                                                      AS IF_TYP            ,  
		                   TOT.IF_MSG                                                                                AS IF_MSG            ,
		                   TOT.PURC_REQ_TYP_SUB                                                                      AS PURC_REQ_TYP_SUB  ,
		                   ( SELECT COUNT(1) 
		                       FROM ESAATTH 
		                      WHERE SYS_ID = TOT.SYS_ID 
		                        AND GRP_CD = TOT.ATT_NO 
		                        AND STS <> 'D' )                                                                     AS ATT_CNT           , 
		                   TOT.REG_ID                                                                                AS REG_ID            ,                           
		                   TOT.ITEM_CNT                                                                                                   ,   
		                   TOT.ITEM_CRE_CNT                                                                                               ,   
		                   TOT.ITEM_DEL_CNT                                                                                               ,  
		                   TOT.ITEM_REJ_CNT                                                                                               , 
		                   TOT.PLT_CD                                                                                                     ,
		                   TOT.ELEC_APRV_YN																								  ,
		                   TOT.OPER_ORG_SN
		            FROM (
		                  SELECT #locale# AS LOCALE, 
		                         PRHD.*,
		                         CASE WHEN PRHD.PURC_REQ_TYP = 'NC' AND PRDT.PRICE_CNTR_NO IS NOT NULL
                                           THEN 'CC'
                                      ELSE PRHD.PURC_REQ_TYP
                                  END                                                                               AS PURC_REQ_TYP_SUB       , --구매요청요형
		                         NVL(PRDT.ITEM_CNT, 0) AS ITEM_CNT,
		                         NVL(PRDT.ITEM_CRE_CNT, 0) AS ITEM_CRE_CNT,
		                         NVL(PRDT.ITEM_DEL_CNT, 0) AS ITEM_DEL_CNT,
		                         NVL(PRDT.ITEM_REJ_CNT, 0) AS ITEM_REJ_CNT,
		                         AUSR.PLT_CD
		                    FROM ( SELECT /*+ INDEX ( PRHD IDX_ESPPRHD_01 ) */
		                                  *
		                             FROM ESPPRHD
		                            WHERE SYS_ID  = #sys_id#
		                              AND (
		                                      (
		                                          #comp_flag#   = 'Y' 
		                                          AND
		                                          (
		                                              #comp_cd#    IS NULL
		                                              OR
		                                              COMP_CD  = NVL(#comp_cd#, #s_comp_cd#)
		                                          )
		                                       )
		                                       OR
		                                       (
		                                           #comp_flag#   IS NULL
		                                           AND
		                                           COMP_CD  = #s_comp_cd#
		                                       )
		                                 )
		                             AND PR_REQ_DATE BETWEEN #from_date# AND #to_date#
		                           [ AND PURC_TYP        =    #purc_typ#          ]
		                           [ AND SAP_PR_NO       LIKE '%'||UPPER(#sap_pr_no#) || '%' ]
		                           [ AND PR_NO           LIKE '%'||UPPER(#pr_no#) || '%' ]
		                           [ AND (
		                                     ( #aprv_sts# = 'K' AND ELEC_APRV_YN = 'N' AND APRV_STS = 'C' )
		                                  OR ( #aprv_sts# = 'C' AND ELEC_APRV_YN = 'Y' AND APRV_STS = 'C' )
		                                  OR ( #aprv_sts# NOT IN ('K', 'C') AND APRV_STS = #aprv_sts# ) 
		                                 ) ]
		                           [ AND PR_REQ_ID       =    #pr_req_id#         ]
		                           [ AND PR_REQ_DEPT     =    #pr_req_dept#       ]
		                           [ AND OPER_ORG_SN     =    #oper_org_sn#       ]
		                             AND PR_MOD_PROG_STS = 'T'             
		                             AND STS             <>   'D'
		                        ORDER BY PR_NO DESC) PRHD,
		                        ( SELECT SYS_ID, 
		                                 COMP_CD, 
		                                 OPER_ORG_SN,
		                                 PR_NO, 
		                                 MAX(PRICE_CNTR_NO)               AS PRICE_CNTR_NO,
		                                 COUNT(*) AS ITEM_CNT,
		                                 COUNT(DECODE(STS, 'D', NULL, 1)) AS ITEM_CRE_CNT,
		                                 COUNT(DECODE(STS, 'D', 1))       AS ITEM_DEL_CNT,
		                                 COUNT(DECODE(STS, 'D', NULL, DECODE(PR_PROG_STS, 'RD', 1))) AS ITEM_REJ_CNT
		                            FROM ESPPRDT
		                           WHERE SYS_ID = #sys_id#
		                        GROUP BY SYS_ID, COMP_CD, OPER_ORG_SN, PR_NO
		                        ) PRDT,
		                        ESAUSER AUSR               
		                  WHERE PRHD.SYS_ID      = PRDT.SYS_ID
		                    AND PRHD.COMP_CD     = PRDT.COMP_CD
		                    AND PRHD.OPER_ORG_SN = PRDT.OPER_ORG_SN
		                    AND PRHD.PR_NO       = PRDT.PR_NO
		                    AND PRHD.SYS_ID      = AUSR.SYS_ID(+)
		                    AND PRHD.COMP_CD     = AUSR.COMP_CD(+)
		                    AND PRHD.PR_REQ_ID   = AUSR.USR_ID(+)
		                ) TOT
		                WHERE 1=1
		                [ AND PURC_REQ_TYP_SUB = #purc_req_typ# ] 
                   ) AA    
        ]]>
    </sql>
 
    <sql id="select.pr_reject.list" comment="">
        <![CDATA[
            SELECT PRDT.PR_NO,
                   PRDT.PR_LNO,
                   PRDT.ITEM_NM,
                   PRDT.REJECT_CAUSE
              FROM ESPPRDT PRDT
             WHERE PRDT.SYS_ID         = #sys_id#
               AND (
                      (
                         #comp_flag#   = 'Y' 
                         AND
                         (
                            #comp_cd#     IS NULL
                            OR
                            PRDT.COMP_CD  = NVL(#comp_cd#, #s_comp_cd#)
                         )
                      )
                      OR
                      (
                         #comp_flag#   IS NULL
                         AND
                         PRDT.COMP_CD  = #s_comp_cd#
                      )
                   )
               AND PRDT.PR_NO   = #pr_no#
          ORDER BY PRDT.PR_NO, TO_NUMBER(PRDT.PR_LNO)
        ]]>
    </sql>
    
    <sql id="select.pr.progstslist" comment="PR진행현황 조회">
        <![CDATA[
            SELECT TOT.*,
                   ( SELECT FC_GET_ORG_SN_NAME(TOT.SYS_ID, '', TOT.OPER_ORG_SN) FROM DUAL )                                   AS OPER_ORG_NM      ,
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'P044', TOT.PR_PROG_STS, '', '', '', '') 
                       FROM DUAL )                                                                                            AS PR_PROG_STS_NM   , --PR진행상태명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'P049', TOT.PURC_REQ_TYP_SUB, '', '', '', '') 
                       FROM DUAL )                                                                                            AS PURC_REQ_TYP_NM  , --구매요청유형명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'P045', TOT.PURC_TYP, '', '', '', '')                              
                       FROM DUAL )                                                                                            AS PURC_TYP_NM      , --구매유형명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'OGMG', 'PLANT', TOT.PLT_CD, '', '', '', '')
                       FROM DUAL )                                                                                            AS PLT_NM           , --Plant명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'VENDOR', TOT.REF_VD, '', '', '', '', '')
                       FROM DUAL )                                                                                            AS REF_VD_NM        , --참조업체명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'USER', TOT.PR_REQ_ID, '', '', '', '' ,'')                          
                        FROM DUAL )                                                                                           AS PR_REQ_NM        , --요청자 명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'USER', TOT.PR_SUG_ID, '', '', '', '' ,'')                          
                        FROM DUAL )                                                                                           AS PR_SUG_NM        , --구매의뢰자 명     
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'C029', TOT.CATE_CD, '', '', '', '')                          
                        FROM DUAL )                                                                                           AS CATE_NM          , --자재그룹명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'P071', TOT.PR_STS, '', '', '', '')                          
                        FROM DUAL )                                                                                           AS PR_STS_NM        ,
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'PURC_GRP', 'PU', TOT.PURC_GRP_CD, '', '', '', '')
                       FROM DUAL )                                                                                            AS PURC_GRP_NM      ,  --구매그룹 명  
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'VENDOR', TOT.VD_CD, '', '', '', '', '') 
                       FROM DUAL )                                                                                            AS VD_NM            ,  --업체명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'P057', TOT.PO_CRE_TYP, '', '', '', '')                          
                       FROM DUAL )                                                                                            AS PO_CRE_TYP_NM    ,
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, TOT.LOCALE, TOT.COMP_CD, 'CODE', 'P053', TOT.PR_TYP, '', '', '', '')                          
                       FROM DUAL )                                                                                            AS PR_TYP_NM        , --구매요청TYPE                                                                                                                                  
                   CASE WHEN TOT.PR_PROG_STS = 'RD'
                        THEN 'assets/images/new_link.png'
                        ELSE ''           
                   END                                                                                                        AS RD_LOCAT1     
              FROM (
		            SELECT PRDT.SYS_ID                                            AS SYS_ID           , --시스템아이디
		                   PRDT.COMP_CD                                           AS COMP_CD          , --회사코드
		                   PRDT.OPER_ORG_SN                                       AS OPER_ORG_SN      ,
		                   #locale#                                               AS LOCALE           , --언어
		                   CASE WHEN PRDT.PR_PROG_STS='GP' AND PRDT.PO_QTY=PRDT.GR_QTY THEN 'GC'
		                        ELSE PRDT.PR_PROG_STS                                       
		                   END                                                    AS PR_PROG_STS      , --PR진행상태
		                   PRDT.PURC_TYP                                          AS PURC_TYP         , --구매유형
		                   PRDT.PR_NO                                             AS PR_NO            , --PR번호
		                   PRDT.PR_LNO                                            AS PR_LNO           , --PR항번
		                   TO_NUMBER(NVL(PRDT.SAP_PR_LNO, PRDT.PR_LNO))           AS LINE_NO          ,
		                   PRDT.REJECT_DT                                         AS REJECT_DT        , --반송일자
		                   PRHD.PR_TIT                                            AS PR_TIT           , --구매요청건명
		                   PRHD.PR_TYP                                            AS PR_TYP           , --구매요청유형 
		                   PRDT.ITEM_CD                                           AS ITEM_CD          , --품목코드
		                   PRDT.ITEM_NM											  AS ITEM_NM		  ,
		                   PRDT.SAP_ITEM_CD                                       AS SAP_ITEM_CD      , --ERP품목코드  
		                   PRDT.SPEC                                              AS SPEC             , --규격
		                   PRDT.UNIT_CD                                           AS UNIT_CD          , --단위
		                   PRDT.ITEM_QTY                                          AS ITEM_QTY         , --수량
		                   PRDT.CUR                                               AS CUR              , --통화
		                   PRDT.PR_PRICE                                          AS PR_PRICE         , --단가
		                   PRDT.PR_AMT                                            AS PR_AMT           , --금액
		                   PRDT.RD_DATE                                           AS RD_DATE          , --납기일자
		                   PRDT.PRD_SD                                            AS PRD_SD           , --프로젝트 시작일
		                   PRDT.PRD_ED                                            AS PRD_ED           , --프로젝트 종료일
		                   PRDT.PLT_CD                                            AS PLT_CD           , --Plant
		                   PRDT.REF_VD                                            AS REF_VD           , --참조업체
		                   PRDT.PO_QTY                                            AS PO_QTY           , --발주수량
		                   PRDT.GR_QTY                                            AS GR_QTY           , --입고수량
		                   PRDT.CATE_CD                                           AS CATE_CD          , --자재그룹
		                   PRDT.PURC_GRP_CD                                       AS PURC_GRP_CD      , --구매그룹
		                   PRDT.RD_LOCAT                                          AS RD_LOCAT         , --수행장소
		                   PRDT.ATT_NO                                            AS ATT_NO           , --첨부파일
		                   ( SELECT COUNT(1)
		                       FROM ESAATTH
		                      WHERE SYS_ID = PRDT.SYS_ID
		                        AND GRP_CD = PRDT.ATT_NO
		                        AND STS    <> 'D' )                               AS ATT_CNT          , --첨부파일 수
		                   PRHD.PURC_REQ_TYP                                      AS PURC_REQ_TYP     , --구매요청유형
                           CASE WHEN PRHD.PURC_REQ_TYP = 'NC' AND PRDT.PRICE_CNTR_NO IS NOT NULL
                                     THEN 'CC'
                                ELSE PRHD.PURC_REQ_TYP
                            END                                                   AS PURC_REQ_TYP_SUB ,
                           PRHD.PR_REQ_ID                                         AS PR_REQ_ID        , --요청자 아이디    
		                   PRHD.PR_REQ_DATE                                       AS PR_REQ_DATE      , --요청 일자
		                   PRAC.WBS_CD                                            AS WBS_CD           , --WBS코드 
		                   PRAC.WBS_NM                                            AS WBS_NM           , --WBS명
		                   PRDT.PR_SUG_ID                                         AS PR_SUG_ID        , --구매의뢰자
		                   PRDT.PR_SUG_TEXT                                       AS PR_SUG_TEXT      , --구매의뢰자텍스트  
		                   PRDT.REJECT_CAUSE                                      AS REJECT_CAUSE     , --반려사유  
		                   PRDT.SAP_PR_NO                                         AS SAP_PR_NO        , --ERP PR NO
		                   PODT.PO_NO                                             AS PO_NO            , --발주번호
		                   PODT.SAP_PO_NO                                         AS SAP_PO_NO        , --ERP PO NO
		                   POHD.CNTR_ATT_NO                                       AS GRP_CD           , --첨부파일
		                   POHD.CNTR_ATT_NO                                       AS CNTR_ATT_NO      , --첨부파일
		                   (SELECT COUNT(1)                                                                
                              FROM ESAATTH                                                             
                             WHERE SYS_ID = PRDT.SYS_ID                                                    
                               AND GRP_CD = POHD.CNTR_ATT_NO                                                    
                               AND STS <> 'D')                                    AS IMG_ATT_NO       , --첨부파일 수
		                   POHD.VD_CD                                             AS VD_CD            , --업체코드
		                   PODT.PO_MOD_CNT                                        AS PO_MOD_CNT       , --발주변경차수
		                   PODT.PO_MOD_VD_CNT                                     AS PO_MOD_VD_CNT    ,
		                   PODT.PO_MOD_VD_CNT                                     AS CNTR_REV         ,
                           POHD.CNTR_NO                                           AS CNTR_NO          , --계약번호
                           POHD.PO_CRE_TYP                                        AS PO_CRE_TYP       , --발주유형
		                   ( SELECT CDDT.DTL_CD
                               FROM ESACDDT CDDT
                              WHERE CDDT.SYS_ID  = PRDT.SYS_ID
                                AND CDDT.COMP_CD = DECODE((SELECT COMP_CLS_YN FROM ESACDGP WHERE SYS_ID = PRDT.SYS_ID AND GRP_CD='P071' AND USE_YN='Y'),'Y', PRDT.COMP_CD,'N')
                                AND CDDT.GRP_CD  = 'P071'
                                AND CDDT.FLAG  LIKE '%' || PRDT.PR_PROG_STS || '%'
                                AND CDDT.USE_YN = 'Y' )                           AS PR_STS
		              FROM ESPPRHD PRHD
		                 , ESPPRDT PRDT
		                 , ESPPRAC PRAC
		                 , ESPPODT PODT
		                 , ESPPOHD POHD
		             WHERE PRHD.SYS_ID      = #sys_id#
		               AND (
		                    (
		                       #comp_flag#   = 'Y' 
		                       AND
		                       (
		                          #comp_cd#     IS NULL
		                          OR
		                          PRHD.COMP_CD  = NVL(#comp_cd#, #s_comp_cd#)
		                       )
		                    )
		                    OR
		                    (
		                       #comp_flag#   IS NULL
		                       AND
		                       PRHD.COMP_CD  = #s_comp_cd#
		                    )
		                 )
		               AND PRHD.PR_REQ_DATE      BETWEEN #from_date# AND #to_date#  
						  {
						  	//운영조직 일련번호 (복수 선택)
						  	var sql = "";
						  	var list = $data.oper_org_sn;
						  	if(list.length > 0)
						  	{
						  		sql = "AND PRDT.OPER_ORG_SN in ("
						  		sql += list.join();
						  		sql += ")";
						  	}
					  		sql;
						  }			             
		             [ AND PRHD.PR_REQ_DEPT      = #pr_req_dept#     ]
                     [ AND PRHD.PR_REQ_ID        = #pr_req_id#       ]
                     [ AND PRDT.PR_SUG_ID        = #pr_sug_id#       ]
		             [ AND PRDT.PURC_TYP         = #purc_typ#        ]
                     [ AND PRDT.PURC_GRP_CD      = #purc_grp_cd#     ]
		             [ AND UPPER(PRHD.PR_NO)       LIKE '%' || UPPER(#pr_no#) || '%'       ]
		             [ AND UPPER(PRDT.SAP_PR_NO)   LIKE '%' || UPPER(#sap_pr_no#) || '%'   ]
                     [ AND UPPER(PODT.SAP_PO_NO)   LIKE '%' || UPPER(#sap_po_no#) || '%'   ]
		             [ AND UPPER(PRDT.ITEM_CD)     LIKE '%' || UPPER(#item_cd#) || '%'     ]
		             [ AND UPPER(PRDT.SAP_ITEM_CD) LIKE '%' || UPPER(#sap_item_cd#) || '%' ]
		             [ AND UPPER(PRAC.WBS_CD)      LIKE '%' || UPPER(#wbs_cd#) || '%'      ]
		               AND PRHD.STS             <> 'D'
                       AND PRDT.STS             <> 'D'
		               AND PRHD.SYS_ID           = PRDT.SYS_ID
                       AND PRHD.COMP_CD          = PRDT.COMP_CD
                       AND PRHD.OPER_ORG_SN      = PRDT.OPER_ORG_SN
		               AND PRHD.PR_NO            = PRDT.PR_NO
		               AND PRDT.SYS_ID           = PRAC.SYS_ID(+)
                       AND PRDT.COMP_CD          = PRAC.COMP_CD(+)
                       AND PRDT.PR_NO            = PRAC.PR_NO(+)
                       AND PRDT.PR_LNO           = PRAC.PR_LNO(+)
                       AND PRDT.SYS_ID           = PODT.SYS_ID(+)
                       AND PRDT.COMP_CD          = PODT.COMP_CD(+)
                       AND PRDT.OPER_ORG_SN      = PODT.OPER_ORG_SN(+)
                       AND PRDT.PR_NO            = PODT.PR_NO(+)
                       AND PRDT.PR_LNO           = PODT.PR_LNO(+)
                       AND PODT.SYS_ID           = POHD.SYS_ID(+)
                       AND PODT.COMP_CD          = POHD.COMP_CD(+)
                       AND PODT.OPER_ORG_SN      = POHD.OPER_ORG_SN(+)
                       AND PODT.PO_NO            = POHD.PO_NO(+)
                       AND PODT.STS(+)          <> 'D'
                       AND PRDT.PR_PROG_STS IS NOT NULL
                       AND PRDT.PR_PROG_STS NOT IN ('RN', 'RP', 'RR', 'RQ')
		           ) TOT, ESAUSER AUSR
             WHERE TOT.SYS_ID      = AUSR.SYS_ID(+)
               AND TOT.COMP_CD     = AUSR.COMP_CD(+)
               AND TOT.PR_REQ_ID   = AUSR.USR_ID(+)
               AND AUSR.STS(+)      <> 'D'
             [ AND TOT.WBS_CD      = #wbs_cd#         ]
             [ AND TOT.PR_STS      = #pr_sts#         ]
          ORDER BY TOT.COMP_CD, TOT.PR_NO DESC, TO_NUMBER(TOT.PR_LNO)
        ]]>
    </sql>
    
    <!--
    ***************************************************************************************************************************
    ** @Description    : PR목록  삭제
    ** @Author         : 김병철(phatchul)
    ** @Create Date    : 2010.10.05
    ** @History        : 1) 2010.10.05-최초 생성
    ***************************************************************************************************************************
    -->     
    <sql id="pr.delete" comment="pr 전체 삭제">
        <![CDATA[
        BEGIN
        
            UPDATE ESPPRHD 
              SET  STS        = 'D'                                     ,                         
                   MOD_ID    = #s_reg_id#                                ,
                   MOD_DT    = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')     
            WHERE  SYS_ID    = #sys_id#
              AND  COMP_CD   = #s_comp_cd#
              AND  PR_NO     = #pr_no# 
              AND  STS       <> 'D' ;

            UPDATE ESPPRDT  
              SET  STS       = 'D'                                     ,
                   MOD_ID    = #s_reg_id#                                ,
                   MOD_DT    = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
            WHERE  SYS_ID    = #sys_id#
              AND  COMP_CD   = #s_comp_cd#
              AND  PR_NO     = #pr_no#
              AND  STS       <> 'D' ;

            UPDATE ESPPRSV  
              SET  STS       = 'D'                                     ,
                   MOD_ID    = #s_reg_id#                                ,
                   MOD_DT    = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
            WHERE  SYS_ID    = #sys_id#
              AND  COMP_CD   = #s_comp_cd#
              AND  PR_NO     = #pr_no#
              AND  STS       <> 'D' ;

            UPDATE ESPPRAC  
              SET  STS       = 'D'                                     ,    
                   MOD_ID    = #s_reg_id#                                ,
                   MOD_DT    = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
            WHERE  SYS_ID    = #sys_id#
              AND  COMP_CD   = #s_comp_cd#
              AND  PR_NO     = #pr_no#
              AND  STS       <> 'D' ;

        END;
        ]]>
    </sql>  
    
     <sql id="copy.espprhd" comment="PR 헤더 Copy">
        <![CDATA[
            INSERT INTO ESPPRHD
            (
                      SYS_ID                          /*시스템 아이디 */ 
                    , PR_NO                           /*구매요청 번호 */ 
                    , PR_MOD_CNT                      /*구매요청 변경 회수 */ 
                    , COMP_CD                         /*회사 코드 */ 
                    , PR_TIT                          /*구매요청 제목 */ 
                    , PURC_TYP                        /*구매 유형 */ 
                    , PURC_REQ_TYP                    /*구매 요청방식*/
                    , CUR                             /*통화 */ 
                    , PR_TOT_AMT                      /*구매요청 전체금액 */ 
                    , PR_PROG_STS                     /*구매요청 진행 상태 */ 
                    , REQ_ID                          /*요청자 아이디 */ 
                    , REQ_DATE                        /*요청 일 */ 
                    , APRV_ID                         /*승인자 아이디 */ 
                    , APRV_DATE                       /*승인 일 */ 
                    , APRV_NO                         /*결재 번호 */ 
                    , APRV_STS                        /*결재 상태 */ 
                    , ATT_NO                          /*첨부 번호 */ 
                    , PR_REM                          /*참조업체사유 */ 
                    , REM                             /*비고 */ 
                    , STS                             /*상태 */ 
                    , REG_ID                          /*등록자 아이디 */ 
                    , REG_DT                          /*등록 일시 */ 
                    , MOD_ID                          /*수정자 아이디 */ 
                    , MOD_DT                          /*수정 일시 */ 
                    , OPER_ORG_SN                     /*운영 조직 일련번호 */ 
            )
            SELECT    SYS_ID                            
                    , #new_pr_no#      
                    , '0'                        
                    , COMP_CD                           
                    , 'COPY_'||PR_TIT                            
                    , PURC_TYP
                    , PURC_REQ_TYP
                    , CUR                               
                    , PR_TOT_AMT                        
                    , 'T'                       
                    , #s_reg_id#                            
                    , FC_GET_CAST_DT_NOW(SYS_ID,'YMD')                         
                    , ''                           
                    , ''                         
                    , ''                           
                    , 'T'                          
                    , ''                            
                    , PR_REM                            
                    , REM                               
                    , 'C'                               
                    , #s_reg_id#   
                    , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')    
                    , #s_reg_id#   
                    , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                          
                    , OPER_ORG_SN                       
              FROM ESPPRHD
             WHERE SYS_ID  = #sys_id#
               AND COMP_CD = #s_comp_cd#
               AND PR_NO   = #pr_no#
        ]]>
    </sql>
    
     <sql id="copy.espprdt" comment="PR 폼목 Copy">
        <![CDATA[
            INSERT INTO ESPPRDT
            (
                 SYS_ID                 , --시스템 아이디  
                 PR_NO                  , --구매요청 번호  
                 PR_LNO                 , --구매요청 항번 
                 PR_MOD_CNT             , --구매요청 변경 회수   
                 COMP_CD                , -- 회사 코드  
                 PLT_CD                 ,--공장 코드  
                 ITEM_CD                ,--품목 코드  
                 ITEM_NM                ,--품목 명  
                 ITEM_EN_NM             ,--품목 영문 명  
                 SPEC                   ,--규격  
                 UNIT_CD                ,--단위 코드  
                 ITEM_QTY               ,--품목 수량  
                 CUR                    ,--통화  
                 PR_PRICE               ,--구매요청 단가  
                 PR_AMT                 ,--구매요청 금액  
                 REF_VD                 ,--참조 업체  
                 CATE_CD                ,--분류 코드  
                 WH_CD                  ,--창고 코드  
                 RD_LOCAT               ,--납품요청 장소  
                 TBE_DEPT_CD            ,--기술검토 부서 코드  
                 PURC_GRP_CD            ,--구매 그룹 코드  
                 EMG_YN                 ,--긴급 여부  
                 REQ_ID                 ,--요청자 아이디  
                 REQ_DATE               ,--요청 일  
                PRD_SD                  ,--프로젝트 시작일  
                PRD_ED                  ,--프로젝트 종료일  
                PR_PROG_STS             ,--구매요청 진행 상태 T:접수중 A:접수R:반송P:진행중 
                RD_DATE                 ,--납품요청 일  
                COST_TYP                ,--비용 유형  
                GL_ACC_CD               ,--입고처 계정 코드  
                COST_ACC_CD             ,--비용 계정 코드  
                ACC_ACC_CD              ,--회계 계정 코드  
                ATT_NO                  ,--첨부 번호  
                REJECT_CAUSE            ,--반려 사유  
                RFQ_QTY                 ,--견적요청 수량  
                PO_QTY                  ,--발주 수량  
                INV_QTY                 ,--송장 수량  
                GR_QTY                  ,--입고 수량  
                PO_END_YN               ,--발주 종료 여부  
                GR_END_YN               ,--입고 종료 여부  
                REM                     ,--비고  
                STS                     ,--상태  
                REG_ID                  ,--등록자 아이디  
                REG_DT                  ,--등록 일시  
                MOD_ID                  ,--수정자 아이디  
                MOD_DT                  ,--수정 일시  
                ACC_MOD_YN              ,--계정 변경 여부  
                ATT_MOD_YN              ,--첨부 변경 여부  
                ITEM_MOD_YN             ,--품목 변경 여부  
                MOD_REQ_PROG_STS        ,--변경 요청 진행 상태 P : 요청중 A : 대상 R : 거부 C : 승인 
                MOD_STS                 ,--변경 상태  
                OPER_ORG_SN             ,--운영 조직 일련번호  
                PR_MOD_YN               ,--구매요청 변경 여부  
                QTY_MOD_YN              ,--수량 변경 여부  
                RD_MOD_YN               ,--납품요청 변경 여부  
                RELEASE_FLAG            ,--릴리즈 플래그  
                RELEASE_REQ_ID          ,--릴리즈 요청자 아이디  
                RELEASE_REQ_DT          ,--릴리즈 요청 일시  
                RELEASE_APRV_ID         ,--릴리즈 승인자 아이디  
                RELEASE_APRV_DT         ,--릴리즈 승인 일시  
                RELEASE_REQ_CAUSE       ,--릴리즈 요청 사유  
                RELEASE_REJECT_CAUSE    ,--릴리즈 반려 사유  
                SVC_MOD_YN              ,--서비스 변경 여부  
                SG_SN                   ,--
                SG_CD                   ,--
                PURC_TYP                ,
                AUTO_PO_YN
        )
        SELECT  
                  SYS_ID       
                , #new_pr_no#       
                , PR_LNO      
                , '0' 
                , COMP_CD     
                , PLT_CD      
                , ITEM_CD     
                , ITEM_NM     
                , ITEM_EN_NM  
                , SPEC        
                , UNIT_CD     
                , ITEM_QTY    
                , CUR         
                , PR_PRICE    
                , PR_AMT      
                , REF_VD      
                , CATE_CD     
                , WH_CD       
                , RD_LOCAT    
                , TBE_DEPT_CD 
                , PURC_GRP_CD 
                , EMG_YN      
                , #s_reg_id#      
                , FC_GET_CAST_DT_NOW(SYS_ID,'YMD')    
                , PRD_SD      
                , PRD_ED      
                , 'T' 
                , RD_DATE     
                , COST_TYP    
                , GL_ACC_CD   
                , COST_ACC_CD 
                , ACC_ACC_CD  
                , ''      
                , '' 
                , ''     
                , ''      
                , ''     
                , ''      
                , PO_END_YN   
                , GR_END_YN   
                , REM         
                , 'C'         
                , #s_reg_id#   
                , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')    
                , #s_reg_id#   
                , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
                , ACC_MOD_YN  
                , ATT_MOD_YN  
                , ITEM_MOD_YN 
                , '' 
                , ''         
                , OPER_ORG_SN     
                , PR_MOD_YN       
                , QTY_MOD_YN      
                , RD_MOD_YN       
                , RELEASE_FLAG    
                , RELEASE_REQ_ID  
                , RELEASE_REQ_DT  
                , RELEASE_APRV_ID 
                , RELEASE_APRV_DT 
                , RELEASE_REQ_CAUSE 
                , RELEASE_REJECT_CAUSE 
                , SVC_MOD_YN 
                , SG_SN
                , SG_CD
                , PURC_TYP
                , AUTO_PO_YN
        FROM ESPPRDT
       WHERE SYS_ID  = #sys_id#
         AND COMP_CD = #s_comp_cd#
         AND PR_NO   = #pr_no#
        ]]>
    </sql>
    
    <sql id="copy.espprsv" comment="PR 서비스 Copy">
        <![CDATA[
            INSERT INTO ESPPRSV
            (
                      SYS_ID           /*시스템 아이디 */ 
                    , PR_NO            /*구매요청 번호 */ 
                    , PR_LNO           /*구매요청 항번 */ 
                    , PR_SVC_LNO       /*구매요청 서비스 항번 */ 
                    , PR_MOD_CNT       /*구매요청 변경 회수 */
                    , SVC_CD           /*서비스 코드 */ 
                    , SVC_NM           /*서비스 명 */ 
                    , UNIT_CD          /*단위 코드 */ 
                    , ITEM_QTY         /*품목 수량 */ 
                    , CUR              /*통화 */ 
                    , PR_AMT           /*구매요청 금액 */ 
                    , PR_MOD_YN        /*구매요청 변경 여부 */ 
                    , REM              /*비고 */
                    , WBS_CD           /*WBS 코드 */ 
                    , WBS_NM           /*WBS 명 */ 
                    , STS              /*상태 */
                    , REG_ID           /*등록자 아이디 */ 
                    , REG_DT           /*등록 일시 */ 
                    , MOD_ID           /*수정자 아이디 */ 
                    , MOD_DT           /*수정 일시 */ 
            )
            SELECT    SYS_ID      
                    , #new_pr_no#       
                    , PR_LNO      
                    , PR_SVC_LNO  
                    , '0'  
                    , SVC_CD 
                    , SVC_NM      
                    , UNIT_CD     
                    , ITEM_QTY    
                    , CUR         
                    , PR_AMT      
                    , ''   
                    , REM
                    , WBS_CD 
                    , WBS_NM         
                    , 'C'
                    , #s_reg_id#   
                    , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')    
                    , #s_reg_id#   
                    , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')    
              FROM ESPPRSV
             WHERE SYS_ID  = #sys_id#
               AND COMP_CD = #s_comp_cd#
               AND PR_NO   = #pr_no#
        ]]>
    </sql>
    
     <sql id="copy.espprac" comment="PR 계정 Copy">
        <![CDATA[
           INSERT INTO ESPPRAC
                (
                     SYS_ID         , --시스템 아이디  
                     PR_NO          , --구매요청 번호  
                     PR_LNO         , --구매요청 항번 
                     PR_SVC_LNO     , --구매요청 서비스 항번   
                     PR_ACC_LNO     , --구매요청 계정 항번   
                     PR_MOD_CNT     , --구매요청 변경 회수   
                     ACC_TYP        , --계정 유형   
                     QTY_OR_RATE    , --수량 OR 율   
                     GL_ACC_CD      , --입고처 계정 코드   
                     COST_ACC_CD    , --비용 계정 코드   
                     ACC_ACC_CD     , --회계 계정 코드   
                     REM            , --비고   
                     STS            , --상태   
                     REG_ID         , --등록자 아이디   
                     REG_DT         , --등록 일시   
                     MOD_ID         , --수정자 아이디   
                     MOD_DT          --수정 일시   
                )
           SELECT  SYS_ID   
                   , #new_pr_no#     
                   , PR_LNO    
                   , PR_SVC_LNO  
                   , PR_ACC_LNO 
                   , '0'
                   , ACC_TYP     
                   , QTY_OR_RATE 
                   , GL_ACC_CD   
                   , COST_ACC_CD
                   , ACC_ACC_CD 
                   , REM         
                    ,'C'         
                   , #s_reg_id#   
                   , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')    
                   , #s_reg_id#   
                   , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')  
          FROM ESPPRAC
         WHERE SYS_ID  = #sys_id#
           AND COMP_CD = #s_comp_cd#
           AND PR_NO   = #pr_no#
        ]]>
    </sql>
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #######################                 구 매 요 청 목 록, 구 매 요 청 진 행 현 황 쿼 리  END               ############################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #####################################                 구 매 요 청 변 경 쿼 리  START              ####################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    <sql id="select.pr.modify.request.list" comment="구매변경요청목록  조회">
        <![CDATA[
        SELECT A.*
          FROM (
                 SELECT TOT.* 
                      , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE', 'P045',TOT.PURC_TYP,'','','','') 
                            FROM DUAL)                                                                                                      AS PURC_TYP_NM      --구매유형명
                      , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE', 'P049',TOT.PURC_REQ_TYP_SUB,'','','','') 
                            FROM DUAL)                                                                                                      AS PURC_REQ_TYP_NM  --구매요청유형명
                      , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE', 'P011',TOT.TMP_APRV_STS,'','','','') 
                            FROM DUAL)                                                                                                      AS APRV_STS_NM      --결재상태명
                      , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'USER', TOT.PR_MOD_PROG_ID, '','','','','') 
                      		FROM DUAL) AS APRV_USER_NM     --승인자 명
                      , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'DEPT', TOT.COMP_CD, TOT.PLT_CD, TOT.PR_REQ_DEPT,'','','') 
                            FROM DUAL)                                                                                                      AS PR_REQ_DEPT_NM   --요청부서 명
                      , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE', 'P003', TOT.COST_TYP,'','','','') 
                            FROM DUAL)                                                                                                      AS COST_TYP_NM      --비용 유형명
                      , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE', 'P040', TOT.PR_MOD_PROG_STS,'','','','') 
                            FROM DUAL)                                                                                                      AS PR_MOD_PROG_STS_NM    --변경요청 진행상태명
                      , PURC_REQ_TYP_SUB  AS PURC_REQ_TYP     --구매요청유형
                      , ( SELECT FC_GET_ORG_SN_NAME(TOT.SYS_ID, '', TOT.OPER_ORG_SN) FROM DUAL )                                            AS OPER_ORG_NM
                   FROM
                      (
                        SELECT PRHD.COMP_CD                                                AS COMP_CD          --회사코드
                             , PRHD.OPER_ORG_SN                                            AS OPER_ORG_SN
		                     , PRHD.APRV_STS                                               AS APRV_STS         --결재상태
		                     , #locale#                                                    AS LOCALE         --언어
		                     , PRHD.SYS_ID                                                 AS SYS_ID         --언어
		                     , CASE WHEN PRHD.ELEC_APRV_YN = 'N' AND PRHD.APRV_STS = 'C'
                                          THEN 'K'
                                     ELSE PRHD.APRV_STS
                                 END                                                       AS TMP_APRV_STS
		                     , PRHD.PURC_TYP                                               AS PURC_TYP         --구매유형
		                     , PRHD.PR_NO                                                  AS PR_NO            --구매요청 번호
		                     , PRHD.SAP_PR_NO                                              AS SAP_PR_NO        --ERP 구매요청 번호
		                     , PRHD.CUR                                                    AS CUR              --통화
		                     , PRHD.PR_TOT_AMT                                             AS PR_TOT_AMT       --구매요청 전체금액
		                     , PRHD.PR_TIT                                                 AS PR_TIT           --구매요청 제목
		                     , PRHD.PR_REQ_DATE                                            AS PR_REQ_DATE      --요청 일
		                     , PRHD.PR_MOD_PROG_DATE                                              AS APRV_DATE        --승인 일
		                     , PRHD.APRV_ID                                                AS APRV_ID          --승인자 아이디
		                     , PRHD.PR_REQ_ID                                              AS PR_REQ_ID        --요청자 아이디
		                     , PRHD.PR_REQ_DEPT                                            AS PR_REQ_DEPT      --요청부서
		                     , PRHD.APRV_NO                                                AS APRV_NO          --결재 번호
		                     , PRHD.ATT_NO                                                 AS ATT_NO           --첨부 번호
		                     , PRHD.REG_ID                                                 AS REG_ID           --등록자 아이디
		                     , PRHD.PR_MOD_CNT                                             AS PR_MOD_CNT       --구매요청 변경 회수
		                     , PRHD.PURC_REQ_TYP                                           AS PURC_REQ_TYP_SUB     --구매요청유형
		                     , DECODE(#locale#,'ko_KR', AUSR.USR_NM ,AUSR.USR_EN_NM)       AS REQ_USER_NM      --요청자
		                     , ( SELECT COUNT(1) 
		                           FROM ESAATTH 
		                          WHERE SYS_ID = PRHD.SYS_ID 
		                            AND GRP_CD = PRHD.ATT_NO 
		                            AND STS <> 'D')                                        AS ATT_CNT          --첨부파일 수 
		                     , PRHD.PR_MOD_PROG_STS                                        AS PR_MOD_PROG_STS  --변경요청 진행상태
		                     , DECODE(SUM(DECODE(PRDT.PO_QTY,0,0,1)),0,'N','Y')            AS PO_YN                 
		                     , DECODE(SUM(DECODE(PRDT.GR_QTY,0,0,1)),0,'N','Y')            AS GR_YN
		                     , MAX(PRDT.COST_TYP)                                          AS COST_TYP  
		                     , AUSR.PLT_CD                                                 AS PLT_CD
		                          
	                         ,PRHD.PR_MOD_PROG_DATE
	                         ,PRHD.PR_MOD_PROG_ID		                                 
		                  FROM ESPPRHD PRHD
		                     , ESPPRDT PRDT
		                     , ESAUSER AUSR  
		                 WHERE PRHD.SYS_ID                 = #sys_id#
		                   AND PRHD.COMP_CD                = #s_comp_cd#
						  {
						  	//운영조직 일련번호 (복수 선택)
						  	var sql = "";
						  	var list = $data.oper_org_sn;
						  	if(list.length > 0)
						  	{
						  		sql = "AND PRDT.OPER_ORG_SN in ("
						  		sql += list.join();
						  		sql += ")";
						  	}
					  		sql;
						  }
		                   AND NVL( PRDT.PO_QTY   , 0   )  = 0
		                   AND NVL( PRDT.RFQ_QTY  , 0   )  = 0
		                   AND NVL( PRDT.PO_END_YN, 'N' )  = 'N'
		                   AND NVL( PRDT.GR_END_YN, 'N' )  = 'N'
		                   AND PRHD.STS                   <> 'D'
		                   AND AUSR.STS                   <> 'D'
		                   AND PRDT.PR_PROG_STS IN ('RQ','RA','RB','RW','RV') --구매요청 진행상태가 변경요청,변경승인,변경반려,변경접수대기 인 것만 불러온다.구매접수(RV)도 추가(2013.02.07)
		                   AND PRHD.PR_REQ_DATE BETWEEN #from_date# AND #to_date#
		                   AND PRHD.PR_MOD_PROG_STS IS NOT NULL
		                 [ AND UPPER(PRHD.PR_NO)           LIKE '%' || UPPER(#pr_no#) || '%'     ]
		                 [ AND UPPER(PRHD.SAP_PR_NO)       LIKE '%' || UPPER(#sap_pr_no#) || '%' ]
		                 [ AND PRHD.PURC_TYP               = #purc_typ#         ]
		                 [ AND PRHD.PR_REQ_ID              = #pr_req_id#        ]
		                 [ AND PRHD.PR_MOD_PROG_STS        = #pr_mod_prog_sts#  ] 
		                 [ AND PRHD.PR_REQ_DEPT            = #pr_req_dept#      ]
		                   AND PRHD.SYS_ID                 = PRDT.SYS_ID
		                   AND PRHD.COMP_CD                = PRDT.COMP_CD
		                   AND PRHD.OPER_ORG_SN            = PRDT.OPER_ORG_SN
		                   AND PRHD.PR_NO                  = PRDT.PR_NO
		                   AND PRHD.SYS_ID                 = AUSR.SYS_ID
		                   AND PRHD.COMP_CD                = AUSR.COMP_CD
		                   AND PRHD.PR_REQ_ID              = AUSR.USR_ID
		                GROUP BY PRHD.SYS_ID                
		                       , PRHD.COMP_CD
		                       , PRHD.OPER_ORG_SN
		                       , PRHD.ELEC_APRV_YN
		                       , PRHD.APRV_STS              
		                       , PRHD.PURC_TYP              
		                       , PRHD.PR_NO                 
		                       , PRHD.SAP_PR_NO             
		                       , PRHD.CUR                   
		                       , PRHD.PR_TOT_AMT            
		                       , PRHD.PR_TIT                
		                       , PRHD.PR_REQ_DATE           
		                       , PRHD.APRV_DATE             
		                       , PRHD.APRV_ID               
		                       , PRHD.PR_REQ_ID             
		                       , PRHD.PR_REQ_DEPT           
		                       , PRHD.COMP_CD               
		                       , PRHD.APRV_NO               
		                       , PRHD.ATT_NO                
		                       , PRHD.REG_ID                
		                       , PRHD.PR_MOD_CNT            
		                       , PRHD.PURC_TYP              
		                       , PRHD.PR_MOD_PROG_STS       
		                       , PRHD.PURC_REQ_TYP 
                        	   , PRHD.PR_MOD_PROG_DATE
                        	   , PRHD.PR_MOD_PROG_ID		                       
		                      -- , PRDT.PRICE_CNTR_NO         
		                       , AUSR.USR_NM                
		                       , AUSR.USR_EN_NM             
		                       , AUSR.COMP_CD               
		                       , AUSR.PLT_CD                
		                ORDER BY PRHD.PR_NO DESC
                     ) TOT        
                 )A
                 WHERE 1=1
                 [ AND PURC_REQ_TYP = #purc_req_typ# ]         
        ]]>
    </sql>
    
    <sql id="update.pr.modify.request.espprhd" comment="PR요청 변경요청 / 변경요청 승인,반려">
    <!-- 기존은 아이템 단위의 변경이 목적이었음. 헤더단위의 변경으로 하여 기존아이템 변경이 아닌 아이템 추가만 하는 경우도 고려한다. -->
        <![CDATA[
            UPDATE ESPPRHD  
               SET PR_MOD_PROG_STS      = #mod_req_prog_sts#                  -- 변경요청 진행상태
				 , PR_MOD_PROG_ID       = #s_reg_id#                         
				 , PR_MOD_PROG_DATE     = TO_CHAR(SYSDATE,'YYYYMMDD')         	                                         
				 , PR_MOD_REQ_DATE      = CASE WHEN #mod_req_prog_sts# = 'R'  -- 변경요청 시에만 변경요청일자
				                                    THEN TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
				                               ELSE PR_MOD_REQ_DATE
				                          END
				 , RELEASE_REQ_CAUSE    = TRIM(#release_req_cause#)           -- 릴리즈 요청 사유
                 , RELEASE_REJECT_CAUSE = CASE WHEN #mod_req_prog_sts# = 'B'  -- 변경요청 반려 시에만 릴리즈 반려 사유
                                                    THEN TRIM(#release_reject_cause#)
                                               ELSE NULL
                                          END
                 , STS                  = 'U'                                 -- 상태
                 , MOD_ID               = #s_reg_id#                          -- 수정자 아이디
                 , MOD_DT               = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') -- 수정 일시
             WHERE SYS_ID  = #sys_id#
               AND COMP_CD = #s_comp_cd#
               AND PR_NO   = #pr_no#
        ]]>
    </sql>
    
    <!-- 품목별로 일부 반려되었거나 일부만 승인되었을 경우가 있기때문에 
        새로이 요청할때 기존 상태 값을 모두 초기화 한다.-->
     <sql id="update.pr.modify.request.init.espprdt" comment="PR요청 변경요청 초기화 ">
        <![CDATA[
            UPDATE  ESPPRDT  
               SET  RELEASE_REQ_CAUSE    = ''                               , -- 릴리즈 요청 사유
                    RELEASE_REJECT_CAUSE = ''                               , -- 
                    MOD_REQ_PROG_STS     = 'T'                                 , -- 변경 요청 진행 상태
                    PR_PROG_STS          = 'RQ'                                , -- 구매요청진행상태
                    RELEASE_REQ_ID       = ''                                  , -- 릴리즈 요청자 아이디
                    RELEASE_REQ_DT       = ''                                  , -- 릴리즈 요청 일시
                    STS                  = 'U'                                 , -- 상태
                    MOD_ID               = #s_reg_id#                            , -- 수정자 아이디
                    MOD_DT               = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')   -- 수정 일시
            WHERE SYS_ID  = #sys_id#
              AND COMP_CD = #s_comp_cd#
              AND PR_NO   = #pr_no#
              AND PR_LNO  = #pr_lno#
        ]]>
    </sql>
    
    <sql id="update.pr.modify.request.espprdt" comment="PR요청 변경요청 / 변경요청 승인,반려">
        <![CDATA[
            UPDATE ESPPRDT  
               SET RELEASE_REQ_CAUSE    = TRIM(#release_req_cause#)                             , -- 릴리즈 요청 사유
                 [ RELEASE_REJECT_CAUSE = TRIM(#release_reject_cause#)                          , -- 릴리즈 반려 사유 ]
                   MOD_REQ_PROG_STS     = #mod_req_prog_sts#                                    , -- 변경 요청 진행 상태
                   RELEASE_FLAG         = DECODE(#mod_req_prog_sts#,'A','Y','N')                , -- 릴리즈 플래그(Y/N)
                   PR_PROG_STS          = DECODE(#mod_req_prog_sts#,'A', 'RA', 'B', 'RB', 'RQ') , -- 구매요청진행상태
                   RELEASE_REQ_ID       = #s_reg_id#                                              , -- 릴리즈 요청자 아이디
                   RELEASE_REQ_DT       = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                   , -- 릴리즈 요청 일시
                   STS                  = 'U'                                                   , -- 상태
                   MOD_ID               = #s_reg_id#                                              , -- 수정자 아이디
                   MOD_DT               = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                     -- 수정 일시
             WHERE SYS_ID  = #sys_id#
               AND COMP_CD = #s_comp_cd#
               AND PR_NO   = #pr_no#
               AND PR_LNO  = #pr_lno#
        ]]>
    </sql>
    
    <sql id="select.pr.release.list" comment="PR변경요청승인목록 조회">
        <![CDATA[
            SELECT TOT.* 
                 , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE','P040', TOT.PR_MOD_PROG_STS, '', '', '', '')
                       FROM DUAL)                                                                                                          AS PR_MOD_PROG_STS_NM     -- 변경요청 진행상태 명
                 , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE', 'P045', TOT.PURC_TYP, '', '', '', '')
                       FROM DUAL)                                                                                                          AS PURC_TYP_NM            -- 구매유형 명     
                 , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'USER', TOT.APRV_ID, '', '', '', '', '')   
                       FROM DUAL)                                                                                                          AS APRV_USER_NM           -- 승인자 명
                 , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'DEPT', TOT.COMP_CD, TOT.PLT_CD, TOT.PR_REQ_DEPT,'','','') 
                       FROM DUAL)                                                                                                          AS REQ_DEPT_NM            -- 요청부서 명
                 , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'DEPT', TOT.COMP_CD, TOT.PLT_CD, TOT.PR_REQ_DEPT, '', '', '') 
                       FROM DUAL)                                                                                                          AS PR_REQ_DEPT_NM         -- 요청부서 명   
                 , ( SELECT FC_GET_NAME(TOT.SYS_ID,TOT.LOCALE,TOT.COMP_CD, 'CODE', 'P011', TOT.TMP_APRV_STS, '', '', '', '')
                       FROM DUAL)                                                                                                          AS APRV_STS_NM            -- 결재 상태 명                       
                 , ( SELECT FC_GET_ORG_SN_NAME(TOT.SYS_ID, '', TOT.OPER_ORG_SN) FROM DUAL )                                                AS OPER_ORG_NM
              FROM
                 (
                    SELECT DISTINCT PRHD.COMP_CD                                                     AS COMP_CD               , -- 회사 코드
                                    PRHD.OPER_ORG_SN                                                 AS OPER_ORG_SN           ,
		                            PRHD.PR_MOD_PROG_STS                                             AS PR_MOD_PROG_STS       , -- 변경요청 진행상태
		                            PRHD.SYS_ID                                                      AS SYS_ID                ,
		                            #locale#                                                         AS locale                , -- 언어
		                            PRHD.PURC_TYP                                                    AS PURC_TYP              , -- 구매유형
		                            PRHD.PR_NO                                                       AS PR_NO                 , -- 구매요청 번호
		                            PRHD.SAP_PR_NO                                                   AS SAP_PR_NO             , -- 구매요청 번호
		                            PRHD.PR_MOD_CNT                                                  AS PR_MOD_CNT            , -- 구매요청 변경 회수
		                            PRHD.CUR                                                         AS CUR                   , -- 통화
		                            PRHD.PR_TOT_AMT                                                  AS PR_TOT_AMT            , -- 구매요청 전체금액
		                            PRHD.PR_TIT                                                      AS PR_TIT                , -- 구매요청 제목
		                            PRHD.REG_DT                                                      AS REQ_DATE              , -- 요청일
		                            PRHD.APRV_DATE                                                   AS APRV_DATE             , -- 승인일
		                            PRHD.APRV_ID                                                     AS APRV_ID               , -- 승인자 아이디
		                            PRHD.REG_ID                                                      AS REQ_ID                , -- 요청자 아이디
		                            DECODE(#locale#, 'ko_KR', AUSR.USR_NM , AUSR.USR_EN_NM)          AS REQ_USER_NM           , -- 요청자 명
		                            PRHD.PR_REQ_DEPT                                                 AS PR_REQ_DEPT           , -- 구매요청자부서(PR헤더 테이블)
		                         -- AUSR.DEPT_CD												     AS PR_REQ_DEPT           , -- 구매요청자부서(사용자 테이블)
		                            PRHD.APRV_STS                                                    AS APRV_STS              , -- 결재 상태
		                            CASE WHEN PRHD.ELEC_APRV_YN = 'N' AND PRHD.APRV_STS = 'C'
                                               THEN 'K'
                                         ELSE PRHD.APRV_STS
                                     END                                                             AS TMP_APRV_STS          ,
                                    PRHD.APRV_NO                                                     AS APRV_NO               , -- 결재 번호
		                            PRHD.ATT_NO                                                      AS ATT_NO                , -- 첨부 번호
		                            ( SELECT COUNT(1)
		                                FROM ESAATTH
		                               WHERE SYS_ID = PRHD.SYS_ID
		                                 AND GRP_CD = PRHD.ATT_NO
		                                 AND STS <> 'D')                                             AS ATT_CNT               , -- 첨부파일 수
		                            AUSR.PLT_CD      
		              FROM ESPPRHD PRHD 
		                 , ESPPRDT PRDT 
		                 , ESAUSER AUSR
		             WHERE PRHD.SYS_ID           = #sys_id#
		               AND PRHD.COMP_CD          = #s_comp_cd#
						  {
						  	//운영조직 일련번호 (복수 선택)
						  	var sql = "";
						  	var list = $data.oper_org_sn;
						  	if(list.length > 0)
						  	{
						  		sql = "AND PRHD.OPER_ORG_SN in ("
						  		sql += list.join();
						  		sql += ")";
						  	}
					  		sql;
						  }	
		             [ AND PRHD.PURC_TYP         = #purc_typ#     ]
		             [ AND UPPER(PRHD.PR_NO)     LIKE '%' || UPPER(#pr_no#) || '%'     ]
		             [ AND UPPER(PRHD.SAP_PR_NO) LIKE '%' || UPPER(#sap_pr_no#) || '%' ]
		             [ AND PRHD.REG_ID           = #req_id#          ]
		             [ AND PRHD.PR_MOD_PROG_STS  = #pr_mod_prog_sts# ]
		             [ AND PRHD.PR_REQ_DEPT      = #pr_req_dept#     ]
		             [ AND PRDT.PURC_GRP_CD      = #purc_grp_cd#     ]
		               AND PRHD.STS              <> 'D'
		               AND PRHD.PR_MOD_PROG_STS  <> 'T'
		               /* PR아이템 변경요청 뿐 아니라 아이템 추가만 이루어질 수도 있다. DT상태가 아닌 HD 상태로 확인(2013.02.07) */
		               AND PRHD.PR_MOD_PROG_STS  IN ('R', 'B', 'A') --변경요청상태(R:변경요청, B:변경요청반려, A:변경요청승인)
		               AND PRHD.PR_MOD_REQ_DATE  BETWEEN #from_date# || '000000' AND #to_date# || '240000'
		               AND PRDT.GR_END_YN       != 'Y'       -- 구매요청 수량과 입고수량을 비교해서 입고가 완료되었는지 확인한다.
		               AND AUSR.STS              <> 'D'
		               AND PRHD.PR_MOD_PROG_STS  IS NOT NULL
		               AND PRHD.SYS_ID           = PRDT.SYS_ID
		               AND PRHD.PR_NO            = PRDT.PR_NO
		               AND PRHD.COMP_CD          = PRDT.COMP_CD
		               AND PRHD.OPER_ORG_SN      = PRDT.OPER_ORG_SN
		               AND AUSR.SYS_ID           = PRHD.SYS_ID
		               AND AUSR.COMP_CD          = PRHD.COMP_CD
		               AND AUSR.USR_ID           = PRHD.REG_ID
		            ORDER BY PRHD.REG_DT DESC, PRHD.PR_NO DESC, PRHD.APRV_STS, PRHD.PURC_TYP
                ) TOT
                WHERE 1=1
                [ AND PURC_REQ_TYP = #purc_req_typ# ]
            
        ]]>
    </sql>
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #####################################                 구 매 요 청 변 경 쿼 리  END                ####################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #####################################                 구 매 요 청 접 수 쿼 리  START               ####################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    <sql id="insert.temp.for.rfx.list" comment="PR접수 조회">
        <![CDATA[
            INSERT INTO ESPTEMP( SYS_ID, COMP_CD, PR_NO, RFQ_NO, PR_LNO, PURC_TYP, COST_TYP, SAP_GRP_CD )
                         VALUES( #sys_id#, #s_comp_cd#, #pr_no#, #rfq_no#, #pr_lno#, #purc_typ#, #cost_typ#, #sap_grp_cd# )
        ]]>
    </sql>
    
    <sql id="insert.multi_pr_no.temp2">
        <![CDATA[
            INSERT INTO ESPTEMP2 (SYS_ID, COMP_CD,PR_NO)
            VALUES (#sys_id#, #s_comp_cd#,#data1#)
        ]]>
    </sql>

    <sql id="insert.multi_sap_pr_no.temp2">
        <![CDATA[
            INSERT INTO ESPTEMP2 (SAP_PR_NO)
            VALUES (#data1#)
        ]]>
    </sql>
    
    <sql id="insert.multi_sap_grp_cd.temp2">
        <![CDATA[
            INSERT INTO ESPTEMP2 (SAP_GRP_CD)
            VALUES (#dtl_cd#)
        ]]>
    </sql>
    
    <sql id="select.pr.receiptlist" comment="PR접수 조회">
        <![CDATA[
            SELECT TOT.*,
                   ROWNUM         AS NO,
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'CODE', 'C026', TOT.MOD_STS,'','','','')
                       FROM DUAL )                                                                                                   AS MOD_STS_NM       , --변경상태명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'CODE', 'P045', DECODE(TOT.PURC_TYP, 'UC', 'MT', TOT.PURC_TYP), '', '', '', '')
                       FROM DUAL )                                                                                                   AS PURC_TYP_NM      , --구매유형명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'CODE', 'P049', TOT.PURC_REQ_TYP_SUB, '', '', '', '') 
                       FROM DUAL )                                                                                                   AS PURC_REQ_TYP_NM  , --구매요청유형명          
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'CODE', 'C009', TOT.SAP_GRP_CD, '', '', '', '') 
                       FROM DUAL )                                                                                                   AS SAP_GRP_NM       , --
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'CODE', 'P052',TOT.COST_TYP,'','','','')
                       FROM DUAL )                                                                                                   AS COST_TYP_NM      , --비용 유형명  
                   ( SELECT FC_GET_NAME(TOT.SYS_ID, #locale#, TOT.COMP_CD, 'USER', TOT.PR_REQ_ID, '', '', '', '' ,'')
                       FROM DUAL )                                                                                                   AS PR_REQ_NM        , --요청자 명
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'VENDOR', TOT.REF_VD, '', '', '', '', '') 
                       FROM DUAL )                                                                                                   AS REF_VD_NM        , --참조업체명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'WHNM', 'PLANT', TOT.PLT_CD, TOT.WH_CD, '', '', '')
                       FROM DUAL )                                                                                                   AS WH_NM            , --창고 명                        
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'PURC_GRP', 'PU', TOT.PURC_GRP_CD, '', '', '', '')
                       FROM DUAL )                                                                                                   AS PURC_GRP_NM      , --구매그룹 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'P072', TOT.ACC_STS, '', '', '', '')
                       FROM DUAL )                                                                                                   AS ACC_STS_NM       , --진행상태 명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'OGMG', 'PLANT', TOT.PLT_CD, '', '', '', '')
                       FROM DUAL )                                                                                                   AS PLT_NM           , --Plant명
                   ( SELECT FC_GET_NAME( TOT.SYS_ID, #locale#, TOT.COMP_CD, 'CODE', 'C029', TOT.CATE_CD, '', '', '', '')                          
                       FROM DUAL )                                                                                                   AS CATE_NM          , --자재그룹명                        
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'OGMG', 'PLANT', TOT.INFO_PLT_CD, '', '', '', '')
                       FROM DUAL )                                                                                                   AS INFO_PLT_NM      , --
                   ( SELECT FC_GET_NAME(TOT.SYS_ID,#locale#,TOT.COMP_CD, 'VENDOR', TOT.INFO_VD_CD, '', '', '', '', '')
                       FROM DUAL )                                                                                                   AS INFO_VD_NM       , --(단가계약) 업체명
                   DECODE(TOT.APRV_FLAG, 'Y', 'assets/images/icon_view.png', '')                                                    AS APRV_IMG    
              FROM (
                    SELECT PRHD.SYS_ID                                                                     AS SYS_ID                 ,
                           PRHD.COMP_CD                                                                    AS COMP_CD                , --회사코드
                           PRDT.MOD_STS                                                                    AS MOD_STS                , --변경상태
                           PRHD.PURC_TYP                                                                   AS PURC_TYP               , --구매유형
                           PRHD.PURC_REQ_TYP                                                               AS PURC_REQ_TYP           ,
                           PRHD.APRV_URL                                                                   AS APRV_URL               ,
                           PRHD.APRV_STS                                                                   AS APRV_STS               ,
                           PRHD.APRV_NO 																   AS APRV_NO                ,
                           CASE WHEN PRHD.APRV_STS IN ('T', 'P', 'C', 'S') AND PRHD.APRV_NO IS NOT NULL                                  
                                     THEN 'Y'
                                ELSE 'N' 
                            END                                                                            AS APRV_FLAG              ,
                           CASE WHEN PRHD.PURC_REQ_TYP = 'NC' AND PRDT.PRICE_CNTR_NO IS NOT NULL 
                                     THEN 'CC'
                                ELSE PRHD.PURC_REQ_TYP
                            END                                                                            AS PURC_REQ_TYP_SUB       , --구매요청유형
                           PRDT.PR_PROG_STS                                                                AS PR_PROG_STS            , --구매요청진행상태
                           CASE WHEN PR_PROG_STS = 'RV'
                                     THEN 'Y'
                                ELSE 'N'
                           END                                                                             AS ACC_STS                , --진행상태 
                           PRHD.PR_NO                                                                      AS PR_NO                  , --PR번호
                           PRDT.SAP_PR_NO                                                                  AS SAP_PR_NO              , --ERP PR NO
                           PRDT.SAP_GRP_CD                                                                 AS SAP_GRP_CD             , --ERP 구매그룹 코드
                           PRDT.PR_LNO                                                                     AS PR_LNO                 , --PR항번
                           TO_NUMBER(NVL(PRDT.SAP_PR_LNO, PRDT.PR_LNO))                                    AS LINE_NO                ,
                           PRHD.PR_REQ_ID                                                                  AS PR_REQ_ID              , --요청자
                           PRHD.PR_REQ_DATE                                                                AS PR_REQ_DATE            , --요청일
                           PRHD.PR_TIT                                                                     AS PR_TIT                 , --요청 제목
                           PRDT.COST_TYP                                                                   AS COST_TYP               , --회계계정지정범주 [P052]
                           ( SELECT CATE4_CD 
                               FROM ESMMTGL 
                              WHERE SYS_ID  = PRHD.SYS_ID 
                                AND ITEM_CD = PRDT.ITEM_CD 
                                AND USE_COMP_CD  LIKE  '%' || UPPER(#s_comp_cd#) ||',%'
                                AND STS    <> 'D' 
                           )                                                                               AS CATE4_CD               , 
                           PRDT.ITEM_CD                                                                    AS ITEM_CD                , --품목코드
                           (CASE WHEN #locale# != 'ko_KR'
                                      THEN PRDT.ITEM_EN_NM
                                 ELSE PRDT.ITEM_NM
                             END)                                                                          AS ITEM_NM_VIEW           , --품명(공사/용역명)
                           PRDT.ITEM_NM                                                                    AS ITEM_NM                , --품명(한글)
                           PRDT.ITEM_EN_NM                                                                 AS ITEM_EN_NM             , --품명(영문)
                           PRDT.SAP_ITEM_CD                                                                AS SAP_ITEM_CD            , --ERP품목코드
                           PRDT.SPEC                                                                       AS SPEC                   , --규격
                           PRDT.UNIT_CD                                                                    AS UNIT_CD                , --단위
                           PRDT.ITEM_QTY                                                                   AS ITEM_QTY               , --수량
                           PRDT.CUR                                                                        AS CUR                    , --통화
                           PRDT.PR_PRICE                                                                   AS PR_PRICE               , --단가
                           PRDT.PR_AMT                                                                     AS PR_AMT                 , --금액
                           PRDT.RD_DATE                                                                    AS RD_DATE                , --납기일자
                           PRDT.PRD_SD                                                                     AS PRD_SD                 , --프로젝트 시작일
                           PRDT.PRD_ED                                                                     AS PRD_ED                 , --프로젝트 종료일
                           PRDT.REF_VD                                                                     AS REF_VD                 , --참조업체
                           ( SELECT FC_GET_SG_SN_NAME(PRDT.SYS_ID, PRDT.SG_SN) FROM DUAL )                    AS SG_NM                  , --SG 명
                           PRDT.SG_SN                                                                      AS SG_SN                  , --SG일련번호
                           PRDT.SG_CD                                                                      AS SG_CD                  , --SG코드
                           PRDT.CATE_CD                                                                    AS CATE_CD                , --자재그룹
                           PRDT.PLT_CD                                                                     AS PLT_CD                 , --PLANT
                           PRDT.WH_CD                                                                      AS WH_CD                  , --저장위치
                           PRDT.RD_LOCAT                                                                   AS RD_LOCAT               , --납품장소
                           PRDT.PURC_GRP_CD                                                                AS PURC_GRP_CD            , --구매그룹
                           PRDT.EMG_YN                                                                     AS EMG_YN                 , --긴급구분
                           PRDT.ATT_NO                                                                     AS ATT_NO                 , --첨부파일
                           (SELECT COUNT(1)                                                                
                              FROM ESAATTH                                                             
                             WHERE SYS_ID = PRDT.SYS_ID                                                    
                               AND GRP_CD = PRDT.ATT_NO                                                    
                               AND STS <> 'D')                                                             AS IMG_ATT_NO             , --첨부파일 수
                           PRDT.RFQ_QTY                                                                    AS RFQ_QTY                , --견적요청수량
                           PRDT.PO_QTY                                                                     AS PO_QTY                 , --발주수량
                           PRDT.AR_QTY                                                                     AS AR_QTY                 , --검수요청수량
                           PRDT.GR_QTY                                                                     AS GR_QTY                 , --입고수량
                           PRDT.PO_END_YN                                                                  AS PO_END_YN              , --발주종료여부
                           PRDT.GR_END_YN                                                                  AS GR_END_YN              , --입고종료여부
                           PRDT.PRICE_CNTR_NO                                                              AS PRICE_CNTR_NO          , --단가계약번호
                           NVL(PRDT.IF_TYP, 'S')                                                           AS IF_TYP                 ,
                           PRDT.IF_FLAG                                                                    AS IF_FLAG                , --I/F FLAG
                           PRDT.IF_REJECT_YN                                                               AS IF_REJECT_YN           , --I/F 반송여부(Y:반송가능, Default:N)
                           PRDT.CNTR_NO                                                                    AS CNTR_NO                , --계약번호
                           INFO.PLT_CD                                                                     AS INFO_PLT_CD            , --(단가계약) Plant
                           INFO.VD_CD                                                                      AS INFO_VD_CD             , --(단가계약) 업체
                           INFO.PURC_GRP_CD                                                                AS INFO_PURC_GRP_CD       , --(단가계약) 구매그룹
                           INFO.CNTR_DATE                                                                  AS INFO_CNTR_DATE         , --(단가계약) 계약일자
                           INFO.APPLY_SD                                                                   AS INFO_APPLY_SD          , --(단가계약) 적용시작일자
                           INFO.APPLY_ED                                                                   AS INFO_APPLY_ED          , --(단가계약) 적용종료일자
                           INFO.ITEM_NM                                                                    AS INFO_ITEM_NM           , --(단가계약) 품명(한글)
                           INFO.ITEM_EN_NM                                                                 AS INFO_ITEM_EN_NM        , --(단가계약) 품명(영문)
                           INFO.SPEC                                                                       AS INFO_SPEC              , --(단가계약) 규격
                           INFO.UNIT_CD                                                                    AS INFO_UNIT_CD           , --(단가계약) 단위
                           INFO.ITEM_QTY                                                                   AS INFO_ITEM_QTY          , --(단가계약) 수량
                           INFO.CUR                                                                        AS INFO_CUR               , --(단가계약) 통화
                           INFO.ITEM_PRICE                                                                 AS INFO_ITEM_PRICE        , --(단가계약) 단가
                           INFO.DISTR_RATE                                                                 AS INFO_DISTR_RATE        , --(단가계약) 금액
                           INFO.PAY_TERMS_CD                                                               AS INFO_PAY_TERMS_CD      , --(단가계약) 대금지급방법
                           INFO.PAY_TERMS_DESC                                                             AS INFO_PAY_TERMS_DESC    , --(단가계약) 대금지급방법 설명
                           INFO.DELY_TERMS_CD                                                              AS INFO_DELY_TERMS_CD     , --(단가계약) 납품방법
                           INFO.DELY_TERMS_DESC                                                            AS INFO_DELY_TERMS_DESC   , --(단가계약) 납품방법 설명
                           INFO.RFQ_NO                                                                     AS INFO_RFQ_NO            , --(단가계약) 견적요청번호
                           INFO.RFQ_CNT                                                                    AS INFO_RFQ_CNT           , --(단가계약) 견적요청회수
                           INFO.RFQ_LNO                                                                    AS INFO_RFQ_LNO           , --(단가계약) 견적요청항번
                           INFO.QTA_NO                                                                     AS INFO_QTA_NO            , --(단가계약) 견적번호
                           INFO.QTA_LNO                                                                    AS INFO_QTA_LNO           , --(단가계약) 견적항번
                           INFO.PRICE_CNTR_NO                                                              AS INFO_PRICE_CNTR_NO     , --(단가계약) 단가계약번호
                           INFO.PRICE_CNTR_LNO                                                             AS INFO_PRICE_CNTR_LNO    , --(단가계약) 단가계약항번
                           PRDT.PURC_GRP_CD                                                                AS OLD_PURC_GRP_CD
                           ,PRDT.OPER_ORG_SN -- 구매 운영 조직 일련번호
                      FROM ESPPRHD PRHD, ESPPRDT PRDT, ESPINFO INFO
                     WHERE PRHD.SYS_ID                 = #sys_id#
                       AND (
                              (
                                 #comp_flag#   = 'Y' 
                                 AND
                                 (
                                    #comp_cd#     IS NULL
                                    OR
                                    PRHD.COMP_CD  = NVL(#comp_cd#, #s_comp_cd#)
                                 )
                               )
                               OR
                               (
                                  #comp_flag#   IS NULL
                                  AND
                                  PRHD.COMP_CD  = #s_comp_cd#
                               )
                           )
						  {
						  	//운영조직 일련번호 (복수 선택)
						  	var sql = "";
						  	var list = $data.oper_org_sn;
						  	if(list.length > 0)
						  	{
						  		sql = "AND PRDT.OPER_ORG_SN in ("
						  		sql += list.join();
						  		sql += ")";
						  	}
					  		sql;
						  }
						  {
						  	//구매담당 - 복수 선택 (2015.07.13 최초 작성) 
						  	var sql = "";
						  	var list = $data.purc_grp_cd;
						  	if(list.length > 0)
						  	{
					  			sql =  "AND PRDT.PURC_GRP_CD in ("
						  		
						  		for(var i=0; i<list.length; i++)
						  		{
						  			sql += "'" + list[i] + "',";
						  		}
						  		
					  			sql += "null)";
						  	}
					  		sql;
						   }
                       AND PRHD.PR_REQ_DATE            BETWEEN #from_date# AND #to_date#
                       AND PRHD.STS                    <> 'D'
                       AND PRHD.APRV_STS               = 'C'
                       --AND PRDT.PR_PROG_STS            IN ( 'RV','RW', 'RB', 'IC', 'VW' )          --[GRP_CD:P044], RW-구매요청접수대기, RB-구매변경요청반려, IC-RFI완료, VW-유찰 , RV-구매요청접수
                       /*각 모듈에서 등록, 수정, 취소, 삭제 시 수량을 맞춰줘야 바른 데이터가 나옵니다.*/
                       AND PRDT.ITEM_QTY               > NVL(PRDT.RFQ_QTY,0)   --견적 수량 
                       AND PRDT.ITEM_QTY               > NVL(PRDT.PO_QTY,0)    --발주 수량
                       AND PRDT.ITEM_QTY               > NVL(PRDT.AR_QTY,0)    --검수요청수량
                       AND PRDT.ITEM_QTY               > NVL(PRDT.GR_QTY,0)    --입고 수량
                       AND NVL(PRDT.PO_END_YN, 'N')    = 'N'
                       AND NVL(PRDT.GR_END_YN, 'N')    = 'N'
                     [ AND UPPER(PRHD.PR_TIT)          LIKE '%' || UPPER(#pr_tit#) || '%'     ]
                     [ AND PRHD.PR_REQ_ID              = #pr_req_id#                  ]
                     [ AND PRHD.PURC_TYP               = #purc_typ#                   ]
                     [ AND PRDT.PLT_CD                 = #plt_cd#                     ]
                     [ AND UPPER(PRDT.ITEM_CD)         LIKE '%' || UPPER(#item_cd#) ||'%'     ]
                     [ AND UPPER(PRDT.ITEM_NM)         LIKE '%' || UPPER(#item_nm#) ||'%'     ] 
                       AND (
                             (
                               #multi_sap_grp# = 'true'
                               AND
                               EXISTS (
                                       SELECT 'X'
                                         FROM ESPTEMP2
                                        WHERE 1=1 
                                          AND SAP_GRP_CD IS NOT NULL
                                          AND PRDT.SAP_GRP_CD = SAP_GRP_CD  
                                      )
                             )
                             OR
                             (
                               #multi_sap_grp# = 'false'
                               [  AND UPPER(PRDT.SAP_GRP_CD) = UPPER(#sap_grp_cd#)  ]
                             )
                           )
                       AND (
                             (
                               #multi_pr_no# = 'true'
                               AND
                               EXISTS (
                                       SELECT 'X'
                                         FROM ESPTEMP2
                                        WHERE 1=1 
                                          AND PR_NO IS NOT NULL
                                          AND PRHD.PR_NO LIKE '%' || PR_NO || '%' 
                                      )
                             )
                             OR
                             (
                               #multi_pr_no# = 'false'
                               [  AND UPPER(PRHD.PR_NO)       LIKE '%' || UPPER(#pr_no#) || '%'        ]
                             )
                           )
                       AND (
                             (
                               #multi_sap_pr_no# = 'true'
                               AND
                               EXISTS (
                                       SELECT 'X'
                                         FROM ESPTEMP2
                                        WHERE 1=1
                                          AND SAP_PR_NO IS NOT NULL
                                          AND PRHD.SAP_PR_NO LIKE '%' || SAP_PR_NO || '%'
                                           
                                      )
                             )
                             OR
                             (
                               #multi_sap_pr_no# = 'false'
                               [  AND UPPER(PRHD.SAP_PR_NO)   LIKE '%' || UPPER(#sap_pr_no#) || '%'    ]
                             )
                           )  
                       AND ( #acc_sts# IS NULL
                              OR
                             (#acc_sts# = 'Y' 
                                AND PR_PROG_STS = 'RV') 
                            OR
                            (#acc_sts# = 'N'
                                AND PR_PROG_STS IN ('RW', 'RB', 'IC', 'VW') )
                            OR
                            (#acc_sts# = 'A'
                                AND PR_PROG_STS IN ('RV', 'RW', 'RB', 'IC', 'VW'))
                            )      --[GRP_CD:P044], RW-구매요청접수대기, RB-구매변경요청반려, IC-RFI완료, VW-유찰              
                       AND PRDT.STS                    <> 'D'
                       AND PRDT.SYS_ID                 = PRHD.SYS_ID
                       AND PRDT.PR_NO                  = PRHD.PR_NO
                       AND PRDT.COMP_CD                = PRHD.COMP_CD 
                       AND PRDT.SYS_ID                 = INFO.SYS_ID(+)
                       AND PRDT.COMP_CD                = INFO.COMP_CD(+)
                       AND PRDT.PLT_CD                 = INFO.PLT_CD(+)
                       AND PRDT.ITEM_CD                = INFO.ITEM_CD(+) 
                       AND PRDT.REF_VD                 = INFO.VD_CD(+) 
                       AND INFO.APPLY_SD            (+)<= TO_CHAR(SYSDATE,'YYYYMMDD')
                       AND INFO.APPLY_ED            (+)>= TO_CHAR(SYSDATE,'YYYYMMDD')
                       AND INFO.STS                 (+)<> 'D'
                       [@addsql@]
                     ORDER BY PRHD.PR_NO DESC, TO_NUMBER(PRDT.PR_LNO)
                 ) TOT
            WHERE 1=1
            [ AND TOT.PURC_REQ_TYP_SUB = #purc_req_typ# ]     
        ]]>
    </sql>
    
    <sql id="select.prdt.prog_sts" comment="접수 - PR상태 체크">
        <![CDATA[
            SELECT CASE WHEN TOT.CNT > 0
                        THEN 'N'
                        ELSE 'Y'
                   END                        AS CHECK_YN     
              FROM (
		             SELECT COUNT(1) AS CNT
		               FROM ESPPRDT
		              WHERE SYS_ID  = #sys_id#
		                AND COMP_CD = #s_comp_cd#
		                AND PR_NO   = #pr_no#
		                AND PR_PROG_STS NOT IN ('RV', 'RW', 'RB', 'IC', 'VW')
		                AND STS    <> 'D'
		            ) TOT     
        ]]>
    </sql>
    
    <sql id="prdt.prog_sts.update" comment="접수 - PR접수(물품)(공사/용역)">
        <![CDATA[
            UPDATE ESPPRDT
               SET PR_PROG_STS = 'RV'                                 -- 구매요청 진행상태 
                 , STS         = 'U'                                  -- 상태
                 , MOD_ID      = #s_reg_id#                             -- 수정자 아이디
                 , MOD_DT      = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')  -- 수정 일시
             WHERE SYS_ID      = #sys_id#
               AND COMP_CD     = #s_comp_cd#
               AND PR_NO       = #pr_no#
               AND PR_LNO      = #pr_lno#
               AND STS         <> 'D'
        ]]>
    </sql>
    
    <sql id="prdt.purc_grp_cd.update" comment="구매그룹변경 - PR접수(물품)(공사/용역)">
        <![CDATA[
        BEGIN
            UPDATE ESPPRDT
               SET PURC_GRP_CD = #purc_grp_cd#                       , --구매 그룹 코드 
                   STS         = 'U'                                 , --상태
                   MOD_ID      = #s_reg_id#                            , --수정자 아이디
                   MOD_DT      = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')   --수정 일시
             WHERE SYS_ID      = #sys_id#
               AND COMP_CD     = #s_comp_cd#
               AND PR_NO       = #pr_no#
               AND PR_LNO      = #pr_lno#
               AND STS         <> 'D';
            
            INSERT INTO ESPTSINFO
            (
                SYS_ID
                , COMP_CD
                , SRC_CD
                , SRC_NO
                , SRC_ID
                , TGT_ID
                , REG_ID
                , REG_DT
            )
            VALUES
            (
                #sys_id#
                , #s_comp_cd#
                , 'PR'
                , #pr_no#
                , #old_purc_grp_cd#
                , #purc_grp_cd#
                , #s_reg_id#
                , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
            );         
        END;
        ]]>
    </sql>
    
    <sql id="prdt.reject.update" comment="PR 반송 - PR접수(물품)(공사/용역)">
        <![CDATA[
            BEGIN
        
	            UPDATE ESPPRDT
	               SET PR_PROG_STS  = 'RD'                                                                             , --구매요청 진행 상태(T:접수중, A:접수,R:반송,P:진행중)
	                   REJECT_CAUSE = '[[' || TO_CHAR(SYSDATE, 'YYYY/MM/DD') || ']]' || chr(13) || TRIM(#reject_cause#)  , --반려 사유
	                   REJECT_DT    = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                                              , --반려일자
	                   STS          = 'U'                                                                              , --상태
	                   MOD_ID       = #s_reg_id#                                                                         , --수정자 아이디
	                   MOD_DT       = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')                                                --수정 일시
	             WHERE SYS_ID       = #sys_id#
	               AND COMP_CD      = #s_comp_cd#
	               AND PR_NO        = #pr_no#
	               AND PR_LNO       = #pr_lno#
	               AND STS          <> 'D';
	               
	               
	            UPDATE ESPPRHD PRHD
	               SET PR_TOT_AMT   = NVL( ( SELECT SUM(PR_AMT)
	                                           FROM ESPPRDT
	                                          WHERE SYS_ID      = PRHD.SYS_ID
	                                            AND COMP_CD     = PRHD.COMP_CD
	                                            AND PR_NO       = PRHD.PR_NO
	                                            AND PR_PROG_STS <> 'RD'
	                                            AND STS         <> 'D' ), 0 )         , 
	                   MOD_ID       = #s_reg_id#                                        ,
	                   MOD_DT       = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')             
	             WHERE SYS_ID       = #sys_id#
	               AND COMP_CD      = #s_comp_cd#
	               AND PR_NO        = #pr_no#;
             END;
        ]]>
    </sql>
    
    <sql id="select.email.info" comment="PR 반송 - 메일 발송 정보 조회">
        <![CDATA[
            SELECT USR_ID AS RECEIVE_ID
                 , USR_NM AS RECEIVE_NM
                 , EMAIL  AS RECEIVE_EMAIL
              FROM ESAUSER     
             WHERE SYS_ID  = #sys_id#
               AND COMP_CD = #s_comp_cd# 
               AND USR_ID  = #pr_req_id#     
        ]]>
    </sql>
    
    <sql id="select.itemprice.itemlist" comment="">
        <![CDATA[
            SELECT PRICE_CNTR_NO,
                   CNTR_NO,
                   CNTR_TIT,
                   VD_CD,
                   CNTR_DATE,
                   APPLY_SD,
                   APPLY_ED,
                   INDT_CNT,
                   TEMP_CNT,
                   (SELECT FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#,'VENDOR',VD_CD,'','','','','') FROM DUAL) AS VD_NM
              FROM (
                    SELECT INHD.PRICE_CNTR_NO    AS PRICE_CNTR_NO, 
                           INHD.CNTR_NO          AS CNTR_NO,
                           INHD.CNTR_TIT         AS CNTR_TIT,
                           INHD.VD_CD            AS VD_CD,
                           INHD.CNTR_DATE        AS CNTR_DATE,
                           INHD.APPLY_SD         AS APPLY_SD,
                           INHD.APPLY_ED         AS APPLY_ED,
                           COUNT(1)              AS INDT_CNT,
                          ( SELECT COUNT(1)
                              FROM ESPTEMP )     AS TEMP_CNT
                      FROM ESPINHD INHD, ESPINDT INDT, ESPTEMP TEMP
                     WHERE INHD.SYS_ID        = #sys_id#
                       AND INHD.COMP_CD       = #s_comp_cd#
                     [ AND INHD.PRICE_CNTR_NO LIKE '%' || #price_cntr_no# || '%' ]
                     [ AND INHD.CNTR_NO       LIKE '%' || #cntr_no# || '%'       ]
                     [ AND INHD.VD_CD         = #vd_cd# ]
                       AND INHD.PROG_STS      = 'P'
                       AND INHD.APPLY_SD      <= TO_CHAR(SYSDATE, 'YYYYMMDD')
                       AND INHD.APPLY_ED      >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                       AND INHD.STS           <> 'D'
                       AND INHD.SYS_ID        = INDT.SYS_ID
                       AND INHD.PRICE_CNTR_NO = INDT.PRICE_CNTR_NO
                       AND INDT.SYS_ID        = TEMP.SYS_ID
                       AND INDT.ITEM_CD       = TEMP.ITEM_CD
                       AND INDT.STS           <> 'D'
                  GROUP BY INHD.PRICE_CNTR_NO, INHD.CNTR_NO, INHD.CNTR_TIT, INHD.VD_CD, INHD.CNTR_DATE, INHD.APPLY_SD, INHD.APPLY_ED
                   )
             WHERE INDT_CNT = TEMP_CNT

        ]]>
    </sql>
    
    <sql id="select.itemprice.for_update" comment="단가계약 일괄지정 - PR접수">
        <![CDATA[
            SELECT INDT.ITEM_CD      AS ITEM_CD , 
                   INDT.ITEM_PRICE   AS PR_PRICE,
                   INHD.CNTR_NO      AS CNTR_NO
              FROM ESPINHD INHD
                  ,ESPINDT INDT
             WHERE INHD.SYS_ID        = INDT.SYS_ID
               AND INHD.COMP_CD       = INDT.COMP_CD
               AND INHD.PRICE_CNTR_NO = INDT.PRICE_CNTR_NO
               AND INHD.SYS_ID        = #sys_id#
               AND INHD.COMP_CD       = #s_comp_cd#
               AND INHD.PRICE_CNTR_NO = #price_cntr_no#
        ]]>
    </sql>
    
    <sql id="update.itemprice.itemlist" comment="단가계약 일괄지정 - PR접수">
        <![CDATA[
            UPDATE ESPPRDT 
               SET PR_PRICE       = NVL( #pr_price#, 0 )   ,
                   PR_AMT         = NVL( #pr_price#, 0 ) * ITEM_QTY / NVL(PRICE_UNIT, 1),
                   PRICE_CNTR_NO  = #price_cntr_no#,
                   REF_VD         = #vd_cd#,
                   CNTR_NO        = #cntr_no#
             WHERE SYS_ID         = #sys_id#
               AND COMP_CD        = #s_comp_cd#
               AND PR_NO          = #pr_no#
               AND PR_LNO         = #pr_lno#
               AND ITEM_CD        = #item_cd#
        ]]>
    </sql>
    
    <sql id="update.mrosend" comment="구매대행 ,행복나래 처리완료 (PR_PROG_STS : 업데이트) - 2012.07.20 추가 ">
        <![CDATA[
            UPDATE ESPPRDT -- 구매 요청 품목 정보
               SET PR_PROG_STS = 'RC'             /* 구매요청 진행 상태 */
             WHERE SYS_ID  = #sys_id#             /* 시스템 아이디 */
               AND COMP_CD = #s_comp_cd#          /* 회사 코드 */
               AND PR_NO   = #pr_no#              /* 구매 요청 번호 */
               AND PR_LNO  = #pr_lno#             /* 구매 요청 항번 */
        ]]>
    </sql>
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #####################################                 구 매 요 청 접 수 쿼 리  END                ####################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->

    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                          전 자 결 재 START        ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    <sql id="get.aprv.query.no" comment="">
        <![CDATA[
            SELECT DOC_NO, MAX_ROW, MAX_URL
              FROM ESAAPINFO
             WHERE SYS_ID    = #sys_id#
               AND COMP_CD   = #s_comp_cd#
               AND JOB_CD    = #job_cd# 
        ]]>
    </sql>
    
    <sql id="get.aprv.cnt">
        <![CDATA[
            SELECT APRV_CNT
              FROM ESPPRHD
             WHERE SYS_ID  = #sys_id# 
               AND COMP_CD = #s_comp_cd#
               AND PR_NO   = #pr_no#
        ]]>
    </sql>
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      ###################################                          전 자 결 재 END          ##############################################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #######################                                품 목 검 색 조 회       START                      ############################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    <sql id="item.cate.tree.select" comment="분류검색 조회">
        <![CDATA[
                  SELECT
                      SYS_ID
                    , CATE_LVL
                    , CATE_CD
                    , CATE_NM   AS  CATE_NM_TREE
                    , CATE_NM
                    , UP_CATE_CD
                    , SORT_ORD
                    , RISK_MGT_YN
                    , ITEM_CD_MAND_YN
                    , REM
                    , SUBSTR(SYS_CONNECT_BY_PATH('(' || CATE_CD || ') ' || CATE_NM, ' > '),4)   AS  CATE_PATH            
                    , LEVEL
                    , 'PU' AS PURC_GRP_TYP
                  FROM  ESMMCLS M
                 WHERE    SYS_ID =  #sys_id#
                   AND  USE_YN =  'Y'
                   AND  STS    <> 'D'
                CONNECT BY (SYS_ID = #sys_id# AND UP_CATE_CD = PRIOR CATE_CD)
                START WITH (SYS_ID = #sys_id# AND UP_CATE_CD = '0' @wh_cate_display_yn@)
                ORDER SIBLINGS BY  SORT_ORD
        ]]>
    </sql>
    
    <sql id="select.pr.item.cataloglist" comment="품목검색 조회">
        <![CDATA[
        SELECT * FROM    
            (SELECT ROWNUM AS RNUM,
            			AAA.*
                FROM
                 ( SELECT
                    COUNT(1) OVER() total_row_num
                    ,A.*
                    ,B.PURC_GRP_NM JOB_GRP_NM --구매그룹명
                    ,(SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = A.SYS_ID AND CATE_CD = A.CATE1_CD) AS CATE1_NM
                    ,(SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = A.SYS_ID AND CATE_CD = A.CATE2_CD) AS CATE2_NM
                    ,(SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = A.SYS_ID AND CATE_CD = A.CATE3_CD) AS CATE3_NM
                    ,(SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = A.SYS_ID AND CATE_CD = A.CATE4_CD) AS CATE4_NM
                    FROM
                    (
                        SELECT
                        A.*
                        ,NVL(A.BAS_UNIT_CD_M, B.UNIT_CD) AS BAS_UNIT_CD
                        ,B.VD_CD
                        ,NVL(B.ITEM_NM,A.ITEM_NM_VIEW_A) AS ITEM_NM_VIEW
                        ,NVL(B.ITEM_NM,A.ITEM_NM_A) AS ITEM_NM
                        ,V.VD_NM_LOC VD_NM
                        ,V.BIZ_REG_NO
                        ,B.ITEM_PRICE
                        ,B.DISTR_RATE
                        ,B.APPLY_SD
                        ,B.APPLY_ED
                        ,B.PAY_TERMS_CD
                        ,B.PAY_TERMS_DESC
                        ,B.DELY_TERMS_CD
                        ,B.DELY_TERMS_DESC
                        ,NVL(B.AUTO_PO_YN,'N') AS AUTO_PO_YN
                        ,(SELECT FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#,'CODE', 'C022', NVL(B.AUTO_PO_YN,'N'), '','','','') FROM DUAL) as AUTO_PO_YN_NM 
                        ,B.PRICE_CNTR_NO    
                        ,B.CNTR_NO
                        ,B.INFO_SN
                        ,NVL(B.PRC_CHG_YN, 'N') AS PRC_CHG_YN
                        ,NVL2(B.PRICE_CNTR_NO,'Y','N') AS PRC_YN             
                        ,NVL(B.CEILING_YN, 'N') AS CEILING_YN
                        ,C.PURC_GRP_CD JOB_GRP_CD --구매그룹코드
                        ,C.PURC_GRP_TYP
                        FROM
                        (
                            SELECT
                             M.ITEM_CD
                            , (CASE WHEN 'ko_KR' = 'ko_KR' THEN M.ITEM_NM ELSE M.ITEM_EN_NM END)  AS  ITEM_NM_VIEW_A
                            , M.ITEM_NM                                                           AS ITEM_NM_A 
                            , M.ITEM_EN_NM
                            , DECODE(M.MOD_NO,'','','[[모델명:'||M.MOD_NO||']]')||DECODE(M.MAKER_NM,'','','[[제조사:'||M.MAKER_NM||']]')||M.SPEC   SPEC                        
                            , M.CATE4_CD   AS  CATE_CD
                            , M.CATE1_CD
                            , M.CATE2_CD
                            , M.CATE3_CD
                            , M.CATE4_CD
                            , M.ATT_NO
                            , M.MOD_NO
                            , M.MAKER_NM
                            , M.REQ_ITEM_CD
                            , M.REM
                            , M.SYS_ID
                            , M.REP_CD_YN -- 대표코드여부
                            , M.ITG_PURC_YN --통합표준
                            , M.USE_COMP_CD -- 품목사용회사
                            , M.BAS_UNIT_CD BAS_UNIT_CD_M -- 기본단위
                            , E.SG_CD
                            , E.SG_SN
                            , E.SG_NM
                            , B.COMP_CD
                            , (SELECT ORG_CD FROM ESAOOMG WHERE OPER_ORG_SN = #oper_org_sn#) AS PLT_CD
                            , B.OPER_ORG_SN
                            FROM ESMMTGL M
                             -- 나의 품목 검색시
        {
            var sqlstr = "";
            if($data.myItem == "Y"){
                sqlstr = "INNER JOIN (SELECT S.* FROM ESMMYMT S WHERE S.SYS_ID = #sys_id# AND S.USR_ID = #s_reg_id# AND S.COMP_CD = #s_comp_cd# AND S.USE_YN = 'Y' ) A ON M.SYS_ID = A.SYS_ID AND M.ITEM_CD = A.ITEM_CD";
            }
            sqlstr;
        }                     
                            INNER JOIN ESMMTOP B
                            ON M.SYS_ID = B.SYS_ID
                            AND M.ITEM_CD = B.ITEM_CD
                            AND B.OPER_ORG_SN = #oper_org_sn#
                            LEFT OUTER JOIN ESRSGMA D --소싱그룹품목 
                            ON M.SYS_ID = D.SYS_ID
                            AND M.ITEM_CD = D.ITEM_CD
                            /* AND D.OPER_ORG_SN= [oper_org_sn] */
                            AND D.OPER_ORG_SN IN (SELECT TARG_OPER_ORG_SN FROM ESAOOLM WHERE SRC_OPER_ORG_SN = #oper_org_sn# AND LINK_TYP = 'IOGO' AND LINK_YN = 'Y')
                            LEFT OUTER JOIN ESRVMSG E --소싱그룹
                            ON  D.SYS_ID  = E.SYS_ID
                            AND  D.OPER_ORG_SN = E.OPER_ORG_SN
                            AND  D.SG_CD       = E.SG_CD
                            [ JOIN  (SELECT DISTINCT CATE_CD  FROM ESMMCLS START WITH CATE_CD LIKE UPPER(#cate_cd4#) || '%' CONNECT BY PRIOR CATE_CD = UP_CATE_CD)G  ON M.CATE4_CD=G.CATE_CD]
                            WHERE M.SYS_ID       =  #sys_id#
                            AND  M.USE_YN       =  'Y'
                            AND  M.STS          <> 'D' 
                            [@wh_cate_display_yn@]
                            [ AND M.REP_CD_YN = #rep_cd_yn# ] -- 대표 품목 코드
                          
                            [ AND  M.ITEM_CD   = TRIM(#item_cd#) ] -- 품목코드
                            [ AND  UPPER(M.ITEM_NM ||' '|| M.SYN_TXT)   LIKE  '%' || UPPER(REPLACE(#item_nm#,'*','%')) ||'%' ] -- 품목명, ERP 품목명, 동의어/유사어, 원자재 내역 
                            [ AND  UPPER(M.MAKER_NM)  LIKE  '%' || UPPER(#maker_nm#) ||'%' ] -- 제조사                  
                            [ AND  UPPER(M.MOD_NO)    LIKE  '%' || UPPER(#mod_no#) ||'%' ]  -- 모델번호                  
                            [ AND  UPPER(M.SPEC||B.REM)      LIKE  '%' || UPPER(REPLACE(#spec#,'*','%')) ||'%' ] -- 규격
                            [ AND  B.COMP_ITEM_CD  LIKE  '%' || UPPER(#erp_item_cd#) ||'%' ] -- ERP 품목 코드          
                            --[ AND C.PLT_CD = [plt_cd] ]  
                            [ AND B.MAT_GRP = #mat_grp# ]  --자재그룹코드         
                        )A 
                    {
                        var sqlstr2 = "LEFT OUTER JOIN ESPINFO B "; 
                        if($data.prc_cnt_yn == "Y" || $data.auto_po_yn =="Y"){
                            sqlstr2 = " JOIN ESPINFO B";
                        }
                        sqlstr2;
                    }       --단가정보
                        ON A.SYS_ID   = B.SYS_ID
                        AND A.ITEM_CD = B.ITEM_CD
                        AND A.COMP_CD = B.COMP_CD
                    {    
                          var sqlstr4 = "";
                          if($data.item_cd != null || $data.erp_item_cd !=null){  
                              sqlstr4 = "AND (  B.PLT_CD IS NULL  OR  A.PLT_CD IS NULL  OR   A.REP_CD_YN = 'Y'    OR  ( A.REP_CD_YN = 'N' AND  B.PLT_CD IS NOT NULL  AND A.PLT_CD  = B.PLT_CD  ) )";   
	                      } 
	                      sqlstr4;    
                      }     
                       
                        AND B.APPLY_SD  <= TO_CHAR(SYSDATE,'YYYYMMDD')
                        AND B.APPLY_ED  >= TO_CHAR(SYSDATE,'YYYYMMDD')
                        AND B.STS       <> 'D'  
                        [AND B.AUTO_PO_YN = #auto_po_yn#]
                        [AND B.COMP_CD = #s_comp_cd#]
                    {
                        var sqlstr3 = "LEFT OUTER JOIN ESMVDGL V "; 
                        if($data.vd_nm != null && $data.vd_nm !=""){
                            sqlstr3 = " JOIN ESMVDGL V";
                        }
                        sqlstr3;
                    } 
                        ON  B.SYS_ID = V.SYS_ID 
                        AND B.VD_CD = V.VD_CD
                       [ AND  UPPER(V.VD_NM_LOC)  LIKE  '%' || UPPER(#vd_nm#) ||'%' ] -- 단가계약 업체명
                        LEFT OUTER JOIN ESMJBMC C --품목_구매그룹_매핑
                        ON A.SYS_ID = C.SYS_ID
                        AND A.COMP_CD = C.COMP_CD
                        AND A.CATE3_CD = C.CATE_CD -- 등록시 소분류별로 PURC_GRP_CD는 한개씩만 등록됨 
                        AND C.PURC_GRP_TYP = 'PU'
                        AND C.STS     <> 'D'                        
                    ) A LEFT OUTER JOIN ESMJBMA B  --직무코드
                    ON A.SYS_ID = B.SYS_ID
                    AND B.COMP_CD = #s_comp_cd#
                    AND A.PURC_GRP_TYP = B.PURC_GRP_TYP
                    AND A.JOB_GRP_CD  = B.PURC_GRP_CD
                     
                    ) AAA
                WHERE ROWNUM <= (#endRowNum#+#pageRowNum#)
                )BBB
               WHERE  BBB.RNUM >= (#endRowNum#+1) AND BBB.RNUM <= (#endRowNum#+#pageRowNum#)   
                    
        ]]>
    </sql>
    
     <sql id="select.pr.item.myItemListInfo" comment="나의 품목 조회">
        SELECT SYS_ID     ,
               ITEM_CD    ,
               COMP_CD    ,
               USR_ID     ,
               USE_YN     ,
               REG_ID     ,
               REG_DT     ,
               MOD_ID     ,
               MOD_DT
          FROM ESMMYMT
         WHERE SYS_ID  = #sys_id#
           AND COMP_CD = #s_comp_cd#
           AND USR_ID  = #s_reg_id#
           AND ITEM_CD = #item_cd#
           AND OPER_ORG_SN = #oper_org_sn#
    </sql>    
    
    <sql id="insert.pr.item.myItemSave" comment="나의 품목 지정 저장">
     INSERT INTO ESMMYMT( SYS_ID
                                     , ITEM_CD  
                                     , COMP_CD 
                                     , USR_ID
                                     , OPER_ORG_SN   
                                     , USE_YN  
                                     , REG_ID   
                                     , REG_DT  
                                     , MOD_ID  
                                     , MOD_DT 
                      ) VALUES (  #sys_id#
                                     , #item_cd#  
                                     , #s_comp_cd# 
                                     , #s_reg_id#
                                     , #oper_org_sn#   
                                     , 'Y'  
                                     , #s_reg_id#   
                                     , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')  
                                     , #s_reg_id#  
                                     , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
                      )
    </sql>
    
     <sql id="update.pr.item.myItemUse" comment="나의 품목 재저장">
        UPDATE ESMMYMT 
           SET USE_YN  = 'Y'                                 ,
               MOD_ID  = #s_reg_id#                            ,
               MOD_DT  = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
         WHERE SYS_ID  = #sys_id#
           AND COMP_CD = #s_comp_cd#
           AND USR_ID  = #s_reg_id#
           AND ITEM_CD = #item_cd#
           AND OPER_ORG_SN = #oper_org_sn#
           
    </sql>
    
     <sql id="update.pr.item.myItemClear" comment="나의 품목 해제 저장">
        UPDATE ESMMYMT 
           SET USE_YN  = 'N'                                 ,
               MOD_ID  = #s_reg_id#                            ,
               MOD_DT  = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') 
         WHERE SYS_ID  = #sys_id#
           AND COMP_CD = #s_comp_cd#
           AND USR_ID  = #s_reg_id#
           AND ITEM_CD = #item_cd#
    </sql>
    <!-- 
      ###################################################################################################################################
      ###################################################################################################################################
      #######################                                품 목 검 색 조 회       END                       ############################
      ###################################################################################################################################
      ###################################################################################################################################
    -->
    
    <sql id="select.pr.resultList" comment="구매실적대장(품목단위)">
        <![CDATA[
                SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'P057', POHD.PO_CRE_TYP, '', '', '', '')                 AS PO_CRE_TYP_NM    --계약방식
                     , POHD.PO_NO                                                                                                     AS PO_NO                 -- 표준구매PO번호
                     , PODT.SAP_PO_NO                                                                                                 AS SAP_PO_NO             -- ERP발주번호
                     , POHD.PURC_ORG                                                                                                  AS PURC_ORG              -- 구매부서코드
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C028', POHD.PURC_ORG, '', '', '', '')                   AS PURC_ORG_NM           -- 구매부서명
                     , POHD.PURC_GRP_CD                                                                                               AS PURC_GRP_CD           -- 구매그룹명
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'PURC_GRP', 'PU', POHD.PURC_GRP_CD, '', '', '', '')              AS PURC_GRP_NM           -- 구매그룹명
                     , FC_GET_NAME(#sys_id#,#locale#,#s_comp_cd#,'CODE', 'C009', POHD.SAP_GRP_CD, '', '', '', '')                     AS SAP_GRP_NM            -- ERP구매그룹 명
                     , POHD.PURC_TYP                                                                                                  AS PURC_TYP              -- 구매유형
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'P045', POHD.PURC_TYP, '', '', '', '')                   AS PURC_TYP_NM           -- 구매유형명
                     , INHD.CNTR_TIT                                                                                                  AS CNTR_TIT              -- 단가계약명
                     , INHD.PRICE_CNTR_NO                                                                                             AS PRICE_CNTR_NO         -- 단가계약번호
                     , POHD.PO_TIT                                                                                                    AS PO_TIT                -- 기본계약명
                     , POHD.CNTR_NO                                                                                                   AS CNTR_NO               -- 기본계약번호
                     , POHD.APRV_DATE                                                                                                 AS CNTR_DATE             -- 계약일자
                     , CASE POHD.PO_CRE_TYP WHEN 'PRC' THEN 
                                       CASE WHEN INHD.APPLY_SD IS NOT NULL THEN FC_GET_CAST_DT(POHD.SYS_ID,INHD.APPLY_SD,'Y/M/D')||'~'||FC_GET_CAST_DT(POHD.SYS_ID,INHD.APPLY_ED,'Y/M/D') ELSE '' END
                                                       ELSE 
                                       CASE WHEN POHD.CNTR_PRD_SD IS NOT NULL THEN FC_GET_CAST_DT(POHD.SYS_ID,POHD.CNTR_PRD_SD,'Y/M/D')||'~'||FC_GET_CAST_DT(POHD.SYS_ID,POHD.CNTR_PRD_ED,'Y/M/D') ELSE '' END
                       END                                                                                                            AS APPLY_DATE            -- 계약기간
                     , PODT.RD_DATE                                                                                                   AS RD_DATE               -- 납기일자
                     , PRDT.PRD_SD
                     , PRDT.PRD_ED
                     , FC_GET_SG_SN_NAME( #sys_id#, PODT.SG_SN)                                                                          AS SG_NM                 -- SG 명
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C029', PODT.CATE_CD, '', '', '', '')                    AS MTG_NM                -- 분류 명
                     , PODT.CATE_CD
                     , (SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = CATE.SYS_ID AND CATE_CD = CATE.CATE1_CD)                           AS CATE1_NM              -- 분류명(대)
                     , (SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = CATE.SYS_ID AND CATE_CD = CATE.CATE2_CD)                           AS CATE2_NM              -- 분류명(중)
                     , (SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = CATE.SYS_ID AND CATE_CD = CATE.CATE3_CD)                           AS CATE3_NM              -- 분류명(소)
                     , (SELECT CATE_NM FROM ESMMCLS WHERE SYS_ID = CATE.SYS_ID AND CATE_CD = CATE.CATE4_CD)                           AS CATE4_NM              -- 분류명(세)
                     , PODT.ITEM_CD                                                                                                   AS ITEM_CD               -- 품목코드
                     , PODT.SAP_ITEM_CD                                                                                               AS SAP_ITEM_CD           -- ERP품목코드
                     , PODT.ITEM_NM                                                                                                   AS ITEM_NM               -- 품명
                     , PODT.SPEC                                                                                                      AS SPEC                  -- 규격
                     , PODT.UNIT_CD                                                                                                   AS UNIT_CD               -- 단위
                     , PODT.PRICE_UNIT                                                                                                AS PRICE_UNIT            -- 가격단위
                     , PODT.ITEM_PRICE                                                                                                AS ITEM_PRICE            -- 단가
                     , PODT.ITEM_QTY                                                                                                  AS ITEM_QTY              -- 수량
                     , PODT.ITEM_AMT                                                                                                  AS ITEM_AMT              -- 금액
                     , FC_GET_EXCH_AMOUT( PODT.SYS_ID, PODT.ITEM_AMT, PODT.CUR, 'KRW', TO_CHAR(SYSDATE, 'YYYYMMDD') )                      AS ITEM_EXCH_AMT         -- 환산금액원화
                     , PODT.CUR                                                                                                       AS CUR                   -- 통화
                     , POHD.SHIPPER_TYPE                                                                                              AS SHIPPER_TYPE          -- 내외자구분
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C024', POHD.SHIPPER_TYPE, '', '', '', '')               AS SHIPPER_TYPE_NM       -- 내/외자명
                     , RQHD.CPT_TYPE_CD                                                                                               AS CPT_TYPE_CD           -- 경쟁방식
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'B104', RQHD.CPT_TYPE_CD, '', '', '', '')                AS CPT_TYPE_CD_NM        -- 경쟁/수의
                     , POHD.VD_CD                                                                                                     AS VD_CD                 -- 공급업체코드
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'VENDOR', POHD.VD_CD, '', '', '', '', '')                        AS VD_NM                 -- 공급업체명
                     , POHD.MAKER_CD
                     , POHD.MAKER_NM                                                                                                  AS MAKER_NM              -- 제조사
                     , NVL(POHD.DELAY_RATE, 0)                                                                                        AS DELAY_RATE            -- 지체상금율
                     , NVL((SELECT SUM(NVL(GH.DELAY_AMT,0)) FROM ESPGRHD GH, ESPGRDT GD WHERE GH.SYS_ID = GD.SYS_ID
                           AND GH.COMP_CD = GD.COMP_CD AND GH.GR_NO = GD.GR_NO AND GH.GR_CNT = GD.GR_CNT
                           AND GD.SYS_ID = PODT.SYS_ID AND GD.COMP_CD = PODT.COMP_CD AND GD.PO_NO = PODT.PO_NO), 0)                   AS DELAY_AMT             -- 지체상금
                     , PRHD.PR_REQ_DATE                                                                                               AS PR_REQ_DATE           -- 구매요청일
                     , PRHD.PR_REQ_DEPT                                                                                               AS PR_REQ_DEPT           -- 구매요청부서
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'UDEPT', PODT.COMP_CD, PODT.PLT_CD, PRHD.PR_REQ_ID, '', '', '')  AS PR_REQ_DEPT_NM        -- 부서명
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'USER' , PRHD.PR_REQ_ID,  '', '', '', '', '')                    AS PR_REQ_NM             -- 구매요청자
                     , PODT.PR_NO                                                                                                     AS PR_NO
                     , PODT.PR_LNO                                                                                                    AS PR_LNO
                     , PRDT.ITEM_NM                                                                                                   AS PR_ITEM_NM            -- 구매요청(품명)
                     , NVL(PRDT.ITEM_QTY, 0)                                                                                          AS PR_ITEM_QTY           -- 구매요청(수량)
                     , PRDT.UNIT_CD                                                                                                   AS PR_UNIT_CD            -- 구매요청(단위)
                     , PRDT.CUR                                                                                                       AS PR_CUR                -- 구매요청(통화)
                     , NVL(PRDT.PR_PRICE, 0)                                                                                          AS PR_PRICE              -- 구매요청(단가)
                     , NVL(PRDT.PR_AMT, 0)                                                                                            AS PR_AMT                -- 구매요청금액
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'VENDOR'
                                  , (SELECT REF_VD FROM ESPPRDT WHERE SYS_ID = PODT.SYS_ID AND COMP_CD = PODT.COMP_CD AND PR_NO = PODT.PR_NO AND PR_LNO = PODT.PR_LNO) --REF_VD
                                  , '', '', '', '', '')                                                                               AS REF_VD_NM             -- 참조업체 명
                     , NVL((SELECT EMG_YN FROM ESPPRDT WHERE SYS_ID = PODT.SYS_ID AND COMP_CD = PODT.COMP_CD AND PR_NO = PODT.PR_NO
                           AND PR_LNO = PODT.PR_LNO), 'N')                                                                            AS EMG_YN                -- 긴급구매여부
                     , NVL((SELECT AUTO_PO_YN FROM ESPPRDT WHERE SYS_ID = PODT.SYS_ID AND COMP_CD = PODT.COMP_CD AND PR_NO = PODT.PR_NO
                           AND PR_LNO = PODT.PR_LNO), 'N')                                                                            AS AUTO_PO_YN            -- 자동발주여부
                     , PODT.GR_QTY                                                                                                    AS GR_QTY                -- 입고수량
                     , PODT.CUR                                                                                                       AS GR_CUR                -- 입고 통화
                     , PODT.GR_QTY * PODT.ITEM_PRICE                                                                                  AS GR_AMT                -- 입고금액
                     , PODT.GR_QTY * PODT.ITEM_PRICE								                                                  AS GR_EXCH_AMT         -- 환산입고금액원화
                       
                     , PODT.GR_CHR_ID                                                                                                 AS GR_CHR_ID             -- 검수담당자
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'USER', PODT.GR_CHR_ID,  '', '', '', '', '')                     AS GR_CHR_NM             -- 검수담당자
                     , PODT.WH_CD                                                                                                     AS WH_CD                 -- Str.Loc
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'WHNM', 'PLANT', PODT.PLT_CD, PODT.WH_CD, '', '', '')            AS WH_NM                 -- 창고 명
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'OGMG', 'PLANT', PODT.PLT_CD, '', '', '', '')                    AS PLT_NM                -- Plant 명
                     , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'P003', PODT.COST_TYP, '', '', '', '')                   AS COST_TYP_NM           -- 회계지정범주
                     , POHD.BIZ_PLACE_NM                                                                                              AS BIZ_PLACE_NM          -- BP
                     , POAC.COST_ACC_NM                                                                                               AS COST_ACC_NM           -- Cost Ctr명
                     , POAC.COST_ACC_CD                                                                                               AS COST_ACC_CD           -- Cost Ctr코드
                     , POAC.FUND_CENTER_NM                                                                                            AS FUND_CENTER_NM        -- Fund Ctr명
                     , POAC.FUND_CENTER_CD                                                                                            AS FUND_CENTER_CD        -- Fund Ctr코드
                     , POAC.GL_ACC_NM                                                                                                 AS GL_ACC_NM             -- G/L계정명
                     , POAC.GL_ACC_CD                                                                                                 AS GL_ACC_CD             -- G/L계정코드
                     , POAC.ORDER_NO                                                                                                  AS ORDER_NO              -- 투자예산번호
                     , POAC.ORDER_NO_NM                                                                                               AS ORDER_NO_NM           -- 투자예산번호명
                     , POAC.ASSET_NO                                                                                                  AS ASSET_NO              -- 자산번호
                     , POAC.ASSET_NO_NM                                                                                               AS ASSET_NO_NM           -- 자산번호명
                     , PRHD.ORGN_RPT_NO                                                                                               AS ORGN_RPT_NO           -- 사업시행품의명/번호
                     , POAC.WBS_CD                                                                                                    AS WBS_CD                -- WBS코드
                     , POAC.WBS_NM                                                                                                    AS WBS_NM                -- WBS명
                     , CASE WHEN POAC.ORDER_NO IS NULL THEN ''
                                                       ELSE POAC.ORDER_NO||'/'||POAC.ORDER_NO_NM 
                       END                                                                                                            AS ORDER_NO              -- BM오더/명
                     , NVL(PODT.CUST_INFO_TREAT_YN, 'N')                                                                              AS CUST_INFO_TREAT_YN    -- 고객정보취급여부
                     , PODT.ORD_PRD_UNIT                                                                                              AS ORD_PRD_UNIT          -- 오더가격단위
                     , PODT.ORD_EXCH_UNIT                                                                                             AS ORD_EXCH_UNIT         -- 오더단위
                     , POHD.PAY_TERMS_CD                                                                                              AS PAY_TERMS_CD          -- 지급조건코드
                     , FC_GET_NAME(POHD.SYS_ID,#locale#,#s_comp_cd#,'CODE','P009',POHD.PAY_TERMS_CD ,'','','','')                     AS PAY_TERMS_NM          -- 지급조건명
                  FROM ESPPOHD POHD
                     , ESPPODT PODT
                     , ESPINHD INHD
                     , ESPPOAC POAC
                     , ESPRQHD RQHD
                     , ESPPRHD PRHD
                     , ESPPRDT PRDT
                     , ( SELECT DISTINCT M.SYS_ID
                              , B.COMP_CD
                              , M.ITEM_CD
                              , M.ITEM_NM
                              , M.ITEM_EN_NM
                              , M.CATE4_CD   AS  CATE_CD
                              , M.CATE1_CD
                              , M.CATE2_CD
                              , M.CATE3_CD
                              , M.CATE4_CD
                           FROM ESMMTGL M
                LEFT OUTER JOIN ESMLMTGL B --관계사매핑테이블
                             ON M.SYS_ID =  B.SYS_ID
                            AND M.ITEM_CD = B.ITEM_CD
                            AND B.USE_YN  =  'Y'
                            AND B.COMP_CD = #s_comp_cd#  -- 다른 회사로 검색하여도 해당 회사 정보만 나오야 함
               /*              
                LEFT OUTER JOIN ESMLPLT C --관계사 품목 플랜트
                             ON B.SYS_ID = C.SYS_ID
                            AND B.ITEM_CD = C.ITEM_CD
                            AND B.COMP_CD = C.COMP_CD
                            AND B.COMP_ITEM_CD = C.COMP_ITEM_CD
               */
                LEFT OUTER JOIN ESRSGMA D --소싱그룹품목 
                             ON M.SYS_ID = D.SYS_ID
                            AND M.ITEM_CD = D.ITEM_CD
                LEFT OUTER JOIN ESRVMSG E --소싱그룹
                             ON D.SYS_ID  = E.SYS_ID
                            AND D.OPER_ORG_SN = E.OPER_ORG_SN
                            AND D.SG_CD       = E.SG_CD
                          WHERE M.SYS_ID       =  #sys_id#
                            AND M.USE_YN       =  'Y'
                            AND M.STS          <> 'D'
                            AND M.USE_COMP_CD   LIKE  '%' || #s_comp_cd# ||',%' -- 품목 등록 회사 
                       ) CATE
                 WHERE POHD.SYS_ID  = PODT.SYS_ID
                   AND POHD.COMP_CD = PODT.COMP_CD
                   AND POHD.PO_NO   = PODT.PO_NO
                   AND POHD.SYS_ID  = INHD.SYS_ID(+)
                   AND POHD.COMP_CD = INHD.COMP_CD(+)
                   AND POHD.CNTR_NO = INHD.CNTR_NO(+)
                   AND PODT.SYS_ID  = POAC.SYS_ID(+)
                   AND PODT.COMP_CD = POAC.COMP_CD(+)
                   AND PODT.PO_NO   = POAC.PO_NO(+)
                   AND PODT.PO_LNO  = POAC.PO_LNO(+)
                   AND PODT.SYS_ID  = RQHD.SYS_ID(+)
                   AND PODT.COMP_CD = RQHD.COMP_CD(+)
                   AND PODT.RFQ_NO  = RQHD.RFQ_NO(+)
                   AND PODT.RFQ_CNT = RQHD.RFQ_CNT(+)
                   AND PODT.SYS_ID  = PRHD.SYS_ID(+)
                   AND PODT.COMP_CD = PRHD.COMP_CD(+)
                   AND PODT.PR_NO   = PRHD.PR_NO(+)
                   AND PODT.SYS_ID  = PRDT.SYS_ID(+)
                   AND PODT.COMP_CD = PRDT.COMP_CD(+)
                   AND PODT.PR_NO   = PRDT.PR_NO(+)
                   AND PODT.PR_LNO  = PRDT.PR_LNO(+)
                   AND POHD.COMP_CD = #s_comp_cd#
                   AND PRDT.SYS_ID  = CATE.SYS_ID(+)
                   AND PRDT.COMP_CD = CATE.COMP_CD(+)
                   AND PRDT.ITEM_CD = CATE.ITEM_CD(+)
                   AND POHD.PO_CRE_DATE BETWEEN #from_date# AND #to_date#
                  [ AND UPPER(POHD.PO_NO) LIKE '%'||UPPER(#po_no#)||'%' ]
                  [ AND UPPER(POHD.PURC_GRP_CD) = UPPER(#purc_grp_cd#)  ]
                  [ AND UPPER(PODT.ITEM_CD) LIKE '%'||UPPER(#item_cd#)||'%' ]
                   AND POHD.PO_PROG_STS  = 'C'   --발주완료여부
                   AND POHD.STS         <> 'D'
                   AND RQHD.STS(+)      <> 'D'
                   AND PRHD.STS(+)      <> 'D'
              ORDER BY POHD.PO_NO
        ]]>
    </sql>
    
    <sql id="select.pr.resultCntrList" comment="구매실적대장(계약단위)">
        <![CDATA[
        SELECT FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'P057', POHD.PO_CRE_TYP, '', '', '', '')        AS PO_CRE_TYP_NM    -- 계약방식
             , POHD.PO_NO                                                                                            AS PO_NO               -- 표준구매PO번호
             , POHD.SAP_PO_NO                                                                                        AS SAP_PO_NO           -- ERP발주번호
             , POHD.PURC_ORG                                                                                         AS PURC_ORG            -- 구매부서코드
             , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C028', POHD.PURC_ORG, '', '', '', '')                   AS PURC_ORG_NM      -- 구매부서명
             , POHD.PURC_GRP_CD                                                                                      AS PURC_GRP_CD         -- 구매그룹명
             , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'PURC_GRP', 'PU', POHD.PURC_GRP_CD, '', '', '', '')              AS PURC_GRP_NM      -- 구매그룹명
             , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#,'CODE', 'C009', POHD.SAP_GRP_CD, '', '', '', '')                     AS SAP_GRP_NM       -- ERP구매그룹 명
             , POHD.PURC_TYP                                                                                         AS PURC_TYP            -- 구매유형
             , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'P045', POHD.PURC_TYP, '', '', '', '')                   AS PURC_TYP_NM      -- 구매유형명
             , INHD.CNTR_TIT                                                                                         AS CNTR_TIT            -- 단가계약명
             , INHD.PRICE_CNTR_NO                                                                                    AS PRICE_CNTR_NO       -- 단가계약번호
             , POHD.PO_TIT                                                                                           AS PO_TIT              -- 기본계약명
             , POHD.CNTR_NO                                                                                          AS CNTR_NO             -- 계약번호
             , POHD.APRV_DATE                                                                                        AS CNTR_DATE           -- 계약일자
             , CASE POHD.PO_CRE_TYP WHEN 'PRC' THEN 
                                       CASE WHEN INHD.APPLY_SD IS NOT NULL THEN FC_GET_CAST_DT(POHD.SYS_ID,INHD.APPLY_SD,'Y/M/D')||'~'||FC_GET_CAST_DT(POHD.SYS_ID,INHD.APPLY_ED,'Y/M/D') ELSE '' END
                                               ELSE 
                                       CASE WHEN POHD.CNTR_PRD_SD IS NOT NULL THEN FC_GET_CAST_DT(POHD.SYS_ID,POHD.CNTR_PRD_SD,'Y/M/D')||'~'||FC_GET_CAST_DT(POHD.SYS_ID,POHD.CNTR_PRD_ED,'Y/M/D') ELSE '' END
               END                                                                                                   AS APPLY_DATE          -- 계약기간
             , PODT.RD_DATE                                                                                          AS RD_DATE             -- 납기일자
             , PODT.PRD_SD                                                                                           AS PRD_SD              -- 프로젝트 시작일
             , PODT.PRD_ED                                                                                           AS PRD_ED              -- 프로젝트 종료일
             , POHD.CUR                                                                                              AS CUR                 -- 통화
             , POHD.SUPPLY_AMT                                                                                       AS CNTR_AMT            -- 금액
             , FC_GET_EXCH_AMOUT( POHD.SYS_ID, POHD.SUPPLY_AMT, POHD.CUR, 'KRW', TO_CHAR(SYSDATE, 'YYYYMMDD') )           AS CNTR_EXCH_AMT       -- 환산금액원화
             , NVL(FC_ACML_AMT_HD(POHD.SYS_ID,POHD.COMP_CD,'GR',POHD.PO_NO,'999'),0)                                             AS TOT_GR_AMT          -- 검수금액
             , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'C024', POHD.SHIPPER_TYPE, '', '', '', '')         AS SHIPPER_TYPE_NM  -- 내/외자명
             , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'CODE', 'B104', RQHD.CPT_TYPE_CD, '', '', '', '')                AS CPT_TYPE_CD_NM      -- 경쟁방식
             , POHD.VD_CD                                                                                            AS VD_CD               -- 공급업체코드
             , FC_GET_NAME( #sys_id#, #locale#, #s_comp_cd#, 'VENDOR', POHD.VD_CD, '', '', '', '', '')                        AS VD_NM               -- 공급업체명
             , POHD.MAKER_NM                                                                                         AS MAKER_NM            -- 제조사
             , NVL(POHD.DELAY_RATE, 0)                                                                               AS DELAY_RATE          -- 지체상금율
             , NVL(PRHD.PR_TOT_AMT, 0)                                                                               AS PR_AMT              -- 구매요청금액
             , PRHD.ORGN_RPT_NO                                                                                      AS ORGN_RPT_NO         -- 사업시행품의명/번호
          FROM ESPPOHD POHD
             , ESPINHD INHD
             , ( SELECT ROW_NUMBER() over( PARTITION by DT.PO_NO ORDER BY DT.PO_NO) RN
                      , DT.SYS_ID
                      , DT.COMP_CD
                      , DT.PO_NO
                      , DT.PO_LNO
                      , DT.RFQ_NO
                      , DT.RFQ_CNT
                      , DT.PR_NO
                      , DT.RD_DATE  --납기일자
                      , DT.PRD_SD   --프로젝트 시작일
                      , DT.PRD_ED   --프로젝트 종료일
                   FROM ESPPODT DT
                  WHERE DT.SYS_ID  = #sys_id#
                    AND DT.COMP_CD = #s_comp_cd#
               ) PODT
             , ESPRQHD RQHD
             , ESPPRHD PRHD
         WHERE POHD.SYS_ID  = INHD.SYS_ID(+)
           AND POHD.COMP_CD = INHD.COMP_CD(+)
           AND POHD.CNTR_NO = INHD.CNTR_NO(+)
           AND POHD.SYS_ID  = PODT.SYS_ID
           AND POHD.COMP_CD = PODT.COMP_CD
           AND POHD.PO_NO   = PODT.PO_NO
           AND PODT.SYS_ID  = RQHD.SYS_ID(+)
           AND PODT.COMP_CD = RQHD.COMP_CD(+)
           AND PODT.RFQ_NO  = RQHD.RFQ_NO(+)
           AND PODT.RFQ_CNT = RQHD.RFQ_CNT(+)
           AND PODT.SYS_ID  = PRHD.SYS_ID(+)
           AND PODT.COMP_CD = PRHD.COMP_CD(+)
           AND PODT.PR_NO   = PRHD.PR_NO(+)
           AND POHD.COMP_CD = #s_comp_cd#
           AND POHD.PO_CRE_DATE BETWEEN #from_date# AND #to_date#
          [ AND UPPER(POHD.PO_NO) LIKE '%'||UPPER(#po_no#)||'%' ]
          [ AND UPPER(POHD.PURC_GRP_CD) = UPPER(#purc_grp_cd#)  ]
           AND PODT.RN          <= 1
           AND POHD.PO_PROG_STS  = 'C'   --발주완료여부
           AND POHD.STS         <> 'D'
           AND RQHD.STS(+)      <> 'D'
           AND PRHD.STS(+)      <> 'D'
       ORDER BY POHD.PO_NO
        ]]>
    </sql>
    
    <sql id="select.pr.info" comment="구매단계별 상세정보(PR정보)">
        <![CDATA[
		SELECT
		       DISTINCT PR.PR_NO
		      ,PR.PR_TIT
		      ,PR.PR_REQ_ID
		      ,FC_GET_NAME(#sys_id#, #locale#, #s_comp_cd#, 'USER', PR.PR_REQ_ID,  '', '', '', '', '') AS PR_REQ_NM             -- 구매요청자
		      ,PR.PURC_TYP
		      ,FC_GET_NAME(#sys_id#, #locale#, #s_comp_cd#, 'CODE', 'P045', PR.PURC_TYP, '', '', '', '') AS PURC_TYP_NM                               -- 구매유형명
		      ,PR.PR_REQ_DATE
		      ,TO_CHAR(TO_DATE(PR.REG_DT,'YYYYMMDDHH24MISS'),'YYYYMMDD') AS REG_DT
		      ,PR.APRV_DATE
		  FROM ESPPRHD PR, ESPTEMP TP
		 WHERE PR.SYS_ID = #sys_id#
		   AND PR.SYS_ID  = TP.SYS_ID
		   AND PR.COMP_CD = TP.COMP_CD
           AND PR.PR_NO   = TP.PR_NO
        ]]>
    </sql>
        
    <sql id="get.aprv.pr.attach">
    	<![CDATA[
    		SELECT ATT_NO
			  FROM ESPPRHD
			 WHERE SYS_ID  = #sys_id#
			   AND COMP_CD = #s_comp_cd#
			   AND PR_NO   = #pr_no#
    	]]>
    </sql>
    
    <sql id="insert.temp.for.pr.ceiling" comment="단가계약 Ceiling Check용">
        <![CDATA[
            INSERT INTO ESPTEMP 
                        ( SYS_ID  
                        , COMP_CD    
                        , PRICE_CNTR_NO
                        , CNTR_NO
                        , PR_AMT) --원화 환산금액
                 VALUES ( #sys_id#
                        , NVL(#comp_cd#, #s_comp_cd#)
                        , #price_cntr_no#
                        , #cntr_no#
                        , FC_GET_EXCH_AMOUT( #sys_id#, (NVL(#item_qty#, 0 ) * NVL(#pr_price#, 0 ) / NVL(#price_unit#, 1)), #cur#, 'KRW', TO_CHAR(SYSDATE, 'YYYYMMDD'))  
                        )
        ]]>
    </sql>
    
    <sql id="check.ceiling" comment="단가계약 Ceiling Check용">
        <![CDATA[
			SELECT TP.TOT_AMT
			      ,TP.PRICE_CNTR_NO
			      ,TP.CNTR_NO
			      ,CE.BALANCE_AMT_LOCAL      --잔액(원화)
			      ,CE.CEILING_AMT_LOCAL      --CEILING금액(원화)
			      ,CE.ACCUMUL_AMT_LOCAL      --누적금액
			      ,'KRW' AS CUR --통화는 원화
			      ,TP.TOT_AMT - CE.BALANCE_AMT_LOCAL AS OVER_AMT --초과 금액
			      ,TP.TOT_AMT  --요청 금액
			  FROM ESPCEIL CE
			      ,(SELECT TEMP.SYS_ID
					      ,TEMP.COMP_CD
					      ,TEMP.PRICE_CNTR_NO
					      ,MAX(TEMP.CNTR_NO) AS CNTR_NO
					      ,SUM(PR_AMT) AS TOT_AMT
					  FROM ESPTEMP TEMP
					 WHERE TEMP.SYS_ID = #sys_id#
					 GROUP BY TEMP.SYS_ID
					         ,TEMP.COMP_CD
					         ,TEMP.PRICE_CNTR_NO
				   ) TP
			 WHERE CE.SYS_ID        = #sys_id#
			   AND CE.SYS_ID        = TP.SYS_ID
			   AND CE.COMP_CD       = TP.COMP_CD
			   AND CE.PRICE_CNTR_NO = TP.PRICE_CNTR_NO
			   AND CE.STS          <> 'D'
			   AND CE.CEILING_AMT_LOCAL IS NOT NULL
			   AND CE.CEILING_AMT_LOCAL <> 0
			   AND TP.TOT_AMT > CE.BALANCE_AMT_LOCAL
        ]]>
    </sql>

	<sql id="get.pr.oper_org_sn" comment="Rfx현황에서  PR에서의  Item 운영조직 알아오는 것">
        <![CDATA[
			SELECT OPER_ORG_SN
			  FROM ESPRQDT
			 WHERE SYS_ID  = #sys_id#
			   AND COMP_CD = #comp_cd#
			   AND RFQ_NO   = #rfq_no#
			   AND RFQ_LNO  = #rfq_lno#
        ]]>
    </sql>
    
</sql-descriptor> 
