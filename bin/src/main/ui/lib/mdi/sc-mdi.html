<script src="../common/sc-session-manager.js"></script>
<script src="../common/sc-role-manager.js"></script>
<script src="sc-mdi-manager.js"></script>
<script src="sc-mdi-history.js"></script>
<link rel="import" href="sc-mdi-topmenu.html">
<link rel="import" href="sc-mdi-leftmenu.html">
<link rel="import" href="sc-mdi-tabbar.html">
<link rel="import" href="sc-mdi-content.html">
<link rel="import" href="sc-mdi-window.html">
<link rel="import" href="sc-mdi-progress.html">
<sc-link rel="import" href="sc-mdi-notice-service.html" lazy></sc-link>
<sc-link rel="import" href="sc-mdi-notice-popup.html"  lazy></sc-link>
<sc-link rel="import" href="sc-mdi-authentication.html" lazy></sc-link>
<sc-link rel="import" href="../smartsuite-notice/smartsuite-notice.html" lazy></sc-link>
<sc-link rel="import" href="../../iot/shared/ep-mdi-target-history.html"></sc-link>
<sc-link rel="import" href="../../iot/shared/ep-position-popup-map.html"></sc-link>

<!-- <sc-link rel="import" href="sc-mdi-window.html"></sc-link> -->
<!-- <sc-link rel="import" href="sc-mdi-progress.html" lazy></sc-link> -->
<!-- <link rel="import" href="sc-mdi-searchbar.html"> -->
<link rel="import" href="../smartsuite-theme/smartsuite-theme.html">
<!-- <link rel="import" href="sc-mdi-splitter.html"> -->
<!-- <link rel="import" href="sc-mdi-notice-service.html" > -->
<!-- <link rel="import" href="sc-mdi-authentication.html"> -->
<!-- <link rel="import" href="sc-mdi-progress.html"> -->

<dom-module id="sc-mdi">
	<!-- RAYCOM 추가 : 현장선택팝업 스타일 -->
	<style type="text/css">
		#site-background {
		    display: none;
		    position: fixed;
		    top: 0; left: 0;
		    width: 100%; height: 100%;
		    background: rgba(0,0,0,.3);
		    z-index: 100;
		}
		
		#my-site {
		    display: none;
		    position: fixed;
		    left: calc( 50% - 160px ); top: calc( 35% - 70px );
		    width: 320px; 
		    height: 400px; 
		    background: white;
/* 		    border-radius: 15px; */
		    z-index: 101;
		    padding: 10px;
		}
		
		.siteName{
			white-space: normal;
			word-break: normal;
			align:center;
			width : 100%;
			text-align: center;
			margin :5px auto;
			color:white;
			background-color:#b4b4b5;
			font-size:20px;
			padding-top:5px;
			padding-bottom:5px;
			cursor: pointer;
			border-radius: 6px 6px 6px 6px;
		}
		
		.siteName:hover{
			background-color: #017DC3;
		}
	</style>
	
	<template>
        <!-- 고객사 조회 -->
        <sc-ajax id="getCompanyList" url="getCompanyList.do" last-response="{{codes.company}}"></sc-ajax>
        
        <!-- 고객사 현장 목록 조회 -->
		<sc-ajax id="getSiteList" 
			url="getSiteList.do">
		</sc-ajax>
		
		<!-- RAYCOM 추가 : 첨부파일 데이터 조회(그룹코드로 조회) -->
		<sc-ajax id="selectAttachImg" 
			url="upload/list.do" 
			on-response="completeSelectAttachImg">
		</sc-ajax>
		
		<!-- RAYCOM 추가 : 첨부파일 데이터 조회(그룹코드로 조회) -->
		<sc-ajax id="chkTokenAlive" 
			url="chkTokenAlive.do" 
			on-response="completeChkTokenAlive">
		</sc-ajax>
		
		<sc-ajax id="findAlarmListCnt" 
		         url="findAlarmList.do"
		         body = "{{searchParam}}"
		         on-response = "onFindAlarmListCnt"
		></sc-ajax>
		
		<!-- @ headWrap S-->
		<div id="headWrap" hidden$="[[useSinglePage]]">
			<div id="mdiLogo" class$="mdiLogo [[_mdiLogoCls(currentUser)]]"></div>
			<!-- # GnbArea S-->
			<div class="gnbBar">
				<sc-mdi-topmenu id="mdiTopMenu" on-menu-click="_onTopMenuClick" on-chk-token-alive="_chkTokenAlive"></sc-mdi-topmenu>
			</div>
			<!--GnbArea E-->
			<!-- # UtilArea S -->
			<div class="toolbar">
				<!-- RAYCOM 추가 : 운영사 로고 추가 & 운영사 선택 팝업 -->
				<div>
					<img id="companyLogo" height="36" width="100" on-error="doNoImage"></img>
				</div>
				
				<div class="label">
					<div class="label">[[mdiSearchParam.company_name]]</div>
					<div class="label">[[mdiSearchParam.site_name]]</div>
				</div>
				
				<sc-button class="setupBtn" on-click="popupCompanySite"></sc-button>
				
				<div class="label">[[_currentUserNm(currentUser, currentLocale)]]</div>
				
				<!--<sc-mdi-searchbar id="searchBar"></sc-mdi-searchbar> -->
				<!-- RAYCOM 수정 : 세션시간 주석 -->
<!-- 				<div id="sessionTimer" class="timer" on-tap="_onSessionTimer" title="Session Time Reset"></div> -->
				<!--<div class="timerBtn" on-tap="_onSessionTimer">[[translate('로그인연장')]]</div> -->
				
				<!-- RAYCOM 수정 : 다국어 선택 주석 -->
<!-- 				<div class="mdi_lan"> -->
<!-- 					<a>[[_selectLocaleName(avaiableLocales, currentLocale)]]</a> -->
<!-- 					<div class="lan_list"> -->
<!-- 						<ul> -->
<!-- 							<template id="localeList" is="dom-repeat" items="{{avaiableLocales}}" as="locale" filter="_onLocaleFilter"> -->
<!-- 								<li><a on-click="_onChangeLocale">[[translate(locale.displayName)]]</a></li> -->
<!-- 							</template> -->
<!-- 						</ul> -->
<!-- 					</div> -->
<!-- 				</div> -->

				<ul class="top_func">
<!-- 					<li class="memo"><sc-button id="memoBtn" class="memo-btn" on-click="popupMemo"></sc-button></li> -->
					<li class="info"><sc-button id="infoBtn" class="info-btn" on-click="popupChangeUserInfo" tabindex="0"></sc-button></li>
					<li class="notice"><span id="noticeNum" style="visibility:hidden;" class="num"></span><smartsuite-notice title="Alert"></smartsuite-notice></li>
					<li class="logout"><sc-button title="Logout" on-click="_onLogout" tabindex="0"></sc-button></li>
				</ul>
			</div>
			<!--UtilArea E-->
		</div>
		<!-- // headWrap E-->
		<!-- @ ContainerWrap S-->
		<div id="containerWrap" class="containerWrap">
			<div>
			</div>
			<sc-mdi-leftmenu id="mdiLeftMenu" on-menu-click="_onLeftMenuClick" on-splitter-click="_onSplitterClick" hidden="[[useSinglePage]]"></sc-mdi-leftmenu>
			<!--<sc-mdi-splitter id="mdiSplitter"></sc-mdi-splitter>-->
			<sc-mdi-content id="mdiContent" on-window-activated="_onWindowActivated" tabbar-hidden="[[useSinglePage]]"></sc-mdi-content>
		</div>
		<!--ContainerWrap E-->
		
		<!-- 사이트 선택 팝업 -->
		<div id="my-site" style="overflow:auto;">
			<div class="vbox flex">
				<div>
			   	 	<h3 style="float:left; font-weight: bold; font-family: 'Noto Sans KR'; margin-top: 2px; font-size: 20px; color:#007dc3">현장 목록</h3>
			  		<button style="float:right; background: transparent;" type="button" id="btn-close-site" on-click="closeSitePop"><img src="/img/portal/button/b_close_01.png"></button>
				</div>
				
				<div class="vspace-10"></div>
				
				<table>
					<tr>
						<td>
							<sc-label text="운영사"></sc-label>
						</td>
						<td>
							<sc-combobox-field id="comboCompany" value="{{searchParam.company_id}}" items="{{codes.company}}" display-field="name" value-field="id" 
								on-select="onSiteSearch"></sc-combobox-field>
						</td>
					</tr>
				</table>
				
				<!-- <sc-label text="※ 현장 변경시 MDI 메뉴는 초기화 됩니다." style="font-size: 14px; font-weight: bold; text-align:left; color:red; margin-top: 10px; margin-bottom: 10px;"></sc-label> -->
				
				<div id="siteContainer" class="flex vbox">
				</div>	
				
			</div>
		</div>
		
		<div id="site-background"></div>
	</template>
	<script>

	SCPreloader.onReady(function() {
		
		Polymer({

            is: 'sc-mdi',

            behaviors: [
                Polymer.SCResizableBehavior
            ],

            properties: {
            	currentUser: {
            		type : Object,
                    value : function() {
                    	if(SCSessionManager.isReady()) {
                        	var currentUser = SCSessionManager.getCurrentUser();
                     		return SCSessionManager.getCurrentUser();
                     	}
                     	return SCSessionManager.onReady(function() {
             				this.currentUser = SCSessionManager.getCurrentUser();
             			}.bind(this));
					}
				},
				
				currentLocale : {
					type : String,
					value : SCI18nManager.getLocale()
				},
            	

				avaiableLocales: {
                    type: Array,
                    value : function() {
                    	if(SCMdiManager.isReady()) {
	                    	return SCMdiManager.getAvaiableLocales();
						}
                    	return SCMdiManager.onReady(function() {
                    		this.avaiableLocales = SCMdiManager.getAvaiableLocales();
                    	}.bind(this));
                    }
                },

                menuPaths : {
                    type : Object,
                    value : {}
                },

                // 타임 아웃 설정
                _sessionTimeout :{
                    type: Number,
                    value : (("number" === typeof window.SESSIONTIMEOUT && window.SESSIONTIMEOUT > 0) ? window.SESSIONTIMEOUT  : (1000 * 60 * 30)) //30분
                },

                // 포탈 정보
                startPage : {
                    type: Object,
                    value : SCMdiManager.getStartPage()
                },

                // 메뉴 개인화 기능 사용 여부 ( true : 사용 )
                useStorageMenu : {
                    type: Object,
                    value : function(){
                    	return true;
                    }
                },
                
                // 하나의 page만 표시할 경우 사용하는 property
                useSinglePage : {
                	type : Object,
                	value : function(){
                		return false;
                	}
                },
                
                SCMdiNoticeService:{
                	type : Object
                },

                /**
                 *  어플리케이션의 최소 너비를 지정, 관리합니다.
                 *
                 * @type {Object}
                 */
	            _minWidth: {
            	    type : Object,
		            value : function() {
            	        return {
            	            use: true, // 사용여부
            	            width: 1600 // 최소너비
	                    }

		            }
	            },
	            
	            isFullSize: {
	            	type: Object,
	            	value: function(){
	            		return false;
	            	}
	            },
	            
	            mdiSearchParam: {
	            	type: Object,
	            	value: function(){
	            		return {};
	            	}
	            },
	            
	            bNoToken: {
	            	type: Object,
	            	value: function(){
	            		return false;
	            	}
	            },
	            
	            codes: {
	            	type: Object,
	            	value: function(){
	            		return {};
	            	}
	            },
	            
	            searchParam: {
	            	type: Object,
	            	value: function(){
	            		return {};
	            	}
	            }
            },
            
            _selectLocaleName : function(locales, locale) {
            	var me = this, selectLocale = {};
        		for(var i = 0,len = locales.length ; i<len ; i++){
        			if(locales[i]["locale"] === locale){
        				selectLocale = locales[i];
        				break;
        			}
        		}
        		return this.translate(selectLocale.displayName);
            },

            listeners: {
                'sc-resize': '_onMdiIronResize',
                'utilarea-resize': '_onUtilAreaResize'
            },

            get mdiHeaderWrapHeight() {
                if(!this._mdiHeaderWrapRect) {
                    this._mdiHeaderWrapRect = this.$.headWrap.getBoundingClientRect();
                }
                return this._mdiHeaderWrapRect.height;
            },
            
            get mdiHeaderWrapBoundingHeight() {
                this._mdiHeaderWrapRect = this.$.headWrap.getBoundingClientRect();
                return this._mdiHeaderWrapRect.height;
            },
            
            get windowHeight() {
                return document.documentElement.clientHeight;
            },

            get windowWidth() {
                var clientWidth = document.documentElement.clientWidth,
	                minWidth = this._minWidth.width;

                return this._minWidth.use && (clientWidth < minWidth) ? minWidth : clientWidth;
            },

            get leftmenuWidth() {
            	// RAYCOM 추가 : 대시보드 최대 화면시, 왼쪽 메뉴 숨김되며 width 0으로 리턴 
            	
            	if(this.$.mdiLeftMenu.style.display == "none"){
            		return 0;
            	}else{
            		return this.$.mdiLeftMenu.clientWidth;	
            	}
                
            },

//            get splitterWidth(){
//                Polymer.dom.flush();
//                return this.$.mdiSplitter.clientWidth;
//            },

            // window 사이즈 갱신
            _onMdiIronResize: function() {
                var containerHeight = (this.windowHeight - this.mdiHeaderWrapHeight);
                this.$.containerWrap.style.width = this.windowWidth + 'px';
                this.$.containerWrap.style.height = containerHeight + 'px';
                this.$.mdiLeftMenu._onMdiLeftMenuIronResize(containerHeight, this.leftmenuWidth);
                this.$.mdiContent._onMdiContentIronResize(containerHeight, this.windowWidth, this.leftmenuWidth);
            },
            
            _onUtilAreaResize: function(){
            	var utilArea = this.$.headWrap.querySelector('.toolbar');
            	this.$.headWrap.querySelector('.toolbar').hidden = !utilArea.hidden;            	
            	this.mdiHeaderWrapBoundingHeight;
            	this._onMdiIronResize();
            },

            // left 메뉴 숨김/펼침
            _onSplitterClick : function() {
                //this.$.mdiSplitter.style.display = this.$.mdiLeftMenu.menuClose ? 'none' : '';
                this._onMdiIronResize();
            },

            /**
             * RAYCOM 추가
             * rino token 체크
             */
            _chkTokenAlive: function(){
            	var ssoYn = SCSessionManager.getCurrentUser().ssoYn || "N";
            	var rinoToken = SCSessionManager.getCurrentUser().rinoToken || "";
				
				if(ssoYn == "Y" && rinoToken){
					UT.request(this.$.chkTokenAlive);
					
				}else if(ssoYn == "Y" && !rinoToken){
					this.set("bNoToken", true);
				}
            },
            
            completeChkTokenAlive: function(e, res){
				var result = res.response || {};
				
				if(!result || result.result == "FAIL"){
					var message = result.message || "오류가 발생하였습니다.";
					
					UT.alert(message, function(){
						document.getElementById('logoutForm').submit();
					});
					 
				}				
			},
			
            // top 메뉴 클릭 시
            _onTopMenuClick: function(event){
            	/**
            	 * RAYCOM 추가
            	 * 메뉴 클릭시, RINO token 을 갖고 있다면, 메뉴 이동시  토큰 alive check
            	 */
				this._chkTokenAlive();
            	
                if(typeof event.detail === 'undefined'){
                    return;
                }
                // 최상위 메뉴 일 경우
                if((event.detail.menu_url === undefined || event.detail.menu_url === null)  && event.detail.level === 0){
                    var rootMenuNode = this.$.mdiTopMenu.getRootMenuNode(event.detail.menu_id);
                    if(this.$.mdiLeftMenu.rootMenuId != rootMenuNode.menu_id) {
                        this.$.mdiLeftMenu.rootMenuId = rootMenuNode.menu_id;
                        this.$.mdiLeftMenu.treeMenuList = rootMenuNode.sub_menu_list ? rootMenuNode.sub_menu_list : [];
                        this.$.mdiLeftMenu.menuName = event.detail.menu_nm;
                    }
                } else if(event.detail.menu_url === undefined || event.detail.menu_url === null){

                } else {
                    this.$.mdiContent.createWindow(event.detail.menu_id, event.detail.menu_nm, event.detail.menu_url);
                }
            },

            // left 메뉴 클릭 시
            _onLeftMenuClick: function(event) {
            	/**
            	 * RAYCOM 추가
            	 * 메뉴 클릭시, RINO token 을 갖고 있다면, 메뉴 이동시  토큰 alive check
            	 */
				this._chkTokenAlive();
            	
                if(event.detail.menu_url === undefined || event.detail.menu_url === null){
                    console.error('menu url is undefined');
                    return;
                }
                this.$.mdiContent.createWindow(event.detail.menu_id, event.detail.menu_nm, event.detail.menu_url);
            },

            // 내/외부 에 따른 로고 클래스 적용
            _mdiLogoCls : function(user) {
            	// 도메인에 따라 logo 변경
    	    	
				// 나머지 smartiot 로고
                return 'smartiot';
                //return user.usr_cls === 'B' ? 'buyer' : 'supplier';
            },
            
         	// 현재 laguage 에 해당 하는 유저명
            _currentUserNm : function(user, locale) {
                var key = 'usr_nm';
                if(locale !== 'ko_KR'){
                    key = 'usr_en_nm';
				}
                return user[key];
			},
			
            // 모듈 활성화
            _onWindowActivated: function(event) {
                var mdiWindow = event.detail;
                var active_menu_id = mdiWindow.windowId;

                if(mdiWindow.module && UT.isFunction(mdiWindow.module.refresh)) {
                    mdiWindow.module.refresh();
				}
                
                this.$.mdiContent.setMenuPath(this.getMenuPath(active_menu_id));
                
                var rootMenuNode = this.$.mdiTopMenu.getRootMenuNode(active_menu_id);
                if(!rootMenuNode){
                    return;
                }
                var subMenuList = rootMenuNode.sub_menu_list;
                this.$.mdiLeftMenu.menuName = rootMenuNode.menu_nm;
                
                //최상위의 sub menu 가 없는 메뉴
                if(rootMenuNode && !subMenuList){
                    this.$.mdiLeftMenu.treeMenuList =[];
                    return;
                }
                if(subMenuList && this.$.mdiLeftMenu.rootMenuId != rootMenuNode.menu_id) {
                    this.$.mdiLeftMenu.rootMenuId = rootMenuNode.menu_id;
                    this.$.mdiLeftMenu.treeMenuList = subMenuList;
                }
                this.$.mdiLeftMenu.selectedItem = this.$.mdiLeftMenu.getMenuNode(active_menu_id);
                this.$.mdiTopMenu.currentEl = this.$.mdiTopMenu.querySelector("#"+ rootMenuNode.menu_id);
            },

            // 메뉴 데이터
            setTopMenuList: function(){
                var hier = new SCHierachicalData();
                var data = SCMdiManager.getMenuList();
                
                hier.usingSort = true;
                var menuNodeMap = {};

                hier.onNodeAppend = function(parentNode, node, parentNodeLevel){
                    node.level = parentNodeLevel;
                    if(node['menu_id'] != null){
                        menuNodeMap[node['menu_id']] = node;
                    }

                    if(parentNodeLevel === 0){

                        node['tree'] = (node['menu_id'] != null ? node['menu_id'] : '');
                        node['root_menu_id'] = node['menu_id'];
                        node['tree_nm'] = (node['menu_nm'] != null ? node['menu_nm'] : '');
                    }else{
                        node['tree'] = parentNode['tree'] + '||' +(node['menu_id'] != null ? node['menu_id'] : '');
                        node['root_menu_id'] = parentNode['root_menu_id'];
                        node['tree_nm'] = parentNode['tree_nm'] + '||' +(node['menu_nm'] != null ? node['menu_nm'] : '');
                    }
                };
                var treeMenuList = hier.HierachyTransformByKey(data, "menu_id", "parent_menu_id", "sub_menu_list", "ROOT", "sort_ord");

                this.$.mdiTopMenu.menuNodeMap = menuNodeMap;
                this.$.mdiTopMenu.treeMenuList = treeMenuList;
                this._onTopMenuClick({detail:treeMenuList[0]});

            },

            getMenuPath : function(windowId) {
                if(windowId == this.startPage.menu_id) {
                    this.menuPaths[windowId] = "<b>Home</b>";
                }
                try {
                    if(typeof this.menuPaths[windowId] === "undefined") {
                        var node = this.$.mdiTopMenu.getMenuNode(windowId);
                        var paths = node.tree_nm.split("||");
                        var htmlStr = "Home";
                        for(var i = 0; i < paths.length; i++) {
                            if(paths[i] == "") {
                                continue;
                            }
                            htmlStr = (i == paths.length -1 ? "<b>" : "") + paths[i] + (i == paths.length -1 ? "</b>" : "") + " &nbsp;&lt;&nbsp; " + htmlStr;
                        }
                        this.menuPaths[windowId] = htmlStr;
                    }
                }
                catch(error) {
                }
                
                return this.menuPaths[windowId];
            },
            _onLocaleFilter: function(item){
            	var me = this;
            	return (item.locale != SCMdiManager.getLocale());
            },
            //locale 변경
            _onChangeLocale: function(e){
            	var me = this,
            	locale = e.model.locale.locale;
            	
            	if(locale != SCMdiManager.getLocale()) {
                    UT.confirm("STD.MDI1004", function() { // "언어를 변경하시겠습니까? 페이지가 새로고침 됩니다."
                        var ajax = new SCAjax();
                        ajax.url = 'i18n/saveI18nLocale.do';
                        ajax.params = {locale : locale};
                        ajax.addEventListener('response', function(event) {
                            ajax.removeEventListener('response', arguments.callee);
                            me.reload();
                        });
                        ajax.request();
                    });
                }
            },
            
            popupCompanySite: function(){
            	var me = this;
            	
            	UT.request(me.$.getCompanyList, function(){
            		me.$.comboCompany.value = SCMdiManager.searchParam.company_id;
            		me.onSiteSearch();
            		$("#my-site,#site-background").toggle();
            	});
            	
//                 me.importLink("ui/lib/mdi/sc-mdi-company-site.html", function () {
//                     var mdiUserPopup = UT.popup("sc-mdi-company-site", me, 500, 500, {
//                     	"selected": function(popup, e) {
//                     		var item = e.detail;
                    		
//                     		var param = {
//                     			company_id : item.companyId
//                     			,company_name : item.companyName
//                     			,site_id : item.id
//                     			,site_name : item.name
//                     			,att_grp_code : item.attGrpCode
//                     		};
                    		
//                     		SCMdiManager.searchParam = param;
//                     		me.set("mdiSearchParam", param);
                    		
//                     		// 첨부파일
//                     		me.doSelectAttachImg(param.att_grp_code);
                    		
//                     		// 탭바 - 전체 MDI 탭 제거
//                     		var tabbar = document.getElementById('mdiTabbar');
//                     		tabbar._onToolCloseAllClickHandler();
                    		
//                     		// 홈 화면 - 로직 추가
//                     		var portal = document.querySelector('em-portal');
                    		
//                     		popup.close();
                    		
                    		
//                     	}
//                     }, {titleText: "현장변경"});
//                     mdiUserPopup.show();
//                     mdiUserPopup.getWindowContent().load(SCMdiManager.searchParam);
//                 });

            },
            
            onSiteSearch: function(){
            	var me = this;
            	
            	me.$.getSiteList.body = {
               		companyId : me.get("searchParam.company_id")
               	};
                    	
                    UT.requestNoDefault(me.$.getSiteList, function(e, res){
                    	var result = res.response || {};
                    	var data = result.body || [];
                       	
                       	$('#siteContainer').empty(); // site list clear(초기화)
                       	
                       	for(var i=0; i < data.length; i ++){
                       		var item = data[i];
           	  				
           	  				var obj = document.createElement('div');
           	  				
           	  				obj.innerHTML = item.name;
           	  				obj.setAttribute("data-id", item.id);
           	  				obj.setAttribute("data-name", item.name);
           	  				obj.setAttribute("data-companyid", item.companyId);
           	  				obj.setAttribute("data-companyname", item.companyName);
           	  				
    	       	  			var companyList = me.get("codes.company") || [];
    	            		for(var idx in companyList){
    	            			var company = companyList[idx];
    	            			
    	            			if( company.id == item.companyId ){
    	            				obj.setAttribute("data-attgrpcode", company.attGrpCode);
    	            				break;
    	            			}
    	            		}
           	  				
           	  				obj.setAttribute("class","siteName");
           	  				
           	  				obj.onclick= function(e){
           	  					var curTarget = e.currentTarget;
           	  		
                        		sessionStorage.company_id = Number(curTarget.getAttribute("data-companyid"));
                        		sessionStorage.company_name = curTarget.getAttribute("data-companyname");
                        		sessionStorage.site_id = Number(curTarget.getAttribute("data-id"));
                        		sessionStorage.site_name = curTarget.getAttribute("data-name");
                        		sessionStorage.att_grp_code = curTarget.getAttribute("data-attgrpcode");

                     			me.reload();
           	  				};
           	  				document.getElementById('siteContainer').appendChild(obj);
           	  				Polymer.dom(document.getElementById('siteContainer')).appendChild(obj);
           	  			}
                       	
                   		$('#my-site').scrollTop(0);
                    });
            },
            
            closeSitePop : function(){
            	$("#my-site,#site-background").toggle();
            },

            // 사용자정보 팝업
            popupChangeUserInfo: function() {
                var me = this;
                me.importLink("ui/lib/mdi/sc-mdi-user-popup.html", function () {
                    var mdiUserPopup = UT.popup("sc-mdi-user-popup", me, 645, 500, {

                    }, {titleText: "사용자정보변경"});
                    mdiUserPopup.show();
                    mdiUserPopup.getWindowContent().load();
                });
            },
            popupMemo: function(){
            	var me = this;
                me.importLink("ui/bp/common/memo/smartsuite-memo-list.html", function () {
                    var mdiMemoPopup = UT.popup("smartsuite-memo-list", me, 930, 620, {
                    	'close' : function(){
                    		mdiMemoPopup.classList.remove('smartsuite-memo-popup-super');
                    	}
                    
                    }, {titleText: "메모",collapsible: true, modal: false});
            		
                    mdiMemoPopup.classList.add('smartsuite-memo-popup-super');
                    mdiMemoPopup.addEventListener('interact-resize-end', me._updateColumnCount);
					
                    mdiMemoPopup.show();
                    mdiMemoPopup.getWindowContent().load();
                });
            },
            _updateColumnCount : function() {
                var me = this,
                    width,
                    memoColumns,
                    checkedSize = ['680', '930', '1150', '1350'];

                width = me.getBoundingClientRect().width;
                memoColumns = me.querySelector('#memoColumns');

                if(width <= checkedSize[0]){
                    memoColumns.style.columnCount = 2;
                }
                else if(width > checkedSize[0] && width <= checkedSize[1]) {
                    memoColumns.style.columnCount = 3;
                }
                else if(width > checkedSize[1] && width <= checkedSize[2]) {
                    memoColumns.style.columnCount = 4;
                }
                else if(width > checkedSize[2] && width < checkedSize[3]) {
                    memoColumns.style.columnCount = 5;
                }
                else {
                    memoColumns.style.columnCount = 6;
                }
            },

            /******************************
             * 로그아웃
             ******************************/
            _onLogout : function() {
                UT.confirm("STD.MDI1001", function() { // "로그아웃 하시겠습니까?"
                	sessionStorage.removeItem("site_id");
                    this.logout();
                }.bind(this), function () {
                    this.$$('.logout > sc-button').focus();
                }.bind(this));
            },

            logout : function() {
            	if(this._invalidSession) {
            		location.href = "/";
            	}
            	else {
	                document.getElementById('logoutForm').submit();
            	}
            },
            
            /******************************
             * 타임 아웃
             ******************************/
            _onSessionTimer: function() {
            	var me = this;
            	
                $.ajax('sessionTimeUpdate.do', $.extend(false, SCPreloader.ajaxSettings(), {
                	data : JSON.stringify({})
                })).then(this._doSessionTimer.bind(this));
                
//                 if(!me.param){
//             		me.param = {
//             			page_id : "temp2" 
//             		};
//             	}
            	
//             	var module = UT.createWindowByMenuId("HOME", function(module) {
//             		if(me.param.page_id == "temp2"){
//             			me.param.page_id = "temp1";
//             		}else{
//             			me.param.page_id = "temp2";
//             		}
            		
//             		module.load(me.param);
//                 }, false);

            	
//              	if(me.isFullSize){
//             		me.closeFullscreen();
//             		me.set("isFullSize", false);
//             	}else{
//             		me.openFullscreen();
//             		me.set("isFullSize", true);
//             	}
            },

            _doSessionTimer : function() {
            	return;
            	
                var me = this;
                if(this._sessionTimeoutInterval) {
                    clearInterval(this._sessionTimeoutInterval);
                }
                this._timeout = this._sessionTimeout;
                this._updateSessionTimer();
                this._sessionTimeoutInterval = setInterval(function() {
                	this._timeout -= 1000;
                	if(this._timeout <= 0) {
                		clearInterval(this._sessionTimeoutInterval);
                        UT.alert([this.translate("STD.MDI1002",null, (this._sessionTimeout / 1000 / 60) ) ], function() { // "{0} 분동안 사용하지 않아 로그아웃 됩니다."
                        	this._invalidSession = true;
                            this.logout();
                        }.bind(this), true);
                	}
                    this._updateSessionTimer();
                }.bind(this), 1000);
            },
            
            _updateSessionTimer : function() {
            	this.$.sessionTimer.textContent = moment.utc(this._timeout).format('HH:mm:ss');
            	// hys
            	// ese 발급 토큰의 만료시간을 연장한다.   혹은 ese 발급 토큰의 만료시간이 지났는지 확인하고, 지났으면 로그아웃 처리한다.
            	
            },

            /******************************
             * 포탈 및 메뉴 개인화
             ******************************/
            _onReady : function(){
            	if(this.useSinglePage){
            		this.$.mdiContent.activateWindow(this.$.mdiContent.createdWindows[0]);
            	}
            	else{
            		// 1. 비밀번호 변경주기 체크
                    if(!this.userPopupCheck()) {
                        return;
                    }
            		
            		this._openStartPage();
            	}
            	// RAYCOM 추가 : 사용자의 운영사 정보 및 현장 정보 보여줌.
            	var user = this.currentUser;
            	var param = {};
            	param.company_id   = user.company_id;
            	param.site_id      = user.site_id;
            	param.company_name = user.company_name;
            	param.site_name    = user.site_name;
            	
            	SCMdiManager.searchParam = param;
            	this.set("mdiSearchParam", param);
            	
            	// company Logo 이미지 조회
                this.doSelectAttachImg(user.att_grp_code);
            	
//                 this.connectSocketServer();
            },
            
         	/**
         	 * company 첨부파일 이미지 조회
         	 */ 
            doSelectAttachImg: function(attGrpCode){
            	this.$.selectAttachImg.body = {
            		'groupId': attGrpCode
                };
            	
                UT.request(this.$.selectAttachImg);
            },
            
            completeSelectAttachImg: function(e, res){
            	var me = this;
            	
            	var resultList = res.response || [];
            	
            	if(resultList.length > 0){
					var item = resultList[0];
            		
            		me.$.companyLogo.src = "upload/download.do?id=" + encodeURIComponent(item.id);
            	}else{
            		me.$.companyLogo.src = "#";
            	}
            	            	
            },
            
            // RAYCOM 추가
            connectSocketServer: function(){
            	var me = this;
            	
                if(me.ws){
                	me.ws.close();
                }
            	
            	var userInfo = SCSessionManager.currentUser;
            	if(userInfo.ws_use == "Y"){
                    var support = "MozWebSocket" in window ? 'MozWebSocket' : ("WebSocket" in window ? 'WebSocket' : null);

                    if (support == null) {
                        alert(noSupportMessage);
                        return;
                    }

                    console.log("* [Notify] ws Connecting to server... : " + SCMdiManager.searchParam.site_id);
                    
//                 	ws = new window[support](conf.ws);
                    me.ws = new WebSocket(conf.ws + SCMdiManager.searchParam.site_id);
                	// when data is comming from the server, this metod is called
                    me.ws.onmessage = function (evt) {
//                     	console.log("# [Notify] onmessage : " + evt.data); //con.raycloud.co.kr
                    	
                		if(evt && evt.data){
                			try{
//                 				UT.alert(JSON.parse(evt.data).body.content.message);
                				
                				// 현재시간
                				var nowDt = new Date();
                				var hour = nowDt.getHours();
                				
                				// 수신시간
                				var startHr = Number(userInfo.ws_from_hr || 0);
                				var endHr = Number(userInfo.ws_to_hr || 23);
                				
                				// 사용자 정보에 설정된 수신시간에만 수행 
                				if(hour >= startHr && hour <= endHr){
                					// 알람 수신 아이콘(빨간동그라미) 표시
                					
                                   	
                                   	// 알람 타입 추가
                                   	var data = JSON.parse(evt.data);
                                   	var eventType = data.eventType;
                                   	var content = data.body;
                                   	var alarmType = content.type; 		// alarm key
                                   	var msg = content.body;
                					
                                   	if(eventType != "Alarm"){
                                   		return;
                                   	}else{
                    					UT.requestNotUseLoading(me.$.findAlarmListCnt);
                                   	}

                                   	// 긴급호출 : 메시지(error) 표시 및 경고음
                                   	if(alarmType == "emergency" || alarmType == "heartbeat"|| alarmType == "ffall"){
                                   		$.notify.addStyle('emergency', {
                                   		  html: 
                                   			"<div>"+
	                             		    	"<div class='notifyjs-bootstrap-base notifyjs-bootstrap-error'>" +
		                                		    "<div data-notify-text class='title' data-notify-html='title' style='white-space:break-spaces; display:contents'/>" +
		                                		    " &nbsp;<a href='#' onclick='showTargetPopup("+JSON.stringify(content.targetInfo)+")'>[위치보기]</a>" +
		                                		    "</div>" +
	                             		    	"</div>"+
                             		    	"</div>"
                                   		});

                                   		console.log(content.targetInfo);
                                   		$.notify(
                                           		{
                                               		title:msg
                                               	}
                        						,{ 
                            						style : 'emergency',
                        							className: 'error', 
                        							clickToHide: true,
                        							autoHide: true,
                        							autoHideDelay: 1800000, // 30분(millisecond)
                        							showAnimation: 'slideDown',
                        							showDuration: 400
                        						}
                                   		);
                						
                                       	// 경고음
                                       	var audio = new Audio('/resources/mp4/fire_truck_air_horn_daniel_simion.mp3');
                                       	audio.play();
                                       	
                                    // 그외 메시지(warn)만 표시, 경고음 없음
                                   	}else{
                                   		$.notify.addStyle('gatewayNoSignal', {
                                     		  html: 
                                     		    "<div>"+
                                     		    	"<div class='notifyjs-bootstrap-base notifyjs-bootstrap-warn'>" +
  		                                		    "<div data-notify-text class='title' data-notify-html='title' style='white-space:break-spaces; display:contents'/>" +
  		                                		 	"&nbsp; <a href='#' onclick='showGatewayPopup("+JSON.stringify(content.targetInfo)+")'>[위치보기]</a>" +
  		                                		    "</div>" +
                                     		    	"</div>"+
                                     		    "</div>"
                                     		});
                                   		$.notify.addStyle('other', {
                                   		  html: 
                                   		    "<div>"+
                                   		    	"<div class='notifyjs-bootstrap-base notifyjs-bootstrap-info'>" +
		                                		    "<div data-notify-text class='title' data-notify-html='title' style='white-space:break-spaces'/>" +
		                                		    "</div>"+
                                   		    	"</div>"+
                                   		    "</div>"
                                   		}); 
                                   		$.notify(msg
                        						,{ 
                    								style : (alarmType == "gatewayNoSignal")?"gatewayNoSignal":"other",
                        							className: 'warn', 
                        							clickToHide: true,
                        							autoHide: true,
                        							autoHideDelay: 10000, // 10초
                        							showAnimation: 'slideDown',
                        							showDuration: 400
                        						}
                                   		);
                                   	}
                					
                				}
                				
                			}catch(e){
                				
                			}
                		}
//                         messageBoard.append("# " + evt.data + "<br />");
//                         console.log(evt);
                    };
                    
                    // when the connection is established, this method is called
                    me.ws.onopen = function () {
                    	console.log('* [Notify] ws Connection open...');
                        
                        var param = {
                        	"eventType":"UserCommand"
                        	,"body":{
                        		"command":"login", 
                        		"parameter": SCSessionManager.currentUser.usr_id
                        	}
                        }
                        
                        me.ws.send(JSON.stringify(param) );
//                         console.log('open');
//                         {"eventType":"UserCommand", "body":{"command":"login", "parameter":"ADMIN"} }
                    };

                    me.ws.onerror = function (error) {
	            		console.log('*[Notify] ws Connection err '+error +'<br/>');  
	               	};

                    // when the connection is closed, this method is called
                    me.ws.onclose = function () {
                    	console.log('*[Notify] ws Connection closed...');
                    }
            	}
            	//me.set("ws", ws);
            	me.startInterval();
            },
            
            
            onFindAlarmListCnt : function(e,res){
            	var resultList  = res.response.body || [];
            	
            	var notiIconEl = $('#notiIcon')[0];
            	$('#notiIcon').html(resultList.length);
				if( $('#notiIcon')[0].innerHTML == ""){
					notiIconEl.style.visibility = 'hidden';
				}else{
                   	notiIconEl.style.visibility = 'visible';
				}
            },
            /**
			 * 알람을 위한 주기적 요청을 시작한다.
			 */
			startInterval: function() {
				var me = this;
				var date = new Date();
				me.timerId = setTimeout(function() {
					me.requestAlertSchedule();
					me.intervalId = setInterval(function() {
						// 네트워크 끊겼을 때, WebSocket 연결 해제
						if (!navigator.onLine) {
							//console.log("You are Offline");
							me.ws.close();
						}
						
						// Ready State Constants
						// 0: 연결이 수립되지 않은 상태
						// 1: 연결이 수립되어 데이터가 오고갈 수 있는 상태
						// 2: 연결이 닫히는 중
						// 3: 연결이 종료되었거나, 연결에 실패한 경우
						if(navigator.onLine && me.ws && me.ws.readyState >= 2 ) {
							me.stopInterval();
							me.connectSocketServer();
						}
						me.requestAlertSchedule();
					}, 60 * 1000);
				}, 0);
			},
			
			/**
			 * 알람 스케줄 요청
			 */
			requestAlertSchedule: function() {
				var me = this;
				// jhkim 임시 처리
 				//UT.requestNotUseLoading(me.$.findAlarmList);
			},
			
			/**
			 * 알람을 위한 주기적 요청을 정지한다.
			 */
			stopInterval: function() {
				var me = this;
				clearInterval(me.intervalId);
			},
			
			/**
			 * 타이머를 멈춘다
			 */
			stopTimer: function() {
				var me = this;
				clearTimeout(me.timerId);
			},
			
            doNoImage: function(e){
            	var me = this;
            	
//             	e.target.removeAttribute("src");
//             	e.target.src = "/img/noImage96.png";
            },
            
            _openStartPage : function() {
            	var me = this;
            	
            	/**
            	 * RAYCOM 추가
            	 * SSO 로그인시, 토큰 정보 없으면 ALERT
            	 */ 
            	if(me.get("bNoToken")){
            		var message = "토큰 정보가 없습니다.";
    				
    				UT.alert(message, function(){
    					document.getElementById('logoutForm').submit();
    				});
    				
    				return;
            	}
            	
                // 1. 최근 로그인 정보 alert
                var message = "<span style='padding-left:5px; font-weight:bolder'>"+ this.translate("최근접속한시간")+" :</span> " + UT.formatDate(this.currentUser.last_login_dt, "yyyy/MM/dd HH:mm:ss") +"<br><br>"
                    + "<span style='padding-left:5px; font-weight:bolder'>"+ this.translate("최근접속한IP")+" :</span> " + (this.currentUser.last_login_ip || '-');
                
              	UT.alert(message, (function() {
              		me.connectSocketServer();
              		
                  	// 2. 포탈 및 개인화 메뉴 로드
                  	me._onStorageMenus();
					me.importLinkByTagName('sc-mdi-notice-service', function(moduleId) {
							me.SCMdiNoticeService = document.createElement(moduleId);
							me.SCMdiNoticeService.addEventListener('notice-list-changed', function(event) {
								me.SCMdiNoticeService.removeEventListener('notice-list-changed', arguments.callee);
								var noticeList = event.detail.value;
								if(noticeList.length > 0){
									// 3. 공지사항 팝업 호출
									me.createNoticeListPopup(noticeList);
								}
							}.bind(me));
					});
                }).bind(me), true);
            },
            
            createNoticeListPopup: function(noticeList){
            	var me = this;
				//팝업 호출
				var noticeListPopup = UT.popup("sc-mdi-notice-popup", me, 800, "90%", {
					'attached' : function(popup, e){
						popup.getWindowContent().setNoticeList(noticeList);
					},
					'notice-hidden' : function(popup, e){
						me.SCMdiNoticeService.setCookie(e.detail.post_no,e.detail.post_no,1);
					},
					'sc-window-hided' : function(popup, e){
						//me.$.searchBar.focus();
					}
			 	},{maximizable : true, titleText : "공지사항"});
            	noticeListPopup.show();
            },

            _onStorageMenus: function() {
                var _storageMenus = this.getStorageMenus();
                _storageMenus.unshift(this.startPage);
                
                for(var i=0, len=_storageMenus.length; i < len; i++) {
                    var lazy = i!==len-1;
                    var menu = _storageMenus[i];
                    
                    this.$.mdiContent.createWindow(menu.menu_id, menu.menu_nm, menu.menu_url, lazy);
                }

                if(!UT.isEmpty(sessionStorage.selected_menu_id)){
                	SCMdiManager.activateWindow(sessionStorage.selected_menu_id);
                	sessionStorage.removeItem("selected_menu_id");
                }

                var me = this;

                if(_storageMenus.length == 0){
                	me.$.mdiTopMenu.treeMenuList.forEach(function (item, index, array) {
						if(item.menu_id =="DAB0000"){
							if(item.sub_menu_list.length > 0){
								var menu = item.sub_menu_list[0];
								me.$.mdiContent.createWindow(menu.menu_id, menu.menu_nm, menu.menu_url, lazy);
							}
						}
                    });
                }
                if(SCSessionManager.isDisableOnSpecifiedDate() && 
               		moment(new Date()).isBetween(SCSessionManager.getAccountDisableUserNotifyDate(), SCSessionManager.getAccountDisableForSpecifiedDate()) && 
               		document.cookie.indexOf(SCSessionManager.currentUser.usr_id + ".accountNotifySkip") == -1) {
	                this.async(this._onAccountNotify, 100);
                }
            },
            
            _onAccountNotify : function() {
            	var me = this;
            	me.importLink("ui/lib/mdi/sc-mdi-account-notify.html", function() {
                	var popup = UT.popup("sc-mdi-account-notify", me, 600, 400, {
                    	  
					}, {titleText: me.translate("공지"), closable:true});  //운영시 closable false 로 변경
                    popup.show();
				});
            },

            getStorageMenus: function() {
                var storageMenu = [];
                if(!this.useStorageMenu){
                    return storageMenu;
                }
                this.addEventListener('add-tab-completed', this.setStorageMenu);
                this.addEventListener('remove-tab-completed', this.setStorageMenu);
                var _storageMenu = localStorage.getItem('[' + this.currentUser.usr_id + ']storageMenu');
                var _storageMenuParse = JSON.parse(_storageMenu) || [];
                var _allMenuList = SCMdiManager.getMenuList();

                var filtered = function (item) {
                    for (var i = 0, len = _allMenuList.length; i < len; i++) {
                        if (_allMenuList[i].menu_id === item) {
                            storageMenu.push(_allMenuList[i]);
                        }
                    }
                };

                for (var i = 0, len = _storageMenuParse.length; i < len; i++) {
                    filtered(_storageMenuParse[i]);
                }

                return storageMenu;
            },

            setStorageMenu: function() {
                var openMenus = this.querySelectorAll('sc-mdi-tabbar sc-tab');
                var ids = [];
                for (var i =0, len=openMenus.length; i<len; i++) {
                    var id = openMenus[i].dataset.windowId;
                    if(id != this.startPage.menu_id) {
                        ids.push(id);
                    }
                }
                localStorage.setItem('['+this.currentUser.usr_id+']storageMenu', JSON.stringify(ids));
            },

            /******************************
             * 비밀번호 변경 주기 체크
             ******************************/
            userPopupCheck: function() {
            	var me = this;
                //패스워드 만료
                if(!SCSessionManager.isCredentialsNonExpired()) {
                	UT.alert(me.translate("STD.MDI1006", null, me.currentUser.usr_nm, SCSessionManager.getPasswordExpiredPeriod()), function() { //{0}님은 {1}개월동안 비밀번호를 변경하지 않았습니다. 비밀번호를 변경해 주시길 바랍니다.
                        me.popupChangePassword();
                    }, true);
                    return false;
                }
                //패스워드 초기화
                if(!SCSessionManager.isCredentialsNonInitialized()) {
                	UT.alert(me.translate("STD.MDI1005"), function() { //"임시 비밀번호로 로그인 되었습니다. 비밀번호를 변경해주시길 바랍니다."
                        me.popupChangePassword();
                    }, true);
                	return false;
                }
                //검사완료
                return true;
            },

            popupChangePassword: function() {
            	var me = this;
                me.importLink("ui/lib/mdi/sc-mdi-pw-popup.html", function() {
                    var pwChangePopup = UT.popup("sc-mdi-pw-popup", me, 350, 300, {
                        "logout": function() {
                            me.logout();
                        },
                        "sc-window-hided" : function(){
                        	me._openStartPage();
                        }
                    }, {titleText: me.translate("비밀번호변경"), closable:false});  //운영시 closable false 로 변경
                    pwChangePopup.show();
                });
            },

            //**********************************************************
            //* 즐겨찾기
            //**********************************************************
            //즐겨찾기 left 조회 적용
            toogleFavorite: function(menuCd){
            	var me = this;
            	var ajax = this.$.mdiLeftMenu.$.saveMyFavorite
            	ajax.body = {
            			menu_cd : menuCd
            	};
            	UT.request(this.$.mdiLeftMenu.$.saveMyFavorite,function(e,res){
            		var result = res.response;
            		if(UT.isEmpty(result)){
            			result = [];
            		}
            		//1. sc mdi favorite List 변경
            		//2. sc-mdi-leftMenu favorite List 변경
            		//3. cc-page-title bar 별표 변경
            		SCMdiManager.setFavoritList(result);
            		me.setFavoritList();
            		var eles = me.querySelectorAll('cc-page-title-bar');
            		for(var i = 0 , len = eles.length ; i < len ; i++){
            			eles[i].setFavorite();
            		}
            	});
            },
            
            setFavoritList : function(){
            	this.$.mdiLeftMenu.set("favoritList",SCMdiManager.getFavoritList());
            },

            /**
             * 어플리케이션의 최소 너비 ( min-width ) 를  지정된 width 값으로 적용합니다.
             *
             * @private
             */
            _setMinWidth : function() {
                this.style.minWidth = this._minWidth.width+"px";
                document.querySelector("HTML").style.overflowX ="auto";
			},

            ready : function() {
                this._doSessionTimer();
                this._minWidth.use && this._setMinWidth(); // 최소 너비 사용 시, width 적용
            	SCMdiManager.onReady(function() {
            		this.mdiInitialized = true;
            		SCSessionManager.onReady(function() {
            			this._onReady();
            		}.bind(this));

            		var menuList = SCMdiManager.menuList;
            		
//             		menuList.forEach(function (item, index, array) {
//             			if (item.site_id != null && item.site_id != SCMdiManager.searchParam.site_id) {
//             				menuList.splice(index, 1);
//             			}
//                 	});
            		var length = menuList.length;
                    for(var i=length-1; i>=0 ; i--){
                    	var item = menuList[i];
                        if(item.site_id !=null && item.site_id != SCMdiManager.searchParam.site_id) {
           		      		menuList.splice(i,1);
                        }
                    }



            		this.setTopMenuList();
            		this.setFavoritList();
                    //this.$.searchBar.menuList = SCMdiManager.menuList;
            		this.importLinkByTagName('smartsuite-notice');
            		this.fire('mdi-initialized', this, {bubbles : true});
            		this.fire('mdi-manager-initialized', this, {bubbles : false});
            	}.bind(this));

            },
            
        	/* View in fullscreen */
        	openFullscreen: function() {
        		var elem = document.documentElement;
        		
        	  	if (elem.requestFullscreen) {
        	  		elem.requestFullscreen();
        	  	} else if (elem.mozRequestFullScreen) { /* Firefox */
        	  		elem.mozRequestFullScreen();
        	  	} else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
        	  		elem.webkitRequestFullscreen();
        	  	} else if (elem.msRequestFullscreen) { /* IE/Edge */
        	  		elem.msRequestFullscreen();
        	  	}
        	},
        	
        	/* Close fullscreen */
        	closeFullscreen: function() {
        		var elem = document.documentElement;
        		
        		if (document.exitFullscreen) {
        			document.exitFullscreen();
        		} else if (document.mozCancelFullScreen) { /* Firefox */
        			document.mozCancelFullScreen();
        		} else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
        			document.webkitExitFullscreen();
        		} else if (document.msExitFullscreen) { /* IE/Edge */
        			document.msExitFullscreen();
        		}
        	},
        	
            _destroy: function(){
                clearInterval(this._sessionTimeoutInterval);
            	SCMdiManager.destroy(), SCMdiManager = null;
            	SCRoleManager.destroy(), SCRoleManager = null;
            	SCSessionManager.destroy(), SCSessionManager = null;
            	currentUser = null;
            	currentLocale = null;
            	avaiableLocales = null;
            	menuPaths = null;
            	_sessionTimeout = null;
            	window.SESSIONTIMEOUT = null;
            	startPage = null; 
            	useStorageMenu = null;
            	useSinglePage = null;
            	mdiSearchParam = null;
            	SCMdiNoticeService = null;
            	SCHierachicalData = null;
            	CCHierachicalData = null;
            }
        });
	});       
	var historyPopup;
	var gatewayPopup;
	
	function showGatewayPopup(data){
		var lon = data.geoJson.coordinates[0];
       	var lat = data.geoJson.coordinates[1];
       	if(gatewayPopup){
       		gatewayPopup.close();
		}
		gatewayPopup = UT.popup('ep-position-popup-map', this, 1000, 800, {}, {titleText : "위치확인"});
		gatewayPopup.show();
		gatewayPopup.getWindowContent().load(lat, lon);
    }
	function showTargetPopup(data){
		console.log(data);
		var title = '작업자';
		if(UT.isEmpty(data.targetType)){
			data.targetType='unmapping';
		}
		
		if(data.targetType=='vehicle'){
			title = '이동장비';
		}else if(data.targetType == 'unmapping'){
			title = '미교부앱';
		}

		data.imagePath = "./ui/lib/openlayers/img/"+data.targetType+".png";
		if(historyPopup){
			historyPopup.close();
		}
		historyPopup = UT.popup('ep-mdi-target-history', this, 1300, 700, {}, {titleText : title+" 당일 이력 조회"});
		historyPopup.show();
		historyPopup.getWindowContent().load(title, data);
    }
	</script>
</dom-module>