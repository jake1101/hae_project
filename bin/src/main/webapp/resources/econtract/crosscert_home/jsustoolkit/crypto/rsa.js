(function(){function q(e){"undefined"===typeof BigInteger&&(BigInteger=e.jsbn.BigInteger);var d=e.asn1,h=e.jsustoolkitErrCode=e.jsustoolkitErrCode||{};e.pki=e.pki||{};e.pki.rsa=e.rsa=e.rsa||{};var g=e.pki,s=function(a){var b;if(a.algorithm in e.pki.oids)b=e.pki.oids[a.algorithm];else throw{code:"101001",message:h["101001"]+"("+a.algorithm+")"};var c=d.oidToDer(b).getBytes();b=d.create(d.Class.UNIVERSAL,d.Type.SEQUENCE,!0,[]);var f=d.create(d.Class.UNIVERSAL,d.Type.SEQUENCE,!0,[]);f.value.push(d.create(d.Class.UNIVERSAL,d.Type.OID,!1,c));f.value.push(d.create(d.Class.UNIVERSAL,d.Type.NULL,!1,""));a=d.create(d.Class.UNIVERSAL,d.Type.OCTETSTRING,!1,a.digest().getBytes());b.value.push(f);b.value.push(a);return d.toDer(b).getBytes()},n=function(a,b,c){if(c)b=a.modPow(b.e,b.n);else{b.dP||(b.dP=b.d.mod(b.p.subtract(BigInteger.ONE)));b.dQ||(b.dQ=b.d.mod(b.q.subtract(BigInteger.ONE)));b.qInv||(b.qInv=b.q.modInverse(b.p));c=a.mod(b.p).modPow(b.dP,b.p);for(a=a.mod(b.q).modPow(b.dQ,b.q);0>c.compareTo(a);)c=c.add(b.p);b=c.subtract(a).multiply(b.qInv).mod(b.p).multiply(b.q).add(a)}return b};g.rsa.encrypt=function(a,b,c){if(null==a||"undefined"==typeof a)throw{code:"101002",message:h["101002"]};if(null==b||"undefined"==typeof b)throw{code:"101003",message:h["101003"]};if(null==c||"undefined"==typeof c)throw{code:"101004",message:h["101004"]};var f=c,k=e.util.createBuffer(),l=Math.ceil(b.n.bitLength()/8);if(!1!==c&&!0!==c){if(a.length>l-11)throw{code:"101005",message:h["101005"]+"(length:"+a.length+", max:"+(l-11)+")"};k.putByte(0);k.putByte(c);var d=l-3-a.length;if(0===c||1===c){f=!1;c=0===c?0:255;for(var g=0;g<d;++g)k.putByte(c)}else for(f=!0,g=0;g<d;++g)c=Math.floor(255*Math.random())+1,k.putByte(c);k.putByte(0)}k.putBytes(a);a=new BigInteger(k.toHex(),16);b=n(a,b,f).toString(16);f=e.util.createBuffer();for(l-=Math.ceil(b.length/2);0<l;)f.putByte(0),--l;f.putBytes(e.util.hexToBytes(b));return f.getBytes()};g.rsa.decrypt=function(a,b,c,f){if(null==a||"undefined"==typeof a)throw{code:"101006",message:h["101006"]};if(null==b||"undefined"==typeof b)throw{code:"101007",message:h["101007"]};if(null==c||"undefined"==typeof c)throw{code:"101008",message:h["101008"]};var k=Math.ceil(b.n.bitLength()/8);if(a.length!=k)throw{code:"101009",message:h["101009"]+"(length: "+a.length+", expected: "+k+")"};a=new BigInteger(e.util.createBuffer(a).toHex(),16);a=n(a,b,c).toString(16);b=e.util.createBuffer();for(var l=k-Math.ceil(a.length/2);0<l;)b.putByte(0),--l;b.putBytes(e.util.hexToBytes(a));if(!1!==f){l=b.getByte();a=b.getByte();if(0!==l||c&&0!==a&&1!==a||!c&&2!=a||c&&0===a&&"undefined"===typeof f)throw{code:"101010",message:h["101010"]};c=0;if(0===a)for(c=k-3-f,f=0;f<c;++f){if(0!==b.getByte())throw{code:"101011",message:h["101011"]};}else if(1===a)for(c=0;1<b.length();){if(255!==b.getByte()){--b.read;break}++c}else if(2===a)for(c=0;1<b.length();){if(0===b.getByte()){--b.read;break}++c}if(0!==b.getByte()||c!==k-3-b.length())throw{code:"101013",message:h["101013"]};}return b.getBytes()};g.rsa.createKeyPairGenerationState=function(a,b){"string"===typeof a&&(a=parseInt(a,10));a=a||1024;var c={state:0,itrs:0,maxItrs:100,bits:a,rng:{nextBytes:function(a){for(var b=e.random.getBytes(a.length),c=0;c<a.length;++c)a[c]=b.charCodeAt(c)}},e:new BigInteger((b||65537).toString(16),16),p:null,q:null,qBits:a>>1,pBits:a-(a>>1),pqState:0,num:null,six:new BigInteger(null),addNext:2,keys:null};c.six.fromInt(6);return c};g.rsa.stepKeyPairGenerationState=function(a,b){for(var c=+new Date,f,k=0;null===a.keys&&(0>=b||k<b);){if(0===a.state){f=null===a.p?a.pBits:a.qBits;var d=f-1;if(0===a.pqState)a.itrs=0,a.num=new BigInteger(f,a.rng),a.r=null,a.num.isEven()&&a.num.dAddOffset(1,0),a.num.testBit(d)||a.num.bitwiseTo(BigInteger.ONE.shiftLeft(d),function(a,b){return a|b},a.num),++a.pqState;else if(1===a.pqState){if(null===a.addNext){var h=a.num.mod(a.six).byteValue();3===h&&(a.num.mod.dAddOffset(2),h=5);a.addNext=1===h?2:4}a.num.isProbablePrime(1)?++a.pqState:a.itrs<a.maxItrs?(a.num.dAddOffset(a.addNext,0),a.num.bitLength()>f?(a.addNext=null,a.num.subTo(BigInteger.ONE.shiftLeft(d),a.num)):a.addNext=4===a.addNext?2:4,++a.itrs):a.pqState=0}else 2===a.pqState?a.pqState=0===a.num.subtract(BigInteger.ONE).gcd(a.e).compareTo(BigInteger.ONE)?3:0:3===a.pqState&&(a.pqState=0,a.num.isProbablePrime(10)&&(null===a.p?a.p=a.num:a.q=a.num,null!==a.p&&null!==a.q&&++a.state),a.num=null)}else 1===a.state?(0>a.p.compareTo(a.q)&&(a.num=a.p,a.p=a.q,a.q=a.num),++a.state):2===a.state?(a.p1=a.p.subtract(BigInteger.ONE),a.q1=a.q.subtract(BigInteger.ONE),a.phi=a.p1.multiply(a.q1),++a.state):3===a.state?0===a.phi.gcd(a.e).compareTo(BigInteger.ONE)?++a.state:(a.p=null,a.q=null,a.state=0):4===a.state?(a.n=a.p.multiply(a.q),a.n.bitLength()===a.bits?++a.state:(a.q=null,a.state=0)):5===a.state&&(f=a.e.modInverse(a.phi),a.keys={privateKey:e.pki.rsa.setPrivateKey(a.n,a.e,f,a.p,a.q,f.mod(a.p1),f.mod(a.q1),a.q.modInverse(a.p)),publicKey:e.pki.rsa.setPublicKey(a.n,a.e)});f=+new Date;k+=f-c;c=f}return null!==a.keys};g.rsa.generateKeyPair=function(a,b){var c=g.rsa.createKeyPairGenerationState(a,b);g.rsa.stepKeyPairGenerationState(c,0);return c.keys};g.rsa.setPublicKey=function(a,b){var c={n:a,e:b,encrypt:function(a){return g.rsa.encrypt(a,c,2)},verify:function(a,b,e){if(null==a||"undefined"==typeof a)throw{code:"104002",message:h["104002"]};if(null==b||"undefined"==typeof b)throw{code:"104003",message:h["104003"]};b=g.rsa.decrypt(b,c,!0,void 0===e?void 0:!1);return void 0===e?(e=d.fromDer(b),a===e.value[1].value):e.verify(a,b,c.n.bitLength())}};return c};g.rsa.setPrivateKey=function(a,b,c,f,e,d,n,m){var p={n:a,e:b,d:c,p:f,q:e,dP:d,dQ:n,qInv:m,decrypt:function(a){return g.rsa.decrypt(a,p,!1)},sign:function(a,b){if(null==a||"undefined"==typeof a)throw{code:"104001",message:h["104001"]};var c=!1;void 0===b&&(b={encode:s},c=1);var e=b.encode(a,p.n.bitLength());return g.rsa.encrypt(e,p,c)}};return p}}var r="./asn1 ./oids ./random ./util ./jsbn ./jsustoolkitErrCode".split(" "),m=null;"function"!==typeof define&&("object"===typeof module&&module.exports?m=function(e,d){d(require,module)}:(crosscert=window.crosscert=window.crosscert||{},q(crosscert)));(m||"function"===typeof define)&&(m||define)(["require","module"].concat(r),function(e,d){d.exports=function(d){var g=r.map(function(d){return e(d)}).concat(q);d=d||{};d.defined=d.defined||{};if(d.defined.rsa)return d.rsa;d.defined.rsa=!0;for(var m=0;m<g.length;++m)g[m](d);return d.rsa}})})();