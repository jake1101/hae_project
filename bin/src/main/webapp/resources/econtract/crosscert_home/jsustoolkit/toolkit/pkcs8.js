(function(){function r(f){var e=f.jsustoolkitErrCode=f.jsustoolkitErrCode||{},c=f.pkcs8=f.pkcs8||{},a=f.asn1,t=f.pkcs5=f.pkcs5||{},k=f.pki=f.pki||{},l=k.oids,q={name:"EncryptedPrivateKeyInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]};c.privateKeyValidator={name:"PrivateKeyInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:a.Class.UNIVERSAL,type:a.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:a.Class.UNIVERSAL,type:a.Type.OCTETSTRING,constructed:!1,capture:"privateKey"},{name:"Random",tagClass:a.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,value:[{name:"Attributes",tagClass:a.Class.UNIVERSAL,type:a.Type.SEQUENCE,constructed:!0,value:[{name:"AttrOID",tagClass:a.Class.UNIVERSAL,type:a.Type.OID,constructed:!1,capture:"attributesOid"},{name:"AttributesValue",tagClass:a.Class.UNIVERSAL,type:a.Type.SET,constructed:!0,value:[{name:"rand",tagClass:a.Class.UNIVERSAL,type:a.Type.BITSTRING,constructed:!1,capture:"attributesRandom"}]}]}]}]};c.getPrivateKeyAttributesRandom=function(d){if(null==d||"undefined"==typeof d)throw{code:"111019",message:e["111019"]};var n={},b=[];if(!a.validate(d,f.pkcs8.privateKeyValidator,n,b))throw{code:"111020",message:e["111020"],errors:b};return"undefined"!=typeof n.attributesOid&&a.derToOid(n.attributesOid)==l.identifyData_random?(d=f.util.createBuffer(n.attributesRandom),++d.read,d.getBytes()):""};c.rsaPrivateKeyInfo=function(d,n){if(null==d||"undefined"==typeof d)throw{code:"111021",message:e["111021"]};var b=a.oidToDer(l.RSAEncryption).getBytes(),c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);c.value.push(a.create(a.Class.UNIVERSAL,a.Type.OID,!1,b));c.value.push(a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,""));b=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(0)),c,a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,a.toDer(d).getBytes())]);null!=n&&(c=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.identifyData_random).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SET,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+n)])])]),b.value.push(c));return b};c.encryptPrivateKeyInfo=function(d,c,b){if(null==d||"undefined"==typeof d)throw{code:"111022",message:e["111022"]};if(null==c||"undefined"==typeof c)throw{code:"111023",message:e["111023"]};b=b||{};b.saltSize=b.saltSize||8;b.count=b.count||2048;b.algorithm=b.algorithm||"seed";b.salt=b.salt||f.random.getBytes(b.saltSize);var g=b.salt,h=b.count,k=f.util.createBuffer();k.putInt16(h);var m;if(0===b.algorithm.indexOf("aes")||0===b.algorithm.indexOf("seed")){var p;if("aes128"===b.algorithm)m=16,p=l["aes128-CBC"];else if("aes192"===b.algorithm)m=24,p=l["aes192-CBC"];else if("aes256"===b.algorithm)m=32,p=l["aes256-CBC"];else if("seed"===b.algorithm)m=16,p=l["seed-CBC"];else throw{code:"111024",message:e["111024"]+"("+b.algorithm+")"};m=f.pkcs5.pbkdf2(c,g,h,m);c=f.random.getBytes(16);b=f.cipher.algorithms[b.algorithm].createEncryptionCipher(m);b.start(c);b.update(a.toDer(d));b.finish();d=b.output.getBytes();g=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.pkcs5PBES2).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l.pkcs5PBKDF2).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,g),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,k.getBytes())])]),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(p).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,c)])])])}else if("3des"===b.algorithm)m=24,p=new f.util.ByteBuffer(g),m=f.pkcs12.generateKey(c,p,1,h,m),c=f.pkcs12.generateKey(c,p,2,h,8),b=f.des.createEncryptionCipher(m),b.start(c),b.update(a.toDer(d)),b.finish(),d=b.output.getBytes(),g=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(l["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,g),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,k.getBytes())])]);else throw{code:"111025",message:e["111025"]+"("+b.algorithm+")"};return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[g,a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,d)])};c.decryptPrivateKeyInfo=function(d,c){if(null==d||"undefined"==typeof d)throw{code:"111026",message:e["111026"]};if(null==c||"undefined"==typeof c)throw{code:"111027",message:e["111027"]};var b=null,g={},h=[];if(!a.validate(d,q,g,h))throw{code:"111028",message:e["111028"],errors:h};h=a.derToOid(g.encryptionOid);h=t.pbe.getCipher(h,g.encryptionParams,c);g=f.util.createBuffer(g.encryptedData);h.update(g);h.finish()&&(b=a.fromDer(h.output));return b};c.encryptedPrivateKeyToPem=function(d,c){if(null==d||"undefined"==typeof d)throw{code:"111029",message:e["111029"]};var b=a.toDer(d),b=f.util.encode64(b.getBytes(),c||64);return"-----BEGIN ENCRYPTED PRIVATE KEY-----\r\n"+b+"\r\n-----END ENCRYPTED PRIVATE KEY-----"};c.encryptedPrivateKeyToBase64=function(d){if(null==d||"undefined"==typeof d)throw{code:"111030",message:e["111030"]};d=a.toDer(d);return f.util.encode64(d.getBytes())};c.encryptedPrivateKeyFromPem=function(d){if(null==d||"undefined"==typeof d)throw{code:"111031",message:e["111031"]};d=k.pemToDer(d);return a.fromDer(d)};c.encryptedPrivateKeyFromBase64=function(d){if(null==d||"undefined"==typeof d)throw{code:"111032",message:e["111032"]};d=k.base64ToDer(d);return a.fromDer(d)};c.encryptRsaPrivateKey=function(a,n,b,g,h){h=h||"bin";a=c.rsaPrivateKeyInfo(k.privateKeyToAsn1(a),n);a=c.encryptPrivateKeyInfo(a,b,g);if("bin"==h)return a;if("base64"==h)return c.encryptedPrivateKeyToBase64(a);if("pem"==h)return c.encryptedPrivateKeyToPem(a);throw{code:"111040",message:e["111040"]+"(type:"+h+")"};};c.decryptRsaPrivateKeyFromPem=function(a,e){var b=c.decryptRsaPrivateKeyInfoFromPem(a,e);null!==b&&(b=k.privateKeyFromAsn1(b));return b};c.decryptRsaPrivateKeyInfoFromPem=function(a,e){var b=c.encryptedPrivateKeyFromPem(a);return c.decryptPrivateKeyInfo(b,e)};c.decryptRsaPrivateKeyFromBase64=function(a,e){var b=c.decryptRsaPrivateKeyInfoFromBase64(a,e);null!==b&&(b=k.privateKeyFromAsn1(b));return b};c.decryptRsaPrivateKeyInfoFromBase64=function(a,e){var b=c.encryptedPrivateKeyFromBase64(a);return c.decryptPrivateKeyInfo(b,e)};c.checkUserCertPassword=function(a,f){if(null==f||"undefined"==typeof f)throw{code:"111034",message:e["111034"]};if(null==a||"undefined"==typeof a)throw{code:"111035",message:e["111035"]};try{return a=c.decryptPrivateKeyInfo(a,f),null!==a&&k.privateKeyFromAsn1(a),!0}catch(b){return!1}};c.changePassword=function(a,f,b,g){if(null==a||"undefined"==typeof a)throw{code:"111036",message:e["111036"]};if(null==f||"undefined"==typeof f)throw{code:"111037",message:e["111037"]};if(null==b||"undefined"==typeof b)throw{code:"111038",message:e["111038"]};g=g||"bin";a=c.decryptPrivateKeyInfo(a,f);a=c.encryptPrivateKeyInfo(a,b,{algorithm:"seed"});if("bin"==g)return a;if("Base64"==g)return c.encryptedPrivateKeyToBase64(a);if("PEM"==g)return c.encryptedPrivateKeyToPem(a);throw{code:"111039",message:e["111039"]+"("+g+")"};};c.verifyVID=function(d,k,b,g){if(null==d||"undefined"==typeof d)throw{code:"111041",message:e["111041"]};if(null==k||"undefined"==typeof k)throw{code:"111042",message:e["111042"]};if(null==b||"undefined"==typeof b)throw{code:"111043",message:e["111043"]};if(null==g||"undefined"==typeof g)throw{code:"111044",message:e["111044"]};g=f.asn1.fromDer(g.getExtension("subjectAltName").value);if(l.identifyData==a.derToOid(g.value[0].value[0].value)){var h=l[a.derToOid(g.value[0].value[1].value[0].value[1].value[0].value[1].value[0].value[0].value)];g=g.value[0].value[1].value[0].value[1].value[0].value[1].value[1].value[0].value;d=c.decryptPrivateKeyInfo(d,k);d=c.getPrivateKeyAttributesRandom(d);b=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.PRINTABLESTRING,!1,b),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+d)]);h=f.md.algorithms[h].create();h.start();h.update(a.toDer(b).getBytes());b=h.digest();h.start();h.update(b.bytes());b=h.digest();return g==b.bytes()?!0:!1}return!1}}var s="./aes ./seed ./asn1 ./jsbn ./md ./oids ./random ./rsa ./util ./jsustoolkitErrCode".split(" "),q=null;"function"!==typeof define&&("object"===typeof module&&module.exports?q=function(f,e){e(require,module)}:(crosscert=window.crosscert=window.crosscert||{},r(crosscert)));(q||"function"===typeof define)&&(q||define)(["require","module"].concat(s),function(f,e){e.exports=function(c){var a=s.map(function(a){return f(a)}).concat(r);c=c||{};c.defined=c.defined||{};if(c.defined.pkcs8)return c.pkcs8;c.defined.pkcs8=!0;for(var e=0;e<a.length;++e)a[e](c);return c.pkcs8}})})();