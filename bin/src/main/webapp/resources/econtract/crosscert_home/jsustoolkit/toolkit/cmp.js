(function(){function r(g){var h=g.jsustoolkitErrCode=g.jsustoolkitErrCode||{},a=g.asn1,b=g.cmp=g.cmp||{},n=g.oids=g.oids||{},p=g.util=g.util||{};b.info={version:0,id:[],certReqId:[0,1],referenceValue:[],secretValue:[],signature_algorithm:[],key_size:[],km_key_gen:[],km_key_backup:[],passwd_len:[],passwd_num_len:[],allow_suspend:[],dir_server_addr:[]};b.revReason={unspecified:0,keyCompromise:1,caCompromise:2,affiliationChanged:3,superseded:4,cessationOfOperation:5,certificateHold:6,unused:7,removeFromCRL:8,privilegeWithdrawn:9,aACompromise:10};b.user={};b.ca={};b.messageFromBase64=function(e){if(null==e||"undefined"==typeof e)throw{code:"114001",message:h["114001"]};e=a.fromDer(p.createBuffer(p.decode64(e)));return b.messageFromAsn1(e)};b.messageToBase64=function(b){if(null==b||"undefined"==typeof b)throw{code:"114002",message:h["114002"]};b=a.toDer(b.toAsn1());return p.encode64(b.getBytes())};b.messageFromAsn1=function(e){if(null==e||"undefined"==typeof e)throw{code:"114003",message:h["114003"]};"string"==typeof e&&(e=a.fromDer(p.createBuffer(e)));var c={},d=[];if(!a.validate(e,b.asn1.PKIMessage,c,d))throw{code:"114004",message:h["114004"],errors:d};e=c.body.type;switch(e){case b.asn1.PKIBodyType.genp:_freeTextSplit(c.header.value[3].value[0].value[0].value);b.info.caSignCert=c.body.value[0].value[0].value[1];c.body.value[0].value[1]&&(b.info.caEncCert=c.body.value[0].value[1].value[1]);break;case b.asn1.PKIBodyType.ip:_parseIPMessage(c);break;case b.asn1.PKIBodyType.kup:_parseKUPMessage(c);break;case b.asn1.PKIBodyType.conf:null==c.body.value[0]&&(b.info.certstate=!0);break;case b.asn1.PKIBodyType.rp:_parseRPMessage(c);break;case b.asn1.PKIBodyType.error:b.info.certstate=!1;_parseErrMessage(c);break;default:throw{code:"114005",message:h["114005"]+"("+e+")"};}};b.createGenmMessage=function(e,c,d,f,k){if(null==e||"undefined"==typeof e)throw{code:"114006",message:h["114006"]};if(null==c||"undefined"==typeof c)throw{code:"114007",message:h["114007"]};if(null==d||"undefined"==typeof d)throw{code:"114008",message:h["114008"]};if("undefined"==typeof f||""==f||null==k)f="";"undefined"==typeof k||""==k||null==k?b.info.sender="":(b.info.signCert=k.signCert,b.info.signpair={},b.info.signpair.publicKey=k.signCert.publicKey,"undefined"!=typeof k.signKey&&""!=k.signKey&&null!=k.signKey&&(b.info.signpair.privateKey=g.pki.privateKeyFromAsn1(g.pkcs8.decryptPrivateKeyInfo(k.signKey,k.pw))),b.info.sender=k.signCert.subject,"undefined"!=typeof k.kmCert&&(b.info.kmCert=k.kmCert,b.info.kmpair={},b.info.kmpair.publicKey=k.kmCert.publicKey,"undefined"!=typeof k.signKey&&""!=k.signKey&&null!=k.signKey&&(b.info.kmpair.privateKey=g.pki.privateKeyFromAsn1(g.pkcs8.decryptPrivateKeyInfo(k.kmKey,k.pw)))));k=null;b.info.referenceValue=e;b.info.secretValue=c;b.info.text=d;b.info.mediaType=f;return k={type:b.asn1.PKIBodyType.genm,version:0,toAsn1:function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version))]);""==b.info.sender?e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32))):e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.sender.attributes})]));e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)));e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.referenceValue)]));if(""!=b.info.mediaType){var d=a.create(a.Class.CONTEXT_SPECIFIC,7,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.UTF8,!1,mediaType)])]);e.value.push(d)}d=a.create(a.Class.CONTEXT_SPECIFIC,21,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n.caProtEncCert).getBytes())])])]);c.value.push(e);c.value.push(d);return c}}};b.createIRMessage=function(e,c){var d=null;b.info.snonce=g.random.getBytes(16);null==e||"undefined"==typeof e?b.info.signpair=g.pki.rsa.generateKeyPair(b.info.key_size):(b.info.signpair={},b.info.signpair.publicKey=e(b.info.key_size));0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen&&(b.info.kmpair=g.pki.rsa.generateKeyPair(b.info.key_size));return d={type:b.asn1.PKIBodyType.ir,version:0,toAsn1:function(){var e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.GENERALIZEDTIME,!1,a.dateToGeneralizedTime(new Date))]),a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.referenceValue)]),a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.snonce)])]),g=null,g=b.info.caEncCert?a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign"),_proofOfPossession(1,"Sign","new",c),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_attributeTypeAndValue("encryptedVID",_encryptedVID())])])]):a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign"),_proofOfPossession(1,"Sign","new",c)])]);if(0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen){var h=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("KM"),_proofOfPossession(1,"KM","new")]);g.value.push(h)}h=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[]);h.value.push(g);e.value.push(d);e.value.push(h);d=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("MAC",a.toDer(e).getBytes()))]);e.value.push(d);return e}}};b.createConfirmMessage=function(e){var c=null;return c={type:b.asn1.PKIBodyType.conf,version:0,toAsn1:function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.GENERALIZEDTIME,!1,a.dateToGeneralizedTime(new Date))])]);"undefined"==typeof b.info.newsignpair&&f.value.push(a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.referenceValue)]));f.value.push(a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.snonce)]));f.value.push(a.create(a.Class.CONTEXT_SPECIFIC,6,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.rnonce)]));var g=a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,""),h=a.create(a.Class.CONTEXT_SPECIFIC,19,!0,[]);h.value.push(g);c.value.push(f);c.value.push(h);f=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[]);"undefined"==typeof b.info.newsignpair?f.value.push(a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("MAC",a.toDer(c).getBytes()))):f.value.push(a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("Sign",c,e)));c.value.push(f);b.info.signpair.privateKey="";null!=b.info.kmCert&&"undefined"!=typeof b.info.kmCert&&(b.info.kmpair.privateKey="");return c}}};b.createRRMessage=function(e,c,d,f,k,l){if(null==e||"undefined"==typeof e)throw{code:"114010",message:h["114010"]};if(null==c||"undefined"==typeof c)throw{code:"114011",message:h["114011"]};if(null==f||"undefined"==typeof f)throw{code:"114012",message:h["114012"]};if(null==k||"undefined"==typeof k)throw{code:"114013",message:h["114013"]};var n=null;b.info.signCert=e;b.info.kmCert=d;b.info.revokeNum=k;b.info.signpair={};if(null==l||"undefined"==typeof l)b.info.signpair.privateKey=g.pki.privateKeyFromAsn1(g.pkcs8.decryptPrivateKeyInfo(c,f));b.info.signature_algorithm=g.pki.oids[e.siginfo.algorithmOid];var m=g.random.getBytes(16);return n={type:b.asn1.PKIBodyType.rr,version:0,toAsn1:function(){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.signCert.subject.attributes})]),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,m)])]),d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);d.value.push(_RevDetails(b.info.signCert.serialNumber,b.info.revokeNum));null!=b.info.kmCert&&"undefined"!=typeof b.info.kmCert&&d.value.push(_RevDetails(b.info.kmCert.serialNumber,b.info.revokeNum));var f=a.create(a.Class.CONTEXT_SPECIFIC,11,!0,[]);f.value.push(d);c.value.push(e);c.value.push(f);e=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("Sign",c,l))]);c.value.push(e);return c}}};b.createKURMessage=function(e,c,d){var f=null;b.info.snonce=g.random.getBytes(16);null==e||"undefined"==typeof e?b.info.newsignpair=g.pki.rsa.generateKeyPair(b.info.key_size):(b.info.newsignpair={},b.info.newsignpair.publicKey=e(b.info.key_size));0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen&&(b.info.newkmpair=g.pki.rsa.generateKeyPair(b.info.key_size));return f={type:b.asn1.PKIBodyType.kur,version:0,toAsn1:function(){var e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]),h=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(b.info.version)),a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.signCert.subject.attributes})]),a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32)),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.GENERALIZEDTIME,!1,a.dateToGeneralizedTime(new Date))]),a.create(a.Class.CONTEXT_SPECIFIC,5,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,b.info.snonce)])]),n=null,n=b.info.caEncCert?a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign",f.type),_proofOfPossession(1,"Sign","keyupdate",c),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_attributeTypeAndValue("encryptedVID",_encryptedVID())])])]):a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("Sign",f.type),_proofOfPossession(1,"Sign","keyupdate",c)])]);if(0!=b.info.km_key_gen.length&&"user"==b.info.km_key_gen){var m=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[_CertRequest("KM"),_proofOfPossession(1,"KM","keyupdate")]);n.value.push(m)}m=a.create(a.Class.CONTEXT_SPECIFIC,f.type,!0,[]);m.value.push(n);e.value.push(h);e.value.push(m);h=a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_processProtection("Sign",e,d))]);e.value.push(h);return e}}};_RevDetails=function(b,c){return a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.CONTEXT_SPECIFIC,1,!1,g.util.hexToBytes(b))]),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,_genRevokeNum(c))])};_genRevokeNum=function(a){var b=null,d=null;switch(a){case 0:b="80";d=7;break;case 1:b="40";d=6;break;case 2:b="20";d=5;break;case 3:b="10";d=4;break;case 4:b="08";d=3;break;case 5:b="04";d=2;break;case 6:b="02";d=1;break;case 7:b="01";d=0;break;case 8:b="8000";d=15;break;default:throw{code:"114014",message:h["114014"]+"("+a+")"};}return String.fromCharCode(d)+g.util.hexToBytes(b)};_parseIPMessage=function(e){if(null==e||"undefined"==typeof e)throw{code:"114015",message:h["114015"]};var c={},d=[];if(!a.validate(e.header,b.asn1.PKIHeader,c,d))throw{code:"114051",message:h["114051"],errors:d};var f=a.derToOid(c.protectionAlg.value[0].value[0].value);if(b.info.snonce!=c.recipNonce.value[0].value)throw{code:"114052",message:h["114052"],errors:d};b.info.rnonce=c.senderNonce.value[0].value;c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);c.value.push(e.header);c.value.push(e.body);d=null;if("passwordBasedMac"==n[f])d=_processProtection("MAC",a.toDer(c).getBytes());else throw{code:"114016",message:h["114016"]+"("+f+")"};if(d==e.protection.value[0].value.substring(1))_processCertRepMessage(e,b.asn1.PKIBodyType.ip);else throw{code:"114027",message:h["114027"]};};_parseRPMessage=function(e){var c={},d=[];if(!a.validate(e.body.value[0],b.asn1.RevRepContent,c,d))throw{code:"114028",message:h["114028"],errors:d};for(e=0;e<c.status.value.length;e++){var f={};if(!a.validate(c.status.value[e],b.asn1.PKIStatusInfo,f,d))throw{code:"114029",message:h["114029"],errors:d};if(0!=f.status&&(f=_parsePKIFreeText(f.statusString),"granted"!=f[0]))throw{code:"114030",message:h["114030"]+f[0],errors:d};}};_processCertRepMessage=function(e,c){var d={},f={},k={},l=[];if(!a.validate(e.body.value[0],b.asn1.CertRepMessage,d,l))throw{code:"114017",message:h["114017"],errors:l};null!=d.caPubs&&_getCAPubs(d.caPubs);for(var n=0;n<d.response.value.length;n++){if(!a.validate(d.response.value[n],b.asn1.CertResponse,f,l))throw{code:"114018",message:h["114018"],errors:l};if(b.info.certReqId[n]==f.certReqId.charCodeAt()){if(!a.validate(f.status,b.asn1.PKIStatusInfo,k,l))throw{code:"114019",message:h["114019"],errors:l};if(0==k.status.charCodeAt()){var m={};if(!a.validate(f.certifiedKeyPair,b.asn1.CertifiedKeyPair,m,l))throw{code:"114020",message:h["114020"],errors:l};if(null!=m.certificate)if(b.user.signcert=g.pki.certificateToBase64(g.pki.certificateFromAsn1(m.certificate[0])),null==b.info.signpair.privateKey||"undefined"==typeof b.info.signpair.privateKey)b.user.vidr=b.info.r;else if(b.asn1.PKIBodyType.ip==c)b.user.signpri=g.pkcs8.encryptRsaPrivateKey(b.info.signpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64");else if(b.asn1.PKIBodyType.kup==c)b.user.signpri=g.pkcs8.encryptRsaPrivateKey(b.info.newsignpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64"),console.debug("signCertUpdate : "+b.user.signcert),console.debug("signpriUpdate : "+b.user.signpri);else throw{code:"114049",message:h["114049"],errors:l};else if(null!=m.EncryptedCert){var p={};if(!a.validate(m.EncryptedCert.value[0],b.asn1.EncryptedValue,p,l))throw{code:"114021",message:h["114021"],errors:l};var m=p.encSymmKey.substring(1),p=p.encValue.substring(1),q=null;if(b.asn1.PKIBodyType.ip==c)q=b.info.kmpair.privateKey;else if(b.asn1.PKIBodyType.kup==c)q=b.info.newkmpair.privateKey;else throw{code:"114050",message:h["114050"],errors:l};m=q.decrypt(m);b.info.secret=m;m=g.cipher.algorithms.desofb.startEncrypting(m,"01234567");m.update(g.util.createBuffer(p));m.finish();b.user.kmcert=g.pki.certificateToBase64(g.pki.certificateFromAsn1(a.fromDer(g.util.createBuffer(m.output.data))));if(b.asn1.PKIBodyType.ip==c)b.user.kmpri=g.pkcs8.encryptRsaPrivateKey(b.info.kmpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64");else if(b.asn1.PKIBodyType.kup==c)b.user.kmpri=g.pkcs8.encryptRsaPrivateKey(b.info.newkmpair.privateKey,b.info.r,b.info.text,{algorithm:"seed"},"base64");else throw{code:"114050",message:h["114050"],errors:l};}else throw{code:"114022",message:h["114022"],errors:l};}else{if(2==k.status.charCodeAt()){if(null!=k.statusString){d=_parsePKIFreeText(k.statusString);if(null!=k.failInfo)throw{code:"114023",message:h["114023"]+d[0]+"(PKIFailureInfo : "+k.failInfo.charCodeAt()+")",errors:l};throw{code:"114024",message:h["114024"]+d[0],errors:l};}throw{code:"114025",message:h["114025"]+k.failInfo.charCodeAt(),errors:l};}throw{code:"114026",message:h["114026"]+"(CertResponse status:"+f.status.value[0].value.charCodeAt()+")",errors:l};}}}b.info.r="";b.info.text=""};_parseKUPMessage=function(e){if(null==e||"undefined"==typeof e)throw{code:"114045",message:h["114045"]};var c={},d=[];if(!a.validate(e.header,b.asn1.PKIHeader,c,d))throw{code:"114053",message:h["114053"],errors:d};var f=a.derToOid(c.protectionAlg.value[0].value[0].value);if(b.info.snonce!=c.recipNonce.value[0].value)throw{code:"114054",message:h["114054"],errors:d};b.info.rnonce=c.senderNonce.value[0].value;c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);c.value.push(e.header);c.value.push(e.body);d=null;if("sha256WithRSAEncryption"==n[f])d=_processProtectionVerify(a.toDer(c).getBytes(),e.protection.value[0].value.substring(1));else throw{code:"114046",message:h["114046"]+"("+f+")"};if(1==d)_processCertRepMessage(e,b.asn1.PKIBodyType.kup);else throw{code:"114047",message:h["114047"]};};_parseErrMessage=function(e){var c={},d={},f=[];if(!a.validate(e.body.value[0],b.asn1.ErrorMsgContent,c,f))throw{code:"114031",message:h["114031"],errors:f};if(!a.validate(c.status,b.asn1.PKIStatusInfo,d,f))throw{code:"114032",message:h["114032"],errors:f};e=_parsePKIFreeText(d.statusString);throw{code:"114033",message:h["114033"]+e[0],errors:f};};_parsePKIFreeText=function(a){if(null==a||"undefined"==typeof a)throw{code:"114034",message:h["114034"]};for(var b=[],d,f=0;f<a.value.length;++f)d=a.value[f],b.push(d.value);return b};_CertRequest=function(e,c){if(null==e||"undefined"==typeof e)throw{code:"114035",message:h["114035"]};var d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode("Sign"==e?b.info.certReqId[0]:b.info.certReqId[1])),_CertTemplate(e)]);if(b.asn1.PKIBodyType.kur==c&&"Sign"==e){var f=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n.oldCertID).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[g.pki.distinguishedNameToAsn1({attributes:b.info.signCert.issuer.attributes})]),a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,g.util.hexToBytes(b.info.signCert.serialNumber))])])]);d.value.push(f)}return d};_CertTemplate=function(b){var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);c.value.push(_setCertTemplate(6,b));return c};_setCertTemplate=function(a,c){var d={},d="Sign"==c?"undefined"!=typeof b.info.newsignpair?g.pki.publicKeyToAsn1(b.info.newsignpair.publicKey):g.pki.publicKeyToAsn1(b.info.signpair.publicKey):"undefined"!=typeof b.info.newkmpair?g.pki.publicKeyToAsn1(b.info.newkmpair.publicKey):g.pki.publicKeyToAsn1(b.info.kmpair.publicKey);switch(a){case 6:if(-1<b.info.signature_algorithm.indexOf("RSA"))return _change(d);throw{code:"114036",message:h["114036"],errors:errors};}};_change=function(b){if(null==b||"undefined"==typeof b)throw{code:"114037",message:h["114037"]};var c=a.create(a.Class.CONTEXT_SPECIFIC,6,!0,[]);c.value.push(a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[b.value[0].value[0]]));c.value.push(b.value[1]);return c};_freeTextSplit=function(a){a=a.split("$");for(var c=0;c<a.length;c++)if(""!=a[c]){var d=a[c].split("=");if("signature_algorithm"==d[0])b.info.signature_algorithm=d[1];else if("key_size"==d[0])b.info.key_size=d[1];else if("km_key_gen"==d[0])b.info.km_key_gen=d[1];else if("km_key_backup"==d[0])b.info.km_key_backup=d[1];else if("passwd_len"==d[0])b.info.passwd_len=d[1];else if("passwd_num_len"==d[0])b.info.passwd_num_len=d[1];else if("allow_suspend"==d[0])b.info.allow_suspend=d[1];else if("dir_server_addr"==d[0])b.info.dir_server_addr=d[1];else throw{code:"114038",message:h["114038"]+"("+d[0]+":"+d[1]+")",errors:errors};}};_proofOfPossession=function(e,c,d,f){"undefined"==typeof d&&(d="new");var g=a.create(a.Class.CONTEXT_SPECIFIC,e,!0,[]);switch(e){case 0:throw{code:"114039",message:h["114039"]};case 1:e=_popoSigningKeyInput(0,c);g.value.push(a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[e.value[0],e.value[1]]));g.value.push(a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n[b.info.signature_algorithm]).getBytes())]));g.value.push(a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+_signature(e,c,d,f)));break;case 2:throw{code:"114040",message:h["114040"]};case 3:throw{code:"114041",message:h["114041"]};default:throw{code:"114042",message:h["114042"]};}return g};_popoSigningKeyInput=function(e,c){var d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);switch(e){case 0:d.value.push(a.create(a.Class.CONTEXT_SPECIFIC,e,!0,[a.create(a.Class.CONTEXT_SPECIFIC,1,!1,String.fromCharCode(32))]));break;default:throw{code:"114043",message:h["114043"]};}publickeyValue="Sign"==c?"undefined"!=typeof b.info.newsignpair?g.pki.publicKeyToAsn1(b.info.newsignpair.publicKey):g.pki.publicKeyToAsn1(b.info.signpair.publicKey):"undefined"!=typeof b.info.newkmpair?g.pki.publicKeyToAsn1(b.info.newkmpair.publicKey):g.pki.publicKeyToAsn1(b.info.kmpair.publicKey);var f=_change(publickeyValue);d.value.push(a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[f.value[0],f.value[1]]));return d};_signature=function(e,c,d,f){var h=b.info.signature_algorithm.split("With"),l;if("Sign"==c)if("keyupdate"==d){if(null==f||"undefined"==typeof f)l=b.info.newsignpair.privateKey}else{if(null==f||"undefined"==typeof f)l=b.info.signpair.privateKey}else l="keyupdate"==d?b.info.newkmpair.privateKey:b.info.kmpair.privateKey;c=g.md.algorithms[h[0]].create();c.start();c.update(a.toDer(e).getBytes());return null==f||"undefined"==typeof f?l.sign(c):f(c)};_attributeTypeAndValue=function(b,c){var d=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);d.value.push(a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n[b]).getBytes()));null!=c&&d.value.push(c);return d};_encryptedVID=function(){var e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[]);e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.INTEGER,!1,String.fromCharCode(0))]));e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,2,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n.RSAEncryption).getBytes()),a.create(a.Class.UNIVERSAL,a.Type.NULL,!1,"")])]));e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,3,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[b.info.caEncCert.value[0].value[3],b.info.caEncCert.value[0].value[1]])]));e.value.push(a.create(a.Class.CONTEXT_SPECIFIC,4,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,_encVID())]));return e};_encVID=function(){var e=b.info.signature_algorithm.split("With");b.info.r=g.random.getBytes(20);var c=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.PRINTABLESTRING,!1,"1234561234567"),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+b.info.r)]),d=g.md.algorithms[e[0]].create();d.start();d.update(a.toDer(c).getBytes());c=d.digest();d.start();d.update(c.bytes());c=d.digest();e=a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.SEQUENCE,!0,[a.create(a.Class.UNIVERSAL,a.Type.OID,!1,a.oidToDer(n[e[0]]).getBytes())]),a.create(a.Class.CONTEXT_SPECIFIC,0,!0,[a.create(a.Class.UNIVERSAL,a.Type.OCTETSTRING,!1,c.bytes())])]),a.create(a.Class.UNIVERSAL,a.Type.BITSTRING,!1,String.fromCharCode(0)+b.info.r)]);return g.pki.certificateFromAsn1(b.info.caEncCert).publicKey.encrypt(a.toDer(e).getBytes())};_processProtection=function(a,b,d){var f=null;if("Sign"==a)f=_processProtectionSign(b,d);else if("MAC"==a)f=_processProtectionMac(b);else throw{code:"114044",message:h["114044"],errors:errors};return f};_processProtectionVerify=function(a,c){var d=g.pki.certificateFromAsn1(b.info.caSignCert),f=n[d.signatureOid].split("With"),f=g.md.algorithms[f[0]].create();f.start();f.update(a);return d.publicKey.verify(f.digest().getBytes(),c)};_processProtectionSign=function(a,b){return _signature(a,"Sign","new",b)};_processProtectionMac=function(a){var c;""!=b.info.secret&&"undefined"!==typeof b.info.secret?(c="aaaaabbbbb"+g.util.bytesToHex(b.info.secret),b.info.secret=""):c="aaaaabbbbb"+b.info.secretValue;for(var d=g.md.algorithms.sha1.create(),f=0;2>f;f++)d.start(),d.update(c),c=d.digest(),c=c.bytes();c=g.cipher.algorithms.des.startEncrypting(c.substring(0,8),g.util.hexToBytes("0000000000000000"));c.update(g.util.createBuffer(a));c.finish(_zero_padding);c=c.output.data;return c.substring(c.length-8,c.length)};_zero_padding=function(a,b,d){d||(a=b.length()==a?0:a-b.length(),b.fillWithByte(0,a));return!0};_getCAPubs=function(a){for(var c={certs:{}},d=0;d<a.value[0].value.length;d++){var f=g.x509Certificate.parser(a.value[0].value[d],"ASN1");""==g.x509Certificate.getAuthorityKeyIndentifier()?b.ca.RootCA=g.pki.certificateToPem(f):(c.certs[f.subject.hash]=g.pki.certificateToPem(f),d==a.value[0].value.length-1&&(b.ca.CA=c))}}}var s="./asn1 ./oids ./cmpasn1 ./pki ./util ./random ./jsustoolkitErrCode".split(" "),q=null;"function"!==typeof define&&("object"===typeof module&&module.exports?q=function(g,h){h(require,module)}:(crosscert=window.crosscert=window.crosscert||{},r(crosscert)));(q||"function"===typeof define)&&(q||define)(["require","module"].concat(s),function(g,h){h.exports=function(a){var b=s.map(function(a){return g(a)}).concat(r);a=a||{};a.defined=a.defined||{};if(a.defined.cmp)return a.cmp;a.defined.cmp=!0;for(var h=0;h<b.length;++h)b[h](a);return a.cmp}})})();